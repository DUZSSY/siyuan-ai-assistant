"use strict";var il=Object.defineProperty;var al=(s,e,t)=>e in s?il(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var q=(s,e,t)=>al(s,typeof e!="symbol"?e+"":e,t);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const Oi=require("siyuan");function ze(){}function Fi(s){return s()}function kr(){return Object.create(null)}function Ce(s){s.forEach(Fi)}function tn(s){return typeof s=="function"}function Ss(s,e){return s!=s?e==e:s!==e||s&&typeof s=="object"||typeof s=="function"}function ll(s){return Object.keys(s).length===0}function d(s,e){s.appendChild(e)}function $(s,e,t){s.insertBefore(e,t||null)}function j(s){s.parentNode&&s.parentNode.removeChild(s)}function Qe(s,e){for(let t=0;t<s.length;t+=1)s[t]&&s[t].d(e)}function w(s){return document.createElement(s)}function V(s){return document.createTextNode(s)}function E(){return V(" ")}function Bi(){return V("")}function O(s,e,t,n){return s.addEventListener(e,t,n),()=>s.removeEventListener(e,t,n)}function g(s,e,t){t==null?s.removeAttribute(e):s.getAttribute(e)!==t&&s.setAttribute(e,t)}function Dn(s){return s===""?null:+s}function ol(s){return Array.from(s.childNodes)}function Y(s,e){e=""+e,s.data!==e&&(s.data=e)}function te(s,e){s.value=e??""}function ce(s,e,t){s.classList.toggle(e,!!t)}function cl(s,e,{bubbles:t=!1,cancelable:n=!1}={}){return new CustomEvent(s,{detail:e,bubbles:t,cancelable:n})}let Yt;function Xt(s){Yt=s}function Li(){if(!Yt)throw new Error("Function called outside component initialization");return Yt}function ks(s){Li().$$.on_mount.push(s)}function ul(){const s=Li();return(e,t,{cancelable:n=!1}={})=>{const i=s.$$.callbacks[e];if(i){const r=cl(e,t,{cancelable:n});return i.slice().forEach(a=>{a.call(s,r)}),!r.defaultPrevented}return!0}}const Tt=[],as=[];let Ft=[];const Ar=[],xi=Promise.resolve();let ls=!1;function Ni(){ls||(ls=!0,xi.then(ji))}function hl(){return Ni(),xi}function os(s){Ft.push(s)}const Kn=new Set;let Ct=0;function ji(){if(Ct!==0)return;const s=Yt;do{try{for(;Ct<Tt.length;){const e=Tt[Ct];Ct++,Xt(e),fl(e.$$)}}catch(e){throw Tt.length=0,Ct=0,e}for(Xt(null),Tt.length=0,Ct=0;as.length;)as.pop()();for(let e=0;e<Ft.length;e+=1){const t=Ft[e];Kn.has(t)||(Kn.add(t),t())}Ft.length=0}while(Tt.length);for(;Ar.length;)Ar.pop()();ls=!1,Kn.clear(),Xt(s)}function fl(s){if(s.fragment!==null){s.update(),Ce(s.before_update);const e=s.dirty;s.dirty=[-1],s.fragment&&s.fragment.p(s.ctx,e),s.after_update.forEach(os)}}function dl(s){const e=[],t=[];Ft.forEach(n=>s.indexOf(n)===-1?e.push(n):t.push(n)),t.forEach(n=>n()),Ft=e}const ml=new Set;function pl(s,e){s&&s.i&&(ml.delete(s),s.i(e))}function ue(s){return(s==null?void 0:s.length)!==void 0?s:Array.from(s)}function gl(s,e,t){const{fragment:n,after_update:i}=s.$$;n&&n.m(e,t),os(()=>{const r=s.$$.on_mount.map(Fi).filter(tn);s.$$.on_destroy?s.$$.on_destroy.push(...r):Ce(r),s.$$.on_mount=[]}),i.forEach(os)}function _l(s,e){const t=s.$$;t.fragment!==null&&(dl(t.after_update),Ce(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function bl(s,e){s.$$.dirty[0]===-1&&(Tt.push(s),Ni(),s.$$.dirty.fill(0)),s.$$.dirty[e/31|0]|=1<<e%31}function As(s,e,t,n,i,r,a=null,l=[-1]){const o=Yt;Xt(s);const c=s.$$={fragment:null,ctx:[],props:r,update:ze,not_equal:i,bound:kr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(o?o.$$.context:[])),callbacks:kr(),dirty:l,skip_bound:!1,root:e.target||o.$$.root};a&&a(c.root);let u=!1;if(c.ctx=t?t(s,e.props||{},(h,f,...m)=>{const p=m.length?m[0]:f;return c.ctx&&i(c.ctx[h],c.ctx[h]=p)&&(!c.skip_bound&&c.bound[h]&&c.bound[h](p),u&&bl(s,h)),f}):[],c.update(),u=!0,Ce(c.before_update),c.fragment=n?n(c.ctx):!1,e.target){if(e.hydrate){const h=ol(e.target);c.fragment&&c.fragment.l(h),h.forEach(j)}else c.fragment&&c.fragment.c();e.intro&&pl(s.$$.fragment),gl(s,e.target,e.anchor),ji()}Xt(o)}class Cs{constructor(){q(this,"$$");q(this,"$$set")}$destroy(){_l(this,1),this.$destroy=ze}$on(e,t){if(!tn(t))return ze;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const i=n.indexOf(t);i!==-1&&n.splice(i,1)}}$set(e){this.$$set&&!ll(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const wl="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(wl);const cs="RFC3986",us={RFC1738:s=>String(s).replace(/%20/g,"+"),RFC3986:s=>String(s)},vl="RFC1738",yl=Array.isArray,qe=(()=>{const s=[];for(let e=0;e<256;++e)s.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return s})(),Gn=1024,Sl=(s,e,t,n,i)=>{if(s.length===0)return s;let r=s;if(typeof s=="symbol"?r=Symbol.prototype.toString.call(s):typeof s!="string"&&(r=String(s)),t==="iso-8859-1")return escape(r).replace(/%u[0-9a-f]{4}/gi,function(l){return"%26%23"+parseInt(l.slice(2),16)+"%3B"});let a="";for(let l=0;l<r.length;l+=Gn){const o=r.length>=Gn?r.slice(l,l+Gn):r,c=[];for(let u=0;u<o.length;++u){let h=o.charCodeAt(u);if(h===45||h===46||h===95||h===126||h>=48&&h<=57||h>=65&&h<=90||h>=97&&h<=122||i===vl&&(h===40||h===41)){c[c.length]=o.charAt(u);continue}if(h<128){c[c.length]=qe[h];continue}if(h<2048){c[c.length]=qe[192|h>>6]+qe[128|h&63];continue}if(h<55296||h>=57344){c[c.length]=qe[224|h>>12]+qe[128|h>>6&63]+qe[128|h&63];continue}u+=1,h=65536+((h&1023)<<10|o.charCodeAt(u)&1023),c[c.length]=qe[240|h>>18]+qe[128|h>>12&63]+qe[128|h>>6&63]+qe[128|h&63]}a+=c.join("")}return a};function kl(s){return!s||typeof s!="object"?!1:!!(s.constructor&&s.constructor.isBuffer&&s.constructor.isBuffer(s))}function Cr(s,e){if(yl(s)){const t=[];for(let n=0;n<s.length;n+=1)t.push(e(s[n]));return t}return e(s)}const Al=Object.prototype.hasOwnProperty,zi={brackets(s){return String(s)+"[]"},comma:"comma",indices(s,e){return String(s)+"["+e+"]"},repeat(s){return String(s)}},Xe=Array.isArray,Cl=Array.prototype.push,$i=function(s,e){Cl.apply(s,Xe(e)?e:[e])},El=Date.prototype.toISOString,pe={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:Sl,encodeValuesOnly:!1,format:cs,formatter:us[cs],indices:!1,serializeDate(s){return El.call(s)},skipNulls:!1,strictNullHandling:!1};function Pl(s){return typeof s=="string"||typeof s=="number"||typeof s=="boolean"||typeof s=="symbol"||typeof s=="bigint"}const Qn={};function Ui(s,e,t,n,i,r,a,l,o,c,u,h,f,m,p,_,b,y){let v=s,C=y,S=0,P=!1;for(;(C=C.get(Qn))!==void 0&&!P;){const F=C.get(s);if(S+=1,typeof F<"u"){if(F===S)throw new RangeError("Cyclic object value");P=!0}typeof C.get(Qn)>"u"&&(S=0)}if(typeof c=="function"?v=c(e,v):v instanceof Date?v=f==null?void 0:f(v):t==="comma"&&Xe(v)&&(v=Cr(v,function(F){return F instanceof Date?f==null?void 0:f(F):F})),v===null){if(r)return o&&!_?o(e,pe.encoder,b,"key",m):e;v=""}if(Pl(v)||kl(v)){if(o){const F=_?e:o(e,pe.encoder,b,"key",m);return[(p==null?void 0:p(F))+"="+(p==null?void 0:p(o(v,pe.encoder,b,"value",m)))]}return[(p==null?void 0:p(e))+"="+(p==null?void 0:p(String(v)))]}const A=[];if(typeof v>"u")return A;let k;if(t==="comma"&&Xe(v))_&&o&&(v=Cr(v,o)),k=[{value:v.length>0?v.join(",")||null:void 0}];else if(Xe(c))k=c;else{const F=Object.keys(v);k=u?F.sort(u):F}const M=l?String(e).replace(/\./g,"%2E"):String(e),T=n&&Xe(v)&&v.length===1?M+"[]":M;if(i&&Xe(v)&&v.length===0)return T+"[]";for(let F=0;F<k.length;++F){const D=k[F],R=typeof D=="object"&&typeof D.value<"u"?D.value:v[D];if(a&&R===null)continue;const I=h&&l?D.replace(/\./g,"%2E"):D,B=Xe(v)?typeof t=="function"?t(T,I):T:T+(h?"."+I:"["+I+"]");y.set(s,S);const x=new WeakMap;x.set(Qn,y),$i(A,Ui(R,B,t,n,i,r,a,l,t==="comma"&&_&&Xe(v)?null:o,c,u,h,f,m,p,_,b,x))}return A}function Il(s=pe){if(typeof s.allowEmptyArrays<"u"&&typeof s.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof s.encodeDotInKeys<"u"&&typeof s.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(s.encoder!==null&&typeof s.encoder<"u"&&typeof s.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=s.charset||pe.charset;if(typeof s.charset<"u"&&s.charset!=="utf-8"&&s.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=cs;if(typeof s.format<"u"){if(!Al.call(us,s.format))throw new TypeError("Unknown format option provided.");t=s.format}const n=us[t];let i=pe.filter;(typeof s.filter=="function"||Xe(s.filter))&&(i=s.filter);let r;if(s.arrayFormat&&s.arrayFormat in zi?r=s.arrayFormat:"indices"in s?r=s.indices?"indices":"repeat":r=pe.arrayFormat,"commaRoundTrip"in s&&typeof s.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof s.allowDots>"u"?s.encodeDotInKeys?!0:pe.allowDots:!!s.allowDots;return{addQueryPrefix:typeof s.addQueryPrefix=="boolean"?s.addQueryPrefix:pe.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof s.allowEmptyArrays=="boolean"?!!s.allowEmptyArrays:pe.allowEmptyArrays,arrayFormat:r,charset:e,charsetSentinel:typeof s.charsetSentinel=="boolean"?s.charsetSentinel:pe.charsetSentinel,commaRoundTrip:!!s.commaRoundTrip,delimiter:typeof s.delimiter>"u"?pe.delimiter:s.delimiter,encode:typeof s.encode=="boolean"?s.encode:pe.encode,encodeDotInKeys:typeof s.encodeDotInKeys=="boolean"?s.encodeDotInKeys:pe.encodeDotInKeys,encoder:typeof s.encoder=="function"?s.encoder:pe.encoder,encodeValuesOnly:typeof s.encodeValuesOnly=="boolean"?s.encodeValuesOnly:pe.encodeValuesOnly,filter:i,format:t,formatter:n,serializeDate:typeof s.serializeDate=="function"?s.serializeDate:pe.serializeDate,skipNulls:typeof s.skipNulls=="boolean"?s.skipNulls:pe.skipNulls,sort:typeof s.sort=="function"?s.sort:null,strictNullHandling:typeof s.strictNullHandling=="boolean"?s.strictNullHandling:pe.strictNullHandling}}function Dl(s,e={}){let t=s;const n=Il(e);let i,r;typeof n.filter=="function"?(r=n.filter,t=r("",t)):Xe(n.filter)&&(r=n.filter,i=r);const a=[];if(typeof t!="object"||t===null)return"";const l=zi[n.arrayFormat],o=l==="comma"&&n.commaRoundTrip;i||(i=Object.keys(t)),n.sort&&i.sort(n.sort);const c=new WeakMap;for(let f=0;f<i.length;++f){const m=i[f];n.skipNulls&&t[m]===null||$i(a,Ui(t[m],m,l,o,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,c))}const u=a.join(n.delimiter);let h=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?h+="utf8=%26%2310003%3B&":h+="utf8=%E2%9C%93&"),u.length>0?h+u:""}const Rt="4.104.0";let Er=!1,Kt,Wi,Hi,hs,Vi,Ji,qi,Xi,Ki;function Tl(s,e={auto:!1}){if(Er)throw new Error(`you must \`import 'openai/shims/${s.kind}'\` before importing anything else from openai`);if(Kt)throw new Error(`can't \`import 'openai/shims/${s.kind}'\` after \`import 'openai/shims/${Kt}'\``);Er=e.auto,Kt=s.kind,Wi=s.fetch,Hi=s.FormData,hs=s.File,Vi=s.ReadableStream,Ji=s.getMultipartRequestOptions,qi=s.getDefaultAgent,Xi=s.fileFromPath,Ki=s.isFsReadStream}class Rl{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Ml({manuallyImported:s}={}){const e=s?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,n,i,r;try{t=fetch,n=Request,i=Response,r=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:i,Headers:r,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,l)=>({...l,body:new Rl(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}const Gi=()=>{Kt||Tl(Ml(),{auto:!0})};Gi();class z extends Error{}class ye extends z{constructor(e,t,n,i){super(`${ye.makeMessage(e,t,n)}`),this.status=e,this.headers=i,this.request_id=i==null?void 0:i["x-request-id"],this.error=t;const r=t;this.code=r==null?void 0:r.code,this.param=r==null?void 0:r.param,this.type=r==null?void 0:r.type}static makeMessage(e,t,n){const i=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,n,i){if(!e||!i)return new Bn({message:n,cause:ds(t)});const r=t==null?void 0:t.error;return e===400?new Qi(e,r,n,i):e===401?new Yi(e,r,n,i):e===403?new Zi(e,r,n,i):e===404?new ea(e,r,n,i):e===409?new ta(e,r,n,i):e===422?new na(e,r,n,i):e===429?new sa(e,r,n,i):e>=500?new ra(e,r,n,i):new ye(e,r,n,i)}}class je extends ye{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Bn extends ye{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Es extends Bn{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Qi extends ye{}class Yi extends ye{}class Zi extends ye{}class ea extends ye{}class ta extends ye{}class na extends ye{}class sa extends ye{}class ra extends ye{}class ia extends z{constructor(){super("Could not parse response content as the length limit was reached")}}class aa extends z{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var dn=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},bt=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},xe;class Ln{constructor(){xe.set(this,void 0),this.buffer=new Uint8Array,dn(this,xe,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer),n.set(t,this.buffer.length),this.buffer=n;const i=[];let r;for(;(r=Ol(this.buffer,bt(this,xe,"f")))!=null;){if(r.carriage&&bt(this,xe,"f")==null){dn(this,xe,r.index,"f");continue}if(bt(this,xe,"f")!=null&&(r.index!==bt(this,xe,"f")+1||r.carriage)){i.push(this.decodeText(this.buffer.slice(0,bt(this,xe,"f")-1))),this.buffer=this.buffer.slice(bt(this,xe,"f")),dn(this,xe,null,"f");continue}const a=bt(this,xe,"f")!==null?r.preceding-1:r.preceding,l=this.decodeText(this.buffer.slice(0,a));i.push(l),this.buffer=this.buffer.slice(r.index),dn(this,xe,null,"f")}return i}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new z(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new z(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new z("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}xe=new WeakMap;Ln.NEWLINE_CHARS=new Set([`
`,"\r"]);Ln.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Ol(s,e){for(let i=e??0;i<s.length;i++){if(s[i]===10)return{preceding:i,index:i+1,carriage:!1};if(s[i]===13)return{preceding:i,index:i+1,carriage:!0}}return null}function Fl(s){for(let n=0;n<s.length-1;n++){if(s[n]===10&&s[n+1]===10||s[n]===13&&s[n+1]===13)return n+2;if(s[n]===13&&s[n+1]===10&&n+3<s.length&&s[n+2]===13&&s[n+3]===10)return n+4}return-1}function la(s){if(s[Symbol.asyncIterator])return s;const e=s.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Ge{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const a of Bl(e,t))if(!r){if(a.data.startsWith("[DONE]")){r=!0;continue}if(a.event===null||a.event.startsWith("response.")||a.event.startsWith("transcript.")){let l;try{l=JSON.parse(a.data)}catch(o){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),o}if(l&&l.error)throw new ye(void 0,l.error,void 0,ma(e.headers));yield l}else{let l;try{l=JSON.parse(a.data)}catch(o){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),o}if(a.event=="error")throw new ye(void 0,l.error,l.message,void 0);yield{event:a.event,data:l}}}r=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{r||t.abort()}}return new Ge(i,t)}static fromReadableStream(e,t){let n=!1;async function*i(){const a=new Ln,l=la(e);for await(const o of l)for(const c of a.decode(o))yield c;for(const o of a.flush())yield o}async function*r(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(const l of i())a||l&&(yield JSON.parse(l));a=!0}catch(l){if(l instanceof Error&&l.name==="AbortError")return;throw l}finally{a||t.abort()}}return new Ge(r,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),i=r=>({next:()=>{if(r.length===0){const a=n.next();e.push(a),t.push(a)}return r.shift()}});return[new Ge(()=>i(e),this.controller),new Ge(()=>i(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new Vi({async start(){t=e[Symbol.asyncIterator]()},async pull(i){try{const{value:r,done:a}=await t.next();if(a)return i.close();const l=n.encode(JSON.stringify(r)+`
`);i.enqueue(l)}catch(r){i.error(r)}},async cancel(){var i;await((i=t.return)==null?void 0:i.call(t))}})}}async function*Bl(s,e){if(!s.body)throw e.abort(),new z("Attempted to iterate over a response with no body");const t=new xl,n=new Ln,i=la(s.body);for await(const r of Ll(i))for(const a of n.decode(r)){const l=t.decode(a);l&&(yield l)}for(const r of n.flush()){const a=t.decode(r);a&&(yield a)}}async function*Ll(s){let e=new Uint8Array;for await(const t of s){if(t==null)continue;const n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let i=new Uint8Array(e.length+n.length);i.set(e),i.set(n,e.length),e=i;let r;for(;(r=Fl(e))!==-1;)yield e.slice(0,r),e=e.slice(r)}e.length>0&&(yield e)}class xl{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const r={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],r}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,i]=Nl(e,":");return i.startsWith(" ")&&(i=i.substring(1)),t==="event"?this.event=i:t==="data"&&this.data.push(i),null}}function Nl(s,e){const t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}const oa=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function",ca=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&xn(s),xn=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",jl=s=>ca(s)||oa(s)||Ki(s);async function ua(s,e,t){var i;if(s=await s,ca(s))return s;if(oa(s)){const r=await s.blob();e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()??"unknown_file");const a=xn(r)?[await r.arrayBuffer()]:[r];return new hs(a,e,t)}const n=await zl(s);if(e||(e=Ul(s)??"unknown_file"),!(t!=null&&t.type)){const r=(i=n[0])==null?void 0:i.type;typeof r=="string"&&(t={...t,type:r})}return new hs(n,e,t)}async function zl(s){var t;let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(xn(s))e.push(await s.arrayBuffer());else if(Wl(s))for await(const n of s)e.push(n);else throw new Error(`Unexpected data type: ${typeof s}; constructor: ${(t=s==null?void 0:s.constructor)==null?void 0:t.name}; props: ${$l(s)}`);return e}function $l(s){return`[${Object.getOwnPropertyNames(s).map(t=>`"${t}"`).join(", ")}]`}function Ul(s){var e;return Yn(s.name)||Yn(s.filename)||((e=Yn(s.path))==null?void 0:e.split(/[\\/]/).pop())}const Yn=s=>{if(typeof s=="string")return s;if(typeof Buffer<"u"&&s instanceof Buffer)return String(s)},Wl=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",Pr=s=>s&&typeof s=="object"&&s.body&&s[Symbol.toStringTag]==="MultipartBody",kt=async s=>{const e=await Hl(s.body);return Ji(e,s)},Hl=async s=>{const e=new Hi;return await Promise.all(Object.entries(s||{}).map(([t,n])=>fs(e,t,n))),e},fs=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(jl(t)){const n=await ua(t);s.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>fs(s,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,i])=>fs(s,`${e}[${n}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Vl=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},Jl=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},mn;Gi();async function ha(s){var a;const{response:e}=s;if(s.options.stream)return ht("response",e.status,e.url,e.headers,e.body),s.options.__streamClass?s.options.__streamClass.fromSSEResponse(e,s.controller):Ge.fromSSEResponse(e,s.controller);if(e.status===204)return null;if(s.options.__binaryResponse)return e;const t=e.headers.get("content-type"),n=(a=t==null?void 0:t.split(";")[0])==null?void 0:a.trim();if((n==null?void 0:n.includes("application/json"))||(n==null?void 0:n.endsWith("+json"))){const l=await e.json();return ht("response",e.status,e.url,e.headers,l),fa(l,e)}const r=await e.text();return ht("response",e.status,e.url,e.headers,r),r}function fa(s,e){return!s||typeof s!="object"||Array.isArray(s)?s:Object.defineProperty(s,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class Nn extends Promise{constructor(e,t=ha){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Nn(this.responsePromise,async t=>fa(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class ql{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:i,fetch:r}){this.baseURL=e,this.maxRetries=Zn("maxRetries",t),this.timeout=Zn("timeout",n),this.httpAgent=i,this.fetch=r??Wi}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Yl(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${no()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async i=>{const r=i&&xn(i==null?void 0:i.body)?new DataView(await i.body.arrayBuffer()):(i==null?void 0:i.body)instanceof DataView?i.body:(i==null?void 0:i.body)instanceof ArrayBuffer?new DataView(i.body):i&&ArrayBuffer.isView(i==null?void 0:i.body)?new DataView(i.body.buffer):i==null?void 0:i.body;return{method:e,path:t,...i,body:r}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var _;const n={...e},{method:i,path:r,query:a,headers:l={}}=n,o=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:Pr(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,c=this.calculateContentLength(o),u=this.buildURL(r,a);"timeout"in n&&Zn("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const h=n.httpAgent??this.httpAgent??qi(u),f=n.timeout+1e3;typeof((_=h==null?void 0:h.options)==null?void 0:_.timeout)=="number"&&f>(h.options.timeout??0)&&(h.options.timeout=f),this.idempotencyHeader&&i!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),l[this.idempotencyHeader]=e.idempotencyKey);const m=this.buildHeaders({options:n,headers:l,contentLength:c,retryCount:t});return{req:{method:i,...o&&{body:o},headers:m,...h&&{agent:h},signal:n.signal??null},url:u,timeout:n.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:i}){const r={};n&&(r["content-length"]=n);const a=this.defaultHeaders(e);return Rr(r,a),Rr(r,t),Pr(e.body)&&Kt!=="node"&&delete r["content-type"],gn(a,"x-stainless-retry-count")===void 0&&gn(t,"x-stainless-retry-count")===void 0&&(r["x-stainless-retry-count"]=String(i)),gn(a,"x-stainless-timeout")===void 0&&gn(t,"x-stainless-timeout")===void 0&&e.timeout&&(r["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,i){return ye.generate(e,t,n,i)}request(e,t=null){return new Nn(this.makeRequest(e,t))}async makeRequest(e,t){var h,f;const n=await e,i=n.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(n);const{req:r,url:a,timeout:l}=this.buildRequest(n,{retryCount:i-t});if(await this.prepareRequest(r,{url:a,options:n}),ht("request",a,n,r.headers),(h=n.signal)!=null&&h.aborted)throw new je;const o=new AbortController,c=await this.fetchWithTimeout(a,r,l,o).catch(ds);if(c instanceof Error){if((f=n.signal)!=null&&f.aborted)throw new je;if(t)return this.retryRequest(n,t);throw c.name==="AbortError"?new Es:new Bn({cause:c})}const u=ma(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const v=`retrying, ${t} attempts remaining`;return ht(`response (error; ${v})`,c.status,a,u),this.retryRequest(n,t,u)}const m=await c.text().catch(v=>ds(v).message),p=Zl(m),_=p?void 0:m;throw ht(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,a,u,_),this.makeStatusError(c.status,p,_,u)}return{response:c,options:n,controller:o}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Xl(this,n,e)}buildURL(e,t){const n=to(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return pa(i)||(t={...i,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new z(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,i){const{signal:r,...a}=t||{};r&&r.addEventListener("abort",()=>i.abort());const l=setTimeout(()=>i.abort(),n),o={signal:i.signal,...a};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally(()=>{clearTimeout(l)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let i;const r=n==null?void 0:n["retry-after-ms"];if(r){const l=parseFloat(r);Number.isNaN(l)||(i=l)}const a=n==null?void 0:n["retry-after"];if(a&&!i){const l=parseFloat(a);Number.isNaN(l)?i=Date.parse(a)-Date.now():i=l*1e3}if(!(i&&0<=i&&i<60*1e3)){const l=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,l)}return await nn(i),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const r=t-e,a=Math.min(.5*Math.pow(2,r),8),l=1-Math.random()*.25;return a*l*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Rt}`}}class da{constructor(e,t,n,i){mn.set(this,void 0),Vl(this,mn,e,"f"),this.options=i,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new z("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[i,r]of n)e.url.searchParams.set(i,r);t.query=void 0,t.path=e.url.toString()}return await Jl(this,mn,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(mn=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Xl extends Nn{constructor(e,t,n){super(t,async i=>new n(e,i.response,await ha(i),i.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const ma=s=>new Proxy(Object.fromEntries(s.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),Kl={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ie=s=>typeof s=="object"&&s!==null&&!pa(s)&&Object.keys(s).every(e=>ga(Kl,e)),Gl=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":Dr(Deno.build.os),"X-Stainless-Arch":Ir(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":Dr(process.platform),"X-Stainless-Arch":Ir(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const s=Ql();return s?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${s.browser}`,"X-Stainless-Runtime-Version":s.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Ql(){if(typeof navigator>"u"||!navigator)return null;const s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of s){const n=t.exec(navigator.userAgent);if(n){const i=n[1]||0,r=n[2]||0,a=n[3]||0;return{browser:e,version:`${i}.${r}.${a}`}}}return null}const Ir=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",Dr=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown");let Tr;const Yl=()=>Tr??(Tr=Gl()),Zl=s=>{try{return JSON.parse(s)}catch{return}},eo=/^[a-z][a-z0-9+.-]*:/i,to=s=>eo.test(s),nn=s=>new Promise(e=>setTimeout(e,s)),Zn=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new z(`${s} must be an integer`);if(e<0)throw new z(`${s} must be a positive integer`);return e},ds=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null)try{return new Error(JSON.stringify(s))}catch{}return new Error(s)},pn=s=>{var e,t,n,i,r;if(typeof process<"u")return((t=(e=process.env)==null?void 0:e[s])==null?void 0:t.trim())??void 0;if(typeof Deno<"u")return(r=(i=(n=Deno.env)==null?void 0:n.get)==null?void 0:i.call(n,s))==null?void 0:r.trim()};function pa(s){if(!s)return!0;for(const e in s)return!1;return!0}function ga(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Rr(s,e){for(const t in e){if(!ga(e,t))continue;const n=t.toLowerCase();if(!n)continue;const i=e[t];i===null?delete s[n]:i!==void 0&&(s[n]=i)}}const Mr=new Set(["authorization","api-key"]);function ht(s,...e){var t;if(typeof process<"u"&&((t=process==null?void 0:process.env)==null?void 0:t.DEBUG)==="true"){const n=e.map(i=>{if(!i)return i;if(i.headers){const a={...i,headers:{...i.headers}};for(const l in i.headers)Mr.has(l.toLowerCase())&&(a.headers[l]="REDACTED");return a}let r=null;for(const a in i)Mr.has(a.toLowerCase())&&(r??(r={...i}),r[a]="REDACTED");return r??i});console.log(`OpenAI:DEBUG:${s}`,...n)}}const no=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}),so=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",ro=s=>typeof(s==null?void 0:s.get)=="function",gn=(s,e)=>{var n;const t=e.toLowerCase();if(ro(s)){const i=((n=e[0])==null?void 0:n.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(r,a,l)=>a+l.toUpperCase());for(const r of[e,t,e.toUpperCase(),i]){const a=s.get(r);if(a)return a}}for(const[i,r]of Object.entries(s))if(i.toLowerCase()===t)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${e} header, using the first entry.`),r[0]):r},io=s=>{if(typeof Buffer<"u"){const e=Buffer.from(s,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(s),t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return Array.from(new Float32Array(n.buffer))}};function es(s){return s!=null&&typeof s=="object"&&!Array.isArray(s)}class jn extends da{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class _e extends da{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var n;const e=this.getPaginatedItems();if(!e.length)return null;const t=(n=e[e.length-1])==null?void 0:n.id;return t?{params:{after:t}}:null}}class U{constructor(e){this._client=e}}let _a=class extends U{list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,ao,{query:t,...n})}},zn=class extends U{constructor(){super(...arguments),this.messages=new _a(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/chat/completions",$n,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}};class $n extends _e{}class ao extends _e{}zn.ChatCompletionsPage=$n;zn.Messages=_a;let Un=class extends U{constructor(){super(...arguments),this.completions=new zn(this._client)}};Un.Completions=zn;Un.ChatCompletionsPage=$n;class ba extends U{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class wa extends U{create(e,t){return this._client.post("/audio/transcriptions",kt({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class va extends U{create(e,t){return this._client.post("/audio/translations",kt({body:e,...t,__metadata:{model:e.model}}))}}class sn extends U{constructor(){super(...arguments),this.transcriptions=new wa(this._client),this.translations=new va(this._client),this.speech=new ba(this._client)}}sn.Transcriptions=wa;sn.Translations=va;sn.Speech=ba;class Ps extends U{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/batches",Is,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Is extends _e{}Ps.BatchesPage=Is;var Ue=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},re=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},ms,kn,An,Ut,Wt,Cn,Ht,st,Vt,Tn,Rn,Mt,ya;class Ds{constructor(){ms.add(this),this.controller=new AbortController,kn.set(this,void 0),An.set(this,()=>{}),Ut.set(this,()=>{}),Wt.set(this,void 0),Cn.set(this,()=>{}),Ht.set(this,()=>{}),st.set(this,{}),Vt.set(this,!1),Tn.set(this,!1),Rn.set(this,!1),Mt.set(this,!1),Ue(this,kn,new Promise((e,t)=>{Ue(this,An,e,"f"),Ue(this,Ut,t,"f")}),"f"),Ue(this,Wt,new Promise((e,t)=>{Ue(this,Cn,e,"f"),Ue(this,Ht,t,"f")}),"f"),re(this,kn,"f").catch(()=>{}),re(this,Wt,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},re(this,ms,"m",ya).bind(this))},0)}_connected(){this.ended||(re(this,An,"f").call(this),this._emit("connect"))}get ended(){return re(this,Vt,"f")}get errored(){return re(this,Tn,"f")}get aborted(){return re(this,Rn,"f")}abort(){this.controller.abort()}on(e,t){return(re(this,st,"f")[e]||(re(this,st,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=re(this,st,"f")[e];if(!n)return this;const i=n.findIndex(r=>r.listener===t);return i>=0&&n.splice(i,1),this}once(e,t){return(re(this,st,"f")[e]||(re(this,st,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{Ue(this,Mt,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){Ue(this,Mt,!0,"f"),await re(this,Wt,"f")}_emit(e,...t){if(re(this,Vt,"f"))return;e==="end"&&(Ue(this,Vt,!0,"f"),re(this,Cn,"f").call(this));const n=re(this,st,"f")[e];if(n&&(re(this,st,"f")[e]=n.filter(i=>!i.once),n.forEach(({listener:i})=>i(...t))),e==="abort"){const i=t[0];!re(this,Mt,"f")&&!(n!=null&&n.length)&&Promise.reject(i),re(this,Ut,"f").call(this,i),re(this,Ht,"f").call(this,i),this._emit("end");return}if(e==="error"){const i=t[0];!re(this,Mt,"f")&&!(n!=null&&n.length)&&Promise.reject(i),re(this,Ut,"f").call(this,i),re(this,Ht,"f").call(this,i),this._emit("end")}}_emitFinal(){}}kn=new WeakMap,An=new WeakMap,Ut=new WeakMap,Wt=new WeakMap,Cn=new WeakMap,Ht=new WeakMap,st=new WeakMap,Vt=new WeakMap,Tn=new WeakMap,Rn=new WeakMap,Mt=new WeakMap,ms=new WeakSet,ya=function(e){if(Ue(this,Tn,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new je),e instanceof je)return Ue(this,Rn,!0,"f"),this._emit("abort",e);if(e instanceof z)return this._emit("error",e);if(e instanceof Error){const t=new z(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new z(String(e)))};var L=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},Le=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},ve,ps,Ke,En,We,yt,Ot,vt,Mn,Ne,Pn,In,Gt,Jt,qt,Or,Fr,Br,Lr,xr,Nr,jr;class He extends Ds{constructor(){super(...arguments),ve.add(this),ps.set(this,[]),Ke.set(this,{}),En.set(this,{}),We.set(this,void 0),yt.set(this,void 0),Ot.set(this,void 0),vt.set(this,void 0),Mn.set(this,void 0),Ne.set(this,void 0),Pn.set(this,void 0),In.set(this,void 0),Gt.set(this,void 0)}[(ps=new WeakMap,Ke=new WeakMap,En=new WeakMap,We=new WeakMap,yt=new WeakMap,Ot=new WeakMap,vt=new WeakMap,Mn=new WeakMap,Ne=new WeakMap,Pn=new WeakMap,In=new WeakMap,Gt=new WeakMap,ve=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",i=>{const r=t.shift();r?r.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((r,a)=>t.push({resolve:r,reject:a})).then(r=>r?{value:r,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new He;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var r;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const i=Ge.fromReadableStream(e,this.controller);for await(const a of i)L(this,ve,"m",Jt).call(this,a);if((r=i.controller.signal)!=null&&r.aborted)throw new je;return this._addRun(L(this,ve,"m",qt).call(this))}toReadableStream(){return new Ge(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,i,r){const a=new He;return a._run(()=>a._runToolAssistantStream(e,t,n,i,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,n,i,r){var c;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const l={...i,stream:!0},o=await e.submitToolOutputs(t,n,l,{...r,signal:this.controller.signal});this._connected();for await(const u of o)L(this,ve,"m",Jt).call(this,u);if((c=o.controller.signal)!=null&&c.aborted)throw new je;return this._addRun(L(this,ve,"m",qt).call(this))}static createThreadAssistantStream(e,t,n){const i=new He;return i._run(()=>i._threadAssistantStream(e,t,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}static createAssistantStream(e,t,n,i){const r=new He;return r._run(()=>r._runAssistantStream(e,t,n,{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),r}currentEvent(){return L(this,Pn,"f")}currentRun(){return L(this,In,"f")}currentMessageSnapshot(){return L(this,We,"f")}currentRunStepSnapshot(){return L(this,Gt,"f")}async finalRunSteps(){return await this.done(),Object.values(L(this,Ke,"f"))}async finalMessages(){return await this.done(),Object.values(L(this,En,"f"))}async finalRun(){if(await this.done(),!L(this,yt,"f"))throw Error("Final run was not received.");return L(this,yt,"f")}async _createThreadAssistantStream(e,t,n){var l;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const r={...t,stream:!0},a=await e.createAndRun(r,{...n,signal:this.controller.signal});this._connected();for await(const o of a)L(this,ve,"m",Jt).call(this,o);if((l=a.controller.signal)!=null&&l.aborted)throw new je;return this._addRun(L(this,ve,"m",qt).call(this))}async _createAssistantStream(e,t,n,i){var o;const r=i==null?void 0:i.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},l=await e.create(t,a,{...i,signal:this.controller.signal});this._connected();for await(const c of l)L(this,ve,"m",Jt).call(this,c);if((o=l.controller.signal)!=null&&o.aborted)throw new je;return this._addRun(L(this,ve,"m",qt).call(this))}static accumulateDelta(e,t){for(const[n,i]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=i;continue}let r=e[n];if(r==null){e[n]=i;continue}if(n==="index"||n==="type"){e[n]=i;continue}if(typeof r=="string"&&typeof i=="string")r+=i;else if(typeof r=="number"&&typeof i=="number")r+=i;else if(es(r)&&es(i))r=this.accumulateDelta(r,i);else if(Array.isArray(r)&&Array.isArray(i)){if(r.every(a=>typeof a=="string"||typeof a=="number")){r.push(...i);continue}for(const a of i){if(!es(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const l=a.index;if(l==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof l!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${l}`);const o=r[l];o==null?r.push(a):r[l]=this.accumulateDelta(o,a)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${i}, accValue: ${r}`);e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,i){return await this._createAssistantStream(t,e,n,i)}async _runToolAssistantStream(e,t,n,i,r){return await this._createToolAssistantStream(n,e,t,i,r)}}Jt=function(e){if(!this.ended)switch(Le(this,Pn,e,"f"),L(this,ve,"m",Br).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":L(this,ve,"m",jr).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":L(this,ve,"m",Fr).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":L(this,ve,"m",Or).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},qt=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");if(!L(this,yt,"f"))throw Error("Final run has not been received");return L(this,yt,"f")},Or=function(e){const[t,n]=L(this,ve,"m",xr).call(this,e,L(this,We,"f"));Le(this,We,t,"f"),L(this,En,"f")[t.id]=t;for(const i of n){const r=t.content[i.index];(r==null?void 0:r.type)=="text"&&this._emit("textCreated",r.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const i of e.data.delta.content){if(i.type=="text"&&i.text){let r=i.text,a=t.content[i.index];if(a&&a.type=="text")this._emit("textDelta",r,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(i.index!=L(this,Ot,"f")){if(L(this,vt,"f"))switch(L(this,vt,"f").type){case"text":this._emit("textDone",L(this,vt,"f").text,L(this,We,"f"));break;case"image_file":this._emit("imageFileDone",L(this,vt,"f").image_file,L(this,We,"f"));break}Le(this,Ot,i.index,"f")}Le(this,vt,t.content[i.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(L(this,Ot,"f")!==void 0){const i=e.data.content[L(this,Ot,"f")];if(i)switch(i.type){case"image_file":this._emit("imageFileDone",i.image_file,L(this,We,"f"));break;case"text":this._emit("textDone",i.text,L(this,We,"f"));break}}L(this,We,"f")&&this._emit("messageDone",e.data),Le(this,We,void 0,"f")}},Fr=function(e){const t=L(this,ve,"m",Lr).call(this,e);switch(Le(this,Gt,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&n.step_details.type=="tool_calls"&&n.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const r of n.step_details.tool_calls)r.index==L(this,Mn,"f")?this._emit("toolCallDelta",r,t.step_details.tool_calls[r.index]):(L(this,Ne,"f")&&this._emit("toolCallDone",L(this,Ne,"f")),Le(this,Mn,r.index,"f"),Le(this,Ne,t.step_details.tool_calls[r.index],"f"),L(this,Ne,"f")&&this._emit("toolCallCreated",L(this,Ne,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Le(this,Gt,void 0,"f"),e.data.step_details.type=="tool_calls"&&L(this,Ne,"f")&&(this._emit("toolCallDone",L(this,Ne,"f")),Le(this,Ne,void 0,"f")),this._emit("runStepDone",e.data,t);break}},Br=function(e){L(this,ps,"f").push(e),this._emit("event",e)},Lr=function(e){switch(e.event){case"thread.run.step.created":return L(this,Ke,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=L(this,Ke,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const i=He.accumulateDelta(t,n.delta);L(this,Ke,"f")[e.data.id]=i}return L(this,Ke,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":L(this,Ke,"f")[e.data.id]=e.data;break}if(L(this,Ke,"f")[e.data.id])return L(this,Ke,"f")[e.data.id];throw new Error("No snapshot available")},xr=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let i=e.data;if(i.delta.content)for(const r of i.delta.content)if(r.index in t.content){let a=t.content[r.index];t.content[r.index]=L(this,ve,"m",Nr).call(this,r,a)}else t.content[r.index]=r,n.push(r);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Nr=function(e,t){return He.accumulateDelta(t,e)},jr=function(e){switch(Le(this,In,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Le(this,yt,e.data,"f"),L(this,Ne,"f")&&(this._emit("toolCallDone",L(this,Ne,"f")),Le(this,Ne,void 0,"f"));break}};class Ts extends U{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/assistants",Rs,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Rs extends _e{}Ts.AssistantsPage=Rs;function zr(s){return typeof s.parse=="function"}const Bt=s=>(s==null?void 0:s.role)==="assistant",Sa=s=>(s==null?void 0:s.role)==="function",ka=s=>(s==null?void 0:s.role)==="tool";function Ms(s){return(s==null?void 0:s.$brand)==="auto-parseable-response-format"}function rn(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function lo(s,e){return!e||!Aa(e)?{...s,choices:s.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:Os(s,e)}function Os(s,e){const t=s.choices.map(n=>{var i;if(n.finish_reason==="length")throw new ia;if(n.finish_reason==="content_filter")throw new aa;return{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:((i=n.message.tool_calls)==null?void 0:i.map(r=>co(e,r)))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?oo(e,n.message.content):null}}});return{...s,choices:t}}function oo(s,e){var t,n;return((t=s.response_format)==null?void 0:t.type)!=="json_schema"?null:((n=s.response_format)==null?void 0:n.type)==="json_schema"?"$parseRaw"in s.response_format?s.response_format.$parseRaw(e):JSON.parse(e):null}function co(s,e){var n;const t=(n=s.tools)==null?void 0:n.find(i=>{var r;return((r=i.function)==null?void 0:r.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:rn(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function uo(s,e){var n;if(!s)return!1;const t=(n=s.tools)==null?void 0:n.find(i=>{var r;return((r=i.function)==null?void 0:r.name)===e.function.name});return rn(t)||(t==null?void 0:t.function.strict)||!1}function Aa(s){var e;return Ms(s.response_format)?!0:((e=s.tools)==null?void 0:e.some(t=>rn(t)||t.type==="function"&&t.function.strict===!0))??!1}function ho(s){for(const e of s??[]){if(e.type!=="function")throw new z(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new z(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Te=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},Se,gs,On,_s,bs,ws,Ca,vs;const $r=10;class Ea extends Ds{constructor(){super(...arguments),Se.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var n;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(n=e.choices[0])==null?void 0:n.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Sa(e)||ka(e))&&e.content)this._emit("functionCallResult",e.content);else if(Bt(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Bt(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionCall",n.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new z("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Te(this,Se,"m",gs).call(this)}async finalMessage(){return await this.done(),Te(this,Se,"m",On).call(this)}async finalFunctionCall(){return await this.done(),Te(this,Se,"m",_s).call(this)}async finalFunctionCallResult(){return await this.done(),Te(this,Se,"m",bs).call(this)}async totalUsage(){return await this.done(),Te(this,Se,"m",ws).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Te(this,Se,"m",On).call(this);t&&this._emit("finalMessage",t);const n=Te(this,Se,"m",gs).call(this);n&&this._emit("finalContent",n);const i=Te(this,Se,"m",_s).call(this);i&&this._emit("finalFunctionCall",i);const r=Te(this,Se,"m",bs).call(this);r!=null&&this._emit("finalFunctionCallResult",r),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",Te(this,Se,"m",ws).call(this))}async _createChatCompletion(e,t,n){const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),Te(this,Se,"m",Ca).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Os(r,t))}async _runChatCompletion(e,t,n){for(const i of t.messages)this._addMessage(i,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){var f;const i="function",{function_call:r="auto",stream:a,...l}=t,o=typeof r!="string"&&(r==null?void 0:r.name),{maxChatCompletions:c=$r}=n||{},u={};for(const m of t.functions)u[m.name||m.function.name]=m;const h=t.functions.map(m=>({name:m.name||m.function.name,parameters:m.parameters,description:m.description}));for(const m of t.messages)this._addMessage(m,!1);for(let m=0;m<c;++m){const _=(f=(await this._createChatCompletion(e,{...l,function_call:r,functions:h,messages:[...this.messages]},n)).choices[0])==null?void 0:f.message;if(!_)throw new z("missing message in ChatCompletion response");if(!_.function_call)return;const{name:b,arguments:y}=_.function_call,v=u[b];if(v){if(o&&o!==b){const A=`Invalid function_call: ${JSON.stringify(b)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:i,name:b,content:A});continue}}else{const A=`Invalid function_call: ${JSON.stringify(b)}. Available options are: ${h.map(k=>JSON.stringify(k.name)).join(", ")}. Please try again`;this._addMessage({role:i,name:b,content:A});continue}let C;try{C=zr(v)?await v.parse(y):y}catch(A){this._addMessage({role:i,name:b,content:A instanceof Error?A.message:String(A)});continue}const S=await v.function(C,this),P=Te(this,Se,"m",vs).call(this,S);if(this._addMessage({role:i,name:b,content:P}),o)return}}async _runTools(e,t,n){var m,p,_;const i="tool",{tool_choice:r="auto",stream:a,...l}=t,o=typeof r!="string"&&((m=r==null?void 0:r.function)==null?void 0:m.name),{maxChatCompletions:c=$r}=n||{},u=t.tools.map(b=>{if(rn(b)){if(!b.$callback)throw new z("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:b.$callback,name:b.function.name,description:b.function.description||"",parameters:b.function.parameters,parse:b.$parseRaw,strict:!0}}}return b}),h={};for(const b of u)b.type==="function"&&(h[b.function.name||b.function.function.name]=b.function);const f="tools"in t?u.map(b=>b.type==="function"?{type:"function",function:{name:b.function.name||b.function.function.name,parameters:b.function.parameters,description:b.function.description,strict:b.function.strict}}:b):void 0;for(const b of t.messages)this._addMessage(b,!1);for(let b=0;b<c;++b){const v=(p=(await this._createChatCompletion(e,{...l,tool_choice:r,tools:f,messages:[...this.messages]},n)).choices[0])==null?void 0:p.message;if(!v)throw new z("missing message in ChatCompletion response");if(!((_=v.tool_calls)!=null&&_.length))return;for(const C of v.tool_calls){if(C.type!=="function")continue;const S=C.id,{name:P,arguments:A}=C.function,k=h[P];if(k){if(o&&o!==P){const D=`Invalid tool_call: ${JSON.stringify(P)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:i,tool_call_id:S,content:D});continue}}else{const D=`Invalid tool_call: ${JSON.stringify(P)}. Available options are: ${Object.keys(h).map(R=>JSON.stringify(R)).join(", ")}. Please try again`;this._addMessage({role:i,tool_call_id:S,content:D});continue}let M;try{M=zr(k)?await k.parse(A):A}catch(D){const R=D instanceof Error?D.message:String(D);this._addMessage({role:i,tool_call_id:S,content:R});continue}const T=await k.function(M,this),F=Te(this,Se,"m",vs).call(this,T);if(this._addMessage({role:i,tool_call_id:S,content:F}),o)return}}}}Se=new WeakSet,gs=function(){return Te(this,Se,"m",On).call(this).content??null},On=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Bt(t)){const{function_call:n,...i}=t,r={...i,content:t.content??null,refusal:t.refusal??null};return n&&(r.function_call=n),r}}throw new z("stream ended without producing a ChatCompletionMessage with role=assistant")},_s=function(){var e,t;for(let n=this.messages.length-1;n>=0;n--){const i=this.messages[n];if(Bt(i)&&(i!=null&&i.function_call))return i.function_call;if(Bt(i)&&((e=i==null?void 0:i.tool_calls)!=null&&e.length))return(t=i.tool_calls.at(-1))==null?void 0:t.function}},bs=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Sa(t)&&t.content!=null||ka(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(n=>{var i;return n.role==="assistant"&&((i=n.tool_calls)==null?void 0:i.some(r=>r.type==="function"&&r.id===t.tool_call_id))}))return t.content}},ws=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Ca=function(e){if(e.n!=null&&e.n>1)throw new z("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},vs=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Zt extends Ea{static runFunctions(e,t,n){const i=new Zt,r={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runFunctions"}};return i._run(()=>i._runFunctions(e,t,r)),i}static runTools(e,t,n){const i=new Zt,r={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,r)),i}_addMessage(e,t=!0){super._addMessage(e,t),Bt(e)&&e.content&&this._emit("content",e.content)}}const Pa=1,Ia=2,Da=4,Ta=8,Ra=16,Ma=32,Oa=64,Fa=128,Ba=256,La=Fa|Ba,xa=Ra|Ma|La|Oa,Na=Pa|Ia|xa,ja=Da|Ta,fo=Na|ja,we={STR:Pa,NUM:Ia,ARR:Da,OBJ:Ta,NULL:Ra,BOOL:Ma,NAN:Oa,INFINITY:Fa,MINUS_INFINITY:Ba,INF:La,SPECIAL:xa,ATOM:Na,COLLECTION:ja,ALL:fo};class mo extends Error{}class po extends Error{}function go(s,e=we.ALL){if(typeof s!="string")throw new TypeError(`expecting str, got ${typeof s}`);if(!s.trim())throw new Error(`${s} is empty`);return _o(s.trim(),e)}const _o=(s,e)=>{const t=s.length;let n=0;const i=f=>{throw new mo(`${f} at position ${n}`)},r=f=>{throw new po(`${f} at position ${n}`)},a=()=>(h(),n>=t&&i("Unexpected end of input"),s[n]==='"'?l():s[n]==="{"?o():s[n]==="["?c():s.substring(n,n+4)==="null"||we.NULL&e&&t-n<4&&"null".startsWith(s.substring(n))?(n+=4,null):s.substring(n,n+4)==="true"||we.BOOL&e&&t-n<4&&"true".startsWith(s.substring(n))?(n+=4,!0):s.substring(n,n+5)==="false"||we.BOOL&e&&t-n<5&&"false".startsWith(s.substring(n))?(n+=5,!1):s.substring(n,n+8)==="Infinity"||we.INFINITY&e&&t-n<8&&"Infinity".startsWith(s.substring(n))?(n+=8,1/0):s.substring(n,n+9)==="-Infinity"||we.MINUS_INFINITY&e&&1<t-n&&t-n<9&&"-Infinity".startsWith(s.substring(n))?(n+=9,-1/0):s.substring(n,n+3)==="NaN"||we.NAN&e&&t-n<3&&"NaN".startsWith(s.substring(n))?(n+=3,NaN):u()),l=()=>{const f=n;let m=!1;for(n++;n<t&&(s[n]!=='"'||m&&s[n-1]==="\\");)m=s[n]==="\\"?!m:!1,n++;if(s.charAt(n)=='"')try{return JSON.parse(s.substring(f,++n-Number(m)))}catch(p){r(String(p))}else if(we.STR&e)try{return JSON.parse(s.substring(f,n-Number(m))+'"')}catch{return JSON.parse(s.substring(f,s.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},o=()=>{n++,h();const f={};try{for(;s[n]!=="}";){if(h(),n>=t&&we.OBJ&e)return f;const m=l();h(),n++;try{const p=a();Object.defineProperty(f,m,{value:p,writable:!0,enumerable:!0,configurable:!0})}catch(p){if(we.OBJ&e)return f;throw p}h(),s[n]===","&&n++}}catch{if(we.OBJ&e)return f;i("Expected '}' at end of object")}return n++,f},c=()=>{n++;const f=[];try{for(;s[n]!=="]";)f.push(a()),h(),s[n]===","&&n++}catch{if(we.ARR&e)return f;i("Expected ']' at end of array")}return n++,f},u=()=>{if(n===0){s==="-"&&we.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(s)}catch(m){if(we.NUM&e)try{return s[s.length-1]==="."?JSON.parse(s.substring(0,s.lastIndexOf("."))):JSON.parse(s.substring(0,s.lastIndexOf("e")))}catch{}r(String(m))}}const f=n;for(s[n]==="-"&&n++;s[n]&&!",]}".includes(s[n]);)n++;n==t&&!(we.NUM&e)&&i("Unterminated number literal");try{return JSON.parse(s.substring(f,n))}catch{s.substring(f,n)==="-"&&we.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(s.substring(f,s.lastIndexOf("e")))}catch(p){r(String(p))}}},h=()=>{for(;n<t&&` 
\r	`.includes(s[n]);)n++};return a()},Ur=s=>go(s,we.ALL^we.NUM);var Et=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},Z=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},me,nt,Pt,ot,ts,_n,ns,ss,rs,bn,is,Wr;class en extends Ea{constructor(e){super(),me.add(this),nt.set(this,void 0),Pt.set(this,void 0),ot.set(this,void 0),Et(this,nt,e,"f"),Et(this,Pt,[],"f")}get currentChatCompletionSnapshot(){return Z(this,ot,"f")}static fromReadableStream(e){const t=new en(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const i=new en(t);return i._run(()=>i._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createChatCompletion(e,t,n){var a;super._createChatCompletion;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),Z(this,me,"m",ts).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const l of r)Z(this,me,"m",ns).call(this,l);if((a=r.controller.signal)!=null&&a.aborted)throw new je;return this._addChatCompletion(Z(this,me,"m",bn).call(this))}async _fromReadableStream(e,t){var a;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),Z(this,me,"m",ts).call(this),this._connected();const i=Ge.fromReadableStream(e,this.controller);let r;for await(const l of i)r&&r!==l.id&&this._addChatCompletion(Z(this,me,"m",bn).call(this)),Z(this,me,"m",ns).call(this,l),r=l.id;if((a=i.controller.signal)!=null&&a.aborted)throw new je;return this._addChatCompletion(Z(this,me,"m",bn).call(this))}[(nt=new WeakMap,Pt=new WeakMap,ot=new WeakMap,me=new WeakSet,ts=function(){this.ended||Et(this,ot,void 0,"f")},_n=function(t){let n=Z(this,Pt,"f")[t.index];return n||(n={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Z(this,Pt,"f")[t.index]=n,n)},ns=function(t){var i,r,a,l,o,c,u,h,f,m,p,_,b,y,v;if(this.ended)return;const n=Z(this,me,"m",Wr).call(this,t);this._emit("chunk",t,n);for(const C of t.choices){const S=n.choices[C.index];C.delta.content!=null&&((i=S.message)==null?void 0:i.role)==="assistant"&&((r=S.message)!=null&&r.content)&&(this._emit("content",C.delta.content,S.message.content),this._emit("content.delta",{delta:C.delta.content,snapshot:S.message.content,parsed:S.message.parsed})),C.delta.refusal!=null&&((a=S.message)==null?void 0:a.role)==="assistant"&&((l=S.message)!=null&&l.refusal)&&this._emit("refusal.delta",{delta:C.delta.refusal,snapshot:S.message.refusal}),((o=C.logprobs)==null?void 0:o.content)!=null&&((c=S.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(u=C.logprobs)==null?void 0:u.content,snapshot:((h=S.logprobs)==null?void 0:h.content)??[]}),((f=C.logprobs)==null?void 0:f.refusal)!=null&&((m=S.message)==null?void 0:m.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(p=C.logprobs)==null?void 0:p.refusal,snapshot:((_=S.logprobs)==null?void 0:_.refusal)??[]});const P=Z(this,me,"m",_n).call(this,S);S.finish_reason&&(Z(this,me,"m",rs).call(this,S),P.current_tool_call_index!=null&&Z(this,me,"m",ss).call(this,S,P.current_tool_call_index));for(const A of C.delta.tool_calls??[])P.current_tool_call_index!==A.index&&(Z(this,me,"m",rs).call(this,S),P.current_tool_call_index!=null&&Z(this,me,"m",ss).call(this,S,P.current_tool_call_index)),P.current_tool_call_index=A.index;for(const A of C.delta.tool_calls??[]){const k=(b=S.message.tool_calls)==null?void 0:b[A.index];k!=null&&k.type&&((k==null?void 0:k.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(y=k.function)==null?void 0:y.name,index:A.index,arguments:k.function.arguments,parsed_arguments:k.function.parsed_arguments,arguments_delta:((v=A.function)==null?void 0:v.arguments)??""}):(k==null||k.type,void 0))}}},ss=function(t,n){var a,l,o;if(Z(this,me,"m",_n).call(this,t).done_tool_calls.has(n))return;const r=(a=t.message.tool_calls)==null?void 0:a[n];if(!r)throw new Error("no tool call snapshot");if(!r.type)throw new Error("tool call snapshot missing `type`");if(r.type==="function"){const c=(o=(l=Z(this,nt,"f"))==null?void 0:l.tools)==null?void 0:o.find(u=>u.type==="function"&&u.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:n,arguments:r.function.arguments,parsed_arguments:rn(c)?c.$parseRaw(r.function.arguments):c!=null&&c.function.strict?JSON.parse(r.function.arguments):null})}else r.type},rs=function(t){var i,r;const n=Z(this,me,"m",_n).call(this,t);if(t.message.content&&!n.content_done){n.content_done=!0;const a=Z(this,me,"m",is).call(this);this._emit("content.done",{content:t.message.content,parsed:a?a.$parseRaw(t.message.content):null})}t.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(i=t.logprobs)!=null&&i.content&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(r=t.logprobs)!=null&&r.refusal&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},bn=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");const t=Z(this,ot,"f");if(!t)throw new z("request ended without sending any chunks");return Et(this,ot,void 0,"f"),Et(this,Pt,[],"f"),bo(t,Z(this,nt,"f"))},is=function(){var n;const t=(n=Z(this,nt,"f"))==null?void 0:n.response_format;return Ms(t)?t:null},Wr=function(t){var n,i,r,a;let l=Z(this,ot,"f");const{choices:o,...c}=t;l?Object.assign(l,c):l=Et(this,ot,{...c,choices:[]},"f");for(const{delta:u,finish_reason:h,index:f,logprobs:m=null,...p}of t.choices){let _=l.choices[f];if(_||(_=l.choices[f]={finish_reason:h,index:f,message:{},logprobs:m,...p}),m)if(!_.logprobs)_.logprobs=Object.assign({},m);else{const{content:A,refusal:k,...M}=m;Object.assign(_.logprobs,M),A&&((n=_.logprobs).content??(n.content=[]),_.logprobs.content.push(...A)),k&&((i=_.logprobs).refusal??(i.refusal=[]),_.logprobs.refusal.push(...k))}if(h&&(_.finish_reason=h,Z(this,nt,"f")&&Aa(Z(this,nt,"f")))){if(h==="length")throw new ia;if(h==="content_filter")throw new aa}if(Object.assign(_,p),!u)continue;const{content:b,refusal:y,function_call:v,role:C,tool_calls:S,...P}=u;if(Object.assign(_.message,P),y&&(_.message.refusal=(_.message.refusal||"")+y),C&&(_.message.role=C),v&&(_.message.function_call?(v.name&&(_.message.function_call.name=v.name),v.arguments&&((r=_.message.function_call).arguments??(r.arguments=""),_.message.function_call.arguments+=v.arguments)):_.message.function_call=v),b&&(_.message.content=(_.message.content||"")+b,!_.message.refusal&&Z(this,me,"m",is).call(this)&&(_.message.parsed=Ur(_.message.content))),S){_.message.tool_calls||(_.message.tool_calls=[]);for(const{index:A,id:k,type:M,function:T,...F}of S){const D=(a=_.message.tool_calls)[A]??(a[A]={});Object.assign(D,F),k&&(D.id=k),M&&(D.type=M),T&&(D.function??(D.function={name:T.name??"",arguments:""})),T!=null&&T.name&&(D.function.name=T.name),T!=null&&T.arguments&&(D.function.arguments+=T.arguments,uo(Z(this,nt,"f"),D)&&(D.function.parsed_arguments=Ur(D.function.arguments)))}}}return l},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",i=>{const r=t.shift();r?r.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((r,a)=>t.push({resolve:r,reject:a})).then(r=>r?{value:r,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ge(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function bo(s,e){const{id:t,choices:n,created:i,model:r,system_fingerprint:a,...l}=s,o={...l,id:t,choices:n.map(({message:c,finish_reason:u,index:h,logprobs:f,...m})=>{if(!u)throw new z(`missing finish_reason for choice ${h}`);const{content:p=null,function_call:_,tool_calls:b,...y}=c,v=c.role;if(!v)throw new z(`missing role for choice ${h}`);if(_){const{arguments:C,name:S}=_;if(C==null)throw new z(`missing function_call.arguments for choice ${h}`);if(!S)throw new z(`missing function_call.name for choice ${h}`);return{...m,message:{content:p,function_call:{arguments:C,name:S},role:v,refusal:c.refusal??null},finish_reason:u,index:h,logprobs:f}}return b?{...m,index:h,finish_reason:u,logprobs:f,message:{...y,role:v,content:p,refusal:c.refusal??null,tool_calls:b.map((C,S)=>{const{function:P,type:A,id:k,...M}=C,{arguments:T,name:F,...D}=P||{};if(k==null)throw new z(`missing choices[${h}].tool_calls[${S}].id
${wn(s)}`);if(A==null)throw new z(`missing choices[${h}].tool_calls[${S}].type
${wn(s)}`);if(F==null)throw new z(`missing choices[${h}].tool_calls[${S}].function.name
${wn(s)}`);if(T==null)throw new z(`missing choices[${h}].tool_calls[${S}].function.arguments
${wn(s)}`);return{...M,id:k,type:A,function:{...D,name:F,arguments:T}}})}}:{...m,message:{...y,content:p,role:v,refusal:c.refusal??null},finish_reason:u,index:h,logprobs:f}}),created:i,model:r,object:"chat.completion",...a?{system_fingerprint:a}:{}};return lo(o,e)}function wn(s){return JSON.stringify(s)}class Lt extends en{static fromReadableStream(e){const t=new Lt(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,n){const i=new Lt(null),r={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runFunctions"}};return i._run(()=>i._runFunctions(e,t,r)),i}static runTools(e,t,n){const i=new Lt(t),r={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,r)),i}}let za=class extends U{parse(e,t){return ho(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(n=>Os(n,e))}runFunctions(e,t){return e.stream?Lt.runFunctions(this._client,e,t):Zt.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Lt.runTools(this._client,e,t):Zt.runTools(this._client,e,t)}stream(e,t){return en.createChatCompletion(this._client,e,t)}};class ys extends U{constructor(){super(...arguments),this.completions=new za(this._client)}}(function(s){s.Completions=za})(ys||(ys={}));class $a extends U{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Ua extends U{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Wn extends U{constructor(){super(...arguments),this.sessions=new $a(this._client),this.transcriptionSessions=new Ua(this._client)}}Wn.Sessions=$a;Wn.TranscriptionSessions=Ua;class Fs extends U{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,t,n,i){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Bs,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class Bs extends _e{}Fs.MessagesPage=Bs;class Ls extends U{retrieve(e,t,n,i={},r){return ie(i)?this.retrieve(e,t,n,{},i):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:i,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e,t,n={},i){return ie(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,xs,{query:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}}class xs extends _e{}Ls.RunStepsPage=xs;let an=class extends U{constructor(){super(...arguments),this.steps=new Ls(this._client)}create(e,t,n){const{include:i,...r}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:i},body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,t,n,i){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Ns,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}async createAndPoll(e,t,n){const i=await this.create(e,t,n);return await this.poll(e,i.id,n)}createAndStream(e,t,n){return He.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const i={...n==null?void 0:n.headers,"X-Stainless-Poll-Helper":"true"};for(n!=null&&n.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:a}=await this.retrieve(e,t,{...n,headers:{...n==null?void 0:n.headers,...i}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let l=5e3;if(n!=null&&n.pollIntervalMs)l=n.pollIntervalMs;else{const o=a.headers.get("openai-poll-after-ms");if(o){const c=parseInt(o);isNaN(c)||(l=c)}}await nn(l);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,n){return He.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,i){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,i){const r=await this.submitToolOutputs(e,t,n,i);return await this.poll(e,r.id,i)}submitToolOutputsStream(e,t,n,i){return He.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,i)}};class Ns extends _e{}an.RunsPage=Ns;an.Steps=Ls;an.RunStepsPage=xs;class xt extends U{constructor(){super(...arguments),this.runs=new an(this._client),this.messages=new Fs(this._client)}create(e={},t){return ie(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return He.createThreadAssistantStream(e,this._client.beta.threads,t)}}xt.Runs=an;xt.RunsPage=Ns;xt.Messages=Fs;xt.MessagesPage=Bs;class Nt extends U{constructor(){super(...arguments),this.realtime=new Wn(this._client),this.chat=new ys(this._client),this.assistants=new Ts(this._client),this.threads=new xt(this._client)}}Nt.Realtime=Wn;Nt.Assistants=Ts;Nt.AssistantsPage=Rs;Nt.Threads=xt;class Wa extends U{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Ha extends U{retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}/content`,{...n,headers:{Accept:"application/binary",...n==null?void 0:n.headers},__binaryResponse:!0})}}let Hn=class extends U{constructor(){super(...arguments),this.content=new Ha(this._client)}create(e,t,n){return this._client.post(`/containers/${e}/files`,kt({body:t,...n}))}retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}`,n)}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,js,{query:t,...n})}del(e,t,n){return this._client.delete(`/containers/${e}/files/${t}`,{...n,headers:{Accept:"*/*",...n==null?void 0:n.headers}})}};class js extends _e{}Hn.FileListResponsesPage=js;Hn.Content=Ha;class ln extends U{constructor(){super(...arguments),this.files=new Hn(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/containers",zs,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}}class zs extends _e{}ln.ContainerListResponsesPage=zs;ln.Files=Hn;ln.FileListResponsesPage=js;class Va extends U{create(e,t){const n=!!e.encoding_format;let i=n?e.encoding_format:"base64";n&&ht("Request","User defined encoding_format:",e.encoding_format);const r=this._client.post("/embeddings",{body:{...e,encoding_format:i},...t});return n?r:(ht("response","Decoding base64 embeddings to float32 array"),r._thenUnwrap(a=>(a&&a.data&&a.data.forEach(l=>{const o=l.embedding;l.embedding=io(o)}),a)))}}class $s extends U{retrieve(e,t,n,i){return this._client.get(`/evals/${e}/runs/${t}/output_items/${n}`,i)}list(e,t,n={},i){return ie(n)?this.list(e,t,{},n):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Us,{query:n,...i})}}class Us extends _e{}$s.OutputItemListResponsesPage=Us;class on extends U{constructor(){super(...arguments),this.outputItems=new $s(this._client)}create(e,t,n){return this._client.post(`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){return this._client.get(`/evals/${e}/runs/${t}`,n)}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,Ws,{query:t,...n})}del(e,t,n){return this._client.delete(`/evals/${e}/runs/${t}`,n)}cancel(e,t,n){return this._client.post(`/evals/${e}/runs/${t}`,n)}}class Ws extends _e{}on.RunListResponsesPage=Ws;on.OutputItems=$s;on.OutputItemListResponsesPage=Us;class cn extends U{constructor(){super(...arguments),this.runs=new on(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,n){return this._client.post(`/evals/${e}`,{body:t,...n})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/evals",Hs,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class Hs extends _e{}cn.EvalListResponsesPage=Hs;cn.Runs=on;cn.RunListResponsesPage=Ws;let Vs=class extends U{create(e,t){return this._client.post("/files",kt({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/files",Js,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=30*60*1e3}={}){const i=new Set(["processed","error","deleted"]),r=Date.now();let a=await this.retrieve(e);for(;!a.status||!i.has(a.status);)if(await nn(t),a=await this.retrieve(e),Date.now()-r>n)throw new Es({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}};class Js extends _e{}Vs.FileObjectsPage=Js;class Ja extends U{}let qa=class extends U{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class qs extends U{constructor(){super(...arguments),this.graders=new qa(this._client)}}qs.Graders=qa;class Xs extends U{create(e,t,n){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,Ks,{body:t,method:"post",...n})}retrieve(e,t={},n){return ie(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}del(e,t,n){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,n)}}class Ks extends jn{}Xs.PermissionCreateResponsesPage=Ks;let Vn=class extends U{constructor(){super(...arguments),this.permissions=new Xs(this._client)}};Vn.Permissions=Xs;Vn.PermissionCreateResponsesPage=Ks;class Gs extends U{list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Qs,{query:t,...n})}}class Qs extends _e{}Gs.FineTuningJobCheckpointsPage=Qs;class jt extends U{constructor(){super(...arguments),this.checkpoints=new Gs(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Ys,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return ie(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Zs,{query:t,...n})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class Ys extends _e{}class Zs extends _e{}jt.FineTuningJobsPage=Ys;jt.FineTuningJobEventsPage=Zs;jt.Checkpoints=Gs;jt.FineTuningJobCheckpointsPage=Qs;class ft extends U{constructor(){super(...arguments),this.methods=new Ja(this._client),this.jobs=new jt(this._client),this.checkpoints=new Vn(this._client),this.alpha=new qs(this._client)}}ft.Methods=Ja;ft.Jobs=jt;ft.FineTuningJobsPage=Ys;ft.FineTuningJobEventsPage=Zs;ft.Checkpoints=Vn;ft.Alpha=qs;class Xa extends U{}class er extends U{constructor(){super(...arguments),this.graderModels=new Xa(this._client)}}er.GraderModels=Xa;class Ka extends U{createVariation(e,t){return this._client.post("/images/variations",kt({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",kt({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class tr extends U{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",nr,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class nr extends jn{}tr.ModelsPage=nr;class Ga extends U{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function wo(s,e){return!e||!yo(e)?{...s,output_parsed:null,output:s.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(n=>({...n,parsed:null}))}:t)}:Qa(s,e)}function Qa(s,e){const t=s.output.map(i=>{if(i.type==="function_call")return{...i,parsed_arguments:Ao(e,i)};if(i.type==="message"){const r=i.content.map(a=>a.type==="output_text"?{...a,parsed:vo(e,a.text)}:a);return{...i,content:r}}return i}),n=Object.assign({},s,{output:t});return Object.getOwnPropertyDescriptor(s,"output_text")||Ya(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const i of n.output)if(i.type==="message"){for(const r of i.content)if(r.type==="output_text"&&r.parsed!==null)return r.parsed}return null}}),n}function vo(s,e){var t,n,i,r;return((n=(t=s.text)==null?void 0:t.format)==null?void 0:n.type)!=="json_schema"?null:"$parseRaw"in((i=s.text)==null?void 0:i.format)?((r=s.text)==null?void 0:r.format).$parseRaw(e):JSON.parse(e)}function yo(s){var e;return!!Ms((e=s.text)==null?void 0:e.format)}function So(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function ko(s,e){return s.find(t=>t.type==="function"&&t.name===e)}function Ao(s,e){const t=ko(s.tools??[],e.name);return{...e,...e,parsed_arguments:So(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function Ya(s){const e=[];for(const t of s.output)if(t.type==="message")for(const n of t.content)n.type==="output_text"&&e.push(n.text);s.output_text=e.join("")}class Za extends U{list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Eo,{query:t,...n})}}var It=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},ct=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},Dt,vn,ut,yn,Hr,Vr,Jr,qr;class sr extends Ds{constructor(e){super(),Dt.add(this),vn.set(this,void 0),ut.set(this,void 0),yn.set(this,void 0),It(this,vn,e,"f")}static createResponse(e,t,n){const i=new sr(t);return i._run(()=>i._createOrRetrieveResponse(e,t,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createOrRetrieveResponse(e,t,n){var l;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),ct(this,Dt,"m",Hr).call(this);let r,a=null;"response_id"in t?(r=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):r=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const o of r)ct(this,Dt,"m",Vr).call(this,o,a);if((l=r.controller.signal)!=null&&l.aborted)throw new je;return ct(this,Dt,"m",Jr).call(this)}[(vn=new WeakMap,ut=new WeakMap,yn=new WeakMap,Dt=new WeakSet,Hr=function(){this.ended||It(this,ut,void 0,"f")},Vr=function(t,n){if(this.ended)return;const i=(a,l)=>{(n==null||l.sequence_number>n)&&this._emit(a,l)},r=ct(this,Dt,"m",qr).call(this,t);switch(i("event",t),t.type){case"response.output_text.delta":{const a=r.output[t.output_index];if(!a)throw new z(`missing output at index ${t.output_index}`);if(a.type==="message"){const l=a.content[t.content_index];if(!l)throw new z(`missing content at index ${t.content_index}`);if(l.type!=="output_text")throw new z(`expected content to be 'output_text', got ${l.type}`);i("response.output_text.delta",{...t,snapshot:l.text})}break}case"response.function_call_arguments.delta":{const a=r.output[t.output_index];if(!a)throw new z(`missing output at index ${t.output_index}`);a.type==="function_call"&&i("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:i(t.type,t);break}},Jr=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");const t=ct(this,ut,"f");if(!t)throw new z("request ended without sending any events");It(this,ut,void 0,"f");const n=Co(t,ct(this,vn,"f"));return It(this,yn,n,"f"),n},qr=function(t){let n=ct(this,ut,"f");if(!n){if(t.type!=="response.created")throw new z(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return n=It(this,ut,t.response,"f"),n}switch(t.type){case"response.output_item.added":{n.output.push(t.item);break}case"response.content_part.added":{const i=n.output[t.output_index];if(!i)throw new z(`missing output at index ${t.output_index}`);i.type==="message"&&i.content.push(t.part);break}case"response.output_text.delta":{const i=n.output[t.output_index];if(!i)throw new z(`missing output at index ${t.output_index}`);if(i.type==="message"){const r=i.content[t.content_index];if(!r)throw new z(`missing content at index ${t.content_index}`);if(r.type!=="output_text")throw new z(`expected content to be 'output_text', got ${r.type}`);r.text+=t.delta}break}case"response.function_call_arguments.delta":{const i=n.output[t.output_index];if(!i)throw new z(`missing output at index ${t.output_index}`);i.type==="function_call"&&(i.arguments+=t.delta);break}case"response.completed":{It(this,ut,t.response,"f");break}}return n},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",i=>{const r=t.shift();r?r.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((r,a)=>t.push({resolve:r,reject:a})).then(r=>r?{value:r,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=ct(this,yn,"f");if(!e)throw new z("stream ended without producing a ChatCompletion");return e}}function Co(s,e){return wo(s,e)}class rr extends U{constructor(){super(...arguments),this.inputItems=new Za(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&Ya(n),n))}retrieve(e,t={},n){return this._client.get(`/responses/${e}`,{query:t,...n,stream:(t==null?void 0:t.stream)??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(n=>Qa(n,e))}stream(e,t){return sr.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}}class Eo extends _e{}rr.InputItems=Za;class el extends U{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,kt({body:t,...n}))}}class ir extends U{constructor(){super(...arguments),this.parts=new el(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}ir.Parts=el;const Po=async s=>{const e=await Promise.allSettled(s),t=e.filter(i=>i.status==="rejected");if(t.length){for(const i of t)console.error(i.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const n=[];for(const i of e)i.status==="fulfilled"&&n.push(i.value);return n};class Jn extends U{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,t,n,i){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,qn,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}async createAndPoll(e,t,n){const i=await this.create(e,t,n);return await this.poll(e,i.id,n)}async poll(e,t,n){const i={...n==null?void 0:n.headers,"X-Stainless-Poll-Helper":"true"};for(n!=null&&n.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const r=await this.retrieve(e,t,{...n,headers:i}).withResponse(),a=r.data;switch(a.status){case"in_progress":let l=5e3;if(n!=null&&n.pollIntervalMs)l=n.pollIntervalMs;else{const o=r.response.headers.get("openai-poll-after-ms");if(o){const c=parseInt(o);isNaN(c)||(l=c)}}await nn(l);break;case"failed":case"completed":return a}}}async upload(e,t,n){const i=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:i.id},n)}async uploadAndPoll(e,t,n){const i=await this.upload(e,t,n);return await this.poll(e,i.id,n)}content(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,ar,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class qn extends _e{}class ar extends jn{}Jn.VectorStoreFilesPage=qn;Jn.FileContentResponsesPage=ar;class tl extends U{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}async createAndPoll(e,t,n){const i=await this.create(e,t);return await this.poll(e,i.id,n)}listFiles(e,t,n={},i){return ie(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,qn,{query:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}async poll(e,t,n){const i={...n==null?void 0:n.headers,"X-Stainless-Poll-Helper":"true"};for(n!=null&&n.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:a}=await this.retrieve(e,t,{...n,headers:i}).withResponse();switch(r.status){case"in_progress":let l=5e3;if(n!=null&&n.pollIntervalMs)l=n.pollIntervalMs;else{const o=a.headers.get("openai-poll-after-ms");if(o){const c=parseInt(o);isNaN(c)||(l=c)}}await nn(l);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},i){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=(i==null?void 0:i.maxConcurrency)??5,a=Math.min(r,t.length),l=this._client,o=t.values(),c=[...n];async function u(f){for(let m of f){const p=await l.files.create({file:m,purpose:"assistants"},i);c.push(p.id)}}const h=Array(a).fill(o).map(u);return await Po(h),await this.createAndPoll(e,{file_ids:c})}}class dt extends U{constructor(){super(...arguments),this.files=new Jn(this._client),this.fileBatches=new tl(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/vector_stores",lr,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}search(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/search`,or,{body:t,method:"post",...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class lr extends _e{}class or extends jn{}dt.VectorStoresPage=lr;dt.VectorStoreSearchResponsesPage=or;dt.Files=Jn;dt.VectorStoreFilesPage=qn;dt.FileContentResponsesPage=ar;dt.FileBatches=tl;var nl;class H extends ql{constructor({baseURL:e=pn("OPENAI_BASE_URL"),apiKey:t=pn("OPENAI_API_KEY"),organization:n=pn("OPENAI_ORG_ID")??null,project:i=pn("OPENAI_PROJECT_ID")??null,...r}={}){if(t===void 0)throw new z("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:t,organization:n,project:i,...r,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&so())throw new z(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new Wa(this),this.chat=new Un(this),this.embeddings=new Va(this),this.files=new Vs(this),this.images=new Ka(this),this.audio=new sn(this),this.moderations=new Ga(this),this.models=new tr(this),this.fineTuning=new ft(this),this.graders=new er(this),this.vectorStores=new dt(this),this.beta=new Nt(this),this.batches=new Ps(this),this.uploads=new ir(this),this.responses=new rr(this),this.evals=new cn(this),this.containers=new ln(this),this._options=a,this.apiKey=t,this.organization=n,this.project=i}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return Dl(e,{arrayFormat:"brackets"})}}nl=H;H.OpenAI=nl;H.DEFAULT_TIMEOUT=6e5;H.OpenAIError=z;H.APIError=ye;H.APIConnectionError=Bn;H.APIConnectionTimeoutError=Es;H.APIUserAbortError=je;H.NotFoundError=ea;H.ConflictError=ta;H.RateLimitError=sa;H.BadRequestError=Qi;H.AuthenticationError=Yi;H.InternalServerError=ra;H.PermissionDeniedError=Zi;H.UnprocessableEntityError=na;H.toFile=ua;H.fileFromPath=Xi;H.Completions=Wa;H.Chat=Un;H.ChatCompletionsPage=$n;H.Embeddings=Va;H.Files=Vs;H.FileObjectsPage=Js;H.Images=Ka;H.Audio=sn;H.Moderations=Ga;H.Models=tr;H.ModelsPage=nr;H.FineTuning=ft;H.Graders=er;H.VectorStores=dt;H.VectorStoresPage=lr;H.VectorStoreSearchResponsesPage=or;H.Beta=Nt;H.Batches=Ps;H.BatchesPage=Is;H.Uploads=ir;H.Responses=rr;H.Evals=cn;H.EvalListResponsesPage=Hs;H.Containers=ln;H.ContainerListResponsesPage=zs;class Io{constructor(e){q(this,"provider");this.provider=e}getRequestModel(e){return e||this.provider.model}createSystemMessage(e){return{role:"system",content:e}}createUserMessage(e){return{role:"user",content:e}}createAssistantMessage(e){return{role:"assistant",content:e}}}class Do extends Io{constructor(t){super(t);q(this,"client");this.client=new H({apiKey:t.apiKey,baseURL:t.baseURL,dangerouslyAllowBrowser:!0,maxRetries:2,timeout:6e4})}getMetadata(){return{id:"openai-compatible",name:this.provider.name,supportStreaming:!0,maxContextToken:4096}}async chatCompletion(t,n){var l,o;const i=await this.client.chat.completions.create({model:this.getRequestModel(n),messages:t,temperature:this.provider.temperature??.7,max_tokens:this.provider.maxTokens??2048}),r=((o=(l=i.choices[0])==null?void 0:l.message)==null?void 0:o.content)||"",a=i.usage;return{content:r,usage:a?{promptTokens:a.prompt_tokens,completionTokens:a.completion_tokens,totalTokens:a.total_tokens}:void 0}}async streamChatCompletion(t,n,i){var r,a;try{const l=await this.client.chat.completions.create({model:this.getRequestModel(i),messages:t,temperature:this.provider.temperature??.7,max_tokens:this.provider.maxTokens??2048,stream:!0});for await(const o of l){const c=(a=(r=o.choices[0])==null?void 0:r.delta)==null?void 0:a.content;c&&n({content:c})}n({done:!0})}catch(l){n({error:l instanceof Error?l:new Error(String(l)),done:!0})}}async testConnection(){try{return await this.client.chat.completions.create({model:this.getRequestModel(),messages:[{role:"user",content:"Hello"}],max_tokens:5}),!0}catch(t){return console.error("[AI Assistant] Connection test failed:",t),!1}}}class To{static createAdapter(e){return new Do(e)}}const Xr=[{name:"Ollama (æœ¬åœ°)",baseURL:"http://localhost:11434/v1",model:"llama3.2",apiKey:"ollama",temperature:.7,maxTokens:2048},{name:"OpenAI",baseURL:"https://api.openai.com/v1",model:"gpt-3.5-turbo",apiKey:"",temperature:.7,maxTokens:2048},{name:"DeepSeek",baseURL:"https://api.deepseek.com/v1",model:"deepseek-chat",apiKey:"",temperature:.7,maxTokens:2048},{name:"Moonshot",baseURL:"https://api.moonshot.cn/v1",model:"moonshot-v1-8k",apiKey:"",temperature:.7,maxTokens:2048},{name:"æ™ºè°±AI (GLM-4-Flash)",baseURL:"https://open.bigmodel.cn/api/paas/v4",model:"glm-4-flash",apiKey:"",temperature:.7,maxTokens:4096},{name:"è‡ªå®šä¹‰ OpenAI æ ¼å¼",baseURL:"",model:"",apiKey:"",temperature:.7,maxTokens:2048}],Qt={chat:"",polish:"ä¼˜åŒ–ä»¥ä¸‹æ–‡æœ¬çš„è¡¨è¾¾ï¼Œä½¿å…¶æ›´æµç•…ã€ä¸“ä¸šã€‚ä¿æŒåŽŸæ„ï¼Œä»…è¾“å‡ºä¿®æ”¹åŽçš„æ–‡æœ¬ï¼š",translate:"å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆç›®æ ‡è¯­è¨€ï¼ˆä¸­æ–‡â†’è‹±æ–‡ï¼Œè‹±æ–‡â†’ä¸­æ–‡ï¼‰ã€‚ä¿æŒåŽŸæ„å’Œè¯­æ°”ï¼Œä»…è¾“å‡ºè¯‘æ–‡ï¼š",summarize:"æç‚¼ä»¥ä¸‹æ–‡æœ¬çš„æ ¸å¿ƒè¦ç‚¹ï¼Œç”¨3-5å¥è¯æ¦‚æ‹¬å…³é”®ä¿¡æ¯ã€‚ä»…è¾“å‡ºæ€»ç»“å†…å®¹ï¼š",expand:"åŸºäºŽä»¥ä¸‹å†…å®¹è¿›è¡Œæ‰©å±•ï¼Œå¢žåŠ ç›¸å…³ç»†èŠ‚å’Œè§£é‡Šï¼Œä½¿å†…å®¹æ›´ä¸°å¯Œå®Œæ•´ã€‚ä¿æŒä¸»é¢˜ä¸€è‡´ï¼š",condense:"åŽ‹ç¼©ä»¥ä¸‹æ–‡æœ¬ï¼ŒåŽ»é™¤å†—ä½™æè¿°å’Œé‡å¤ä¿¡æ¯ï¼Œä¿ç•™æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®æ•°æ®ï¼š",rewrite:"æ”¹å†™ä»¥ä¸‹æ–‡æœ¬ï¼Œè°ƒæ•´ä¸ºæ­£å¼ä¹¦é¢è¯­é£Žæ ¼ï¼Œé€‚ç”¨äºŽå­¦æœ¯æˆ–å•†åŠ¡åœºæ™¯ï¼š",continue:"å»¶ç»­ä»¥ä¸‹æ–‡æœ¬çš„é£Žæ ¼å’Œä¸»é¢˜ï¼Œåˆç†ç»­å†™åŽç»­å†…å®¹ï¼Œä¿æŒé€»è¾‘è¿žè´¯ï¼š",custom1:"",custom2:"",custom3:""},Ro=[{id:"custom1",name:"è‡ªå®šä¹‰1",icon:"âœ¨",prompt:"",enabled:!1},{id:"custom2",name:"è‡ªå®šä¹‰2",icon:"ðŸ”§",prompt:"",enabled:!1},{id:"custom3",name:"è‡ªå®šä¹‰3",icon:"ðŸŽ¯",prompt:"",enabled:!1}],Mo={polish:!0,translate:!0,summarize:!0,expand:!0,condense:!1,rewrite:!1,continue:!1,custom1:!1,custom2:!1,custom3:!1};class sl{constructor(){q(this,"adapter",null);q(this,"provider",null)}setProvider(e){this.provider=e,this.adapter=To.createAdapter(e)}getCurrentProvider(){return this.provider}isConfigured(){return this.adapter!==null&&this.provider!==null}async*streamChat(e){if(!this.adapter)throw new Error("AI provider not configured");let t="";await this.adapter.streamChatCompletion(e,n=>{if(n.content&&(t+=n.content),n.error)throw n.error});for(const n of t)yield n,await new Promise(i=>setTimeout(i,10))}async processText(e,t){if(!this.adapter)throw new Error("AI provider not configured");if(t==="chat")throw new Error("Use streamChat for chat operation");const n=Qt[t];if(!n)throw new Error(`Unknown operation: ${t}`);const i=[{role:"system",content:"You are a helpful writing assistant."},{role:"user",content:`${n}

${e}`}];return this.adapter.chatCompletion(i)}async testConnection(){return this.adapter?this.adapter.testConnection():!1}buildOperationMessages(e,t,n){const i=n||Qt[t];return[{role:"system",content:"You are a helpful writing assistant. Respond only with the processed text, no explanations."},{role:"user",content:`${i}

${e}`}]}}q(sl,"DEFAULT_PROMPTS",Qt);const ge=new sl,Kr="ai-assistant-settings";class Oo{constructor(){q(this,"plugin",null);q(this,"settings",this.getDefaultSettings())}init(e){this.plugin=e}async loadSettings(){if(this.plugin)try{const e=await this.plugin.loadData(Kr);e&&(this.settings={...this.getDefaultSettings(),...e})}catch(e){console.error("[AI Assistant] Failed to load settings:",e)}}async saveSettings(){if(this.plugin)try{await this.plugin.saveData(Kr,this.settings)}catch(e){console.error("[AI Assistant] Failed to save settings:",e)}}getSettings(){return{...this.settings}}async updateSettings(e){this.settings={...this.settings,...e},await this.saveSettings()}async addProvider(e){const t=[...this.settings.providers];(e.isDefault||t.length===0)&&(t.forEach(n=>n.isDefault=!1),e.isDefault=!0),t.push(e),this.settings.providers=t,e.isDefault&&(this.settings.currentProviderId=e.id),await this.saveSettings()}async updateProvider(e,t){const n=this.settings.providers.findIndex(r=>r.id===e);if(n===-1)return;const i=this.settings.providers[n];t.isDefault&&t.isDefault!==i.isDefault&&(this.settings.providers.forEach(r=>r.isDefault=!1),this.settings.currentProviderId=e),this.settings.providers[n]={...i,...t},await this.saveSettings()}async deleteProvider(e){const t=this.settings.providers.findIndex(i=>i.id===e);if(t===-1)return;const n=this.settings.providers[t].isDefault;this.settings.providers.splice(t,1),n&&this.settings.providers.length>0?(this.settings.providers[0].isDefault=!0,this.settings.currentProviderId=this.settings.providers[0].id):this.settings.providers.length===0&&(this.settings.currentProviderId=null),await this.saveSettings()}getProvider(e){return this.settings.providers.find(t=>t.id===e)}getCurrentProvider(){return this.settings.currentProviderId&&this.getProvider(this.settings.currentProviderId)||null}async setCurrentProvider(e){const t=this.getProvider(e);t&&(this.settings.providers.forEach(n=>n.isDefault=!1),t.isDefault=!0,this.settings.currentProviderId=e,await this.saveSettings())}getConversations(){return[...this.settings.conversations]}async addConversation(e){const t=this.settings.conversations.findIndex(n=>n.id===e.id);t>=0?this.settings.conversations[t]=e:this.settings.conversations.push(e),await this.saveSettings()}async deleteConversation(e){this.settings.conversations=this.settings.conversations.filter(t=>t.id!==e),await this.saveSettings()}getCustomButtons(){return[...this.settings.customButtons]}async updateCustomButtons(e){this.settings.customButtons=e,await this.saveSettings()}getToolbarButtons(){return{...this.settings.toolbarButtons}}async updateToolbarButtons(e){this.settings.toolbarButtons=e,await this.saveSettings()}getDefaultSettings(){const e={id:"ollama-default",name:"Ollama (æœ¬åœ°)",apiKey:"ollama",baseURL:"http://localhost:11434/v1",model:"llama3.2",temperature:.7,maxTokens:2048,isDefault:!0};return{providers:[e],currentProviderId:e.id,conversations:[],operationPrompts:Qt,uiMode:"both",diffHighlightStyle:"word",showFloatingToolbar:!0,showContextMenu:!0,autoApplyOnAccept:!1,maxConcurrentRequests:3,requestTimeout:6e4,customButtons:Ro,toolbarButtons:Mo,enableLocalMode:!0,redactSensitiveInfo:!1}}}const Q=new Oo;class Fo{getSelectedText(){const e=window.getSelection();return!e||e.rangeCount===0?"":e.toString().trim()}getSelectedBlockIds(){const e=window.getSelection();if(!e||e.rangeCount===0)return[];const t=e.getRangeAt(0),n=new Set,i=t.commonAncestorContainer,r=i.nodeType===Node.ELEMENT_NODE?i:i.parentElement;if(r){const a=document.createTreeWalker(r,NodeFilter.SHOW_ELEMENT,{acceptNode:o=>o.hasAttribute("data-node-id")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});let l;for(;l=a.nextNode();){const o=l.getAttribute("data-node-id");o&&n.add(o)}}if(n.size===0){let a=t.startContainer;for(;a;){if(a.nodeType===Node.ELEMENT_NODE){const o=a.getAttribute("data-node-id");if(o){n.add(o);break}}a=a.parentElement}let l=t.endContainer;for(;l;){if(l.nodeType===Node.ELEMENT_NODE){const o=l.getAttribute("data-node-id");if(o){n.add(o);break}}l=l.parentElement}}if(n.size===0){const a=document.querySelector(".protyle-wysiwyg--select");if(a){const l=a.getAttribute("data-node-id");l&&n.add(l)}}if(n.size===0){const a=window.getSelection();if(a&&a.rangeCount>0){const l=a.getRangeAt(0);let o=l.startContainer.nodeType===Node.ELEMENT_NODE?l.startContainer:l.startContainer.parentElement;for(;o;){if(o.classList&&(o.classList.contains("p")||o.classList.contains("h1")||o.classList.contains("h2")||o.classList.contains("h3")||o.classList.contains("h4")||o.classList.contains("h5")||o.classList.contains("h6")||o.classList.contains("li")||o.classList.contains("blockquote")||o.classList.contains("code-block"))){const c=o.getAttribute("data-node-id");if(c){n.add(c);break}}o=o.parentElement}}}return Array.from(n)}getCurrentBlockId(){const e=this.getSelectedBlockIds();return e.length>0?e[0]:null}async getBlockContent(e){try{const t=await fetch("/api/block/getBlockInfo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})});if(!t.ok)throw new Error(`Failed to get block: ${t.statusText}`);const n=await t.json();if(n.code!==0||!n.data)return null;const i=n.data;return{id:i.id,type:i.type,subtype:i.subtype,content:i.content||"",markdown:i.markdown}}catch(t){return console.error("[AI Assistant] Failed to get block content:",t),null}}async updateBlock(e,t){try{const n=await fetch("/api/block/updateBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,data:t,dataType:"markdown"})});if(!n.ok)throw new Error(`Failed to update block: ${n.statusText}`);return(await n.json()).code===0}catch(n){return console.error("[AI Assistant] Failed to update block:",n),!1}}async insertBlockAfter(e,t){try{const n=await fetch("/api/block/insertBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({previousID:e,data:t,dataType:"markdown"})});if(!n.ok)throw new Error(`Failed to insert block: ${n.statusText}`);const i=await n.json();return i.code===0&&i.data&&i.data[0]?i.data[0].id:null}catch(n){return console.error("[AI Assistant] Failed to insert block:",n),null}}getSelectionRange(){const e=window.getSelection();if(!e||e.rangeCount===0)return{text:"",rect:null};const n=e.getRangeAt(0).getBoundingClientRect();return{text:e.toString().trim(),rect:n}}clearSelection(){const e=window.getSelection();e&&e.removeAllRanges()}async replaceSelectedText(e,t,n){try{const i=await this.getBlockContent(e);if(!i)return{success:!1,error:"æ— æ³•èŽ·å–å—å†…å®¹"};let r=i.content;if(!t)return{success:!0,content:r};console.log("[AI Assistant] ====== replaceSelectedText è°ƒè¯• ======"),console.log("[AI Assistant] blockId:",e),console.log("[AI Assistant] fullContent (åŽŸæ–‡):",JSON.stringify(r)),console.log("[AI Assistant] selectedText (é€‰ä¸­):",JSON.stringify(t)),console.log("[AI Assistant] newText (AIç»“æžœ):",JSON.stringify(n)),console.log("[AI Assistant] fullContenté•¿åº¦:",r.length),console.log("[AI Assistant] selectedTexté•¿åº¦:",t.length),console.log("[AI Assistant] fullContentæ˜¯å¦åŒ…å«selectedText:",r.includes(t));let a=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(a,"");if(l.test(r)){const h=r.replace(l,n);return console.log("[AI Assistant] ç­–ç•¥1-ç²¾ç¡®åŒ¹é…æˆåŠŸ"),{success:!0,content:h}}console.log("[AI Assistant] ç­–ç•¥1-ç²¾ç¡®åŒ¹é…å¤±è´¥");const o=t.trim();if(console.log("[AI Assistant] trimmedSelected:",JSON.stringify(o)),console.log("[AI Assistant] trimmedå…¨æ–‡æ˜¯å¦åŒ…å«trimmedé€‰ä¸­:",r.trim().includes(o)),a=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(a,""),l.test(r)){const h=r.substring(0,r.indexOf(o)),f=r.substring(r.indexOf(o)+o.length),m=h+n+f;return console.log("[AI Assistant] ç­–ç•¥2-TrimåŒ¹é…æˆåŠŸ"),{success:!0,content:m}}console.log("[AI Assistant] ç­–ç•¥2-TrimåŒ¹é…å¤±è´¥");const c=r.trim(),u=c.indexOf(o);if(console.log("[AI Assistant] trimmedIndex:",u),u!==-1){const h=r.substring(0,r.indexOf(c.substring(0,u>0?u:0))),f=r.indexOf(c)+u+o.length,m=r.substring(f),p=h+n+m;return console.log("[AI Assistant] ç­–ç•¥3-æ¨¡ç³ŠåŒ¹é…æˆåŠŸ"),{success:!0,content:p}}return console.log("[AI Assistant] ç­–ç•¥3-æ¨¡ç³ŠåŒ¹é…å¤±è´¥"),console.log("[AI Assistant] æ‰€æœ‰å­—ç¬¦ä¸²åŒ¹é…ç­–ç•¥å¤±è´¥ï¼Œå°è¯•DOMé€‰åŒºæ›¿æ¢"),await this.smartReplaceByDOMSelection(e,t,n)}catch(i){return console.error("[AI Assistant] æ™ºèƒ½æ›¿æ¢å¤±è´¥:",i),{success:!1,error:String(i)}}}async smartReplaceByDOMSelection(e,t,n){try{const i=await this.getBlockContent(e);if(!i)return{success:!1,error:"æ— æ³•èŽ·å–å—å†…å®¹"};const r=window.getSelection();if(!r||r.rangeCount===0)return console.warn("[AI Assistant] æ— DOMé€‰åŒºï¼Œå›žé€€åˆ°å®Œæ•´æ›¿æ¢"),{success:!0,content:n};const a=r.getRangeAt(0),l=a.startOffset,o=a.endOffset,c=[t,t.trim(),t.replace(/\s+/g," ")];let u="",h=-1;for(const f of c){const m=i.content.indexOf(f);if(m!==-1){u=f,h=m;break}}if(h!==-1){const f=i.content.substring(0,h),m=i.content.substring(h+u.length),p=f+n+m;return console.log("[AI Assistant] DOMé€‰åŒºæ›¿æ¢æˆåŠŸ"),{success:!0,content:p}}return console.warn("[AI Assistant] æ— æ³•æ‰¾åˆ°é€‰ä¸­æ–‡å­—åœ¨åŽŸæ–‡ä¸­çš„ä½ç½®ï¼Œå›žé€€åˆ°å®Œæ•´æ›¿æ¢"),{success:!0,content:n}}catch(i){return console.error("[AI Assistant] DOMé€‰åŒºæ›¿æ¢å¤±è´¥:",i),{success:!1,error:String(i)}}}}const St=new Fo;function Gr(s,e,t){const n=s.slice();return n[26]=e[t],n}function Qr(s,e,t){const n=s.slice();return n[31]=e[t],n}function Yr(s,e,t){const n=s.slice();return n[26]=e[t],n}function Zr(s,e,t){const n=s.slice();return n[34]=e[t],n}function ei(s){let e,t,n,i,r,a,l,o,c,u,h=ue(s[5]),f=[];for(let p=0;p<h.length;p+=1)f[p]=ti(Zr(s,h,p));let m=s[5].length===0&&ni();return{c(){e=w("div"),t=w("div"),n=w("h3"),n.textContent="å¯¹è¯åŽ†å²",i=E(),r=w("button"),r.textContent="âœ•",a=E(),l=w("div");for(let p=0;p<f.length;p+=1)f[p].c();o=E(),m&&m.c(),g(n,"class","svelte-ou36hp"),g(r,"class","btn-close svelte-ou36hp"),g(t,"class","history-header svelte-ou36hp"),g(l,"class","history-list svelte-ou36hp"),g(e,"class","history-sidebar svelte-ou36hp")},m(p,_){$(p,e,_),d(e,t),d(t,n),d(t,i),d(t,r),d(e,a),d(e,l);for(let b=0;b<f.length;b+=1)f[b]&&f[b].m(l,null);d(l,o),m&&m.m(l,null),c||(u=O(r,"click",s[16]),c=!0)},p(p,_){if(_[0]&12336){h=ue(p[5]);let b;for(b=0;b<h.length;b+=1){const y=Zr(p,h,b);f[b]?f[b].p(y,_):(f[b]=ti(y),f[b].c(),f[b].m(l,o))}for(;b<f.length;b+=1)f[b].d(1);f.length=h.length}p[5].length===0?m||(m=ni(),m.c(),m.m(l,null)):m&&(m.d(1),m=null)},d(p){p&&j(e),Qe(f,p),m&&m.d(),c=!1,u()}}}function ti(s){let e,t,n=s[34].title+"",i,r,a,l=new Date(s[34].updatedAt).toLocaleDateString()+"",o,c,u,h,f;function m(..._){return s[17](s[34],..._)}function p(){return s[18](s[34])}return{c(){e=w("div"),t=w("div"),i=V(n),r=E(),a=w("div"),o=V(l),c=E(),u=w("button"),u.textContent="ðŸ—‘ï¸",g(t,"class","history-title svelte-ou36hp"),g(u,"class","btn-delete svelte-ou36hp"),g(a,"class","history-meta svelte-ou36hp"),g(e,"class","history-item svelte-ou36hp"),ce(e,"active",s[34].id===s[4])},m(_,b){$(_,e,b),d(e,t),d(t,i),d(e,r),d(e,a),d(a,o),d(a,c),d(a,u),h||(f=[O(u,"click",m),O(e,"click",p)],h=!0)},p(_,b){s=_,b[0]&32&&n!==(n=s[34].title+"")&&Y(i,n),b[0]&32&&l!==(l=new Date(s[34].updatedAt).toLocaleDateString()+"")&&Y(o,l),b[0]&48&&ce(e,"active",s[34].id===s[4])},d(_){_&&j(e),h=!1,Ce(f)}}}function ni(s){let e;return{c(){e=w("div"),e.textContent="æš‚æ— åŽ†å²å¯¹è¯",g(e,"class","history-empty svelte-ou36hp")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function Bo(s){let e,t,n=ue(s[1]),i=[];for(let a=0;a<n.length;a+=1)i[a]=si(Qr(s,n,a));let r=s[3]&&ri();return{c(){for(let a=0;a<i.length;a+=1)i[a].c();e=E(),r&&r.c(),t=Bi()},m(a,l){for(let o=0;o<i.length;o+=1)i[o]&&i[o].m(a,l);$(a,e,l),r&&r.m(a,l),$(a,t,l)},p(a,l){if(l[0]&2){n=ue(a[1]);let o;for(o=0;o<n.length;o+=1){const c=Qr(a,n,o);i[o]?i[o].p(c,l):(i[o]=si(c),i[o].c(),i[o].m(e.parentNode,e))}for(;o<i.length;o+=1)i[o].d(1);i.length=n.length}a[3]?r||(r=ri(),r.c(),r.m(t.parentNode,t)):r&&(r.d(1),r=null)},d(a){a&&(j(e),j(t)),Qe(i,a),r&&r.d(a)}}}function Lo(s){let e,t,n,i,r,a,l,o,c=ue(s[8]),u=[];for(let h=0;h<c.length;h+=1)u[h]=ii(Yr(s,c,h));return{c(){e=w("div"),t=w("div"),t.textContent="ðŸ¤–",n=E(),i=w("h2"),i.textContent="AIåŠ©æ‰‹",r=E(),a=w("p"),a.textContent="é€‰æ‹©æ–‡æœ¬å¹¶ä½¿ç”¨å¿«æ·æ“ä½œï¼Œæˆ–ç›´æŽ¥å¼€å§‹å¯¹è¯",l=E(),o=w("div");for(let h=0;h<u.length;h+=1)u[h].c();g(t,"class","welcome-icon svelte-ou36hp"),g(i,"class","svelte-ou36hp"),g(a,"class","svelte-ou36hp"),g(o,"class","quick-actions svelte-ou36hp"),g(e,"class","welcome-message svelte-ou36hp")},m(h,f){$(h,e,f),d(e,t),d(e,n),d(e,i),d(e,r),d(e,a),d(e,l),d(e,o);for(let m=0;m<u.length;m+=1)u[m]&&u[m].m(o,null)},p(h,f){if(f[0]&1280){c=ue(h[8]);let m;for(m=0;m<c.length;m+=1){const p=Yr(h,c,m);u[m]?u[m].p(p,f):(u[m]=ii(p),u[m].c(),u[m].m(o,null))}for(;m<u.length;m+=1)u[m].d(1);u.length=c.length}},d(h){h&&j(e),Qe(u,h)}}}function si(s){let e,t,n=s[31].role==="user"?"ðŸ‘¤":"ðŸ¤–",i,r,a,l,o=s[31].content+"",c,u,h,f=oi(s[31].timestamp)+"",m;return{c(){e=w("div"),t=w("div"),i=V(n),r=E(),a=w("div"),l=w("div"),c=V(o),u=E(),h=w("div"),m=V(f),g(t,"class","message-avatar svelte-ou36hp"),g(l,"class","message-text svelte-ou36hp"),g(h,"class","message-time svelte-ou36hp"),g(a,"class","message-content svelte-ou36hp"),g(e,"class","message svelte-ou36hp"),ce(e,"user",s[31].role==="user"),ce(e,"assistant",s[31].role==="assistant")},m(p,_){$(p,e,_),d(e,t),d(t,i),d(e,r),d(e,a),d(a,l),d(l,c),d(a,u),d(a,h),d(h,m)},p(p,_){_[0]&2&&n!==(n=p[31].role==="user"?"ðŸ‘¤":"ðŸ¤–")&&Y(i,n),_[0]&2&&o!==(o=p[31].content+"")&&Y(c,o),_[0]&2&&f!==(f=oi(p[31].timestamp)+"")&&Y(m,f),_[0]&2&&ce(e,"user",p[31].role==="user"),_[0]&2&&ce(e,"assistant",p[31].role==="assistant")},d(p){p&&j(e)}}}function ri(s){let e;return{c(){e=w("div"),e.innerHTML='<div class="message-avatar svelte-ou36hp">ðŸ¤–</div> <div class="message-content svelte-ou36hp"><div class="typing-indicator svelte-ou36hp"><span class="svelte-ou36hp"></span> <span class="svelte-ou36hp"></span> <span class="svelte-ou36hp"></span></div></div>',g(e,"class","message assistant streaming svelte-ou36hp")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function ii(s){let e,t,n,i,r,a,l;function o(){return s[19](s[26])}return{c(){e=w("button"),t=w("span"),t.textContent=`${s[26].icon}`,n=E(),i=w("span"),i.textContent=`${s[26].label}`,r=E(),g(t,"class","icon"),g(e,"class","quick-action-btn svelte-ou36hp")},m(c,u){$(c,e,u),d(e,t),d(e,n),d(e,i),d(e,r),a||(l=O(e,"click",o),a=!0)},p(c,u){s=c},d(c){c&&j(e),a=!1,l()}}}function ai(s){let e,t=ue(s[8]),n=[];for(let i=0;i<t.length;i+=1)n[i]=li(Gr(s,t,i));return{c(){e=w("div");for(let i=0;i<n.length;i+=1)n[i].c();g(e,"class","quick-actions-bar svelte-ou36hp")},m(i,r){$(i,e,r);for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(e,null)},p(i,r){if(r[0]&1288){t=ue(i[8]);let a;for(a=0;a<t.length;a+=1){const l=Gr(i,t,a);n[a]?n[a].p(l,r):(n[a]=li(l),n[a].c(),n[a].m(e,null))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},d(i){i&&j(e),Qe(n,i)}}}function li(s){let e,t=s[26].icon+"",n,i,r=s[26].label+"",a,l,o,c;function u(){return s[21](s[26])}return{c(){e=w("button"),n=V(t),i=E(),a=V(r),l=E(),g(e,"class","quick-action-chip svelte-ou36hp"),e.disabled=s[3]},m(h,f){$(h,e,f),d(e,n),d(e,i),d(e,a),d(e,l),o||(c=O(e,"click",u),o=!0)},p(h,f){s=h,f[0]&8&&(e.disabled=s[3])},d(h){h&&j(e),o=!1,c()}}}function xo(s){let e,t,n,i,r,a,l,o,c,u,h,f,m,p,_,b,y,v,C,S=s[3]?"â³":"âž¤",P,A,k,M,T=s[6]&&ei(s);function F(B,x){return B[1].length===0?Lo:Bo}let D=F(s),R=D(s),I=s[1].length>0&&ai(s);return{c(){e=w("div"),t=w("div"),n=w("div"),n.innerHTML='<span class="icon svelte-ou36hp">ðŸ¤–</span> <span>AIåŠ©æ‰‹</span>',i=E(),r=w("div"),a=w("button"),a.textContent="ðŸ“š",l=E(),o=w("button"),o.textContent="âž•",c=E(),u=w("button"),u.textContent="âš™ï¸",h=E(),T&&T.c(),f=E(),m=w("div"),R.c(),p=E(),I&&I.c(),_=E(),b=w("div"),y=w("textarea"),v=E(),C=w("button"),P=V(S),g(n,"class","header-title svelte-ou36hp"),g(a,"class","btn-icon svelte-ou36hp"),g(a,"title","åŽ†å²è®°å½•"),g(o,"class","btn-icon svelte-ou36hp"),g(o,"title","æ–°å¯¹è¯"),g(u,"class","btn-icon svelte-ou36hp"),g(u,"title","è®¾ç½®"),g(r,"class","header-actions svelte-ou36hp"),g(t,"class","chat-header svelte-ou36hp"),g(m,"class","messages-container svelte-ou36hp"),g(y,"placeholder","è¾“å…¥æ¶ˆæ¯... (Enterå‘é€, Shift+Enteræ¢è¡Œ)"),y.disabled=s[3],g(y,"rows","2"),g(y,"class","svelte-ou36hp"),g(C,"class","send-btn svelte-ou36hp"),C.disabled=A=!s[2].trim()||s[3],g(b,"class","input-area svelte-ou36hp"),g(e,"class","ai-chat-panel svelte-ou36hp")},m(B,x){$(B,e,x),d(e,t),d(t,n),d(t,i),d(t,r),d(r,a),d(r,l),d(r,o),d(r,c),d(r,u),d(e,h),T&&T.m(e,null),d(e,f),d(e,m),R.m(m,null),s[20](m),d(e,p),I&&I.m(e,null),d(e,_),d(e,b),d(b,y),te(y,s[2]),d(b,v),d(b,C),d(C,P),k||(M=[O(a,"click",s[15]),O(o,"click",s[11]),O(u,"click",function(){tn(s[0])&&s[0].apply(this,arguments)}),O(y,"input",s[22]),O(y,"keydown",s[14]),O(C,"click",s[9])],k=!0)},p(B,x){s=B,s[6]?T?T.p(s,x):(T=ei(s),T.c(),T.m(e,f)):T&&(T.d(1),T=null),D===(D=F(s))&&R?R.p(s,x):(R.d(1),R=D(s),R&&(R.c(),R.m(m,null))),s[1].length>0?I?I.p(s,x):(I=ai(s),I.c(),I.m(e,_)):I&&(I.d(1),I=null),x[0]&8&&(y.disabled=s[3]),x[0]&4&&te(y,s[2]),x[0]&8&&S!==(S=s[3]?"â³":"âž¤")&&Y(P,S),x[0]&12&&A!==(A=!s[2].trim()||s[3])&&(C.disabled=A)},i:ze,o:ze,d(B){B&&j(e),T&&T.d(),R.d(),s[20](null),I&&I.d(),k=!1,Ce(M)}}}function wt(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function oi(s){return new Date(s).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}function No(s,e,t){let{onOpenSettings:n=()=>{}}=e,i=[],r="",a=!1,l=null,o=[],c=!1,u;const h=[{type:"polish",label:"æ¶¦è‰²",icon:"âœ¨"},{type:"translate",label:"ç¿»è¯‘",icon:"ðŸŒ"},{type:"summarize",label:"æ€»ç»“",icon:"ðŸ“"},{type:"expand",label:"æ‰©å†™",icon:"ðŸ“–"}];ks(()=>{f();const I=Q.getCurrentProvider();I&&ge.setProvider(I)});function f(){t(5,o=Q.getConversations())}async function m(){if(!r.trim()||a)return;const I={id:wt(),role:"user",content:r.trim(),timestamp:Date.now()};t(1,i=[...i,I]),t(2,r=""),t(3,a=!0),S();try{const B=[{role:"system",content:"You are a helpful assistant."},...i.map(ee=>({role:ee.role,content:ee.content}))];let x="";const G={id:wt(),role:"assistant",content:"",timestamp:Date.now()};t(1,i=[...i,G]),await ge.streamChat(B),x=(await ge.processText(I.content,"chat").catch(async()=>{var ae;return await((ae=ge.adapter)==null?void 0:ae.chatCompletion(B))||{content:"Sorry, I could not process your request."}})).content;const W=i.findIndex(ee=>ee.id===G.id);W>=0&&(t(1,i[W]={...G,content:x},i),t(1,i=[...i])),await _()}catch(B){console.error("[AI Assistant] Chat error:",B),t(1,i=[...i,{id:wt(),role:"assistant",content:"æŠ±æ­‰ï¼Œå¤„ç†è¯·æ±‚æ—¶å‡ºé”™ã€‚è¯·æ£€æŸ¥AIæä¾›å•†é…ç½®ã€‚",timestamp:Date.now()}])}finally{t(3,a=!1),S()}}async function p(I){const B=St.getSelectedText();if(!B){t(2,r=Qt[I]);return}const x={id:wt(),role:"user",content:`[${I}] ${B.substring(0,50)}...`,timestamp:Date.now()};t(1,i=[...i,x]),t(3,a=!0),S();try{const G=await ge.processText(B,I);t(1,i=[...i,{id:wt(),role:"assistant",content:G.content,timestamp:Date.now()}]),await _()}catch(G){console.error("[AI Assistant] Action error:",G),t(1,i=[...i,{id:wt(),role:"assistant",content:"å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚",timestamp:Date.now()}])}finally{t(3,a=!1),S()}}async function _(){var x;if(i.length===0)return;const I=i[0].content.substring(0,30)+(i[0].content.length>30?"...":""),B={id:l||wt(),title:I,messages:[...i],createdAt:l&&((x=o.find(G=>G.id===l))==null?void 0:x.createdAt)||Date.now(),updatedAt:Date.now()};t(4,l=B.id),await Q.addConversation(B),f()}function b(){i.length>0&&_(),t(1,i=[]),t(4,l=null)}function y(I){const B=o.find(x=>x.id===I);B&&(t(1,i=[...B.messages]),t(4,l=I),t(6,c=!1),S())}async function v(I,B){B.stopPropagation(),confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ")&&(await Q.deleteConversation(I),l===I&&b(),f())}function C(I){I.key==="Enter"&&!I.shiftKey&&(I.preventDefault(),m())}function S(){hl().then(()=>{u&&t(7,u.scrollTop=u.scrollHeight,u)})}const P=()=>t(6,c=!c),A=()=>t(6,c=!1),k=(I,B)=>v(I.id,B),M=I=>y(I.id),T=I=>p(I.type);function F(I){as[I?"unshift":"push"](()=>{u=I,t(7,u)})}const D=I=>p(I.type);function R(){r=this.value,t(2,r)}return s.$$set=I=>{"onOpenSettings"in I&&t(0,n=I.onOpenSettings)},[n,i,r,a,l,o,c,u,h,m,p,b,y,v,C,P,A,k,M,T,F,D,R]}class jo extends Cs{constructor(e){super(),As(this,e,No,xo,Ss,{onOpenSettings:0},null,[-1,-1])}}function ci(s,e,t){const n=s.slice();return n[74]=e[t],n[75]=e,n[76]=t,n}function ui(s,e,t){const n=s.slice();return n[71]=e[t],n}function hi(s,e,t){const n=s.slice();return n[68]=e[t],n}function zo(s){let e,t,n,i,r,a,l=ue(s[3]),o=[];for(let u=0;u<l.length;u+=1)o[u]=fi(ci(s,l,u));let c=s[10]&&di(s);return{c(){e=w("div"),t=w("h3"),t.textContent="è‡ªå®šä¹‰æŒ‰é’®é…ç½®",n=E(),i=w("p"),i.textContent="é…ç½®ä¸‰ä¸ªè‡ªå®šä¹‰æ“ä½œæŒ‰é’®ï¼ˆå¯ç”¨åŽä¼šè‡ªåŠ¨åŒæ­¥åˆ°å·¥å…·æ ï¼‰",r=E();for(let u=0;u<o.length;u+=1)o[u].c();a=E(),c&&c.c(),g(i,"class","section-desc svelte-j5ryrz"),g(e,"class","prompts-section")},m(u,h){$(u,e,h),d(e,t),d(e,n),d(e,i),d(e,r);for(let f=0;f<o.length;f+=1)o[f]&&o[f].m(e,null);d(e,a),c&&c.m(e,null)},p(u,h){if(h[0]&2621448){l=ue(u[3]);let f;for(f=0;f<l.length;f+=1){const m=ci(u,l,f);o[f]?o[f].p(m,h):(o[f]=fi(m),o[f].c(),o[f].m(e,a))}for(;f<o.length;f+=1)o[f].d(1);o.length=l.length}u[10]?c?c.p(u,h):(c=di(u),c.c(),c.m(e,null)):c&&(c.d(1),c=null)},d(u){u&&j(e),Qe(o,u),c&&c.d()}}}function $o(s){let e;return{c(){e=w("div"),e.innerHTML='<h3>ç•Œé¢è®¾ç½®</h3> <p class="section-desc svelte-j5ryrz">MVPç‰ˆæœ¬æš‚ä¸æ”¯æŒç•Œé¢è‡ªå®šä¹‰</p>',g(e,"class","ui-section")},m(t,n){$(t,e,n)},p:ze,d(t){t&&j(e)}}}function Uo(s){var hr,fr,dr,mr,pr,gr;let e,t,n,i,r,a,l,o,c,u,h,f,m,p,_,b,y,v,C,S,P,A,k,M,T,F,D,R,I,B,x,G,X,W,ee,ae,Re,K,ke,Ee,Ye,rt,Ve,Ze,Pe,Me,Oe,Ae,mt,$e,et=(((hr=s[3][0])==null?void 0:hr.name)||"è‡ªå®šä¹‰1")+"",le,pt,Fe=(((fr=s[3][0])==null?void 0:fr.icon)||"âœ¨")+"",oe,gt,Be,he,be,J,ne=(((dr=s[3][1])==null?void 0:dr.name)||"è‡ªå®šä¹‰2")+"",zt,un,At=(((mr=s[3][1])==null?void 0:mr.icon)||"ðŸ”§")+"",$t,hn,it,Je,fn,_t,N=(((pr=s[3][2])==null?void 0:pr.name)||"è‡ªå®šä¹‰3")+"",fe,at,tt=(((gr=s[3][2])==null?void 0:gr.icon)||"ðŸŽ¯")+"",lt,cr,Xn,ur,Ie=s[10]&&mi(s);return{c(){e=w("div"),t=w("h3"),t.textContent="æµ®åŠ¨å·¥å…·æ æŒ‰é’®",n=E(),i=w("p"),i.textContent="é€‰æ‹©åœ¨æµ®åŠ¨å·¥å…·æ ä¸­æ˜¾ç¤ºå“ªäº›æŒ‰é’®",r=E(),a=w("div"),l=w("label"),o=w("input"),c=E(),u=w("span"),u.textContent="âœ¨ æ¶¦è‰²",h=E(),f=w("label"),m=w("input"),p=E(),_=w("span"),_.textContent="ðŸŒ ç¿»è¯‘",b=E(),y=w("label"),v=w("input"),C=E(),S=w("span"),S.textContent="ðŸ“ æ€»ç»“",P=E(),A=w("label"),k=w("input"),M=E(),T=w("span"),T.textContent="ðŸ“– æ‰©å†™",F=E(),D=w("label"),R=w("input"),I=E(),B=w("span"),B.textContent="ðŸ“„ ç²¾ç®€",x=E(),G=w("label"),X=w("input"),W=E(),ee=w("span"),ee.textContent="ðŸ”„ æ”¹å†™",ae=E(),Re=w("label"),K=w("input"),ke=E(),Ee=w("span"),Ee.textContent="âž¡ï¸ ç»­å†™",Ye=E(),rt=w("h4"),rt.textContent="è‡ªå®šä¹‰æŒ‰é’®",Ve=E(),Ze=w("p"),Ze.textContent='åœ¨"è‡ªå®šä¹‰æç¤ºè¯"Tabä¸­é…ç½®åŽä¼šè‡ªåŠ¨åŒæ­¥åˆ°è¿™é‡Œ',Pe=E(),Me=w("div"),Oe=w("label"),Ae=w("input"),mt=E(),$e=w("span"),le=V(et),pt=E(),oe=V(Fe),gt=E(),Be=w("label"),he=w("input"),be=E(),J=w("span"),zt=V(ne),un=E(),$t=V(At),hn=E(),it=w("label"),Je=w("input"),fn=E(),_t=w("span"),fe=V(N),at=E(),lt=V(tt),cr=E(),Ie&&Ie.c(),g(i,"class","section-desc svelte-j5ryrz"),g(o,"type","checkbox"),g(o,"class","svelte-j5ryrz"),g(l,"class","checkbox-item svelte-j5ryrz"),g(m,"type","checkbox"),g(m,"class","svelte-j5ryrz"),g(f,"class","checkbox-item svelte-j5ryrz"),g(v,"type","checkbox"),g(v,"class","svelte-j5ryrz"),g(y,"class","checkbox-item svelte-j5ryrz"),g(k,"type","checkbox"),g(k,"class","svelte-j5ryrz"),g(A,"class","checkbox-item svelte-j5ryrz"),g(R,"type","checkbox"),g(R,"class","svelte-j5ryrz"),g(D,"class","checkbox-item svelte-j5ryrz"),g(X,"type","checkbox"),g(X,"class","svelte-j5ryrz"),g(G,"class","checkbox-item svelte-j5ryrz"),g(K,"type","checkbox"),g(K,"class","svelte-j5ryrz"),g(Re,"class","checkbox-item svelte-j5ryrz"),g(a,"class","checkbox-list svelte-j5ryrz"),g(Ze,"class","section-desc svelte-j5ryrz"),g(Ae,"type","checkbox"),g(Ae,"class","svelte-j5ryrz"),g(Oe,"class","checkbox-item svelte-j5ryrz"),g(he,"type","checkbox"),g(he,"class","svelte-j5ryrz"),g(Be,"class","checkbox-item svelte-j5ryrz"),g(Je,"type","checkbox"),g(Je,"class","svelte-j5ryrz"),g(it,"class","checkbox-item svelte-j5ryrz"),g(Me,"class","checkbox-list svelte-j5ryrz"),g(e,"class","toolbar-section")},m(se,de){$(se,e,de),d(e,t),d(e,n),d(e,i),d(e,r),d(e,a),d(a,l),d(l,o),o.checked=s[4].polish,d(l,c),d(l,u),d(a,h),d(a,f),d(f,m),m.checked=s[4].translate,d(f,p),d(f,_),d(a,b),d(a,y),d(y,v),v.checked=s[4].summarize,d(y,C),d(y,S),d(a,P),d(a,A),d(A,k),k.checked=s[4].expand,d(A,M),d(A,T),d(a,F),d(a,D),d(D,R),R.checked=s[4].condense,d(D,I),d(D,B),d(a,x),d(a,G),d(G,X),X.checked=s[4].rewrite,d(G,W),d(G,ee),d(a,ae),d(a,Re),d(Re,K),K.checked=s[4].continue,d(Re,ke),d(Re,Ee),d(e,Ye),d(e,rt),d(e,Ve),d(e,Ze),d(e,Pe),d(e,Me),d(Me,Oe),d(Oe,Ae),Ae.checked=s[4].custom1,d(Oe,mt),d(Oe,$e),d($e,le),d($e,pt),d($e,oe),d(Me,gt),d(Me,Be),d(Be,he),he.checked=s[4].custom2,d(Be,be),d(Be,J),d(J,zt),d(J,un),d(J,$t),d(Me,hn),d(Me,it),d(it,Je),Je.checked=s[4].custom3,d(it,fn),d(it,_t),d(_t,fe),d(_t,at),d(_t,lt),d(e,cr),Ie&&Ie.m(e,null),Xn||(ur=[O(o,"change",s[36]),O(o,"change",s[37]),O(m,"change",s[38]),O(m,"change",s[39]),O(v,"change",s[40]),O(v,"change",s[41]),O(k,"change",s[42]),O(k,"change",s[43]),O(R,"change",s[44]),O(R,"change",s[45]),O(X,"change",s[46]),O(X,"change",s[47]),O(K,"change",s[48]),O(K,"change",s[49]),O(Ae,"change",s[50]),O(Ae,"change",s[51]),O(he,"change",s[52]),O(he,"change",s[53]),O(Je,"change",s[54]),O(Je,"change",s[55])],Xn=!0)},p(se,de){var _r,br,wr,vr,yr,Sr;de[0]&16&&(o.checked=se[4].polish),de[0]&16&&(m.checked=se[4].translate),de[0]&16&&(v.checked=se[4].summarize),de[0]&16&&(k.checked=se[4].expand),de[0]&16&&(R.checked=se[4].condense),de[0]&16&&(X.checked=se[4].rewrite),de[0]&16&&(K.checked=se[4].continue),de[0]&16&&(Ae.checked=se[4].custom1),de[0]&8&&et!==(et=(((_r=se[3][0])==null?void 0:_r.name)||"è‡ªå®šä¹‰1")+"")&&Y(le,et),de[0]&8&&Fe!==(Fe=(((br=se[3][0])==null?void 0:br.icon)||"âœ¨")+"")&&Y(oe,Fe),de[0]&16&&(he.checked=se[4].custom2),de[0]&8&&ne!==(ne=(((wr=se[3][1])==null?void 0:wr.name)||"è‡ªå®šä¹‰2")+"")&&Y(zt,ne),de[0]&8&&At!==(At=(((vr=se[3][1])==null?void 0:vr.icon)||"ðŸ”§")+"")&&Y($t,At),de[0]&16&&(Je.checked=se[4].custom3),de[0]&8&&N!==(N=(((yr=se[3][2])==null?void 0:yr.name)||"è‡ªå®šä¹‰3")+"")&&Y(fe,N),de[0]&8&&tt!==(tt=(((Sr=se[3][2])==null?void 0:Sr.icon)||"ðŸŽ¯")+"")&&Y(lt,tt),se[10]?Ie?Ie.p(se,de):(Ie=mi(se),Ie.c(),Ie.m(e,null)):Ie&&(Ie.d(1),Ie=null)},d(se){se&&j(e),Ie&&Ie.d(),Xn=!1,Ce(ur)}}}function Wo(s){let e;function t(r,a){return r[5]?Vo:Ho}let n=t(s),i=n(s);return{c(){e=w("div"),i.c(),g(e,"class","providers-section")},m(r,a){$(r,e,a),i.m(e,null)},p(r,a){n===(n=t(r))&&i?i.p(r,a):(i.d(1),i=n(r),i&&(i.c(),i.m(e,null)))},d(r){r&&j(e),i.d()}}}function fi(s){let e,t,n,i,r,a,l,o,c,u,h,f,m,p,_,b,y,v,C,S,P,A,k,M;function T(){s[56].call(r,s[75],s[76])}function F(){return s[57](s[76])}function D(){s[58].call(f,s[75],s[76])}function R(){s[60].call(y,s[75],s[76])}function I(){s[62].call(A,s[75],s[76])}return{c(){e=w("div"),t=w("h4"),t.textContent=`è‡ªå®šä¹‰æŒ‰é’® ${s[76]+1}`,n=E(),i=w("label"),r=w("input"),a=E(),l=w("span"),l.textContent="å¯ç”¨æ­¤æŒ‰é’®",o=E(),c=w("div"),u=w("label"),u.textContent="æŒ‰é’®åç§°",h=E(),f=w("input"),m=E(),p=w("div"),_=w("label"),_.textContent="å›¾æ ‡ (emoji)",b=E(),y=w("input"),v=E(),C=w("div"),S=w("label"),S.textContent="AIæç¤ºè¯",P=E(),A=w("textarea"),g(t,"class","svelte-j5ryrz"),g(r,"type","checkbox"),g(r,"class","svelte-j5ryrz"),g(i,"class","checkbox-item svelte-j5ryrz"),g(u,"class","svelte-j5ryrz"),g(f,"type","text"),g(f,"placeholder","æŒ‰é’®æ˜¾ç¤ºåç§°"),g(f,"class","svelte-j5ryrz"),g(c,"class","form-group svelte-j5ryrz"),g(_,"class","svelte-j5ryrz"),g(y,"type","text"),g(y,"placeholder","âœ¨"),g(y,"maxlength","2"),g(y,"class","svelte-j5ryrz"),g(p,"class","form-group svelte-j5ryrz"),g(S,"class","svelte-j5ryrz"),g(A,"placeholder","è¾“å…¥AIæç¤ºè¯ï¼Œä¾‹å¦‚ï¼šè¯·å°†ä»¥ä¸‹å†…å®¹è½¬æ¢æˆè¡¨æ ¼å½¢å¼ï¼š"),g(A,"rows","3"),g(A,"class","svelte-j5ryrz"),g(C,"class","form-group svelte-j5ryrz"),g(e,"class","custom-button-form svelte-j5ryrz")},m(B,x){$(B,e,x),d(e,t),d(e,n),d(e,i),d(i,r),r.checked=s[74].enabled,d(i,a),d(i,l),d(e,o),d(e,c),d(c,u),d(c,h),d(c,f),te(f,s[74].name),d(e,m),d(e,p),d(p,_),d(p,b),d(p,y),te(y,s[74].icon),d(e,v),d(e,C),d(C,S),d(C,P),d(C,A),te(A,s[74].prompt),k||(M=[O(r,"change",T),O(r,"change",F),O(f,"input",D),O(f,"input",s[59]),O(y,"input",R),O(y,"input",s[61]),O(A,"input",I),O(A,"input",s[63])],k=!0)},p(B,x){s=B,x[0]&8&&(r.checked=s[74].enabled),x[0]&8&&f.value!==s[74].name&&te(f,s[74].name),x[0]&8&&y.value!==s[74].icon&&te(y,s[74].icon),x[0]&8&&te(A,s[74].prompt)},d(B){B&&j(e),k=!1,Ce(M)}}}function di(s){let e,t;return{c(){e=w("div"),t=V(s[10]),g(e,"class","save-message svelte-j5ryrz")},m(n,i){$(n,e,i),d(e,t)},p(n,i){i[0]&1024&&Y(t,n[10])},d(n){n&&j(e)}}}function mi(s){let e,t;return{c(){e=w("div"),t=V(s[10]),g(e,"class","save-message svelte-j5ryrz")},m(n,i){$(n,e,i),d(e,t)},p(n,i){i[0]&1024&&Y(t,n[10])},d(n){n&&j(e)}}}function Ho(s){let e,t,n,i,r,a,l,o;function c(f,m){return f[2].length===0?qo:Jo}let u=c(s),h=u(s);return{c(){e=w("div"),t=w("div"),n=w("h3"),n.textContent="å·²é…ç½®çš„æä¾›å•†",i=E(),r=w("button"),r.textContent="+ æ·»åŠ æä¾›å•†",a=E(),h.c(),g(n,"class","svelte-j5ryrz"),g(r,"class","btn-primary svelte-j5ryrz"),g(t,"class","section-header svelte-j5ryrz"),g(e,"class","providers-list svelte-j5ryrz")},m(f,m){$(f,e,m),d(e,t),d(t,n),d(t,i),d(t,r),d(e,a),h.m(e,null),l||(o=O(r,"click",s[11]),l=!0)},p(f,m){u===(u=c(f))&&h?h.p(f,m):(h.d(1),h=u(f),h&&(h.c(),h.m(e,null)))},d(f){f&&j(e),h.d(),l=!1,o()}}}function Vo(s){let e,t,n=s[6]?"æ·»åŠ æä¾›å•†":"ç¼–è¾‘æä¾›å•†",i,r,a,l,o,c,u,h,f,m,p,_,b,y,v,C,S,P,A,k,M,T,F,D,R,I,B,x,G,X,W,ee,ae,Re,K,ke,Ee,Ye,rt,Ve,Ze,Pe,Me,Oe,Ae,mt,$e,et,le=s[6]&&bi(s);function pt(J,ne){if(J[7]==="success")return Ko;if(J[7]==="error")return Xo}let Fe=pt(s),oe=Fe&&Fe(s);function gt(J,ne){return J[7]==="testing"?Qo:Go}let Be=gt(s),he=Be(s),be=!s[9]&&vi();return{c(){e=w("div"),t=w("h3"),i=V(n),r=E(),le&&le.c(),a=E(),l=w("div"),o=w("label"),o.textContent="åç§° *",c=E(),u=w("input"),h=E(),f=w("div"),m=w("label"),m.textContent="APIåœ°å€ *",p=E(),_=w("input"),b=E(),y=w("div"),v=w("label"),v.textContent="APIå¯†é’¥",C=E(),S=w("input"),P=E(),A=w("div"),k=w("label"),k.textContent="æ¨¡åž‹åç§° *",M=E(),T=w("input"),F=E(),D=w("div"),R=w("div"),I=w("label"),I.textContent="æ¸©åº¦ (0-2)",B=E(),x=w("input"),G=E(),X=w("div"),W=w("label"),W.textContent="æœ€å¤§Token",ee=E(),ae=w("input"),Re=E(),oe&&oe.c(),K=E(),ke=w("div"),Ee=w("button"),he.c(),rt=E(),Ve=w("button"),Ve.textContent="å–æ¶ˆ",Ze=E(),Pe=w("button"),Me=V("ä¿å­˜"),mt=E(),be&&be.c(),g(t,"class","svelte-j5ryrz"),g(o,"class","svelte-j5ryrz"),g(u,"type","text"),g(u,"placeholder","ä¾‹å¦‚ï¼šOllamaæœ¬åœ°"),g(u,"class","svelte-j5ryrz"),g(l,"class","form-group svelte-j5ryrz"),g(m,"class","svelte-j5ryrz"),g(_,"type","text"),g(_,"placeholder","http://localhost:11434/v1"),g(_,"class","svelte-j5ryrz"),g(f,"class","form-group svelte-j5ryrz"),g(v,"class","svelte-j5ryrz"),g(S,"type","password"),g(S,"placeholder","sk-..."),g(S,"class","svelte-j5ryrz"),g(y,"class","form-group svelte-j5ryrz"),g(k,"class","svelte-j5ryrz"),g(T,"type","text"),g(T,"placeholder","llama3.2"),g(T,"class","svelte-j5ryrz"),g(A,"class","form-group svelte-j5ryrz"),g(I,"class","svelte-j5ryrz"),g(x,"type","number"),g(x,"min","0"),g(x,"max","2"),g(x,"step","0.1"),g(x,"class","svelte-j5ryrz"),g(R,"class","form-group svelte-j5ryrz"),g(W,"class","svelte-j5ryrz"),g(ae,"type","number"),g(ae,"min","100"),g(ae,"max","8192"),g(ae,"class","svelte-j5ryrz"),g(X,"class","form-group svelte-j5ryrz"),g(D,"class","form-row svelte-j5ryrz"),g(Ee,"class","btn-test svelte-j5ryrz"),Ee.disabled=Ye=s[7]==="testing",g(Ve,"class","btn-secondary svelte-j5ryrz"),g(Pe,"class","btn-primary svelte-j5ryrz"),Pe.disabled=Oe=!s[9],g(Pe,"title",Ae=s[9]?"":"è¯·å…ˆé€šè¿‡è¿žæŽ¥æµ‹è¯•"),g(ke,"class","form-actions svelte-j5ryrz"),g(e,"class","provider-form svelte-j5ryrz")},m(J,ne){$(J,e,ne),d(e,t),d(t,i),d(e,r),le&&le.m(e,null),d(e,a),d(e,l),d(l,o),d(l,c),d(l,u),te(u,s[5].name),d(e,h),d(e,f),d(f,m),d(f,p),d(f,_),te(_,s[5].baseURL),d(e,b),d(e,y),d(y,v),d(y,C),d(y,S),te(S,s[5].apiKey),d(e,P),d(e,A),d(A,k),d(A,M),d(A,T),te(T,s[5].model),d(e,F),d(e,D),d(D,R),d(R,I),d(R,B),d(R,x),te(x,s[5].temperature),d(D,G),d(D,X),d(X,W),d(X,ee),d(X,ae),te(ae,s[5].maxTokens),d(e,Re),oe&&oe.m(e,null),d(e,K),d(e,ke),d(ke,Ee),he.m(Ee,null),d(ke,rt),d(ke,Ve),d(ke,Ze),d(ke,Pe),d(Pe,Me),d(e,mt),be&&be.m(e,null),$e||(et=[O(u,"input",s[27]),O(_,"input",s[28]),O(S,"input",s[29]),O(T,"input",s[30]),O(x,"input",s[31]),O(ae,"input",s[32]),O(Ee,"click",s[16]),O(Ve,"click",s[13]),O(Pe,"click",s[14])],$e=!0)},p(J,ne){ne[0]&64&&n!==(n=J[6]?"æ·»åŠ æä¾›å•†":"ç¼–è¾‘æä¾›å•†")&&Y(i,n),J[6]?le?le.p(J,ne):(le=bi(J),le.c(),le.m(e,a)):le&&(le.d(1),le=null),ne[0]&32&&u.value!==J[5].name&&te(u,J[5].name),ne[0]&32&&_.value!==J[5].baseURL&&te(_,J[5].baseURL),ne[0]&32&&S.value!==J[5].apiKey&&te(S,J[5].apiKey),ne[0]&32&&T.value!==J[5].model&&te(T,J[5].model),ne[0]&32&&Dn(x.value)!==J[5].temperature&&te(x,J[5].temperature),ne[0]&32&&Dn(ae.value)!==J[5].maxTokens&&te(ae,J[5].maxTokens),Fe===(Fe=pt(J))&&oe?oe.p(J,ne):(oe&&oe.d(1),oe=Fe&&Fe(J),oe&&(oe.c(),oe.m(e,K))),Be!==(Be=gt(J))&&(he.d(1),he=Be(J),he&&(he.c(),he.m(Ee,null))),ne[0]&128&&Ye!==(Ye=J[7]==="testing")&&(Ee.disabled=Ye),ne[0]&512&&Oe!==(Oe=!J[9])&&(Pe.disabled=Oe),ne[0]&512&&Ae!==(Ae=J[9]?"":"è¯·å…ˆé€šè¿‡è¿žæŽ¥æµ‹è¯•")&&g(Pe,"title",Ae),J[9]?be&&(be.d(1),be=null):be||(be=vi(),be.c(),be.m(e,null))},d(J){J&&j(e),le&&le.d(),oe&&oe.d(),he.d(),be&&be.d(),$e=!1,Ce(et)}}}function Jo(s){let e,t=ue(s[2]),n=[];for(let i=0;i<t.length;i+=1)n[i]=_i(ui(s,t,i));return{c(){for(let i=0;i<n.length;i+=1)n[i].c();e=Bi()},m(i,r){for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(i,r);$(i,e,r)},p(i,r){if(r[0]&167940){t=ue(i[2]);let a;for(a=0;a<t.length;a+=1){const l=ui(i,t,a);n[a]?n[a].p(l,r):(n[a]=_i(l),n[a].c(),n[a].m(e.parentNode,e))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},d(i){i&&j(e),Qe(n,i)}}}function qo(s){let e,t,n,i,r,a;return{c(){e=w("div"),t=w("p"),t.textContent="æš‚æ— é…ç½®çš„AIæä¾›å•†",n=E(),i=w("button"),i.textContent="æ·»åŠ ç¬¬ä¸€ä¸ªæä¾›å•†",g(t,"class","svelte-j5ryrz"),g(i,"class","btn-primary svelte-j5ryrz"),g(e,"class","empty-state svelte-j5ryrz")},m(l,o){$(l,e,o),d(e,t),d(e,n),d(e,i),r||(a=O(i,"click",s[11]),r=!0)},p:ze,d(l){l&&j(e),r=!1,a()}}}function pi(s){let e;return{c(){e=w("span"),e.textContent="é»˜è®¤",g(e,"class","badge svelte-j5ryrz")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function gi(s){let e,t,n;function i(){return s[33](s[71])}return{c(){e=w("button"),e.textContent="è®¾ä¸ºé»˜è®¤",g(e,"class","btn-text svelte-j5ryrz")},m(r,a){$(r,e,a),t||(n=O(e,"click",i),t=!0)},p(r,a){s=r},d(r){r&&j(e),t=!1,n()}}}function _i(s){let e,t,n,i=s[71].name+"",r,a,l,o,c=s[71].model+"",u,h,f=s[71].baseURL+"",m,p,_,b,y,v,C,S,P,A,k=s[71].isDefault&&pi(),M=!s[71].isDefault&&gi(s);function T(){return s[34](s[71])}function F(){return s[35](s[71])}return{c(){e=w("div"),t=w("div"),n=w("div"),r=V(i),a=E(),k&&k.c(),l=E(),o=w("div"),u=V(c),h=V(" @ "),m=V(f),p=E(),_=w("div"),M&&M.c(),b=E(),y=w("button"),y.textContent="âœï¸",v=E(),C=w("button"),C.textContent="ðŸ—‘ï¸",S=E(),g(n,"class","provider-name svelte-j5ryrz"),g(o,"class","provider-details svelte-j5ryrz"),g(t,"class","provider-info"),g(y,"class","btn-icon svelte-j5ryrz"),g(C,"class","btn-icon svelte-j5ryrz"),g(_,"class","provider-actions svelte-j5ryrz"),g(e,"class","provider-card svelte-j5ryrz"),ce(e,"default",s[71].isDefault)},m(D,R){$(D,e,R),d(e,t),d(t,n),d(n,r),d(n,a),k&&k.m(n,null),d(t,l),d(t,o),d(o,u),d(o,h),d(o,m),d(e,p),d(e,_),M&&M.m(_,null),d(_,b),d(_,y),d(_,v),d(_,C),d(e,S),P||(A=[O(y,"click",T),O(C,"click",F)],P=!0)},p(D,R){s=D,R[0]&4&&i!==(i=s[71].name+"")&&Y(r,i),s[71].isDefault?k||(k=pi(),k.c(),k.m(n,null)):k&&(k.d(1),k=null),R[0]&4&&c!==(c=s[71].model+"")&&Y(u,c),R[0]&4&&f!==(f=s[71].baseURL+"")&&Y(m,f),s[71].isDefault?M&&(M.d(1),M=null):M?M.p(s,R):(M=gi(s),M.c(),M.m(_,b)),R[0]&4&&ce(e,"default",s[71].isDefault)},d(D){D&&j(e),k&&k.d(),M&&M.d(),P=!1,Ce(A)}}}function bi(s){let e,t,n,i=ue(Xr),r=[];for(let a=0;a<i.length;a+=1)r[a]=wi(hi(s,i,a));return{c(){e=w("div"),t=w("label"),t.textContent="å¿«é€Ÿæ¨¡æ¿ï¼š",n=E();for(let a=0;a<r.length;a+=1)r[a].c();g(t,"class","svelte-j5ryrz"),g(e,"class","template-buttons svelte-j5ryrz")},m(a,l){$(a,e,l),d(e,t),d(e,n);for(let o=0;o<r.length;o+=1)r[o]&&r[o].m(e,null)},p(a,l){if(l[0]&262144){i=ue(Xr);let o;for(o=0;o<i.length;o+=1){const c=hi(a,i,o);r[o]?r[o].p(c,l):(r[o]=wi(c),r[o].c(),r[o].m(e,null))}for(;o<r.length;o+=1)r[o].d(1);r.length=i.length}},d(a){a&&j(e),Qe(r,a)}}}function wi(s){let e,t,n;function i(){return s[26](s[68])}return{c(){e=w("button"),e.textContent=`${s[68].name} `,g(e,"class","template-btn svelte-j5ryrz")},m(r,a){$(r,e,a),t||(n=O(e,"click",i),t=!0)},p(r,a){s=r},d(r){r&&j(e),t=!1,n()}}}function Xo(s){let e,t,n,i,r;return{c(){e=w("div"),t=w("div"),t.textContent="âŒ è¿žæŽ¥å¤±è´¥",n=E(),i=w("div"),r=V(s[8]),g(t,"class","test-result-header svelte-j5ryrz"),g(i,"class","test-result-content svelte-j5ryrz"),g(e,"class","test-result error svelte-j5ryrz")},m(a,l){$(a,e,l),d(e,t),d(e,n),d(e,i),d(i,r)},p(a,l){l[0]&256&&Y(r,a[8])},d(a){a&&j(e)}}}function Ko(s){let e,t,n,i,r;return{c(){e=w("div"),t=w("div"),t.textContent="âœ… è¿žæŽ¥æˆåŠŸ",n=E(),i=w("div"),r=V(s[8]),g(t,"class","test-result-header svelte-j5ryrz"),g(i,"class","test-result-content svelte-j5ryrz"),g(e,"class","test-result success svelte-j5ryrz")},m(a,l){$(a,e,l),d(e,t),d(e,n),d(e,i),d(i,r)},p(a,l){l[0]&256&&Y(r,a[8])},d(a){a&&j(e)}}}function Go(s){let e;return{c(){e=V("æµ‹è¯•è¿žæŽ¥")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function Qo(s){let e;return{c(){e=V("æµ‹è¯•ä¸­...")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function vi(s){let e;return{c(){e=w("div"),e.textContent='âš ï¸ è¯·å…ˆç‚¹å‡»"æµ‹è¯•è¿žæŽ¥"æŒ‰é’®ï¼Œæµ‹è¯•é€šè¿‡åŽæ‰èƒ½ä¿å­˜',g(e,"class","test-warning svelte-j5ryrz")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function Yo(s){let e,t,n,i,r,a,l,o,c,u,h,f,m,p,_,b,y,v;function C(A,k){if(A[1]==="providers")return Wo;if(A[1]==="toolbar")return Uo;if(A[1]==="ui")return $o;if(A[1]==="prompts")return zo}let S=C(s),P=S&&S(s);return{c(){e=w("div"),t=w("div"),n=w("h2"),n.textContent="âš™ï¸ AIåŠ©æ‰‹è®¾ç½®",i=E(),r=w("button"),r.textContent="âœ•",a=E(),l=w("div"),o=w("button"),o.textContent="AIæä¾›å•†",c=E(),u=w("button"),u.textContent="å·¥å…·æ ",h=E(),f=w("button"),f.textContent="ç•Œé¢è®¾ç½®",m=E(),p=w("button"),p.textContent="è‡ªå®šä¹‰æç¤ºè¯",_=E(),b=w("div"),P&&P.c(),g(n,"class","svelte-j5ryrz"),g(r,"class","btn-close svelte-j5ryrz"),g(t,"class","settings-header svelte-j5ryrz"),g(o,"class","tab-btn svelte-j5ryrz"),ce(o,"active",s[1]==="providers"),g(u,"class","tab-btn svelte-j5ryrz"),ce(u,"active",s[1]==="toolbar"),g(f,"class","tab-btn svelte-j5ryrz"),ce(f,"active",s[1]==="ui"),g(p,"class","tab-btn svelte-j5ryrz"),ce(p,"active",s[1]==="prompts"),g(l,"class","settings-tabs svelte-j5ryrz"),g(b,"class","settings-content svelte-j5ryrz"),g(e,"class","settings-panel svelte-j5ryrz")},m(A,k){$(A,e,k),d(e,t),d(t,n),d(t,i),d(t,r),d(e,a),d(e,l),d(l,o),d(l,c),d(l,u),d(l,h),d(l,f),d(l,m),d(l,p),d(e,_),d(e,b),P&&P.m(b,null),y||(v=[O(r,"click",function(){tn(s[0])&&s[0].apply(this,arguments)}),O(o,"click",s[22]),O(u,"click",s[23]),O(f,"click",s[24]),O(p,"click",s[25])],y=!0)},p(A,k){s=A,k[0]&2&&ce(o,"active",s[1]==="providers"),k[0]&2&&ce(u,"active",s[1]==="toolbar"),k[0]&2&&ce(f,"active",s[1]==="ui"),k[0]&2&&ce(p,"active",s[1]==="prompts"),S===(S=C(s))&&P?P.p(s,k):(P&&P.d(1),P=S&&S(s),P&&(P.c(),P.m(b,null)))},i:ze,o:ze,d(A){A&&j(e),P&&P.d(),y=!1,Ce(v)}}}function Zo(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function ec(s,e,t){let{onClose:n=()=>{}}=e,i="providers",r=[],a=[],l={polish:!0,translate:!0,summarize:!0,expand:!0,condense:!1,rewrite:!1,continue:!1,custom1:!1,custom2:!1,custom3:!1},o=null,c=!1,u="idle",h="",f=!1;ks(()=>{m()});function m(){const N=Q.getSettings();t(2,r=N.providers),t(3,a=N.customButtons),t(4,l=N.toolbarButtons)}function p(){t(6,c=!0),t(5,o={id:Zo(),name:"",apiKey:"",baseURL:"",model:"",temperature:.7,maxTokens:2048,isDefault:r.length===0})}function _(N){t(6,c=!1),t(5,o={...N})}function b(){t(5,o=null),t(6,c=!1),t(7,u="idle")}async function y(){if(o){if(!o.name||!o.baseURL||!o.model){alert("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ");return}c?await Q.addProvider(o):await Q.updateProvider(o.id,o),m(),t(5,o=null),t(6,c=!1)}}async function v(N){confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæä¾›å•†å—ï¼Ÿ")&&(await Q.deleteProvider(N),m())}async function C(){var fe;if(!o)return;t(7,u="testing"),t(8,h=""),t(9,f=!1);const N=ge.getCurrentProvider();ge.setProvider(o);try{const tt=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AIåŠ©æ‰‹ã€‚"},{role:"user",content:"ä½ å¥½ï¼Œè¿™æ˜¯æµ‹è¯•"}],lt=await((fe=ge.adapter)==null?void 0:fe.chatCompletion(tt));lt&&lt.content&&lt.content.length>0?(t(7,u="success"),t(8,h=lt.content),t(9,f=!0)):(t(7,u="error"),t(8,h="AIè¿”å›žç©ºå†…å®¹"),t(9,f=!1))}catch(at){t(7,u="error"),t(8,h=at instanceof Error?at.message:"è¿žæŽ¥å¤±è´¥"),t(9,f=!1)}finally{N&&ge.setProvider(N)}}async function S(N){await Q.setCurrentProvider(N),m()}function P(N){o&&t(5,o={...o,name:N.name,baseURL:N.baseURL,model:N.model,apiKey:N.apiKey,temperature:N.temperature,maxTokens:N.maxTokens})}async function A(){await Q.updateCustomButtons(a),await M(),D("è‡ªå®šä¹‰æŒ‰é’®é…ç½®å·²ä¿å­˜")}async function k(){await Q.updateToolbarButtons(l),D("å·¥å…·æ é…ç½®å·²ä¿å­˜")}async function M(){const N=Q.getSettings().toolbarButtons;a.forEach((fe,at)=>{const tt=`custom${at+1}`;tt in N&&t(4,l[tt]=fe.enabled,l)}),await Q.updateToolbarButtons(l)}let T="",F=null;function D(N){t(10,T=N),F&&clearTimeout(F),F=window.setTimeout(()=>{t(10,T="")},2e3)}function R(N){const fe=`custom${N+1}`;fe in l&&t(4,l[fe]=a[N].enabled,l),Promise.all([Q.updateCustomButtons(a),Q.updateToolbarButtons(l)]).then(()=>{D("å·²è‡ªåŠ¨ä¿å­˜")})}const I=()=>t(1,i="providers"),B=()=>t(1,i="toolbar"),x=()=>t(1,i="ui"),G=()=>t(1,i="prompts"),X=N=>P(N);function W(){o.name=this.value,t(5,o)}function ee(){o.baseURL=this.value,t(5,o)}function ae(){o.apiKey=this.value,t(5,o)}function Re(){o.model=this.value,t(5,o)}function K(){o.temperature=Dn(this.value),t(5,o)}function ke(){o.maxTokens=Dn(this.value),t(5,o)}const Ee=N=>S(N.id),Ye=N=>_(N),rt=N=>v(N.id);function Ve(){l.polish=this.checked,t(4,l)}const Ze=()=>k();function Pe(){l.translate=this.checked,t(4,l)}const Me=()=>k();function Oe(){l.summarize=this.checked,t(4,l)}const Ae=()=>k();function mt(){l.expand=this.checked,t(4,l)}const $e=()=>k();function et(){l.condense=this.checked,t(4,l)}const le=()=>k();function pt(){l.rewrite=this.checked,t(4,l)}const Fe=()=>k();function oe(){l.continue=this.checked,t(4,l)}const gt=()=>k();function Be(){l.custom1=this.checked,t(4,l)}const he=()=>k();function be(){l.custom2=this.checked,t(4,l)}const J=()=>k();function ne(){l.custom3=this.checked,t(4,l)}const zt=()=>k();function un(N,fe){N[fe].enabled=this.checked,t(3,a)}const At=N=>R(N);function $t(N,fe){N[fe].name=this.value,t(3,a)}const hn=()=>A();function it(N,fe){N[fe].icon=this.value,t(3,a)}const Je=()=>A();function fn(N,fe){N[fe].prompt=this.value,t(3,a)}const _t=()=>A();return s.$$set=N=>{"onClose"in N&&t(0,n=N.onClose)},[n,i,r,a,l,o,c,u,h,f,T,p,_,b,y,v,C,S,P,A,k,R,I,B,x,G,X,W,ee,ae,Re,K,ke,Ee,Ye,rt,Ve,Ze,Pe,Me,Oe,Ae,mt,$e,et,le,pt,Fe,oe,gt,Be,he,be,J,ne,zt,un,At,$t,hn,it,Je,fn,_t]}class tc extends Cs{constructor(e){super(),As(this,e,ec,Yo,Ss,{onClose:0},null,[-1,-1,-1])}}function nc(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var rl={exports:{}};(function(s){var e=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},t=-1,n=1,i=0;e.Diff=function(r,a){return[r,a]},e.prototype.diff_main=function(r,a,l,o){typeof o>"u"&&(this.Diff_Timeout<=0?o=Number.MAX_VALUE:o=new Date().getTime()+this.Diff_Timeout*1e3);var c=o;if(r==null||a==null)throw new Error("Null input. (diff_main)");if(r==a)return r?[new e.Diff(i,r)]:[];typeof l>"u"&&(l=!0);var u=l,h=this.diff_commonPrefix(r,a),f=r.substring(0,h);r=r.substring(h),a=a.substring(h),h=this.diff_commonSuffix(r,a);var m=r.substring(r.length-h);r=r.substring(0,r.length-h),a=a.substring(0,a.length-h);var p=this.diff_compute_(r,a,u,c);return f&&p.unshift(new e.Diff(i,f)),m&&p.push(new e.Diff(i,m)),this.diff_cleanupMerge(p),p},e.prototype.diff_compute_=function(r,a,l,o){var c;if(!r)return[new e.Diff(n,a)];if(!a)return[new e.Diff(t,r)];var u=r.length>a.length?r:a,h=r.length>a.length?a:r,f=u.indexOf(h);if(f!=-1)return c=[new e.Diff(n,u.substring(0,f)),new e.Diff(i,h),new e.Diff(n,u.substring(f+h.length))],r.length>a.length&&(c[0][0]=c[2][0]=t),c;if(h.length==1)return[new e.Diff(t,r),new e.Diff(n,a)];var m=this.diff_halfMatch_(r,a);if(m){var p=m[0],_=m[1],b=m[2],y=m[3],v=m[4],C=this.diff_main(p,b,l,o),S=this.diff_main(_,y,l,o);return C.concat([new e.Diff(i,v)],S)}return l&&r.length>100&&a.length>100?this.diff_lineMode_(r,a,o):this.diff_bisect_(r,a,o)},e.prototype.diff_lineMode_=function(r,a,l){var o=this.diff_linesToChars_(r,a);r=o.chars1,a=o.chars2;var c=o.lineArray,u=this.diff_main(r,a,!1,l);this.diff_charsToLines_(u,c),this.diff_cleanupSemantic(u),u.push(new e.Diff(i,""));for(var h=0,f=0,m=0,p="",_="";h<u.length;){switch(u[h][0]){case n:m++,_+=u[h][1];break;case t:f++,p+=u[h][1];break;case i:if(f>=1&&m>=1){u.splice(h-f-m,f+m),h=h-f-m;for(var b=this.diff_main(p,_,!1,l),y=b.length-1;y>=0;y--)u.splice(h,0,b[y]);h=h+b.length}m=0,f=0,p="",_="";break}h++}return u.pop(),u},e.prototype.diff_bisect_=function(r,a,l){for(var o=r.length,c=a.length,u=Math.ceil((o+c)/2),h=u,f=2*u,m=new Array(f),p=new Array(f),_=0;_<f;_++)m[_]=-1,p[_]=-1;m[h+1]=0,p[h+1]=0;for(var b=o-c,y=b%2!=0,v=0,C=0,S=0,P=0,A=0;A<u&&!(new Date().getTime()>l);A++){for(var k=-A+v;k<=A-C;k+=2){var M=h+k,T;k==-A||k!=A&&m[M-1]<m[M+1]?T=m[M+1]:T=m[M-1]+1;for(var F=T-k;T<o&&F<c&&r.charAt(T)==a.charAt(F);)T++,F++;if(m[M]=T,T>o)C+=2;else if(F>c)v+=2;else if(y){var D=h+b-k;if(D>=0&&D<f&&p[D]!=-1){var R=o-p[D];if(T>=R)return this.diff_bisectSplit_(r,a,T,F,l)}}}for(var I=-A+S;I<=A-P;I+=2){var D=h+I,R;I==-A||I!=A&&p[D-1]<p[D+1]?R=p[D+1]:R=p[D-1]+1;for(var B=R-I;R<o&&B<c&&r.charAt(o-R-1)==a.charAt(c-B-1);)R++,B++;if(p[D]=R,R>o)P+=2;else if(B>c)S+=2;else if(!y){var M=h+b-I;if(M>=0&&M<f&&m[M]!=-1){var T=m[M],F=h+T-M;if(R=o-R,T>=R)return this.diff_bisectSplit_(r,a,T,F,l)}}}}return[new e.Diff(t,r),new e.Diff(n,a)]},e.prototype.diff_bisectSplit_=function(r,a,l,o,c){var u=r.substring(0,l),h=a.substring(0,o),f=r.substring(l),m=a.substring(o),p=this.diff_main(u,h,!1,c),_=this.diff_main(f,m,!1,c);return p.concat(_)},e.prototype.diff_linesToChars_=function(r,a){var l=[],o={};l[0]="";function c(m){for(var p="",_=0,b=-1,y=l.length;b<m.length-1;){b=m.indexOf(`
`,_),b==-1&&(b=m.length-1);var v=m.substring(_,b+1);(o.hasOwnProperty?o.hasOwnProperty(v):o[v]!==void 0)?p+=String.fromCharCode(o[v]):(y==u&&(v=m.substring(_),b=m.length),p+=String.fromCharCode(y),o[v]=y,l[y++]=v),_=b+1}return p}var u=4e4,h=c(r);u=65535;var f=c(a);return{chars1:h,chars2:f,lineArray:l}},e.prototype.diff_charsToLines_=function(r,a){for(var l=0;l<r.length;l++){for(var o=r[l][1],c=[],u=0;u<o.length;u++)c[u]=a[o.charCodeAt(u)];r[l][1]=c.join("")}},e.prototype.diff_commonPrefix=function(r,a){if(!r||!a||r.charAt(0)!=a.charAt(0))return 0;for(var l=0,o=Math.min(r.length,a.length),c=o,u=0;l<c;)r.substring(u,c)==a.substring(u,c)?(l=c,u=l):o=c,c=Math.floor((o-l)/2+l);return c},e.prototype.diff_commonSuffix=function(r,a){if(!r||!a||r.charAt(r.length-1)!=a.charAt(a.length-1))return 0;for(var l=0,o=Math.min(r.length,a.length),c=o,u=0;l<c;)r.substring(r.length-c,r.length-u)==a.substring(a.length-c,a.length-u)?(l=c,u=l):o=c,c=Math.floor((o-l)/2+l);return c},e.prototype.diff_commonOverlap_=function(r,a){var l=r.length,o=a.length;if(l==0||o==0)return 0;l>o?r=r.substring(l-o):l<o&&(a=a.substring(0,l));var c=Math.min(l,o);if(r==a)return c;for(var u=0,h=1;;){var f=r.substring(c-h),m=a.indexOf(f);if(m==-1)return u;h+=m,(m==0||r.substring(c-h)==a.substring(0,h))&&(u=h,h++)}},e.prototype.diff_halfMatch_=function(r,a){if(this.Diff_Timeout<=0)return null;var l=r.length>a.length?r:a,o=r.length>a.length?a:r;if(l.length<4||o.length*2<l.length)return null;var c=this;function u(C,S,P){for(var A=C.substring(P,P+Math.floor(C.length/4)),k=-1,M="",T,F,D,R;(k=S.indexOf(A,k+1))!=-1;){var I=c.diff_commonPrefix(C.substring(P),S.substring(k)),B=c.diff_commonSuffix(C.substring(0,P),S.substring(0,k));M.length<B+I&&(M=S.substring(k-B,k)+S.substring(k,k+I),T=C.substring(0,P-B),F=C.substring(P+I),D=S.substring(0,k-B),R=S.substring(k+I))}return M.length*2>=C.length?[T,F,D,R,M]:null}var h=u(l,o,Math.ceil(l.length/4)),f=u(l,o,Math.ceil(l.length/2)),m;if(!h&&!f)return null;f?h?m=h[4].length>f[4].length?h:f:m=f:m=h;var p,_,b,y;r.length>a.length?(p=m[0],_=m[1],b=m[2],y=m[3]):(b=m[0],y=m[1],p=m[2],_=m[3]);var v=m[4];return[p,_,b,y,v]},e.prototype.diff_cleanupSemantic=function(r){for(var a=!1,l=[],o=0,c=null,u=0,h=0,f=0,m=0,p=0;u<r.length;)r[u][0]==i?(l[o++]=u,h=m,f=p,m=0,p=0,c=r[u][1]):(r[u][0]==n?m+=r[u][1].length:p+=r[u][1].length,c&&c.length<=Math.max(h,f)&&c.length<=Math.max(m,p)&&(r.splice(l[o-1],0,new e.Diff(t,c)),r[l[o-1]+1][0]=n,o--,o--,u=o>0?l[o-1]:-1,h=0,f=0,m=0,p=0,c=null,a=!0)),u++;for(a&&this.diff_cleanupMerge(r),this.diff_cleanupSemanticLossless(r),u=1;u<r.length;){if(r[u-1][0]==t&&r[u][0]==n){var _=r[u-1][1],b=r[u][1],y=this.diff_commonOverlap_(_,b),v=this.diff_commonOverlap_(b,_);y>=v?(y>=_.length/2||y>=b.length/2)&&(r.splice(u,0,new e.Diff(i,b.substring(0,y))),r[u-1][1]=_.substring(0,_.length-y),r[u+1][1]=b.substring(y),u++):(v>=_.length/2||v>=b.length/2)&&(r.splice(u,0,new e.Diff(i,_.substring(0,v))),r[u-1][0]=n,r[u-1][1]=b.substring(0,b.length-v),r[u+1][0]=t,r[u+1][1]=_.substring(v),u++),u++}u++}},e.prototype.diff_cleanupSemanticLossless=function(r){function a(v,C){if(!v||!C)return 6;var S=v.charAt(v.length-1),P=C.charAt(0),A=S.match(e.nonAlphaNumericRegex_),k=P.match(e.nonAlphaNumericRegex_),M=A&&S.match(e.whitespaceRegex_),T=k&&P.match(e.whitespaceRegex_),F=M&&S.match(e.linebreakRegex_),D=T&&P.match(e.linebreakRegex_),R=F&&v.match(e.blanklineEndRegex_),I=D&&C.match(e.blanklineStartRegex_);return R||I?5:F||D?4:A&&!M&&T?3:M||T?2:A||k?1:0}for(var l=1;l<r.length-1;){if(r[l-1][0]==i&&r[l+1][0]==i){var o=r[l-1][1],c=r[l][1],u=r[l+1][1],h=this.diff_commonSuffix(o,c);if(h){var f=c.substring(c.length-h);o=o.substring(0,o.length-h),c=f+c.substring(0,c.length-h),u=f+u}for(var m=o,p=c,_=u,b=a(o,c)+a(c,u);c.charAt(0)===u.charAt(0);){o+=c.charAt(0),c=c.substring(1)+u.charAt(0),u=u.substring(1);var y=a(o,c)+a(c,u);y>=b&&(b=y,m=o,p=c,_=u)}r[l-1][1]!=m&&(m?r[l-1][1]=m:(r.splice(l-1,1),l--),r[l][1]=p,_?r[l+1][1]=_:(r.splice(l+1,1),l--))}l++}},e.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,e.whitespaceRegex_=/\s/,e.linebreakRegex_=/[\r\n]/,e.blanklineEndRegex_=/\n\r?\n$/,e.blanklineStartRegex_=/^\r?\n\r?\n/,e.prototype.diff_cleanupEfficiency=function(r){for(var a=!1,l=[],o=0,c=null,u=0,h=!1,f=!1,m=!1,p=!1;u<r.length;)r[u][0]==i?(r[u][1].length<this.Diff_EditCost&&(m||p)?(l[o++]=u,h=m,f=p,c=r[u][1]):(o=0,c=null),m=p=!1):(r[u][0]==t?p=!0:m=!0,c&&(h&&f&&m&&p||c.length<this.Diff_EditCost/2&&h+f+m+p==3)&&(r.splice(l[o-1],0,new e.Diff(t,c)),r[l[o-1]+1][0]=n,o--,c=null,h&&f?(m=p=!0,o=0):(o--,u=o>0?l[o-1]:-1,m=p=!1),a=!0)),u++;a&&this.diff_cleanupMerge(r)},e.prototype.diff_cleanupMerge=function(r){r.push(new e.Diff(i,""));for(var a=0,l=0,o=0,c="",u="",h;a<r.length;)switch(r[a][0]){case n:o++,u+=r[a][1],a++;break;case t:l++,c+=r[a][1],a++;break;case i:l+o>1?(l!==0&&o!==0&&(h=this.diff_commonPrefix(u,c),h!==0&&(a-l-o>0&&r[a-l-o-1][0]==i?r[a-l-o-1][1]+=u.substring(0,h):(r.splice(0,0,new e.Diff(i,u.substring(0,h))),a++),u=u.substring(h),c=c.substring(h)),h=this.diff_commonSuffix(u,c),h!==0&&(r[a][1]=u.substring(u.length-h)+r[a][1],u=u.substring(0,u.length-h),c=c.substring(0,c.length-h))),a-=l+o,r.splice(a,l+o),c.length&&(r.splice(a,0,new e.Diff(t,c)),a++),u.length&&(r.splice(a,0,new e.Diff(n,u)),a++),a++):a!==0&&r[a-1][0]==i?(r[a-1][1]+=r[a][1],r.splice(a,1)):a++,o=0,l=0,c="",u="";break}r[r.length-1][1]===""&&r.pop();var f=!1;for(a=1;a<r.length-1;)r[a-1][0]==i&&r[a+1][0]==i&&(r[a][1].substring(r[a][1].length-r[a-1][1].length)==r[a-1][1]?(r[a][1]=r[a-1][1]+r[a][1].substring(0,r[a][1].length-r[a-1][1].length),r[a+1][1]=r[a-1][1]+r[a+1][1],r.splice(a-1,1),f=!0):r[a][1].substring(0,r[a+1][1].length)==r[a+1][1]&&(r[a-1][1]+=r[a+1][1],r[a][1]=r[a][1].substring(r[a+1][1].length)+r[a+1][1],r.splice(a+1,1),f=!0)),a++;f&&this.diff_cleanupMerge(r)},e.prototype.diff_xIndex=function(r,a){var l=0,o=0,c=0,u=0,h;for(h=0;h<r.length&&(r[h][0]!==n&&(l+=r[h][1].length),r[h][0]!==t&&(o+=r[h][1].length),!(l>a));h++)c=l,u=o;return r.length!=h&&r[h][0]===t?u:u+(a-c)},e.prototype.diff_prettyHtml=function(r){for(var a=[],l=/&/g,o=/</g,c=/>/g,u=/\n/g,h=0;h<r.length;h++){var f=r[h][0],m=r[h][1],p=m.replace(l,"&amp;").replace(o,"&lt;").replace(c,"&gt;").replace(u,"&para;<br>");switch(f){case n:a[h]='<ins style="background:#e6ffe6;">'+p+"</ins>";break;case t:a[h]='<del style="background:#ffe6e6;">'+p+"</del>";break;case i:a[h]="<span>"+p+"</span>";break}}return a.join("")},e.prototype.diff_text1=function(r){for(var a=[],l=0;l<r.length;l++)r[l][0]!==n&&(a[l]=r[l][1]);return a.join("")},e.prototype.diff_text2=function(r){for(var a=[],l=0;l<r.length;l++)r[l][0]!==t&&(a[l]=r[l][1]);return a.join("")},e.prototype.diff_levenshtein=function(r){for(var a=0,l=0,o=0,c=0;c<r.length;c++){var u=r[c][0],h=r[c][1];switch(u){case n:l+=h.length;break;case t:o+=h.length;break;case i:a+=Math.max(l,o),l=0,o=0;break}}return a+=Math.max(l,o),a},e.prototype.diff_toDelta=function(r){for(var a=[],l=0;l<r.length;l++)switch(r[l][0]){case n:a[l]="+"+encodeURI(r[l][1]);break;case t:a[l]="-"+r[l][1].length;break;case i:a[l]="="+r[l][1].length;break}return a.join("	").replace(/%20/g," ")},e.prototype.diff_fromDelta=function(r,a){for(var l=[],o=0,c=0,u=a.split(/\t/g),h=0;h<u.length;h++){var f=u[h].substring(1);switch(u[h].charAt(0)){case"+":try{l[o++]=new e.Diff(n,decodeURI(f))}catch{throw new Error("Illegal escape in diff_fromDelta: "+f)}break;case"-":case"=":var m=parseInt(f,10);if(isNaN(m)||m<0)throw new Error("Invalid number in diff_fromDelta: "+f);var p=r.substring(c,c+=m);u[h].charAt(0)=="="?l[o++]=new e.Diff(i,p):l[o++]=new e.Diff(t,p);break;default:if(u[h])throw new Error("Invalid diff operation in diff_fromDelta: "+u[h])}}if(c!=r.length)throw new Error("Delta length ("+c+") does not equal source text length ("+r.length+").");return l},e.prototype.match_main=function(r,a,l){if(r==null||a==null||l==null)throw new Error("Null input. (match_main)");return l=Math.max(0,Math.min(l,r.length)),r==a?0:r.length?r.substring(l,l+a.length)==a?l:this.match_bitap_(r,a,l):-1},e.prototype.match_bitap_=function(r,a,l){if(a.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var o=this.match_alphabet_(a),c=this;function u(T,F){var D=T/a.length,R=Math.abs(l-F);return c.Match_Distance?D+R/c.Match_Distance:R?1:D}var h=this.Match_Threshold,f=r.indexOf(a,l);f!=-1&&(h=Math.min(u(0,f),h),f=r.lastIndexOf(a,l+a.length),f!=-1&&(h=Math.min(u(0,f),h)));var m=1<<a.length-1;f=-1;for(var p,_,b=a.length+r.length,y,v=0;v<a.length;v++){for(p=0,_=b;p<_;)u(v,l+_)<=h?p=_:b=_,_=Math.floor((b-p)/2+p);b=_;var C=Math.max(1,l-_+1),S=Math.min(l+_,r.length)+a.length,P=Array(S+2);P[S+1]=(1<<v)-1;for(var A=S;A>=C;A--){var k=o[r.charAt(A-1)];if(v===0?P[A]=(P[A+1]<<1|1)&k:P[A]=(P[A+1]<<1|1)&k|((y[A+1]|y[A])<<1|1)|y[A+1],P[A]&m){var M=u(v,A-1);if(M<=h)if(h=M,f=A-1,f>l)C=Math.max(1,2*l-f);else break}}if(u(v+1,l)>h)break;y=P}return f},e.prototype.match_alphabet_=function(r){for(var a={},l=0;l<r.length;l++)a[r.charAt(l)]=0;for(var l=0;l<r.length;l++)a[r.charAt(l)]|=1<<r.length-l-1;return a},e.prototype.patch_addContext_=function(r,a){if(a.length!=0){if(r.start2===null)throw Error("patch not initialized");for(var l=a.substring(r.start2,r.start2+r.length1),o=0;a.indexOf(l)!=a.lastIndexOf(l)&&l.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)o+=this.Patch_Margin,l=a.substring(r.start2-o,r.start2+r.length1+o);o+=this.Patch_Margin;var c=a.substring(r.start2-o,r.start2);c&&r.diffs.unshift(new e.Diff(i,c));var u=a.substring(r.start2+r.length1,r.start2+r.length1+o);u&&r.diffs.push(new e.Diff(i,u)),r.start1-=c.length,r.start2-=c.length,r.length1+=c.length+u.length,r.length2+=c.length+u.length}},e.prototype.patch_make=function(r,a,l){var o,c;if(typeof r=="string"&&typeof a=="string"&&typeof l>"u")o=r,c=this.diff_main(o,a,!0),c.length>2&&(this.diff_cleanupSemantic(c),this.diff_cleanupEfficiency(c));else if(r&&typeof r=="object"&&typeof a>"u"&&typeof l>"u")c=r,o=this.diff_text1(c);else if(typeof r=="string"&&a&&typeof a=="object"&&typeof l>"u")o=r,c=a;else if(typeof r=="string"&&typeof a=="string"&&l&&typeof l=="object")o=r,c=l;else throw new Error("Unknown call format to patch_make.");if(c.length===0)return[];for(var u=[],h=new e.patch_obj,f=0,m=0,p=0,_=o,b=o,y=0;y<c.length;y++){var v=c[y][0],C=c[y][1];switch(!f&&v!==i&&(h.start1=m,h.start2=p),v){case n:h.diffs[f++]=c[y],h.length2+=C.length,b=b.substring(0,p)+C+b.substring(p);break;case t:h.length1+=C.length,h.diffs[f++]=c[y],b=b.substring(0,p)+b.substring(p+C.length);break;case i:C.length<=2*this.Patch_Margin&&f&&c.length!=y+1?(h.diffs[f++]=c[y],h.length1+=C.length,h.length2+=C.length):C.length>=2*this.Patch_Margin&&f&&(this.patch_addContext_(h,_),u.push(h),h=new e.patch_obj,f=0,_=b,m=p);break}v!==n&&(m+=C.length),v!==t&&(p+=C.length)}return f&&(this.patch_addContext_(h,_),u.push(h)),u},e.prototype.patch_deepCopy=function(r){for(var a=[],l=0;l<r.length;l++){var o=r[l],c=new e.patch_obj;c.diffs=[];for(var u=0;u<o.diffs.length;u++)c.diffs[u]=new e.Diff(o.diffs[u][0],o.diffs[u][1]);c.start1=o.start1,c.start2=o.start2,c.length1=o.length1,c.length2=o.length2,a[l]=c}return a},e.prototype.patch_apply=function(r,a){if(r.length==0)return[a,[]];r=this.patch_deepCopy(r);var l=this.patch_addPadding(r);a=l+a+l,this.patch_splitMax(r);for(var o=0,c=[],u=0;u<r.length;u++){var h=r[u].start2+o,f=this.diff_text1(r[u].diffs),m,p=-1;if(f.length>this.Match_MaxBits?(m=this.match_main(a,f.substring(0,this.Match_MaxBits),h),m!=-1&&(p=this.match_main(a,f.substring(f.length-this.Match_MaxBits),h+f.length-this.Match_MaxBits),(p==-1||m>=p)&&(m=-1))):m=this.match_main(a,f,h),m==-1)c[u]=!1,o-=r[u].length2-r[u].length1;else{c[u]=!0,o=m-h;var _;if(p==-1?_=a.substring(m,m+f.length):_=a.substring(m,p+this.Match_MaxBits),f==_)a=a.substring(0,m)+this.diff_text2(r[u].diffs)+a.substring(m+f.length);else{var b=this.diff_main(f,_,!1);if(f.length>this.Match_MaxBits&&this.diff_levenshtein(b)/f.length>this.Patch_DeleteThreshold)c[u]=!1;else{this.diff_cleanupSemanticLossless(b);for(var y=0,v,C=0;C<r[u].diffs.length;C++){var S=r[u].diffs[C];S[0]!==i&&(v=this.diff_xIndex(b,y)),S[0]===n?a=a.substring(0,m+v)+S[1]+a.substring(m+v):S[0]===t&&(a=a.substring(0,m+v)+a.substring(m+this.diff_xIndex(b,y+S[1].length))),S[0]!==t&&(y+=S[1].length)}}}}}return a=a.substring(l.length,a.length-l.length),[a,c]},e.prototype.patch_addPadding=function(r){for(var a=this.Patch_Margin,l="",o=1;o<=a;o++)l+=String.fromCharCode(o);for(var o=0;o<r.length;o++)r[o].start1+=a,r[o].start2+=a;var c=r[0],u=c.diffs;if(u.length==0||u[0][0]!=i)u.unshift(new e.Diff(i,l)),c.start1-=a,c.start2-=a,c.length1+=a,c.length2+=a;else if(a>u[0][1].length){var h=a-u[0][1].length;u[0][1]=l.substring(u[0][1].length)+u[0][1],c.start1-=h,c.start2-=h,c.length1+=h,c.length2+=h}if(c=r[r.length-1],u=c.diffs,u.length==0||u[u.length-1][0]!=i)u.push(new e.Diff(i,l)),c.length1+=a,c.length2+=a;else if(a>u[u.length-1][1].length){var h=a-u[u.length-1][1].length;u[u.length-1][1]+=l.substring(0,h),c.length1+=h,c.length2+=h}return l},e.prototype.patch_splitMax=function(r){for(var a=this.Match_MaxBits,l=0;l<r.length;l++)if(!(r[l].length1<=a)){var o=r[l];r.splice(l--,1);for(var c=o.start1,u=o.start2,h="";o.diffs.length!==0;){var f=new e.patch_obj,m=!0;for(f.start1=c-h.length,f.start2=u-h.length,h!==""&&(f.length1=f.length2=h.length,f.diffs.push(new e.Diff(i,h)));o.diffs.length!==0&&f.length1<a-this.Patch_Margin;){var p=o.diffs[0][0],_=o.diffs[0][1];p===n?(f.length2+=_.length,u+=_.length,f.diffs.push(o.diffs.shift()),m=!1):p===t&&f.diffs.length==1&&f.diffs[0][0]==i&&_.length>2*a?(f.length1+=_.length,c+=_.length,m=!1,f.diffs.push(new e.Diff(p,_)),o.diffs.shift()):(_=_.substring(0,a-f.length1-this.Patch_Margin),f.length1+=_.length,c+=_.length,p===i?(f.length2+=_.length,u+=_.length):m=!1,f.diffs.push(new e.Diff(p,_)),_==o.diffs[0][1]?o.diffs.shift():o.diffs[0][1]=o.diffs[0][1].substring(_.length))}h=this.diff_text2(f.diffs),h=h.substring(h.length-this.Patch_Margin);var b=this.diff_text1(o.diffs).substring(0,this.Patch_Margin);b!==""&&(f.length1+=b.length,f.length2+=b.length,f.diffs.length!==0&&f.diffs[f.diffs.length-1][0]===i?f.diffs[f.diffs.length-1][1]+=b:f.diffs.push(new e.Diff(i,b))),m||r.splice(++l,0,f)}}},e.prototype.patch_toText=function(r){for(var a=[],l=0;l<r.length;l++)a[l]=r[l];return a.join("")},e.prototype.patch_fromText=function(r){var a=[];if(!r)return a;for(var l=r.split(`
`),o=0,c=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;o<l.length;){var u=l[o].match(c);if(!u)throw new Error("Invalid patch string: "+l[o]);var h=new e.patch_obj;for(a.push(h),h.start1=parseInt(u[1],10),u[2]===""?(h.start1--,h.length1=1):u[2]=="0"?h.length1=0:(h.start1--,h.length1=parseInt(u[2],10)),h.start2=parseInt(u[3],10),u[4]===""?(h.start2--,h.length2=1):u[4]=="0"?h.length2=0:(h.start2--,h.length2=parseInt(u[4],10)),o++;o<l.length;){var f=l[o].charAt(0);try{var m=decodeURI(l[o].substring(1))}catch{throw new Error("Illegal escape in patch_fromText: "+m)}if(f=="-")h.diffs.push(new e.Diff(t,m));else if(f=="+")h.diffs.push(new e.Diff(n,m));else if(f==" ")h.diffs.push(new e.Diff(i,m));else{if(f=="@")break;if(f!=="")throw new Error('Invalid patch mode "'+f+'" in: '+m)}o++}}return a},e.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},e.patch_obj.prototype.toString=function(){var r,a;this.length1===0?r=this.start1+",0":this.length1==1?r=this.start1+1:r=this.start1+1+","+this.length1,this.length2===0?a=this.start2+",0":this.length2==1?a=this.start2+1:a=this.start2+1+","+this.length2;for(var l=["@@ -"+r+" +"+a+` @@
`],o,c=0;c<this.diffs.length;c++){switch(this.diffs[c][0]){case n:o="+";break;case t:o="-";break;case i:o=" ";break}l[c+1]=o+encodeURI(this.diffs[c][1])+`
`}return l.join("").replace(/%20/g," ")},s.exports=e,s.exports.diff_match_patch=e,s.exports.DIFF_DELETE=t,s.exports.DIFF_INSERT=n,s.exports.DIFF_EQUAL=i})(rl);var sc=rl.exports;const De=nc(sc);class rc{constructor(){q(this,"dmp");this.dmp=new De}computeDiff(e,t){const n=this.dmp.diff_main(e,t);return this.dmp.diff_cleanupSemantic(n),n.map(([i,r])=>{let a;switch(i){case De.DIFF_EQUAL:a="equal";break;case De.DIFF_DELETE:a="delete";break;case De.DIFF_INSERT:a="insert";break;default:a="equal"}return{type:a,original:i===De.DIFF_INSERT?"":r,modified:i===De.DIFF_DELETE?"":r,accepted:!0}})}computeLineDiff(e,t){const n=this.dmp.diff_linesToChars_(e,t),i=this.dmp.diff_main(n.chars1,n.chars2);return this.dmp.diff_charsToLines_(i,n.lineArray),this.dmp.diff_cleanupSemantic(i),i.map(([r,a])=>{let l;switch(r){case De.DIFF_EQUAL:l="equal";break;case De.DIFF_DELETE:l="delete";break;case De.DIFF_INSERT:l="insert";break;default:l="equal"}return{type:l,original:r===De.DIFF_INSERT?"":a,modified:r===De.DIFF_DELETE?"":a,accepted:!0}})}computeInlineDiff(e,t){const n=this.dmp.diff_main(e,t);this.dmp.diff_cleanupSemantic(n);const i=[],r=[];for(const[a,l]of n)switch(a){case De.DIFF_EQUAL:i.push({type:"equal",text:l}),r.push({type:"equal",text:l});break;case De.DIFF_DELETE:i.push({type:"delete",text:l});break;case De.DIFF_INSERT:r.push({type:"insert",text:l});break}return{original:{fullText:e,segments:i},modified:{fullText:t,segments:r}}}getInlineStats(e){const t=e.original.segments.filter(r=>r.type==="delete").length,n=e.modified.segments.filter(r=>r.type==="insert").length,i=e.original.segments.filter(r=>r.type==="equal").length;return{total:e.original.segments.length+e.modified.segments.length,unchanged:i,modified:t+n,accepted:t+n,rejected:0}}getStats(e){const t={total:e.length,unchanged:0,modified:0,accepted:0,rejected:0};for(const n of e)n.type==="equal"?t.unchanged++:t.modified++,n.accepted?t.accepted++:t.rejected++;return t}acceptAll(e){return e.map(t=>({...t,accepted:t.type!=="delete"}))}rejectAll(e){return e.map(t=>({...t,accepted:t.type==="delete"}))}toggleAtIndex(e,t){if(t<0||t>=e.length)return e;const n=[...e];return n[t]={...n[t],accepted:!n[t].accepted},n}mergeAcceptedChanges(e){return e.map(t=>t.accepted?t.modified||"":t.original||"").join("")}createPatch(e,t){const n=this.dmp.diff_main(e,t),i=this.dmp.patch_make(e,n);return this.dmp.patch_toText(i)}applyPatch(e,t){const n=this.dmp.patch_fromText(t),i=this.dmp.patch_apply(n,e);return{result:i[0],applied:i[1].every(Boolean)}}}const Sn=new rc;function yi(s,e,t){const n=s.slice();return n[35]=e[t],n}function Si(s,e,t){const n=s.slice();return n[35]=e[t],n}function ki(s,e,t){const n=s.slice();return n[40]=e[t],n}function Ai(s){let e,t=ue(s[9]),n=[];for(let i=0;i<t.length;i+=1)n[i]=Ei(ki(s,t,i));return{c(){e=w("div");for(let i=0;i<n.length;i+=1)n[i].c();g(e,"class","model-dropdown svelte-negwbs")},m(i,r){$(i,e,r);for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(e,null)},p(i,r){if(r[0]&525824){t=ue(i[9]);let a;for(a=0;a<t.length;a+=1){const l=ki(i,t,a);n[a]?n[a].p(l,r):(n[a]=Ei(l),n[a].c(),n[a].m(e,null))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},d(i){i&&j(e),Qe(n,i)}}}function Ci(s){let e;return{c(){e=w("span"),e.textContent="âœ“",g(e,"class","check svelte-negwbs")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function Ei(s){var y;let e,t,n=s[40].name+"",i,r,a,l,o=s[40].model+"",c,u,h,f,m,p=s[40].id===((y=s[10])==null?void 0:y.id)&&Ci();function _(){return s[26](s[40])}function b(...v){return s[27](s[40],...v)}return{c(){var v;e=w("div"),t=w("span"),i=V(n),r=E(),a=w("span"),l=V(": "),c=V(o),u=E(),p&&p.c(),h=E(),g(a,"class","model-name svelte-negwbs"),g(e,"class","dropdown-item svelte-negwbs"),g(e,"role","button"),g(e,"tabindex","0"),ce(e,"active",s[40].id===((v=s[10])==null?void 0:v.id))},m(v,C){$(v,e,C),d(e,t),d(t,i),d(e,r),d(e,a),d(a,l),d(a,c),d(e,u),p&&p.m(e,null),d(e,h),f||(m=[O(e,"click",_),O(e,"keydown",b)],f=!0)},p(v,C){var S,P;s=v,C[0]&512&&n!==(n=s[40].name+"")&&Y(i,n),C[0]&512&&o!==(o=s[40].model+"")&&Y(c,o),s[40].id===((S=s[10])==null?void 0:S.id)?p||(p=Ci(),p.c(),p.m(e,h)):p&&(p.d(1),p=null),C[0]&1536&&ce(e,"active",s[40].id===((P=s[10])==null?void 0:P.id))},d(v){v&&j(e),p&&p.d(),f=!1,Ce(m)}}}function Pi(s){let e,t,n=s[6]?"âœ• å–æ¶ˆç¼–è¾‘":"âœï¸ ç›´æŽ¥ç¼–è¾‘",i,r,a,l,o,c,u,h,f;return{c(){e=w("div"),t=w("button"),i=V(n),r=E(),a=w("button"),a.textContent="ðŸ”„ é‡æ–°ç”Ÿæˆ",l=E(),o=w("button"),o.textContent="âœ“ åº”ç”¨ä¿®æ”¹",c=E(),u=w("button"),u.textContent="å–æ¶ˆ",g(t,"class","btn-edit svelte-negwbs"),g(a,"class","btn-regenerate svelte-negwbs"),g(o,"class","btn-apply svelte-negwbs"),g(u,"class","btn-cancel svelte-negwbs"),g(e,"class","diff-actions svelte-negwbs")},m(m,p){$(m,e,p),d(e,t),d(t,i),d(e,r),d(e,a),d(e,l),d(e,o),d(e,c),d(e,u),h||(f=[O(t,"click",function(){tn(s[6]?s[15]:s[13])&&(s[6]?s[15]:s[13]).apply(this,arguments)}),O(a,"click",s[28]),O(o,"click",s[16]),O(u,"click",s[17])],h=!0)},p(m,p){s=m,p[0]&64&&n!==(n=s[6]?"âœ• å–æ¶ˆç¼–è¾‘":"âœï¸ ç›´æŽ¥ç¼–è¾‘")&&Y(i,n)},d(m){m&&j(e),h=!1,Ce(f)}}}function Ii(s){let e,t,n,i,r,a,l,o,c,u,h,f,m,p,_,b,y,v,C;return{c(){e=w("div"),t=w("div"),n=w("span"),n.textContent="ðŸ’¬ é‡æ–°ç”Ÿæˆ - æ ¹æ®æ‚¨çš„è¦æ±‚è°ƒæ•´ç»“æžœ",i=E(),r=w("button"),r.textContent="âœ•",a=E(),l=w("div"),o=w("p"),o.innerHTML=`ðŸ’¡ è¾“å…¥æ‚¨çš„è¦æ±‚ï¼ŒAIå°†åŸºäºŽåŽŸæ–‡å’Œå½“å‰ç»“æžœè¿›è¡Œè°ƒæ•´ã€‚<br/>
          ä¾‹å¦‚ï¼š&quot;è¯·æ›´ç®€æ´ä¸€äº›&quot;ã€&quot;å¢žåŠ æ›´å¤šæŠ€æœ¯ç»†èŠ‚&quot;ã€&quot;è¯­æ°”æ›´æ­£å¼&quot;ç­‰ã€‚`,c=E(),u=w("textarea"),h=E(),f=w("div"),m=w("button"),m.textContent="å–æ¶ˆ",p=E(),_=w("button"),b=V("å‘é€è¯·æ±‚"),g(r,"class","btn-close svelte-negwbs"),g(t,"class","regenerate-header svelte-negwbs"),g(o,"class","regenerate-hint svelte-negwbs"),g(u,"placeholder","è¯·è¾“å…¥æ‚¨çš„ä¿®æ”¹è¦æ±‚..."),g(u,"rows","3"),g(u,"class","regenerate-input svelte-negwbs"),g(m,"class","btn-secondary svelte-negwbs"),g(_,"class","btn-primary svelte-negwbs"),_.disabled=y=!s[4].trim(),g(f,"class","regenerate-actions svelte-negwbs"),g(l,"class","regenerate-content svelte-negwbs"),g(e,"class","regenerate-panel svelte-negwbs")},m(S,P){$(S,e,P),d(e,t),d(t,n),d(t,i),d(t,r),d(e,a),d(e,l),d(l,o),d(l,c),d(l,u),te(u,s[4]),d(l,h),d(l,f),d(f,m),d(f,p),d(f,_),d(_,b),v||(C=[O(r,"click",s[29]),O(u,"input",s[30]),O(m,"click",s[31]),O(_,"click",s[18])],v=!0)},p(S,P){P[0]&16&&te(u,S[4]),P[0]&16&&y!==(y=!S[4].trim())&&(_.disabled=y)},d(S){S&&j(e),v=!1,Ce(C)}}}function ic(s){let e,t,n,i,r,a,l,o,c,u,h,f=s[6]?"ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰":"",m,p,_,b=ue(s[2].original.segments),y=[];for(let P=0;P<b.length;P+=1)y[P]=Di(Si(s,b,P));function v(P,A){return P[6]?oc:lc}let C=v(s),S=C(s);return{c(){e=w("div"),t=w("div"),n=w("div"),n.innerHTML="<span>ðŸ“ åŽŸæ–‡</span>",i=E(),r=w("div"),a=w("div");for(let P=0;P<y.length;P+=1)y[P].c();l=E(),o=w("div"),c=w("div"),u=w("span"),h=V("âœ¨ ä¿®æ”¹åŽ "),m=V(f),p=E(),_=w("div"),S.c(),g(n,"class","panel-header svelte-negwbs"),g(a,"class","text-content svelte-negwbs"),g(r,"class","panel-content svelte-negwbs"),g(t,"class","diff-panel original svelte-negwbs"),g(c,"class","panel-header svelte-negwbs"),g(_,"class","panel-content svelte-negwbs"),g(o,"class","diff-panel modified svelte-negwbs"),ce(o,"editing",s[6]),g(e,"class","diff-content-inline svelte-negwbs")},m(P,A){$(P,e,A),d(e,t),d(t,n),d(t,i),d(t,r),d(r,a);for(let k=0;k<y.length;k+=1)y[k]&&y[k].m(a,null);d(e,l),d(e,o),d(o,c),d(c,u),d(u,h),d(u,m),d(o,p),d(o,_),S.m(_,null)},p(P,A){if(A[0]&4){b=ue(P[2].original.segments);let k;for(k=0;k<b.length;k+=1){const M=Si(P,b,k);y[k]?y[k].p(M,A):(y[k]=Di(M),y[k].c(),y[k].m(a,null))}for(;k<y.length;k+=1)y[k].d(1);y.length=b.length}A[0]&64&&f!==(f=P[6]?"ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰":"")&&Y(m,f),C===(C=v(P))&&S?S.p(P,A):(S.d(1),S=C(P),S&&(S.c(),S.m(_,null))),A[0]&64&&ce(o,"editing",P[6])},d(P){P&&j(e),Qe(y,P),S.d()}}}function ac(s){let e;return{c(){e=w("div"),e.innerHTML='<div class="loading-spinner svelte-negwbs">â³</div> <p>æ­£åœ¨å¤„ç†ä¸­...</p>',g(e,"class","loading-content svelte-negwbs")},m(t,n){$(t,e,n)},p:ze,d(t){t&&j(e)}}}function Di(s){let e,t=s[35].text+"",n,i;return{c(){e=w("span"),n=V(t),g(e,"class",i="segment "+Fn(s[35].type)+" svelte-negwbs")},m(r,a){$(r,e,a),d(e,n)},p(r,a){a[0]&4&&t!==(t=r[35].text+"")&&Y(n,t),a[0]&4&&i!==(i="segment "+Fn(r[35].type)+" svelte-negwbs")&&g(e,"class",i)},d(r){r&&j(e)}}}function lc(s){let e,t=ue(s[2].modified.segments),n=[];for(let i=0;i<t.length;i+=1)n[i]=Ti(yi(s,t,i));return{c(){e=w("div");for(let i=0;i<n.length;i+=1)n[i].c();g(e,"class","text-content svelte-negwbs")},m(i,r){$(i,e,r);for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(e,null)},p(i,r){if(r[0]&4){t=ue(i[2].modified.segments);let a;for(a=0;a<t.length;a+=1){const l=yi(i,t,a);n[a]?n[a].p(l,r):(n[a]=Ti(l),n[a].c(),n[a].m(e,null))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},d(i){i&&j(e),Qe(n,i)}}}function oc(s){let e,t,n,i,r,a,l,o,c;return{c(){e=w("textarea"),n=E(),i=w("div"),r=w("button"),r.textContent="å–æ¶ˆ",a=E(),l=w("button"),l.textContent="ä¿å­˜",g(e,"class","edit-textarea svelte-negwbs"),g(e,"placeholder","åœ¨æ­¤ç›´æŽ¥ç¼–è¾‘ä¿®æ”¹åŽçš„å†…å®¹..."),g(e,"rows",t=Math.max(10,s[7].split(`
`).length)),g(r,"class","btn-secondary svelte-negwbs"),g(l,"class","btn-primary svelte-negwbs"),g(i,"class","edit-actions svelte-negwbs")},m(u,h){$(u,e,h),te(e,s[7]),$(u,n,h),$(u,i,h),d(i,r),d(i,a),d(i,l),o||(c=[O(e,"input",s[32]),O(r,"click",s[15]),O(l,"click",s[14])],o=!0)},p(u,h){h[0]&128&&t!==(t=Math.max(10,u[7].split(`
`).length))&&g(e,"rows",t),h[0]&128&&te(e,u[7])},d(u){u&&(j(e),j(n),j(i)),o=!1,Ce(c)}}}function Ti(s){let e,t=s[35].text+"",n,i;return{c(){e=w("span"),n=V(t),g(e,"class",i="segment "+Fn(s[35].type)+" svelte-negwbs")},m(r,a){$(r,e,a),d(e,n)},p(r,a){a[0]&4&&t!==(t=r[35].text+"")&&Y(n,t),a[0]&4&&i!==(i="segment "+Fn(r[35].type)+" svelte-negwbs")&&g(e,"class",i)},d(r){r&&j(e)}}}function Ri(s){let e,t,n=s[3].modified+"",i,r;return{c(){e=w("span"),t=V("å…± "),i=V(n),r=V(" å¤„ä¿®æ”¹"),g(e,"class","stats-total")},m(a,l){$(a,e,l),d(e,t),d(e,i),d(e,r)},p(a,l){l[0]&8&&n!==(n=a[3].modified+"")&&Y(i,n)},d(a){a&&j(e)}}}function cc(s){let e,t,n,i,r,a=(s[12][s[1]]||"AIå¤„ç†")+"",l,o,c,u,h=s[10]?s[10].name+" : "+s[10].model:"æœªé…ç½®",f,m,p,_,b,y,v,C,S,P,A,k,M,T,F,D=s[8]&&Ai(s),R=s[0]&&!s[11]&&Pi(s),I=s[5]&&!s[11]&&!s[6]&&Ii(s);function B(W,ee){return W[11]?ac:ic}let x=B(s),G=x(s),X=s[3]&&Ri(s);return{c(){e=w("div"),t=w("div"),n=w("div"),i=w("span"),r=V("ðŸ“Š "),l=V(a),o=E(),c=w("div"),u=w("button"),f=V(h),m=E(),D&&D.c(),p=E(),R&&R.c(),_=E(),I&&I.c(),b=E(),G.c(),y=E(),v=w("div"),C=w("span"),C.innerHTML='<span class="legend-color equal svelte-negwbs"></span>æœªæ”¹å˜',S=E(),P=w("span"),P.innerHTML='<span class="legend-color delete svelte-negwbs"></span>åˆ é™¤',A=E(),k=w("span"),k.innerHTML='<span class="legend-color insert svelte-negwbs"></span>æ–°å¢ž',M=E(),X&&X.c(),g(u,"class","model-btn svelte-negwbs"),g(c,"class","model-selector svelte-negwbs"),g(n,"class","diff-title svelte-negwbs"),g(t,"class","diff-header svelte-negwbs"),g(C,"class","legend-item svelte-negwbs"),g(P,"class","legend-item svelte-negwbs"),g(k,"class","legend-item svelte-negwbs"),g(v,"class","diff-legend svelte-negwbs"),g(e,"class","diff-viewer svelte-negwbs")},m(W,ee){$(W,e,ee),d(e,t),d(t,n),d(n,i),d(i,r),d(i,l),d(n,o),d(n,c),d(c,u),d(u,f),d(c,m),D&&D.m(c,null),d(t,p),R&&R.m(t,null),d(e,_),I&&I.m(e,null),d(e,b),G.m(e,null),d(e,y),d(e,v),d(v,C),d(v,S),d(v,P),d(v,A),d(v,k),d(v,M),X&&X.m(v,null),T||(F=O(u,"click",s[20]),T=!0)},p(W,ee){ee[0]&2&&a!==(a=(W[12][W[1]]||"AIå¤„ç†")+"")&&Y(l,a),ee[0]&1024&&h!==(h=W[10]?W[10].name+" : "+W[10].model:"æœªé…ç½®")&&Y(f,h),W[8]?D?D.p(W,ee):(D=Ai(W),D.c(),D.m(c,null)):D&&(D.d(1),D=null),W[0]&&!W[11]?R?R.p(W,ee):(R=Pi(W),R.c(),R.m(t,null)):R&&(R.d(1),R=null),W[5]&&!W[11]&&!W[6]?I?I.p(W,ee):(I=Ii(W),I.c(),I.m(e,b)):I&&(I.d(1),I=null),x===(x=B(W))&&G?G.p(W,ee):(G.d(1),G=x(W),G&&(G.c(),G.m(e,y))),W[3]?X?X.p(W,ee):(X=Ri(W),X.c(),X.m(v,null)):X&&(X.d(1),X=null)},i:ze,o:ze,d(W){W&&j(e),D&&D.d(),R&&R.d(),I&&I.d(),G.d(),X&&X.d(),T=!1,F()}}}function Fn(s){switch(s){case"equal":return"equal";case"delete":return"delete";case"insert":return"insert";default:return"equal"}}function uc(s,e,t){let n,i,{original:r}=e,{modified:a}=e,{selectedText:l=""}=e,{showActions:o=!0}=e,{operationType:c="polish"}=e,{blockId:u=""}=e;const h=ul();let f,m,p="",_=!1,b=!1,y="",v=!1,C=[],S=null;const P={chat:"å¯¹è¯",polish:"æ¶¦è‰²",translate:"ç¿»è¯‘",summarize:"æ€»ç»“",expand:"æ‰©å†™",condense:"ç²¾ç®€",rewrite:"æ”¹å†™",continue:"ç»­å†™",custom1:"è‡ªå®šä¹‰1",custom2:"è‡ªå®šä¹‰2",custom3:"è‡ªå®šä¹‰3"};ks(()=>{A()});function A(){const K=Q.getSettings();t(9,C=K.providers),t(10,S=Q.getCurrentProvider())}function k(){t(7,y=a),t(6,b=!0),A()}function M(){t(21,a=y),t(6,b=!1),t(2,f=Sn.computeInlineDiff(r,a)),t(3,m=Sn.getInlineStats(f))}function T(){t(6,b=!1),t(7,y="")}function F(){h("apply",a)}function D(){h("cancel")}function R(){if(!p.trim()){alert("è¯·è¾“å…¥ä¿®æ”¹è¦æ±‚");return}h("regenerate",{instruction:p,original:n,currentModified:a}),t(4,p=""),t(5,_=!1)}function I(K){h("switchModel",K),t(8,v=!1),A()}function B(){t(8,v=!v),A()}const x=K=>I(K.id),G=(K,ke)=>ke.key==="Enter"&&I(K.id),X=()=>t(5,_=!_),W=()=>t(5,_=!1);function ee(){p=this.value,t(4,p)}const ae=()=>t(5,_=!1);function Re(){y=this.value,t(7,y)}return s.$$set=K=>{"original"in K&&t(22,r=K.original),"modified"in K&&t(21,a=K.modified),"selectedText"in K&&t(23,l=K.selectedText),"showActions"in K&&t(0,o=K.showActions),"operationType"in K&&t(1,c=K.operationType),"blockId"in K&&t(24,u=K.blockId)},s.$$.update=()=>{s.$$.dirty[0]&12582912&&t(25,n=l||r),s.$$.dirty[0]&2097152&&t(11,i=a.startsWith("â³")||a===""||a===null||a===void 0),s.$$.dirty[0]&35651588&&(t(2,f=Sn.computeInlineDiff(n,a)),t(3,m=Sn.getInlineStats(f)))},[o,c,f,m,p,_,b,y,v,C,S,i,P,k,M,T,F,D,R,I,B,a,r,l,u,n,x,G,X,W,ee,ae,Re]}class hc extends Cs{constructor(e){super(),As(this,e,uc,cc,Ss,{original:22,modified:21,selectedText:23,showActions:0,operationType:1,blockId:24},null,[-1,-1])}}class fc{constructor(e){q(this,"toolbarElement",null);q(this,"options");q(this,"isVisible",!1);q(this,"hideTimeout",null);q(this,"currentSelection","");q(this,"currentBlockId",null);q(this,"currentSelectionStart",-1);q(this,"currentSelectionEnd",-1);q(this,"modelDropdownElement",null);q(this,"isDragging",!1);q(this,"dragOffsetX",0);q(this,"dragOffsetY",0);q(this,"isPinned",!1);this.options=e,this.bindEvents()}bindEvents(){let e;document.addEventListener("mouseup",t=>{clearTimeout(e),e=window.setTimeout(()=>{this.handleSelectionChange(t)},200)}),document.addEventListener("mousedown",t=>{const n=t.target;this.modelDropdownElement&&!this.modelDropdownElement.contains(n)&&this.hideModelDropdown(),this.toolbarElement&&!this.toolbarElement.contains(n)&&this.hide()}),document.addEventListener("scroll",()=>{this.hide(),this.hideModelDropdown()},!0),document.addEventListener("keydown",t=>{t.key==="Escape"&&(this.hideModelDropdown(),this.hide())})}handleSelectionChange(e){if(!Q.getSettings().showFloatingToolbar||!e.target.closest(".protyle-wysiwyg"))return;const i=window.getSelection();if(!i||i.rangeCount===0){this.hide();return}const r=i.toString().trim();if(r.length<1){this.hide();return}this.currentBlockId=St.getCurrentBlockId(),console.log("[AI Assistant] Selected block ID:",this.currentBlockId,"Text length:",r.length),this.calculateSelectionIndices(i,r),this.currentSelection=r,this.show(e,r)}calculateSelectionIndices(e,t){var p;this.currentSelectionStart=-1,this.currentSelectionEnd=-1;const n=e.getRangeAt(0),i=n.commonAncestorContainer;let r=i.nodeType===Node.ELEMENT_NODE?i:i.parentElement,a=null;for(;r;){if(r.classList&&r.classList.contains("p")){a=r;break}r=r.parentElement}if(!a){console.warn("[AI Assistant] æ— æ³•æ‰¾åˆ°åŒ…å«é€‰ä¸­æ–‡å­—çš„å—å…ƒç´ ");return}const l=a.textContent||"",o=e.toString();let c=0,u=0;const h=document.createRange();h.selectNodeContents(a),h.setEnd(n.startContainer,n.startOffset);const f=document.createElement("div");f.appendChild(h.cloneContents()),c=((p=f.textContent)==null?void 0:p.length)||0,u=c+o.length,this.currentSelectionStart=c,this.currentSelectionEnd=u,console.log("[AI Assistant] é€‰ä¸­ä½ç½®è®¡ç®—:",{blockContent:l.substring(0,50)+"...",selectedText:o.substring(0,30)+"...",startOffset:c,endOffset:u,totalLength:l.length});const m=l.substring(c,u);if(m!==o){console.warn("[AI Assistant] ç´¢å¼•è®¡ç®—å¯èƒ½æœ‰è¯¯:",{expected:o,extracted:m});const _=l.indexOf(o);_!==-1&&(this.currentSelectionStart=_,this.currentSelectionEnd=_+o.length,console.log("[AI Assistant] ä½¿ç”¨å›žé€€ç´¢å¼•:",this.currentSelectionStart,this.currentSelectionEnd))}}show(e,t){if(this.toolbarElement||this.createToolbar(),!this.toolbarElement)return;if(this.isPinned){this.toolbarElement.style.display="block",this.toolbarElement.classList.add("show"),this.isVisible=!0;return}this.refreshToolbar();const n=window.getSelection();if(!n||n.rangeCount===0)return;const r=n.getRangeAt(0).getBoundingClientRect(),a=this.toolbarElement.offsetHeight||50,l=this.toolbarElement.offsetWidth||300;let o=r.top-a-10,c=r.left+r.width/2-l/2;o<10&&(o=r.bottom+15),c<10&&(c=10),c+l>window.innerWidth-10&&(c=window.innerWidth-l-10),o+a>window.innerHeight-10&&o>r.bottom+10&&(o=r.top,c=r.right+10,c+l>window.innerWidth-10&&(c=r.left-l-10)),this.toolbarElement.style.top=`${o+window.scrollY}px`,this.toolbarElement.style.left=`${c+window.scrollX}px`,this.toolbarElement.style.display="block",this.toolbarElement.classList.add("show"),this.isVisible=!0,this.resetHideTimeout()}hide(){!this.toolbarElement||!this.isVisible||this.isPinned||(this.toolbarElement.classList.remove("show"),this.toolbarElement.style.display="none",this.isVisible=!1,this.currentSelection="",this.currentBlockId=null,this.currentSelectionStart=-1,this.currentSelectionEnd=-1,this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null))}forceHide(){!this.toolbarElement||!this.isVisible||(this.toolbarElement.classList.remove("show"),this.toolbarElement.style.display="none",this.isVisible=!1,this.isPinned=!1,this.currentSelection="",this.currentBlockId=null,this.currentSelectionStart=-1,this.currentSelectionEnd=-1,this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null))}resetHideTimeout(){this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=window.setTimeout(()=>{this.hide(),this.hideModelDropdown()},1e4)}refreshToolbar(){if(!this.toolbarElement)return;const e=Q.getSettings(),t=Q.getCurrentProvider(),n=e.toolbarButtons,i=this.toolbarElement.querySelector(".provider-name");i&&(i.textContent=t?`${t.name} : ${t.model}`:"âš ï¸ æœªé…ç½®");const r=this.toolbarElement.querySelector(".toolbar-buttons");if(r){r.innerHTML="";const a=[{type:"polish",label:"æ¶¦è‰²",icon:"âœ¨",enabled:n.polish},{type:"translate",label:"ç¿»è¯‘",icon:"ðŸŒ",enabled:n.translate},{type:"summarize",label:"æ€»ç»“",icon:"ðŸ“",enabled:n.summarize},{type:"expand",label:"æ‰©å†™",icon:"ðŸ“–",enabled:n.expand},{type:"condense",label:"ç²¾ç®€",icon:"ðŸ“„",enabled:n.condense},{type:"rewrite",label:"æ”¹å†™",icon:"ðŸ”„",enabled:n.rewrite},{type:"continue",label:"ç»­å†™",icon:"âž¡ï¸",enabled:n.continue}];e.customButtons.forEach((l,o)=>{if(l.enabled){const c=`custom${o+1}`;a.push({type:`custom${o+1}`,label:l.name,icon:l.icon,enabled:n[c]||!1})}}),a.filter(l=>l.enabled).forEach(l=>{const o=document.createElement("button");o.className="toolbar-btn",o.innerHTML=`<span class="icon">${l.icon}</span><span>${l.label}</span>`,o.addEventListener("click",()=>this.handleOperation(l.type)),r.appendChild(o)})}}createModelDropdown(){this.modelDropdownElement&&(this.modelDropdownElement.remove(),this.modelDropdownElement=null);const e=Q.getSettings(),t=e.providers,n=e.currentProviderId;if(t.length===0)return;const i=document.createElement("div");i.className="ai-model-dropdown",i.style.cssText=`
            position: fixed;
            z-index: 10000;
            background: var(--b3-theme-background, #fff);
            border: 1px solid var(--b3-border-color, #e0e0e0);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-height: 200px;
            overflow-y: auto;
            min-width: 200px;
            padding: 4px 0;
        `,t.forEach(r=>{const a=document.createElement("div");a.className="dropdown-item";const l=r.id===n;a.style.cssText=`
                padding: 10px 12px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 13px;
                color: var(--b3-theme-on-background, #333);
            `,l&&(a.style.background="var(--b3-theme-primary-light, rgba(66, 133, 244, 0.1))"),a.innerHTML=`
                <span>${r.name}</span>
                <span style="color: var(--b3-theme-on-surface, #666); font-size: 12px;">: ${r.model}</span>
                ${l?'<span style="margin-left: auto; color: var(--b3-theme-success, #22c55e);">âœ“</span>':""}
            `,a.addEventListener("click",async o=>{o.stopPropagation(),console.log("[AI Assistant] Switching to provider:",r.name,r.model),await Q.setCurrentProvider(r.id),ge.setProvider(r),this.refreshToolbar(),this.hideModelDropdown(),console.log("[AI Assistant] Provider switched successfully to:",r.name)}),a.addEventListener("mouseenter",()=>{a.style.background="var(--b3-theme-hover, rgba(0, 0, 0, 0.05))"}),a.addEventListener("mouseleave",()=>{l||(a.style.background="")}),i.appendChild(a)}),document.body.appendChild(i),this.modelDropdownElement=i}showModelDropdown(){if(!this.toolbarElement||(this.hideModelDropdown(),this.createModelDropdown(),!this.modelDropdownElement))return;const e=this.toolbarElement.querySelector(".provider-name");if(!e)return;const t=e.getBoundingClientRect();this.modelDropdownElement.style.top=`${t.bottom+5}px`,this.modelDropdownElement.style.left=`${t.left}px`}hideModelDropdown(){this.modelDropdownElement&&(this.modelDropdownElement.remove(),this.modelDropdownElement=null)}createToolbar(){var u,h;const e=document.createElement("div");e.className="ai-floating-toolbar",e.style.cssText=`
            position: fixed;
            display: none;
            z-index: 9999;
            background: var(--b3-theme-background, #fff);
            border: 1px solid var(--b3-border-color, #e0e0e0);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px;
            font-family: var(--b3-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            user-select: none;
        `;const t=Q.getCurrentProvider(),n=t?`${t.name} : ${t.model}`:"âš ï¸ æœªé…ç½®",i=document.createElement("div");i.className="toolbar-header",i.style.cssText="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--b3-border-color, #e0e0e0); cursor: move;",i.innerHTML=`
            <span class="drag-handle" style="cursor: move; padding: 2px 4px; margin-right: 4px; color: var(--b3-theme-on-surface, #999);">â‹®â‹®</span>
            <span class="provider-name" style="cursor: pointer; font-weight: 500; font-size: 12px; color: var(--b3-theme-on-surface, #666); flex: 1;" title="ç‚¹å‡»åˆ‡æ¢æ¨¡åž‹">${n}</span>
            <button class="btn-pin" style="background: none; border: none; cursor: pointer; font-size: 12px; padding: 2px 6px; margin-right: 4px; opacity: 0.6;" title="å›ºå®šä½ç½®">ðŸ“Œ</button>
            <button class="btn-settings" style="background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px 6px;" title="è®¾ç½®">âš™ï¸</button>
            <button class="btn-close" style="background: none; border: none; cursor: pointer; font-size: 12px; padding: 2px 6px; margin-left: 4px; color: var(--b3-theme-on-surface, #999);" title="å…³é—­">âœ•</button>
        `;const r=i.querySelector(".drag-handle"),a=f=>{f.addEventListener("mousedown",m=>{(m.target===f||m.target===i||m.target.classList.contains("provider-name"))&&(m.preventDefault(),this.isDragging=!0,this.dragOffsetX=m.clientX-e.offsetLeft,this.dragOffsetY=m.clientY-e.offsetTop,e.style.cursor="grabbing")})};a(i),r&&a(r);const l=i.querySelector(".btn-pin");l&&l.addEventListener("click",f=>{f.stopPropagation(),this.isPinned=!this.isPinned,l.style.opacity=this.isPinned?"1":"0.6",l.textContent=this.isPinned?"ðŸ“":"ðŸ“Œ",l.title=this.isPinned?"å·²å›ºå®šï¼Œç‚¹å‡»å–æ¶ˆå›ºå®š":"å›ºå®šä½ç½®",console.log("[AI Assistant] å·¥å…·æ å·²",this.isPinned?"å›ºå®š":"å–æ¶ˆå›ºå®š")});const o=i.querySelector(".btn-close");o&&o.addEventListener("click",f=>{f.stopPropagation(),this.forceHide()}),(u=i.querySelector(".provider-name"))==null||u.addEventListener("click",f=>{f.stopPropagation(),this.showModelDropdown()}),(h=i.querySelector(".btn-settings"))==null||h.addEventListener("click",()=>{this.hideModelDropdown(),this.options.onOpenSettings(),this.forceHide()}),e.appendChild(i);const c=document.createElement("div");c.className="toolbar-buttons",c.style.cssText="display: flex; gap: 4px; flex-wrap: wrap;",e.appendChild(c),this.refreshToolbar(),document.body.appendChild(e),this.toolbarElement=e,document.addEventListener("mousemove",f=>{if(this.isDragging&&this.toolbarElement){f.preventDefault();const m=f.clientX-this.dragOffsetX,p=f.clientY-this.dragOffsetY,_=window.innerWidth-this.toolbarElement.offsetWidth-10,b=window.innerHeight-this.toolbarElement.offsetHeight-10;this.toolbarElement.style.left=`${Math.max(10,Math.min(m,_))}px`,this.toolbarElement.style.top=`${Math.max(10,Math.min(p,b))}px`}}),document.addEventListener("mouseup",()=>{this.isDragging&&(this.isDragging=!1,this.toolbarElement&&(this.toolbarElement.style.cursor="default"))}),e.addEventListener("mouseenter",()=>{this.hideTimeout&&clearTimeout(this.hideTimeout)}),e.addEventListener("mouseleave",()=>{this.resetHideTimeout()})}async handleOperation(e){var o;if(!this.currentSelection)return;const n=Q.getSettings().customButtons.find(c=>c.id===e),i=n==null?void 0:n.prompt;let r="";if(this.currentBlockId){const c=await St.getBlockContent(this.currentBlockId);r=(c==null?void 0:c.content)||"",console.log("[AI Assistant] èŽ·å–å®Œæ•´å—å†…å®¹:",r==null?void 0:r.substring(0,50),"blockId:",this.currentBlockId)}r||(r=this.getFullBlockContentFromDOM(),console.log("[AI Assistant] ä»ŽDOMèŽ·å–å®Œæ•´å—å†…å®¹:",r==null?void 0:r.substring(0,50))),r||(r=this.currentSelection,console.warn("[AI Assistant] æ— æ³•èŽ·å–å®Œæ•´å—å†…å®¹ï¼Œä½¿ç”¨é€‰ä¸­æ–‡å­—ä»£æ›¿"));let a="";const l=r!==this.currentSelection;l?a={polish:`è¯·æ¶¦è‰²ä»¥ä¸‹æ–‡æœ¬çš„é€‰ä¸­éƒ¨åˆ†ï¼Œåªè¿”å›žæ¶¦è‰²åŽçš„é€‰ä¸­éƒ¨åˆ†æ–‡æœ¬ï¼Œä¸è¦è§£é‡Šï¼š

é€‰ä¸­éƒ¨åˆ†ï¼š${this.currentSelection}`,translate:`è¯·ç¿»è¯‘ä»¥ä¸‹æ–‡æœ¬çš„é€‰ä¸­éƒ¨åˆ†ï¼Œåªè¿”å›žç¿»è¯‘åŽçš„é€‰ä¸­éƒ¨åˆ†æ–‡æœ¬ï¼Œä¸è¦è§£é‡Šï¼š

é€‰ä¸­éƒ¨åˆ†ï¼š${this.currentSelection}`,summarize:`è¯·æ€»ç»“ä»¥ä¸‹æ–‡æœ¬ï¼Œåªè¿”å›žæ€»ç»“å†…å®¹ï¼š

${r}`,expand:`è¯·æ‰©å†™ä»¥ä¸‹æ–‡æœ¬ï¼š

${r}`,condense:`è¯·ç²¾ç®€ä»¥ä¸‹æ–‡æœ¬ï¼š

${r}`,rewrite:`è¯·æ”¹å†™ä»¥ä¸‹æ–‡æœ¬ï¼š

${r}`,continue:`è¯·ç»­å†™ä»¥ä¸‹æ–‡æœ¬ï¼š

${r}`}[e]||i||`${e}: ${this.currentSelection}`:a=i||"",console.log("[AI Assistant] Starting operation:",e,"isPartialSelection:",l),this.options.onOperationStart(e,r,this.currentBlockId||void 0,this.currentSelection,this.currentSelectionStart,this.currentSelectionEnd);try{this.setLoading(!0);const c=ge.buildOperationMessages(this.currentSelection,e,a),u=await((o=ge.adapter)==null?void 0:o.chatCompletion(c));u&&(console.log("[AI Assistant] Operation completed"),this.options.onOperation(e,r,u.content,this.currentBlockId||void 0,this.currentSelection,this.currentSelectionStart,this.currentSelectionEnd))}catch(c){console.error("[AI Assistant] Operation failed:",c),alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥AIæä¾›å•†é…ç½®")}finally{this.setLoading(!1),this.hide()}}getFullBlockContentFromDOM(){const e=window.getSelection();if(!e||e.rangeCount===0)return"";const n=e.getRangeAt(0).commonAncestorContainer;let i=n.nodeType===Node.ELEMENT_NODE?n:n.parentElement;for(;i;){if(i.classList&&i.classList.contains("p")){const r=i.textContent||"";return console.log("[AI Assistant] ä»ŽDOMæ‰¾åˆ°å—å†…å®¹:",r==null?void 0:r.substring(0,50)),r}i=i.parentElement}return this.currentSelection}setLoading(e){if(!this.toolbarElement)return;this.toolbarElement.querySelectorAll(".toolbar-btn").forEach(n=>{n.disabled=e,e?n.classList.add("loading"):n.classList.remove("loading")})}getCurrentSelection(){return this.currentSelection}getCurrentBlockId(){return this.currentBlockId}destroy(){this.hide(),this.hideModelDropdown(),this.toolbarElement&&(this.toolbarElement.remove(),this.toolbarElement=null)}}class dc{constructor(e){q(this,"options");q(this,"menuElement",null);this.options=e}injectIntoBlockMenu(e){var l,o,c,u;const t=(c=(o=(l=window.siyuan)==null?void 0:l.config)==null?void 0:o.pluginSettings)==null?void 0:c["siyuan-ai-assistant"];if(t&&!t.showContextMenu)return;const n=e.detail;if(!((u=n==null?void 0:n.menu)!=null&&u.element))return;const i=n.menu,r=n.blockId;if(!r)return;i.addItem({type:"separator"});const a=[{label:"âœ¨ æ¶¦è‰²æ–‡æœ¬",click:()=>this.options.onOperation("polish",r)},{label:"ðŸŒ ç¿»è¯‘æ–‡æœ¬",click:()=>this.options.onOperation("translate",r)},{label:"ðŸ“ æ€»ç»“å†…å®¹",click:()=>this.options.onOperation("summarize",r)},{label:"ðŸ“– æ‰©å†™å†…å®¹",click:()=>this.options.onOperation("expand",r)},{type:"separator"},{label:"âš™ï¸ AIåŠ©æ‰‹è®¾ç½®",click:()=>this.options.onOpenSettings()}];i.addItem({label:"ðŸ¤– AIåŠ©æ‰‹",submenu:a})}showForSelection(e,t,n){this.hide();const i=document.createElement("div");i.className="ai-context-menu",i.style.cssText=`
            position: fixed;
            z-index: 9999;
            background: var(--b3-theme-background);
            border: 1px solid var(--b3-border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 4px 0;
            min-width: 160px;
            font-family: var(--b3-font-family);
            font-size: 14px;
        `,[{label:"âœ¨ æ¶¦è‰²",action:n.onPolish},{label:"ðŸŒ ç¿»è¯‘",action:n.onTranslate},{label:"ðŸ“ æ€»ç»“",action:n.onSummarize},{label:"ðŸ“– æ‰©å†™",action:n.onExpand}].forEach(o=>{const c=document.createElement("div");c.className="ai-context-menu-item",c.textContent=o.label,c.style.cssText=`
                padding: 8px 16px;
                cursor: pointer;
                transition: background 0.15s;
            `,c.addEventListener("mouseenter",()=>{c.style.background="var(--b3-theme-hover)"}),c.addEventListener("mouseleave",()=>{c.style.background="transparent"}),c.addEventListener("click",()=>{o.action(),this.hide()}),i.appendChild(c)}),i.style.left=`${e.clientX}px`,i.style.top=`${e.clientY}px`;const a=i.getBoundingClientRect();a.right>window.innerWidth&&(i.style.left=`${e.clientX-a.width}px`),a.bottom>window.innerHeight&&(i.style.top=`${e.clientY-a.height}px`),document.body.appendChild(i),this.menuElement=i;const l=o=>{i.contains(o.target)||(this.hide(),document.removeEventListener("mousedown",l))};setTimeout(()=>{document.addEventListener("mousedown",l)},0)}hide(){this.menuElement&&(this.menuElement.remove(),this.menuElement=null)}}function Mi(s){const{title:e,content:t,width:n="600px",height:i="auto",destroyCallback:r}=s;let a;typeof t=="string"?a=t:a='<div class="ai-dialog-content-placeholder"></div>';const l=new Oi.Dialog({title:e,content:a,width:n,height:i,destroyCallback:r});if(typeof t!="string"){const o=[".b3-dialog__body",".b3-dialog__content",".b3-dialog .b3-dialog__body",".b3-dialog .b3-dialog__content"];let c=null;for(const h of o)if(c=l.element.querySelector(h),c)break;c||(c=l.element);const u=c.querySelector(".ai-dialog-content-placeholder");u?u.replaceWith(t):c.appendChild(t)}return l}const mc="siyuan-ai-assistant",pc="ai_assistant_dock";class gc extends Oi.Plugin{constructor(){super(...arguments);q(this,"floatingToolbar",null);q(this,"contextMenuManager",null);q(this,"settingsDialog",null);q(this,"diffDialog",null);q(this,"chatPanelComponent",null);q(this,"currentDiffViewer",null);q(this,"currentOriginalText","");q(this,"currentSelectedText","");q(this,"currentSelectionStart",-1);q(this,"currentSelectionEnd",-1)}async onload(){Q.init(this),await Q.loadSettings();const t=Q.getCurrentProvider();t&&ge.setProvider(t),this.addIcons(`
            <symbol id="iconAIAssistant" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                <circle cx="12" cy="12" r="3" fill="currentColor"/>
            </symbol>
            <symbol id="iconSparkles" viewBox="0 0 24 24">
                <path d="M7 2v11h3v9l7-12h-4l4-8z"/>
            </symbol>
        `),this.addDock({config:{position:"RightBottom",size:{width:320,height:500},icon:"iconAIAssistant",title:this.i18n.title||"AIåŠ©æ‰‹"},data:{text:this.i18n.title||"AIåŠ©æ‰‹"},type:pc,init:n=>{this.initChatPanel(n.element)}}),this.initFloatingToolbar(),this.initContextMenu()}onLayoutReady(){const t=Q.getCurrentProvider();t&&ge.setProvider(t)}onunload(){this.floatingToolbar&&(this.floatingToolbar.destroy(),this.floatingToolbar=null),this.contextMenuManager&&(this.contextMenuManager.destroy(),this.contextMenuManager=null),this.settingsDialog&&(this.settingsDialog.destroy(),this.settingsDialog=null),this.diffDialog&&(this.diffDialog.destroy(),this.diffDialog=null),this.chatPanelComponent&&(this.chatPanelComponent.$destroy(),this.chatPanelComponent=null)}async uninstall(){await this.removeData(mc)}openSetting(){this.openSettings()}initChatPanel(t){t.style.height="100%",t.style.overflow="hidden";const n=new jo({target:t,props:{onOpenSettings:()=>this.openSettings()}});this.chatPanelComponent=n}initFloatingToolbar(){this.floatingToolbar=new fc({onOperation:(t,n,i,r,a,l,o)=>{this.updateDiffViewer(i,n,a,l,o)},onOperationStart:(t,n,i,r,a,l)=>{this.showDiffViewer(n,"â³ æ­£åœ¨è¯·æ±‚AIå¤„ç†...",t,i,r,a,l)},onOpenSettings:()=>this.openSettings()})}initContextMenu(){this.contextMenuManager=new dc({onOperation:async(t,n)=>{const i=await St.getBlockContent(n);if(i)try{const r=await ge.processText(i.content,t);this.showDiffViewer(i.content,r.content,t,n)}catch(r){console.error("[AI Assistant] Context menu operation failed:",r),alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥AIæä¾›å•†é…ç½®")}},onOpenSettings:()=>this.openSettings()}),this.eventBus.on("click-blockicon",t=>{var n;(n=this.contextMenuManager)==null||n.injectIntoBlockMenu(t)})}openSettings(){this.settingsDialog&&this.settingsDialog.destroy();const t=document.createElement("div");t.style.height="500px",new tc({target:t,props:{onClose:()=>{var n;(n=this.settingsDialog)==null||n.destroy(),this.settingsDialog=null}}}),this.settingsDialog=Mi({title:"AIåŠ©æ‰‹è®¾ç½®",content:t,width:"600px",height:"500px",destroyCallback:()=>{this.settingsDialog=null}})}showDiffViewer(t,n,i,r,a,l,o){this.diffDialog&&this.diffDialog.destroy();const c=r;this.currentOriginalText=t,this.currentSelectedText=a||"",this.currentSelectionStart=l??-1,this.currentSelectionEnd=o??-1;const u=document.createElement("div");this.currentDiffViewer=new hc({target:u,props:{original:t,modified:n,selectedText:a||"",operationType:i,blockId:r||""}}),this.currentDiffViewer.$on("apply",async f=>{var p,_;const m=f.detail;if(this.currentOriginalText){let b;if(this.currentSelectionStart>=0&&this.currentSelectionEnd>this.currentSelectionStart){const y=this.currentOriginalText.substring(0,this.currentSelectionStart),v=this.currentOriginalText.substring(this.currentSelectionEnd);b=y+m+v}else{const v=St.getSelectedText()||this.currentSelectedText||this.currentOriginalText;b=this.currentOriginalText;const C=v.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),S=new RegExp(C,"");if(S.test(b))b=b.replace(S,m);else{const P=v.trim(),A=new RegExp(P.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"");if(A.test(b))b=b.replace(A,m);else{alert("åº”ç”¨å¤±è´¥ï¼šæ— æ³•åœ¨åŽŸæ–‡ä¸­æ‰¾åˆ°é€‰ä¸­çš„æ–‡å­—"),(p=this.diffDialog)==null||p.destroy(),this.diffDialog=null;return}}}c?await St.updateBlock(c,b)||alert("åº”ç”¨ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•"):alert("æ— æ³•ç¡®å®šè¦æ›´æ–°çš„æ–‡æœ¬å—")}else c&&(await St.updateBlock(c,m)||alert("åº”ç”¨ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•"));(_=this.diffDialog)==null||_.destroy(),this.diffDialog=null}),this.currentDiffViewer.$on("cancel",()=>{var f;(f=this.diffDialog)==null||f.destroy(),this.diffDialog=null,this.currentDiffViewer=null}),this.currentDiffViewer.$on("regenerate",async f=>{var b;const{instruction:m,original:p,currentModified:_}=f.detail;this.updateDiffViewer("â³ æ­£åœ¨é‡æ–°ç”Ÿæˆ...");try{const y=[{role:"system",content:"ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å†™ä½œåŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„è¦æ±‚ï¼Œç»“åˆåŽŸæ–‡ï¼Œç”Ÿæˆæ›´å¥½çš„å†…å®¹ã€‚åªè¾“å‡ºç”ŸæˆåŽçš„æ–‡æœ¬ï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šã€‚"},{role:"user",content:`ã€åŽŸæ–‡ã€‘
${p}

ã€ç”¨æˆ·è¦æ±‚ã€‘
${m}

è¯·æ ¹æ®è¦æ±‚é‡æ–°ç”Ÿæˆå†…å®¹ï¼Œç›´æŽ¥è¾“å‡ºæ–‡æœ¬ï¼Œæ— éœ€è§£é‡Šã€‚`}],v=await((b=ge.adapter)==null?void 0:b.chatCompletion(y));v&&v.content?this.updateDiffViewer(v.content):(alert("é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"),this.updateDiffViewer(_))}catch{alert("é‡æ–°ç”Ÿæˆæ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥AIæä¾›å•†é…ç½®"),this.updateDiffViewer(_)}}),this.currentDiffViewer.$on("switchModel",async f=>{var p;const m=f.detail;try{await Q.setCurrentProvider(m),ge.setProvider(Q.getCurrentProvider()),this.updateDiffViewer("â³ æ­£åœ¨ä½¿ç”¨æ–°æ¨¡åž‹é‡æ–°å¤„ç†...");const _=ge.buildOperationMessages(t,i),b=await((p=ge.adapter)==null?void 0:p.chatCompletion(_));b&&b.content?this.updateDiffViewer(b.content):alert("ä½¿ç”¨æ–°æ¨¡åž‹å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•")}catch{alert("åˆ‡æ¢æ¨¡åž‹å¤±è´¥")}});const h={chat:"å¯¹è¯",polish:"æ¶¦è‰²",translate:"ç¿»è¯‘",summarize:"æ€»ç»“",expand:"æ‰©å†™",condense:"ç²¾ç®€",rewrite:"æ”¹å†™",continue:"ç»­å†™",custom1:"è‡ªå®šä¹‰1",custom2:"è‡ªå®šä¹‰2",custom3:"è‡ªå®šä¹‰3"};this.diffDialog=Mi({title:`${h[i]||"AI"}ç»“æžœ - å·®å¼‚å¯¹æ¯”`,content:u,width:"800px",height:"600px",destroyCallback:()=>{this.diffDialog=null,this.currentDiffViewer=null}})}updateDiffViewer(t,n,i,r,a){if(this.currentDiffViewer){const l={modified:t};i!==void 0&&(l.selectedText=i),n!==void 0&&(l.original=n),this.currentDiffViewer.$set(l),i&&(this.currentSelectedText=i),n&&(this.currentOriginalText=n),r!==void 0&&r>=0&&(this.currentSelectionStart=r),a!==void 0&&a>=0&&(this.currentSelectionEnd=a)}}}exports.default=gc;
