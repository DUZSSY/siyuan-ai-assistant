"use strict";var oo=Object.defineProperty;var lo=(s,e,t)=>e in s?oo(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var q=(s,e,t)=>lo(s,typeof e!="symbol"?e+"":e,t);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const Bi=require("siyuan");function ze(){}function Li(s){return s()}function Sr(){return Object.create(null)}function Ce(s){s.forEach(Li)}function tn(s){return typeof s=="function"}function ks(s,e){return s!=s?e==e:s!==e||s&&typeof s=="object"||typeof s=="function"}function co(s){return Object.keys(s).length===0}function d(s,e){s.appendChild(e)}function $(s,e,t){s.insertBefore(e,t||null)}function j(s){s.parentNode&&s.parentNode.removeChild(s)}function Qe(s,e){for(let t=0;t<s.length;t+=1)s[t]&&s[t].d(e)}function b(s){return document.createElement(s)}function V(s){return document.createTextNode(s)}function E(){return V(" ")}function xi(){return V("")}function O(s,e,t,n){return s.addEventListener(e,t,n),()=>s.removeEventListener(e,t,n)}function p(s,e,t){t==null?s.removeAttribute(e):s.getAttribute(e)!==t&&s.setAttribute(e,t)}function Rn(s){return s===""?null:+s}function uo(s){return Array.from(s.childNodes)}function Y(s,e){e=""+e,s.data!==e&&(s.data=e)}function te(s,e){s.value=e??""}function ce(s,e,t){s.classList.toggle(e,!!t)}function ho(s,e,{bubbles:t=!1,cancelable:n=!1}={}){return new CustomEvent(s,{detail:e,bubbles:t,cancelable:n})}let Yt;function Xt(s){Yt=s}function Ni(){if(!Yt)throw new Error("Function called outside component initialization");return Yt}function Ss(s){Ni().$$.on_mount.push(s)}function fo(){const s=Ni();return(e,t,{cancelable:n=!1}={})=>{const i=s.$$.callbacks[e];if(i){const r=ho(e,t,{cancelable:n});return i.slice().forEach(a=>{a.call(s,r)}),!r.defaultPrevented}return!0}}const Rt=[],os=[];let Ft=[];const Cr=[],ji=Promise.resolve();let ls=!1;function zi(){ls||(ls=!0,ji.then($i))}function mo(){return zi(),ji}function cs(s){Ft.push(s)}const Gn=new Set;let Ct=0;function $i(){if(Ct!==0)return;const s=Yt;do{try{for(;Ct<Rt.length;){const e=Rt[Ct];Ct++,Xt(e),go(e.$$)}}catch(e){throw Rt.length=0,Ct=0,e}for(Xt(null),Rt.length=0,Ct=0;os.length;)os.pop()();for(let e=0;e<Ft.length;e+=1){const t=Ft[e];Gn.has(t)||(Gn.add(t),t())}Ft.length=0}while(Rt.length);for(;Cr.length;)Cr.pop()();ls=!1,Gn.clear(),Xt(s)}function go(s){if(s.fragment!==null){s.update(),Ce(s.before_update);const e=s.dirty;s.dirty=[-1],s.fragment&&s.fragment.p(s.ctx,e),s.after_update.forEach(cs)}}function po(s){const e=[],t=[];Ft.forEach(n=>s.indexOf(n)===-1?e.push(n):t.push(n)),t.forEach(n=>n()),Ft=e}const _o=new Set;function bo(s,e){s&&s.i&&(_o.delete(s),s.i(e))}function ue(s){return(s==null?void 0:s.length)!==void 0?s:Array.from(s)}function wo(s,e,t){const{fragment:n,after_update:i}=s.$$;n&&n.m(e,t),cs(()=>{const r=s.$$.on_mount.map(Li).filter(tn);s.$$.on_destroy?s.$$.on_destroy.push(...r):Ce(r),s.$$.on_mount=[]}),i.forEach(cs)}function vo(s,e){const t=s.$$;t.fragment!==null&&(po(t.after_update),Ce(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function yo(s,e){s.$$.dirty[0]===-1&&(Rt.push(s),zi(),s.$$.dirty.fill(0)),s.$$.dirty[e/31|0]|=1<<e%31}function Cs(s,e,t,n,i,r,a=null,o=[-1]){const l=Yt;Xt(s);const c=s.$$={fragment:null,ctx:[],props:r,update:ze,not_equal:i,bound:Sr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:Sr(),dirty:o,skip_bound:!1,root:e.target||l.$$.root};a&&a(c.root);let u=!1;if(c.ctx=t?t(s,e.props||{},(h,f,...m)=>{const g=m.length?m[0]:f;return c.ctx&&i(c.ctx[h],c.ctx[h]=g)&&(!c.skip_bound&&c.bound[h]&&c.bound[h](g),u&&yo(s,h)),f}):[],c.update(),u=!0,Ce(c.before_update),c.fragment=n?n(c.ctx):!1,e.target){if(e.hydrate){const h=uo(e.target);c.fragment&&c.fragment.l(h),h.forEach(j)}else c.fragment&&c.fragment.c();e.intro&&bo(s.$$.fragment),wo(s,e.target,e.anchor),$i()}Xt(l)}class Es{constructor(){q(this,"$$");q(this,"$$set")}$destroy(){vo(this,1),this.$destroy=ze}$on(e,t){if(!tn(t))return ze;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const i=n.indexOf(t);i!==-1&&n.splice(i,1)}}$set(e){this.$$set&&!co(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const Ao="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Ao);const us="RFC3986",hs={RFC1738:s=>String(s).replace(/%20/g,"+"),RFC3986:s=>String(s)},ko="RFC1738",So=Array.isArray,qe=(()=>{const s=[];for(let e=0;e<256;++e)s.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return s})(),Qn=1024,Co=(s,e,t,n,i)=>{if(s.length===0)return s;let r=s;if(typeof s=="symbol"?r=Symbol.prototype.toString.call(s):typeof s!="string"&&(r=String(s)),t==="iso-8859-1")return escape(r).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<r.length;o+=Qn){const l=r.length>=Qn?r.slice(o,o+Qn):r,c=[];for(let u=0;u<l.length;++u){let h=l.charCodeAt(u);if(h===45||h===46||h===95||h===126||h>=48&&h<=57||h>=65&&h<=90||h>=97&&h<=122||i===ko&&(h===40||h===41)){c[c.length]=l.charAt(u);continue}if(h<128){c[c.length]=qe[h];continue}if(h<2048){c[c.length]=qe[192|h>>6]+qe[128|h&63];continue}if(h<55296||h>=57344){c[c.length]=qe[224|h>>12]+qe[128|h>>6&63]+qe[128|h&63];continue}u+=1,h=65536+((h&1023)<<10|l.charCodeAt(u)&1023),c[c.length]=qe[240|h>>18]+qe[128|h>>12&63]+qe[128|h>>6&63]+qe[128|h&63]}a+=c.join("")}return a};function Eo(s){return!s||typeof s!="object"?!1:!!(s.constructor&&s.constructor.isBuffer&&s.constructor.isBuffer(s))}function Er(s,e){if(So(s)){const t=[];for(let n=0;n<s.length;n+=1)t.push(e(s[n]));return t}return e(s)}const Io=Object.prototype.hasOwnProperty,Ui={brackets(s){return String(s)+"[]"},comma:"comma",indices(s,e){return String(s)+"["+e+"]"},repeat(s){return String(s)}},Xe=Array.isArray,Po=Array.prototype.push,Hi=function(s,e){Po.apply(s,Xe(e)?e:[e])},Do=Date.prototype.toISOString,ge={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:Co,encodeValuesOnly:!1,format:us,formatter:hs[us],indices:!1,serializeDate(s){return Do.call(s)},skipNulls:!1,strictNullHandling:!1};function Ro(s){return typeof s=="string"||typeof s=="number"||typeof s=="boolean"||typeof s=="symbol"||typeof s=="bigint"}const Yn={};function Wi(s,e,t,n,i,r,a,o,l,c,u,h,f,m,g,_,w,y){let v=s,S=y,A=0,I=!1;for(;(S=S.get(Yn))!==void 0&&!I;){const F=S.get(s);if(A+=1,typeof F<"u"){if(F===A)throw new RangeError("Cyclic object value");I=!0}typeof S.get(Yn)>"u"&&(A=0)}if(typeof c=="function"?v=c(e,v):v instanceof Date?v=f==null?void 0:f(v):t==="comma"&&Xe(v)&&(v=Er(v,function(F){return F instanceof Date?f==null?void 0:f(F):F})),v===null){if(r)return l&&!_?l(e,ge.encoder,w,"key",m):e;v=""}if(Ro(v)||Eo(v)){if(l){const F=_?e:l(e,ge.encoder,w,"key",m);return[(g==null?void 0:g(F))+"="+(g==null?void 0:g(l(v,ge.encoder,w,"value",m)))]}return[(g==null?void 0:g(e))+"="+(g==null?void 0:g(String(v)))]}const C=[];if(typeof v>"u")return C;let k;if(t==="comma"&&Xe(v))_&&l&&(v=Er(v,l)),k=[{value:v.length>0?v.join(",")||null:void 0}];else if(Xe(c))k=c;else{const F=Object.keys(v);k=u?F.sort(u):F}const M=o?String(e).replace(/\./g,"%2E"):String(e),R=n&&Xe(v)&&v.length===1?M+"[]":M;if(i&&Xe(v)&&v.length===0)return R+"[]";for(let F=0;F<k.length;++F){const D=k[F],T=typeof D=="object"&&typeof D.value<"u"?D.value:v[D];if(a&&T===null)continue;const P=h&&o?D.replace(/\./g,"%2E"):D,B=Xe(v)?typeof t=="function"?t(R,P):R:R+(h?"."+P:"["+P+"]");y.set(s,A);const x=new WeakMap;x.set(Yn,y),Hi(C,Wi(T,B,t,n,i,r,a,o,t==="comma"&&_&&Xe(v)?null:l,c,u,h,f,m,g,_,w,x))}return C}function To(s=ge){if(typeof s.allowEmptyArrays<"u"&&typeof s.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof s.encodeDotInKeys<"u"&&typeof s.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(s.encoder!==null&&typeof s.encoder<"u"&&typeof s.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=s.charset||ge.charset;if(typeof s.charset<"u"&&s.charset!=="utf-8"&&s.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=us;if(typeof s.format<"u"){if(!Io.call(hs,s.format))throw new TypeError("Unknown format option provided.");t=s.format}const n=hs[t];let i=ge.filter;(typeof s.filter=="function"||Xe(s.filter))&&(i=s.filter);let r;if(s.arrayFormat&&s.arrayFormat in Ui?r=s.arrayFormat:"indices"in s?r=s.indices?"indices":"repeat":r=ge.arrayFormat,"commaRoundTrip"in s&&typeof s.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof s.allowDots>"u"?s.encodeDotInKeys?!0:ge.allowDots:!!s.allowDots;return{addQueryPrefix:typeof s.addQueryPrefix=="boolean"?s.addQueryPrefix:ge.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof s.allowEmptyArrays=="boolean"?!!s.allowEmptyArrays:ge.allowEmptyArrays,arrayFormat:r,charset:e,charsetSentinel:typeof s.charsetSentinel=="boolean"?s.charsetSentinel:ge.charsetSentinel,commaRoundTrip:!!s.commaRoundTrip,delimiter:typeof s.delimiter>"u"?ge.delimiter:s.delimiter,encode:typeof s.encode=="boolean"?s.encode:ge.encode,encodeDotInKeys:typeof s.encodeDotInKeys=="boolean"?s.encodeDotInKeys:ge.encodeDotInKeys,encoder:typeof s.encoder=="function"?s.encoder:ge.encoder,encodeValuesOnly:typeof s.encodeValuesOnly=="boolean"?s.encodeValuesOnly:ge.encodeValuesOnly,filter:i,format:t,formatter:n,serializeDate:typeof s.serializeDate=="function"?s.serializeDate:ge.serializeDate,skipNulls:typeof s.skipNulls=="boolean"?s.skipNulls:ge.skipNulls,sort:typeof s.sort=="function"?s.sort:null,strictNullHandling:typeof s.strictNullHandling=="boolean"?s.strictNullHandling:ge.strictNullHandling}}function Mo(s,e={}){let t=s;const n=To(e);let i,r;typeof n.filter=="function"?(r=n.filter,t=r("",t)):Xe(n.filter)&&(r=n.filter,i=r);const a=[];if(typeof t!="object"||t===null)return"";const o=Ui[n.arrayFormat],l=o==="comma"&&n.commaRoundTrip;i||(i=Object.keys(t)),n.sort&&i.sort(n.sort);const c=new WeakMap;for(let f=0;f<i.length;++f){const m=i[f];n.skipNulls&&t[m]===null||Hi(a,Wi(t[m],m,o,l,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,c))}const u=a.join(n.delimiter);let h=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?h+="utf8=%26%2310003%3B&":h+="utf8=%E2%9C%93&"),u.length>0?h+u:""}const Tt="4.104.0";let Ir=!1,Kt,Vi,Ji,fs,qi,Xi,Ki,Gi,Qi;function Oo(s,e={auto:!1}){if(Ir)throw new Error(`you must \`import 'openai/shims/${s.kind}'\` before importing anything else from openai`);if(Kt)throw new Error(`can't \`import 'openai/shims/${s.kind}'\` after \`import 'openai/shims/${Kt}'\``);Ir=e.auto,Kt=s.kind,Vi=s.fetch,Ji=s.FormData,fs=s.File,qi=s.ReadableStream,Xi=s.getMultipartRequestOptions,Ki=s.getDefaultAgent,Gi=s.fileFromPath,Qi=s.isFsReadStream}class Fo{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Bo({manuallyImported:s}={}){const e=s?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,n,i,r;try{t=fetch,n=Request,i=Response,r=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:i,Headers:r,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new Fo(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}const Yi=()=>{Kt||Oo(Bo(),{auto:!0})};Yi();class z extends Error{}class ye extends z{constructor(e,t,n,i){super(`${ye.makeMessage(e,t,n)}`),this.status=e,this.headers=i,this.request_id=i==null?void 0:i["x-request-id"],this.error=t;const r=t;this.code=r==null?void 0:r.code,this.param=r==null?void 0:r.param,this.type=r==null?void 0:r.type}static makeMessage(e,t,n){const i=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,n,i){if(!e||!i)return new Ln({message:n,cause:ms(t)});const r=t==null?void 0:t.error;return e===400?new Zi(e,r,n,i):e===401?new ea(e,r,n,i):e===403?new ta(e,r,n,i):e===404?new na(e,r,n,i):e===409?new sa(e,r,n,i):e===422?new ra(e,r,n,i):e===429?new ia(e,r,n,i):e>=500?new aa(e,r,n,i):new ye(e,r,n,i)}}class je extends ye{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Ln extends ye{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Is extends Ln{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Zi extends ye{}class ea extends ye{}class ta extends ye{}class na extends ye{}class sa extends ye{}class ra extends ye{}class ia extends ye{}class aa extends ye{}class oa extends z{constructor(){super("Could not parse response content as the length limit was reached")}}class la extends z{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var dn=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},bt=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},xe;class xn{constructor(){xe.set(this,void 0),this.buffer=new Uint8Array,dn(this,xe,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer),n.set(t,this.buffer.length),this.buffer=n;const i=[];let r;for(;(r=Lo(this.buffer,bt(this,xe,"f")))!=null;){if(r.carriage&&bt(this,xe,"f")==null){dn(this,xe,r.index,"f");continue}if(bt(this,xe,"f")!=null&&(r.index!==bt(this,xe,"f")+1||r.carriage)){i.push(this.decodeText(this.buffer.slice(0,bt(this,xe,"f")-1))),this.buffer=this.buffer.slice(bt(this,xe,"f")),dn(this,xe,null,"f");continue}const a=bt(this,xe,"f")!==null?r.preceding-1:r.preceding,o=this.decodeText(this.buffer.slice(0,a));i.push(o),this.buffer=this.buffer.slice(r.index),dn(this,xe,null,"f")}return i}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new z(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new z(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new z("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}xe=new WeakMap;xn.NEWLINE_CHARS=new Set([`
`,"\r"]);xn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Lo(s,e){for(let i=e??0;i<s.length;i++){if(s[i]===10)return{preceding:i,index:i+1,carriage:!1};if(s[i]===13)return{preceding:i,index:i+1,carriage:!0}}return null}function xo(s){for(let n=0;n<s.length-1;n++){if(s[n]===10&&s[n+1]===10||s[n]===13&&s[n+1]===13)return n+2;if(s[n]===13&&s[n+1]===10&&n+3<s.length&&s[n+2]===13&&s[n+3]===10)return n+4}return-1}function ca(s){if(s[Symbol.asyncIterator])return s;const e=s.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Ge{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const a of No(e,t))if(!r){if(a.data.startsWith("[DONE]")){r=!0;continue}if(a.event===null||a.event.startsWith("response.")||a.event.startsWith("transcript.")){let o;try{o=JSON.parse(a.data)}catch(l){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),l}if(o&&o.error)throw new ye(void 0,o.error,void 0,pa(e.headers));yield o}else{let o;try{o=JSON.parse(a.data)}catch(l){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),l}if(a.event=="error")throw new ye(void 0,o.error,o.message,void 0);yield{event:a.event,data:o}}}r=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{r||t.abort()}}return new Ge(i,t)}static fromReadableStream(e,t){let n=!1;async function*i(){const a=new xn,o=ca(e);for await(const l of o)for(const c of a.decode(l))yield c;for(const l of a.flush())yield l}async function*r(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(const o of i())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new Ge(r,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),i=r=>({next:()=>{if(r.length===0){const a=n.next();e.push(a),t.push(a)}return r.shift()}});return[new Ge(()=>i(e),this.controller),new Ge(()=>i(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new qi({async start(){t=e[Symbol.asyncIterator]()},async pull(i){try{const{value:r,done:a}=await t.next();if(a)return i.close();const o=n.encode(JSON.stringify(r)+`
`);i.enqueue(o)}catch(r){i.error(r)}},async cancel(){var i;await((i=t.return)==null?void 0:i.call(t))}})}}async function*No(s,e){if(!s.body)throw e.abort(),new z("Attempted to iterate over a response with no body");const t=new zo,n=new xn,i=ca(s.body);for await(const r of jo(i))for(const a of n.decode(r)){const o=t.decode(a);o&&(yield o)}for(const r of n.flush()){const a=t.decode(r);a&&(yield a)}}async function*jo(s){let e=new Uint8Array;for await(const t of s){if(t==null)continue;const n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let i=new Uint8Array(e.length+n.length);i.set(e),i.set(n,e.length),e=i;let r;for(;(r=xo(e))!==-1;)yield e.slice(0,r),e=e.slice(r)}e.length>0&&(yield e)}class zo{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const r={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],r}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,i]=$o(e,":");return i.startsWith(" ")&&(i=i.substring(1)),t==="event"?this.event=i:t==="data"&&this.data.push(i),null}}function $o(s,e){const t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}const ua=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function",ha=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&Nn(s),Nn=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",Uo=s=>ha(s)||ua(s)||Qi(s);async function fa(s,e,t){var i;if(s=await s,ha(s))return s;if(ua(s)){const r=await s.blob();e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()??"unknown_file");const a=Nn(r)?[await r.arrayBuffer()]:[r];return new fs(a,e,t)}const n=await Ho(s);if(e||(e=Vo(s)??"unknown_file"),!(t!=null&&t.type)){const r=(i=n[0])==null?void 0:i.type;typeof r=="string"&&(t={...t,type:r})}return new fs(n,e,t)}async function Ho(s){var t;let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(Nn(s))e.push(await s.arrayBuffer());else if(Jo(s))for await(const n of s)e.push(n);else throw new Error(`Unexpected data type: ${typeof s}; constructor: ${(t=s==null?void 0:s.constructor)==null?void 0:t.name}; props: ${Wo(s)}`);return e}function Wo(s){return`[${Object.getOwnPropertyNames(s).map(t=>`"${t}"`).join(", ")}]`}function Vo(s){var e;return Zn(s.name)||Zn(s.filename)||((e=Zn(s.path))==null?void 0:e.split(/[\\/]/).pop())}const Zn=s=>{if(typeof s=="string")return s;if(typeof Buffer<"u"&&s instanceof Buffer)return String(s)},Jo=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",Pr=s=>s&&typeof s=="object"&&s.body&&s[Symbol.toStringTag]==="MultipartBody",kt=async s=>{const e=await qo(s.body);return Xi(e,s)},qo=async s=>{const e=new Ji;return await Promise.all(Object.entries(s||{}).map(([t,n])=>ds(e,t,n))),e},ds=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(Uo(t)){const n=await fa(t);s.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>ds(s,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,i])=>ds(s,`${e}[${n}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Xo=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},Ko=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},mn;Yi();async function da(s){var a;const{response:e}=s;if(s.options.stream)return ht("response",e.status,e.url,e.headers,e.body),s.options.__streamClass?s.options.__streamClass.fromSSEResponse(e,s.controller):Ge.fromSSEResponse(e,s.controller);if(e.status===204)return null;if(s.options.__binaryResponse)return e;const t=e.headers.get("content-type"),n=(a=t==null?void 0:t.split(";")[0])==null?void 0:a.trim();if((n==null?void 0:n.includes("application/json"))||(n==null?void 0:n.endsWith("+json"))){const o=await e.json();return ht("response",e.status,e.url,e.headers,o),ma(o,e)}const r=await e.text();return ht("response",e.status,e.url,e.headers,r),r}function ma(s,e){return!s||typeof s!="object"||Array.isArray(s)?s:Object.defineProperty(s,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class jn extends Promise{constructor(e,t=da){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new jn(this.responsePromise,async t=>ma(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class Go{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:i,fetch:r}){this.baseURL=e,this.maxRetries=es("maxRetries",t),this.timeout=es("timeout",n),this.httpAgent=i,this.fetch=r??Vi}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...tl(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${il()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async i=>{const r=i&&Nn(i==null?void 0:i.body)?new DataView(await i.body.arrayBuffer()):(i==null?void 0:i.body)instanceof DataView?i.body:(i==null?void 0:i.body)instanceof ArrayBuffer?new DataView(i.body):i&&ArrayBuffer.isView(i==null?void 0:i.body)?new DataView(i.body.buffer):i==null?void 0:i.body;return{method:e,path:t,...i,body:r}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var _;const n={...e},{method:i,path:r,query:a,headers:o={}}=n,l=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:Pr(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,c=this.calculateContentLength(l),u=this.buildURL(r,a);"timeout"in n&&es("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const h=n.httpAgent??this.httpAgent??Ki(u),f=n.timeout+1e3;typeof((_=h==null?void 0:h.options)==null?void 0:_.timeout)=="number"&&f>(h.options.timeout??0)&&(h.options.timeout=f),this.idempotencyHeader&&i!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);const m=this.buildHeaders({options:n,headers:o,contentLength:c,retryCount:t});return{req:{method:i,...l&&{body:l},headers:m,...h&&{agent:h},signal:n.signal??null},url:u,timeout:n.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:i}){const r={};n&&(r["content-length"]=n);const a=this.defaultHeaders(e);return Mr(r,a),Mr(r,t),Pr(e.body)&&Kt!=="node"&&delete r["content-type"],pn(a,"x-stainless-retry-count")===void 0&&pn(t,"x-stainless-retry-count")===void 0&&(r["x-stainless-retry-count"]=String(i)),pn(a,"x-stainless-timeout")===void 0&&pn(t,"x-stainless-timeout")===void 0&&e.timeout&&(r["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,i){return ye.generate(e,t,n,i)}request(e,t=null){return new jn(this.makeRequest(e,t))}async makeRequest(e,t){var h,f;const n=await e,i=n.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(n);const{req:r,url:a,timeout:o}=this.buildRequest(n,{retryCount:i-t});if(await this.prepareRequest(r,{url:a,options:n}),ht("request",a,n,r.headers),(h=n.signal)!=null&&h.aborted)throw new je;const l=new AbortController,c=await this.fetchWithTimeout(a,r,o,l).catch(ms);if(c instanceof Error){if((f=n.signal)!=null&&f.aborted)throw new je;if(t)return this.retryRequest(n,t);throw c.name==="AbortError"?new Is:new Ln({cause:c})}const u=pa(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const v=`retrying, ${t} attempts remaining`;return ht(`response (error; ${v})`,c.status,a,u),this.retryRequest(n,t,u)}const m=await c.text().catch(v=>ms(v).message),g=nl(m),_=g?void 0:m;throw ht(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,a,u,_),this.makeStatusError(c.status,g,_,u)}return{response:c,options:n,controller:l}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Qo(this,n,e)}buildURL(e,t){const n=rl(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return _a(i)||(t={...i,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new z(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,i){const{signal:r,...a}=t||{};r&&r.addEventListener("abort",()=>i.abort());const o=setTimeout(()=>i.abort(),n),l={signal:i.signal,...a};return l.method&&(l.method=l.method.toUpperCase()),this.fetch.call(void 0,e,l).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let i;const r=n==null?void 0:n["retry-after-ms"];if(r){const o=parseFloat(r);Number.isNaN(o)||(i=o)}const a=n==null?void 0:n["retry-after"];if(a&&!i){const o=parseFloat(a);Number.isNaN(o)?i=Date.parse(a)-Date.now():i=o*1e3}if(!(i&&0<=i&&i<60*1e3)){const o=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,o)}return await nn(i),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const r=t-e,a=Math.min(.5*Math.pow(2,r),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Tt}`}}class ga{constructor(e,t,n,i){mn.set(this,void 0),Xo(this,mn,e,"f"),this.options=i,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new z("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[i,r]of n)e.url.searchParams.set(i,r);t.query=void 0,t.path=e.url.toString()}return await Ko(this,mn,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(mn=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Qo extends jn{constructor(e,t,n){super(t,async i=>new n(e,i.response,await da(i),i.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const pa=s=>new Proxy(Object.fromEntries(s.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),Yo={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ie=s=>typeof s=="object"&&s!==null&&!_a(s)&&Object.keys(s).every(e=>ba(Yo,e)),Zo=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tt,"X-Stainless-OS":Rr(Deno.build.os),"X-Stainless-Arch":Dr(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tt,"X-Stainless-OS":Rr(process.platform),"X-Stainless-Arch":Dr(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const s=el();return s?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${s.browser}`,"X-Stainless-Runtime-Version":s.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function el(){if(typeof navigator>"u"||!navigator)return null;const s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of s){const n=t.exec(navigator.userAgent);if(n){const i=n[1]||0,r=n[2]||0,a=n[3]||0;return{browser:e,version:`${i}.${r}.${a}`}}}return null}const Dr=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",Rr=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown");let Tr;const tl=()=>Tr??(Tr=Zo()),nl=s=>{try{return JSON.parse(s)}catch{return}},sl=/^[a-z][a-z0-9+.-]*:/i,rl=s=>sl.test(s),nn=s=>new Promise(e=>setTimeout(e,s)),es=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new z(`${s} must be an integer`);if(e<0)throw new z(`${s} must be a positive integer`);return e},ms=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null)try{return new Error(JSON.stringify(s))}catch{}return new Error(s)},gn=s=>{var e,t,n,i,r;if(typeof process<"u")return((t=(e=process.env)==null?void 0:e[s])==null?void 0:t.trim())??void 0;if(typeof Deno<"u")return(r=(i=(n=Deno.env)==null?void 0:n.get)==null?void 0:i.call(n,s))==null?void 0:r.trim()};function _a(s){if(!s)return!0;for(const e in s)return!1;return!0}function ba(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Mr(s,e){for(const t in e){if(!ba(e,t))continue;const n=t.toLowerCase();if(!n)continue;const i=e[t];i===null?delete s[n]:i!==void 0&&(s[n]=i)}}const Or=new Set(["authorization","api-key"]);function ht(s,...e){var t;if(typeof process<"u"&&((t=process==null?void 0:process.env)==null?void 0:t.DEBUG)==="true"){const n=e.map(i=>{if(!i)return i;if(i.headers){const a={...i,headers:{...i.headers}};for(const o in i.headers)Or.has(o.toLowerCase())&&(a.headers[o]="REDACTED");return a}let r=null;for(const a in i)Or.has(a.toLowerCase())&&(r??(r={...i}),r[a]="REDACTED");return r??i});console.log(`OpenAI:DEBUG:${s}`,...n)}}const il=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}),al=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",ol=s=>typeof(s==null?void 0:s.get)=="function",pn=(s,e)=>{var n;const t=e.toLowerCase();if(ol(s)){const i=((n=e[0])==null?void 0:n.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(r,a,o)=>a+o.toUpperCase());for(const r of[e,t,e.toUpperCase(),i]){const a=s.get(r);if(a)return a}}for(const[i,r]of Object.entries(s))if(i.toLowerCase()===t)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${e} header, using the first entry.`),r[0]):r},ll=s=>{if(typeof Buffer<"u"){const e=Buffer.from(s,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(s),t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return Array.from(new Float32Array(n.buffer))}};function ts(s){return s!=null&&typeof s=="object"&&!Array.isArray(s)}class zn extends ga{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class _e extends ga{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var n;const e=this.getPaginatedItems();if(!e.length)return null;const t=(n=e[e.length-1])==null?void 0:n.id;return t?{params:{after:t}}:null}}class U{constructor(e){this._client=e}}let wa=class extends U{list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,cl,{query:t,...n})}},$n=class extends U{constructor(){super(...arguments),this.messages=new wa(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/chat/completions",Un,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}};class Un extends _e{}class cl extends _e{}$n.ChatCompletionsPage=Un;$n.Messages=wa;let Hn=class extends U{constructor(){super(...arguments),this.completions=new $n(this._client)}};Hn.Completions=$n;Hn.ChatCompletionsPage=Un;class va extends U{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class ya extends U{create(e,t){return this._client.post("/audio/transcriptions",kt({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class Aa extends U{create(e,t){return this._client.post("/audio/translations",kt({body:e,...t,__metadata:{model:e.model}}))}}class sn extends U{constructor(){super(...arguments),this.transcriptions=new ya(this._client),this.translations=new Aa(this._client),this.speech=new va(this._client)}}sn.Transcriptions=ya;sn.Translations=Aa;sn.Speech=va;class Ps extends U{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/batches",Ds,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Ds extends _e{}Ps.BatchesPage=Ds;var Ue=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},re=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},gs,Sn,Cn,Ut,Ht,En,Wt,st,Vt,Tn,Mn,Mt,ka;class Rs{constructor(){gs.add(this),this.controller=new AbortController,Sn.set(this,void 0),Cn.set(this,()=>{}),Ut.set(this,()=>{}),Ht.set(this,void 0),En.set(this,()=>{}),Wt.set(this,()=>{}),st.set(this,{}),Vt.set(this,!1),Tn.set(this,!1),Mn.set(this,!1),Mt.set(this,!1),Ue(this,Sn,new Promise((e,t)=>{Ue(this,Cn,e,"f"),Ue(this,Ut,t,"f")}),"f"),Ue(this,Ht,new Promise((e,t)=>{Ue(this,En,e,"f"),Ue(this,Wt,t,"f")}),"f"),re(this,Sn,"f").catch(()=>{}),re(this,Ht,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},re(this,gs,"m",ka).bind(this))},0)}_connected(){this.ended||(re(this,Cn,"f").call(this),this._emit("connect"))}get ended(){return re(this,Vt,"f")}get errored(){return re(this,Tn,"f")}get aborted(){return re(this,Mn,"f")}abort(){this.controller.abort()}on(e,t){return(re(this,st,"f")[e]||(re(this,st,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=re(this,st,"f")[e];if(!n)return this;const i=n.findIndex(r=>r.listener===t);return i>=0&&n.splice(i,1),this}once(e,t){return(re(this,st,"f")[e]||(re(this,st,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{Ue(this,Mt,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){Ue(this,Mt,!0,"f"),await re(this,Ht,"f")}_emit(e,...t){if(re(this,Vt,"f"))return;e==="end"&&(Ue(this,Vt,!0,"f"),re(this,En,"f").call(this));const n=re(this,st,"f")[e];if(n&&(re(this,st,"f")[e]=n.filter(i=>!i.once),n.forEach(({listener:i})=>i(...t))),e==="abort"){const i=t[0];!re(this,Mt,"f")&&!(n!=null&&n.length)&&Promise.reject(i),re(this,Ut,"f").call(this,i),re(this,Wt,"f").call(this,i),this._emit("end");return}if(e==="error"){const i=t[0];!re(this,Mt,"f")&&!(n!=null&&n.length)&&Promise.reject(i),re(this,Ut,"f").call(this,i),re(this,Wt,"f").call(this,i),this._emit("end")}}_emitFinal(){}}Sn=new WeakMap,Cn=new WeakMap,Ut=new WeakMap,Ht=new WeakMap,En=new WeakMap,Wt=new WeakMap,st=new WeakMap,Vt=new WeakMap,Tn=new WeakMap,Mn=new WeakMap,Mt=new WeakMap,gs=new WeakSet,ka=function(e){if(Ue(this,Tn,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new je),e instanceof je)return Ue(this,Mn,!0,"f"),this._emit("abort",e);if(e instanceof z)return this._emit("error",e);if(e instanceof Error){const t=new z(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new z(String(e)))};var L=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},Le=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},ve,ps,Ke,In,He,yt,Ot,vt,On,Ne,Pn,Dn,Gt,Jt,qt,Fr,Br,Lr,xr,Nr,jr,zr;class We extends Rs{constructor(){super(...arguments),ve.add(this),ps.set(this,[]),Ke.set(this,{}),In.set(this,{}),He.set(this,void 0),yt.set(this,void 0),Ot.set(this,void 0),vt.set(this,void 0),On.set(this,void 0),Ne.set(this,void 0),Pn.set(this,void 0),Dn.set(this,void 0),Gt.set(this,void 0)}[(ps=new WeakMap,Ke=new WeakMap,In=new WeakMap,He=new WeakMap,yt=new WeakMap,Ot=new WeakMap,vt=new WeakMap,On=new WeakMap,Ne=new WeakMap,Pn=new WeakMap,Dn=new WeakMap,Gt=new WeakMap,ve=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",i=>{const r=t.shift();r?r.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((r,a)=>t.push({resolve:r,reject:a})).then(r=>r?{value:r,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new We;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var r;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const i=Ge.fromReadableStream(e,this.controller);for await(const a of i)L(this,ve,"m",Jt).call(this,a);if((r=i.controller.signal)!=null&&r.aborted)throw new je;return this._addRun(L(this,ve,"m",qt).call(this))}toReadableStream(){return new Ge(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,i,r){const a=new We;return a._run(()=>a._runToolAssistantStream(e,t,n,i,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,n,i,r){var c;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const o={...i,stream:!0},l=await e.submitToolOutputs(t,n,o,{...r,signal:this.controller.signal});this._connected();for await(const u of l)L(this,ve,"m",Jt).call(this,u);if((c=l.controller.signal)!=null&&c.aborted)throw new je;return this._addRun(L(this,ve,"m",qt).call(this))}static createThreadAssistantStream(e,t,n){const i=new We;return i._run(()=>i._threadAssistantStream(e,t,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}static createAssistantStream(e,t,n,i){const r=new We;return r._run(()=>r._runAssistantStream(e,t,n,{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),r}currentEvent(){return L(this,Pn,"f")}currentRun(){return L(this,Dn,"f")}currentMessageSnapshot(){return L(this,He,"f")}currentRunStepSnapshot(){return L(this,Gt,"f")}async finalRunSteps(){return await this.done(),Object.values(L(this,Ke,"f"))}async finalMessages(){return await this.done(),Object.values(L(this,In,"f"))}async finalRun(){if(await this.done(),!L(this,yt,"f"))throw Error("Final run was not received.");return L(this,yt,"f")}async _createThreadAssistantStream(e,t,n){var o;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const r={...t,stream:!0},a=await e.createAndRun(r,{...n,signal:this.controller.signal});this._connected();for await(const l of a)L(this,ve,"m",Jt).call(this,l);if((o=a.controller.signal)!=null&&o.aborted)throw new je;return this._addRun(L(this,ve,"m",qt).call(this))}async _createAssistantStream(e,t,n,i){var l;const r=i==null?void 0:i.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},o=await e.create(t,a,{...i,signal:this.controller.signal});this._connected();for await(const c of o)L(this,ve,"m",Jt).call(this,c);if((l=o.controller.signal)!=null&&l.aborted)throw new je;return this._addRun(L(this,ve,"m",qt).call(this))}static accumulateDelta(e,t){for(const[n,i]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=i;continue}let r=e[n];if(r==null){e[n]=i;continue}if(n==="index"||n==="type"){e[n]=i;continue}if(typeof r=="string"&&typeof i=="string")r+=i;else if(typeof r=="number"&&typeof i=="number")r+=i;else if(ts(r)&&ts(i))r=this.accumulateDelta(r,i);else if(Array.isArray(r)&&Array.isArray(i)){if(r.every(a=>typeof a=="string"||typeof a=="number")){r.push(...i);continue}for(const a of i){if(!ts(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const l=r[o];l==null?r.push(a):r[o]=this.accumulateDelta(l,a)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${i}, accValue: ${r}`);e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,i){return await this._createAssistantStream(t,e,n,i)}async _runToolAssistantStream(e,t,n,i,r){return await this._createToolAssistantStream(n,e,t,i,r)}}Jt=function(e){if(!this.ended)switch(Le(this,Pn,e,"f"),L(this,ve,"m",Lr).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":L(this,ve,"m",zr).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":L(this,ve,"m",Br).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":L(this,ve,"m",Fr).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},qt=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");if(!L(this,yt,"f"))throw Error("Final run has not been received");return L(this,yt,"f")},Fr=function(e){const[t,n]=L(this,ve,"m",Nr).call(this,e,L(this,He,"f"));Le(this,He,t,"f"),L(this,In,"f")[t.id]=t;for(const i of n){const r=t.content[i.index];(r==null?void 0:r.type)=="text"&&this._emit("textCreated",r.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const i of e.data.delta.content){if(i.type=="text"&&i.text){let r=i.text,a=t.content[i.index];if(a&&a.type=="text")this._emit("textDelta",r,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(i.index!=L(this,Ot,"f")){if(L(this,vt,"f"))switch(L(this,vt,"f").type){case"text":this._emit("textDone",L(this,vt,"f").text,L(this,He,"f"));break;case"image_file":this._emit("imageFileDone",L(this,vt,"f").image_file,L(this,He,"f"));break}Le(this,Ot,i.index,"f")}Le(this,vt,t.content[i.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(L(this,Ot,"f")!==void 0){const i=e.data.content[L(this,Ot,"f")];if(i)switch(i.type){case"image_file":this._emit("imageFileDone",i.image_file,L(this,He,"f"));break;case"text":this._emit("textDone",i.text,L(this,He,"f"));break}}L(this,He,"f")&&this._emit("messageDone",e.data),Le(this,He,void 0,"f")}},Br=function(e){const t=L(this,ve,"m",xr).call(this,e);switch(Le(this,Gt,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&n.step_details.type=="tool_calls"&&n.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const r of n.step_details.tool_calls)r.index==L(this,On,"f")?this._emit("toolCallDelta",r,t.step_details.tool_calls[r.index]):(L(this,Ne,"f")&&this._emit("toolCallDone",L(this,Ne,"f")),Le(this,On,r.index,"f"),Le(this,Ne,t.step_details.tool_calls[r.index],"f"),L(this,Ne,"f")&&this._emit("toolCallCreated",L(this,Ne,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Le(this,Gt,void 0,"f"),e.data.step_details.type=="tool_calls"&&L(this,Ne,"f")&&(this._emit("toolCallDone",L(this,Ne,"f")),Le(this,Ne,void 0,"f")),this._emit("runStepDone",e.data,t);break}},Lr=function(e){L(this,ps,"f").push(e),this._emit("event",e)},xr=function(e){switch(e.event){case"thread.run.step.created":return L(this,Ke,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=L(this,Ke,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const i=We.accumulateDelta(t,n.delta);L(this,Ke,"f")[e.data.id]=i}return L(this,Ke,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":L(this,Ke,"f")[e.data.id]=e.data;break}if(L(this,Ke,"f")[e.data.id])return L(this,Ke,"f")[e.data.id];throw new Error("No snapshot available")},Nr=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let i=e.data;if(i.delta.content)for(const r of i.delta.content)if(r.index in t.content){let a=t.content[r.index];t.content[r.index]=L(this,ve,"m",jr).call(this,r,a)}else t.content[r.index]=r,n.push(r);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},jr=function(e,t){return We.accumulateDelta(t,e)},zr=function(e){switch(Le(this,Dn,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Le(this,yt,e.data,"f"),L(this,Ne,"f")&&(this._emit("toolCallDone",L(this,Ne,"f")),Le(this,Ne,void 0,"f"));break}};class Ts extends U{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/assistants",Ms,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Ms extends _e{}Ts.AssistantsPage=Ms;function $r(s){return typeof s.parse=="function"}const Bt=s=>(s==null?void 0:s.role)==="assistant",Sa=s=>(s==null?void 0:s.role)==="function",Ca=s=>(s==null?void 0:s.role)==="tool";function Os(s){return(s==null?void 0:s.$brand)==="auto-parseable-response-format"}function rn(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function ul(s,e){return!e||!Ea(e)?{...s,choices:s.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:Fs(s,e)}function Fs(s,e){const t=s.choices.map(n=>{var i;if(n.finish_reason==="length")throw new oa;if(n.finish_reason==="content_filter")throw new la;return{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:((i=n.message.tool_calls)==null?void 0:i.map(r=>fl(e,r)))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?hl(e,n.message.content):null}}});return{...s,choices:t}}function hl(s,e){var t,n;return((t=s.response_format)==null?void 0:t.type)!=="json_schema"?null:((n=s.response_format)==null?void 0:n.type)==="json_schema"?"$parseRaw"in s.response_format?s.response_format.$parseRaw(e):JSON.parse(e):null}function fl(s,e){var n;const t=(n=s.tools)==null?void 0:n.find(i=>{var r;return((r=i.function)==null?void 0:r.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:rn(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function dl(s,e){var n;if(!s)return!1;const t=(n=s.tools)==null?void 0:n.find(i=>{var r;return((r=i.function)==null?void 0:r.name)===e.function.name});return rn(t)||(t==null?void 0:t.function.strict)||!1}function Ea(s){var e;return Os(s.response_format)?!0:((e=s.tools)==null?void 0:e.some(t=>rn(t)||t.type==="function"&&t.function.strict===!0))??!1}function ml(s){for(const e of s??[]){if(e.type!=="function")throw new z(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new z(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Re=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},Ae,_s,Fn,bs,ws,vs,Ia,ys;const Ur=10;class Pa extends Rs{constructor(){super(...arguments),Ae.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var n;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(n=e.choices[0])==null?void 0:n.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Sa(e)||Ca(e))&&e.content)this._emit("functionCallResult",e.content);else if(Bt(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Bt(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionCall",n.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new z("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Re(this,Ae,"m",_s).call(this)}async finalMessage(){return await this.done(),Re(this,Ae,"m",Fn).call(this)}async finalFunctionCall(){return await this.done(),Re(this,Ae,"m",bs).call(this)}async finalFunctionCallResult(){return await this.done(),Re(this,Ae,"m",ws).call(this)}async totalUsage(){return await this.done(),Re(this,Ae,"m",vs).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Re(this,Ae,"m",Fn).call(this);t&&this._emit("finalMessage",t);const n=Re(this,Ae,"m",_s).call(this);n&&this._emit("finalContent",n);const i=Re(this,Ae,"m",bs).call(this);i&&this._emit("finalFunctionCall",i);const r=Re(this,Ae,"m",ws).call(this);r!=null&&this._emit("finalFunctionCallResult",r),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",Re(this,Ae,"m",vs).call(this))}async _createChatCompletion(e,t,n){const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),Re(this,Ae,"m",Ia).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Fs(r,t))}async _runChatCompletion(e,t,n){for(const i of t.messages)this._addMessage(i,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){var f;const i="function",{function_call:r="auto",stream:a,...o}=t,l=typeof r!="string"&&(r==null?void 0:r.name),{maxChatCompletions:c=Ur}=n||{},u={};for(const m of t.functions)u[m.name||m.function.name]=m;const h=t.functions.map(m=>({name:m.name||m.function.name,parameters:m.parameters,description:m.description}));for(const m of t.messages)this._addMessage(m,!1);for(let m=0;m<c;++m){const _=(f=(await this._createChatCompletion(e,{...o,function_call:r,functions:h,messages:[...this.messages]},n)).choices[0])==null?void 0:f.message;if(!_)throw new z("missing message in ChatCompletion response");if(!_.function_call)return;const{name:w,arguments:y}=_.function_call,v=u[w];if(v){if(l&&l!==w){const C=`Invalid function_call: ${JSON.stringify(w)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:i,name:w,content:C});continue}}else{const C=`Invalid function_call: ${JSON.stringify(w)}. Available options are: ${h.map(k=>JSON.stringify(k.name)).join(", ")}. Please try again`;this._addMessage({role:i,name:w,content:C});continue}let S;try{S=$r(v)?await v.parse(y):y}catch(C){this._addMessage({role:i,name:w,content:C instanceof Error?C.message:String(C)});continue}const A=await v.function(S,this),I=Re(this,Ae,"m",ys).call(this,A);if(this._addMessage({role:i,name:w,content:I}),l)return}}async _runTools(e,t,n){var m,g,_;const i="tool",{tool_choice:r="auto",stream:a,...o}=t,l=typeof r!="string"&&((m=r==null?void 0:r.function)==null?void 0:m.name),{maxChatCompletions:c=Ur}=n||{},u=t.tools.map(w=>{if(rn(w)){if(!w.$callback)throw new z("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:w.$callback,name:w.function.name,description:w.function.description||"",parameters:w.function.parameters,parse:w.$parseRaw,strict:!0}}}return w}),h={};for(const w of u)w.type==="function"&&(h[w.function.name||w.function.function.name]=w.function);const f="tools"in t?u.map(w=>w.type==="function"?{type:"function",function:{name:w.function.name||w.function.function.name,parameters:w.function.parameters,description:w.function.description,strict:w.function.strict}}:w):void 0;for(const w of t.messages)this._addMessage(w,!1);for(let w=0;w<c;++w){const v=(g=(await this._createChatCompletion(e,{...o,tool_choice:r,tools:f,messages:[...this.messages]},n)).choices[0])==null?void 0:g.message;if(!v)throw new z("missing message in ChatCompletion response");if(!((_=v.tool_calls)!=null&&_.length))return;for(const S of v.tool_calls){if(S.type!=="function")continue;const A=S.id,{name:I,arguments:C}=S.function,k=h[I];if(k){if(l&&l!==I){const D=`Invalid tool_call: ${JSON.stringify(I)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:i,tool_call_id:A,content:D});continue}}else{const D=`Invalid tool_call: ${JSON.stringify(I)}. Available options are: ${Object.keys(h).map(T=>JSON.stringify(T)).join(", ")}. Please try again`;this._addMessage({role:i,tool_call_id:A,content:D});continue}let M;try{M=$r(k)?await k.parse(C):C}catch(D){const T=D instanceof Error?D.message:String(D);this._addMessage({role:i,tool_call_id:A,content:T});continue}const R=await k.function(M,this),F=Re(this,Ae,"m",ys).call(this,R);if(this._addMessage({role:i,tool_call_id:A,content:F}),l)return}}}}Ae=new WeakSet,_s=function(){return Re(this,Ae,"m",Fn).call(this).content??null},Fn=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Bt(t)){const{function_call:n,...i}=t,r={...i,content:t.content??null,refusal:t.refusal??null};return n&&(r.function_call=n),r}}throw new z("stream ended without producing a ChatCompletionMessage with role=assistant")},bs=function(){var e,t;for(let n=this.messages.length-1;n>=0;n--){const i=this.messages[n];if(Bt(i)&&(i!=null&&i.function_call))return i.function_call;if(Bt(i)&&((e=i==null?void 0:i.tool_calls)!=null&&e.length))return(t=i.tool_calls.at(-1))==null?void 0:t.function}},ws=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Sa(t)&&t.content!=null||Ca(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(n=>{var i;return n.role==="assistant"&&((i=n.tool_calls)==null?void 0:i.some(r=>r.type==="function"&&r.id===t.tool_call_id))}))return t.content}},vs=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Ia=function(e){if(e.n!=null&&e.n>1)throw new z("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ys=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Zt extends Pa{static runFunctions(e,t,n){const i=new Zt,r={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runFunctions"}};return i._run(()=>i._runFunctions(e,t,r)),i}static runTools(e,t,n){const i=new Zt,r={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,r)),i}_addMessage(e,t=!0){super._addMessage(e,t),Bt(e)&&e.content&&this._emit("content",e.content)}}const Da=1,Ra=2,Ta=4,Ma=8,Oa=16,Fa=32,Ba=64,La=128,xa=256,Na=La|xa,ja=Oa|Fa|Na|Ba,za=Da|Ra|ja,$a=Ta|Ma,gl=za|$a,we={STR:Da,NUM:Ra,ARR:Ta,OBJ:Ma,NULL:Oa,BOOL:Fa,NAN:Ba,INFINITY:La,MINUS_INFINITY:xa,INF:Na,SPECIAL:ja,ATOM:za,COLLECTION:$a,ALL:gl};class pl extends Error{}class _l extends Error{}function bl(s,e=we.ALL){if(typeof s!="string")throw new TypeError(`expecting str, got ${typeof s}`);if(!s.trim())throw new Error(`${s} is empty`);return wl(s.trim(),e)}const wl=(s,e)=>{const t=s.length;let n=0;const i=f=>{throw new pl(`${f} at position ${n}`)},r=f=>{throw new _l(`${f} at position ${n}`)},a=()=>(h(),n>=t&&i("Unexpected end of input"),s[n]==='"'?o():s[n]==="{"?l():s[n]==="["?c():s.substring(n,n+4)==="null"||we.NULL&e&&t-n<4&&"null".startsWith(s.substring(n))?(n+=4,null):s.substring(n,n+4)==="true"||we.BOOL&e&&t-n<4&&"true".startsWith(s.substring(n))?(n+=4,!0):s.substring(n,n+5)==="false"||we.BOOL&e&&t-n<5&&"false".startsWith(s.substring(n))?(n+=5,!1):s.substring(n,n+8)==="Infinity"||we.INFINITY&e&&t-n<8&&"Infinity".startsWith(s.substring(n))?(n+=8,1/0):s.substring(n,n+9)==="-Infinity"||we.MINUS_INFINITY&e&&1<t-n&&t-n<9&&"-Infinity".startsWith(s.substring(n))?(n+=9,-1/0):s.substring(n,n+3)==="NaN"||we.NAN&e&&t-n<3&&"NaN".startsWith(s.substring(n))?(n+=3,NaN):u()),o=()=>{const f=n;let m=!1;for(n++;n<t&&(s[n]!=='"'||m&&s[n-1]==="\\");)m=s[n]==="\\"?!m:!1,n++;if(s.charAt(n)=='"')try{return JSON.parse(s.substring(f,++n-Number(m)))}catch(g){r(String(g))}else if(we.STR&e)try{return JSON.parse(s.substring(f,n-Number(m))+'"')}catch{return JSON.parse(s.substring(f,s.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},l=()=>{n++,h();const f={};try{for(;s[n]!=="}";){if(h(),n>=t&&we.OBJ&e)return f;const m=o();h(),n++;try{const g=a();Object.defineProperty(f,m,{value:g,writable:!0,enumerable:!0,configurable:!0})}catch(g){if(we.OBJ&e)return f;throw g}h(),s[n]===","&&n++}}catch{if(we.OBJ&e)return f;i("Expected '}' at end of object")}return n++,f},c=()=>{n++;const f=[];try{for(;s[n]!=="]";)f.push(a()),h(),s[n]===","&&n++}catch{if(we.ARR&e)return f;i("Expected ']' at end of array")}return n++,f},u=()=>{if(n===0){s==="-"&&we.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(s)}catch(m){if(we.NUM&e)try{return s[s.length-1]==="."?JSON.parse(s.substring(0,s.lastIndexOf("."))):JSON.parse(s.substring(0,s.lastIndexOf("e")))}catch{}r(String(m))}}const f=n;for(s[n]==="-"&&n++;s[n]&&!",]}".includes(s[n]);)n++;n==t&&!(we.NUM&e)&&i("Unterminated number literal");try{return JSON.parse(s.substring(f,n))}catch{s.substring(f,n)==="-"&&we.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(s.substring(f,s.lastIndexOf("e")))}catch(g){r(String(g))}}},h=()=>{for(;n<t&&` 
\r	`.includes(s[n]);)n++};return a()},Hr=s=>bl(s,we.ALL^we.NUM);var Et=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},Z=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},me,nt,It,lt,ns,_n,ss,rs,is,bn,as,Wr;class en extends Pa{constructor(e){super(),me.add(this),nt.set(this,void 0),It.set(this,void 0),lt.set(this,void 0),Et(this,nt,e,"f"),Et(this,It,[],"f")}get currentChatCompletionSnapshot(){return Z(this,lt,"f")}static fromReadableStream(e){const t=new en(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const i=new en(t);return i._run(()=>i._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createChatCompletion(e,t,n){var a;super._createChatCompletion;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),Z(this,me,"m",ns).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const o of r)Z(this,me,"m",ss).call(this,o);if((a=r.controller.signal)!=null&&a.aborted)throw new je;return this._addChatCompletion(Z(this,me,"m",bn).call(this))}async _fromReadableStream(e,t){var a;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),Z(this,me,"m",ns).call(this),this._connected();const i=Ge.fromReadableStream(e,this.controller);let r;for await(const o of i)r&&r!==o.id&&this._addChatCompletion(Z(this,me,"m",bn).call(this)),Z(this,me,"m",ss).call(this,o),r=o.id;if((a=i.controller.signal)!=null&&a.aborted)throw new je;return this._addChatCompletion(Z(this,me,"m",bn).call(this))}[(nt=new WeakMap,It=new WeakMap,lt=new WeakMap,me=new WeakSet,ns=function(){this.ended||Et(this,lt,void 0,"f")},_n=function(t){let n=Z(this,It,"f")[t.index];return n||(n={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Z(this,It,"f")[t.index]=n,n)},ss=function(t){var i,r,a,o,l,c,u,h,f,m,g,_,w,y,v;if(this.ended)return;const n=Z(this,me,"m",Wr).call(this,t);this._emit("chunk",t,n);for(const S of t.choices){const A=n.choices[S.index];S.delta.content!=null&&((i=A.message)==null?void 0:i.role)==="assistant"&&((r=A.message)!=null&&r.content)&&(this._emit("content",S.delta.content,A.message.content),this._emit("content.delta",{delta:S.delta.content,snapshot:A.message.content,parsed:A.message.parsed})),S.delta.refusal!=null&&((a=A.message)==null?void 0:a.role)==="assistant"&&((o=A.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:S.delta.refusal,snapshot:A.message.refusal}),((l=S.logprobs)==null?void 0:l.content)!=null&&((c=A.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(u=S.logprobs)==null?void 0:u.content,snapshot:((h=A.logprobs)==null?void 0:h.content)??[]}),((f=S.logprobs)==null?void 0:f.refusal)!=null&&((m=A.message)==null?void 0:m.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(g=S.logprobs)==null?void 0:g.refusal,snapshot:((_=A.logprobs)==null?void 0:_.refusal)??[]});const I=Z(this,me,"m",_n).call(this,A);A.finish_reason&&(Z(this,me,"m",is).call(this,A),I.current_tool_call_index!=null&&Z(this,me,"m",rs).call(this,A,I.current_tool_call_index));for(const C of S.delta.tool_calls??[])I.current_tool_call_index!==C.index&&(Z(this,me,"m",is).call(this,A),I.current_tool_call_index!=null&&Z(this,me,"m",rs).call(this,A,I.current_tool_call_index)),I.current_tool_call_index=C.index;for(const C of S.delta.tool_calls??[]){const k=(w=A.message.tool_calls)==null?void 0:w[C.index];k!=null&&k.type&&((k==null?void 0:k.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(y=k.function)==null?void 0:y.name,index:C.index,arguments:k.function.arguments,parsed_arguments:k.function.parsed_arguments,arguments_delta:((v=C.function)==null?void 0:v.arguments)??""}):(k==null||k.type,void 0))}}},rs=function(t,n){var a,o,l;if(Z(this,me,"m",_n).call(this,t).done_tool_calls.has(n))return;const r=(a=t.message.tool_calls)==null?void 0:a[n];if(!r)throw new Error("no tool call snapshot");if(!r.type)throw new Error("tool call snapshot missing `type`");if(r.type==="function"){const c=(l=(o=Z(this,nt,"f"))==null?void 0:o.tools)==null?void 0:l.find(u=>u.type==="function"&&u.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:n,arguments:r.function.arguments,parsed_arguments:rn(c)?c.$parseRaw(r.function.arguments):c!=null&&c.function.strict?JSON.parse(r.function.arguments):null})}else r.type},is=function(t){var i,r;const n=Z(this,me,"m",_n).call(this,t);if(t.message.content&&!n.content_done){n.content_done=!0;const a=Z(this,me,"m",as).call(this);this._emit("content.done",{content:t.message.content,parsed:a?a.$parseRaw(t.message.content):null})}t.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(i=t.logprobs)!=null&&i.content&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(r=t.logprobs)!=null&&r.refusal&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},bn=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");const t=Z(this,lt,"f");if(!t)throw new z("request ended without sending any chunks");return Et(this,lt,void 0,"f"),Et(this,It,[],"f"),vl(t,Z(this,nt,"f"))},as=function(){var n;const t=(n=Z(this,nt,"f"))==null?void 0:n.response_format;return Os(t)?t:null},Wr=function(t){var n,i,r,a;let o=Z(this,lt,"f");const{choices:l,...c}=t;o?Object.assign(o,c):o=Et(this,lt,{...c,choices:[]},"f");for(const{delta:u,finish_reason:h,index:f,logprobs:m=null,...g}of t.choices){let _=o.choices[f];if(_||(_=o.choices[f]={finish_reason:h,index:f,message:{},logprobs:m,...g}),m)if(!_.logprobs)_.logprobs=Object.assign({},m);else{const{content:C,refusal:k,...M}=m;Object.assign(_.logprobs,M),C&&((n=_.logprobs).content??(n.content=[]),_.logprobs.content.push(...C)),k&&((i=_.logprobs).refusal??(i.refusal=[]),_.logprobs.refusal.push(...k))}if(h&&(_.finish_reason=h,Z(this,nt,"f")&&Ea(Z(this,nt,"f")))){if(h==="length")throw new oa;if(h==="content_filter")throw new la}if(Object.assign(_,g),!u)continue;const{content:w,refusal:y,function_call:v,role:S,tool_calls:A,...I}=u;if(Object.assign(_.message,I),y&&(_.message.refusal=(_.message.refusal||"")+y),S&&(_.message.role=S),v&&(_.message.function_call?(v.name&&(_.message.function_call.name=v.name),v.arguments&&((r=_.message.function_call).arguments??(r.arguments=""),_.message.function_call.arguments+=v.arguments)):_.message.function_call=v),w&&(_.message.content=(_.message.content||"")+w,!_.message.refusal&&Z(this,me,"m",as).call(this)&&(_.message.parsed=Hr(_.message.content))),A){_.message.tool_calls||(_.message.tool_calls=[]);for(const{index:C,id:k,type:M,function:R,...F}of A){const D=(a=_.message.tool_calls)[C]??(a[C]={});Object.assign(D,F),k&&(D.id=k),M&&(D.type=M),R&&(D.function??(D.function={name:R.name??"",arguments:""})),R!=null&&R.name&&(D.function.name=R.name),R!=null&&R.arguments&&(D.function.arguments+=R.arguments,dl(Z(this,nt,"f"),D)&&(D.function.parsed_arguments=Hr(D.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",i=>{const r=t.shift();r?r.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((r,a)=>t.push({resolve:r,reject:a})).then(r=>r?{value:r,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ge(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function vl(s,e){const{id:t,choices:n,created:i,model:r,system_fingerprint:a,...o}=s,l={...o,id:t,choices:n.map(({message:c,finish_reason:u,index:h,logprobs:f,...m})=>{if(!u)throw new z(`missing finish_reason for choice ${h}`);const{content:g=null,function_call:_,tool_calls:w,...y}=c,v=c.role;if(!v)throw new z(`missing role for choice ${h}`);if(_){const{arguments:S,name:A}=_;if(S==null)throw new z(`missing function_call.arguments for choice ${h}`);if(!A)throw new z(`missing function_call.name for choice ${h}`);return{...m,message:{content:g,function_call:{arguments:S,name:A},role:v,refusal:c.refusal??null},finish_reason:u,index:h,logprobs:f}}return w?{...m,index:h,finish_reason:u,logprobs:f,message:{...y,role:v,content:g,refusal:c.refusal??null,tool_calls:w.map((S,A)=>{const{function:I,type:C,id:k,...M}=S,{arguments:R,name:F,...D}=I||{};if(k==null)throw new z(`missing choices[${h}].tool_calls[${A}].id
${wn(s)}`);if(C==null)throw new z(`missing choices[${h}].tool_calls[${A}].type
${wn(s)}`);if(F==null)throw new z(`missing choices[${h}].tool_calls[${A}].function.name
${wn(s)}`);if(R==null)throw new z(`missing choices[${h}].tool_calls[${A}].function.arguments
${wn(s)}`);return{...M,id:k,type:C,function:{...D,name:F,arguments:R}}})}}:{...m,message:{...y,content:g,role:v,refusal:c.refusal??null},finish_reason:u,index:h,logprobs:f}}),created:i,model:r,object:"chat.completion",...a?{system_fingerprint:a}:{}};return ul(l,e)}function wn(s){return JSON.stringify(s)}class Lt extends en{static fromReadableStream(e){const t=new Lt(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,n){const i=new Lt(null),r={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runFunctions"}};return i._run(()=>i._runFunctions(e,t,r)),i}static runTools(e,t,n){const i=new Lt(t),r={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,r)),i}}let Ua=class extends U{parse(e,t){return ml(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(n=>Fs(n,e))}runFunctions(e,t){return e.stream?Lt.runFunctions(this._client,e,t):Zt.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Lt.runTools(this._client,e,t):Zt.runTools(this._client,e,t)}stream(e,t){return en.createChatCompletion(this._client,e,t)}};class As extends U{constructor(){super(...arguments),this.completions=new Ua(this._client)}}(function(s){s.Completions=Ua})(As||(As={}));class Ha extends U{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Wa extends U{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Wn extends U{constructor(){super(...arguments),this.sessions=new Ha(this._client),this.transcriptionSessions=new Wa(this._client)}}Wn.Sessions=Ha;Wn.TranscriptionSessions=Wa;class Bs extends U{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,t,n,i){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Ls,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class Ls extends _e{}Bs.MessagesPage=Ls;class xs extends U{retrieve(e,t,n,i={},r){return ie(i)?this.retrieve(e,t,n,{},i):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:i,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e,t,n={},i){return ie(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Ns,{query:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}}class Ns extends _e{}xs.RunStepsPage=Ns;let an=class extends U{constructor(){super(...arguments),this.steps=new xs(this._client)}create(e,t,n){const{include:i,...r}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:i},body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,t,n,i){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,js,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}async createAndPoll(e,t,n){const i=await this.create(e,t,n);return await this.poll(e,i.id,n)}createAndStream(e,t,n){return We.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const i={...n==null?void 0:n.headers,"X-Stainless-Poll-Helper":"true"};for(n!=null&&n.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:a}=await this.retrieve(e,t,{...n,headers:{...n==null?void 0:n.headers,...i}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(n!=null&&n.pollIntervalMs)o=n.pollIntervalMs;else{const l=a.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await nn(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,n){return We.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,i){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,i){const r=await this.submitToolOutputs(e,t,n,i);return await this.poll(e,r.id,i)}submitToolOutputsStream(e,t,n,i){return We.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,i)}};class js extends _e{}an.RunsPage=js;an.Steps=xs;an.RunStepsPage=Ns;class xt extends U{constructor(){super(...arguments),this.runs=new an(this._client),this.messages=new Bs(this._client)}create(e={},t){return ie(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return We.createThreadAssistantStream(e,this._client.beta.threads,t)}}xt.Runs=an;xt.RunsPage=js;xt.Messages=Bs;xt.MessagesPage=Ls;class Nt extends U{constructor(){super(...arguments),this.realtime=new Wn(this._client),this.chat=new As(this._client),this.assistants=new Ts(this._client),this.threads=new xt(this._client)}}Nt.Realtime=Wn;Nt.Assistants=Ts;Nt.AssistantsPage=Ms;Nt.Threads=xt;class Va extends U{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Ja extends U{retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}/content`,{...n,headers:{Accept:"application/binary",...n==null?void 0:n.headers},__binaryResponse:!0})}}let Vn=class extends U{constructor(){super(...arguments),this.content=new Ja(this._client)}create(e,t,n){return this._client.post(`/containers/${e}/files`,kt({body:t,...n}))}retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}`,n)}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,zs,{query:t,...n})}del(e,t,n){return this._client.delete(`/containers/${e}/files/${t}`,{...n,headers:{Accept:"*/*",...n==null?void 0:n.headers}})}};class zs extends _e{}Vn.FileListResponsesPage=zs;Vn.Content=Ja;class on extends U{constructor(){super(...arguments),this.files=new Vn(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/containers",$s,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}}class $s extends _e{}on.ContainerListResponsesPage=$s;on.Files=Vn;on.FileListResponsesPage=zs;class qa extends U{create(e,t){const n=!!e.encoding_format;let i=n?e.encoding_format:"base64";n&&ht("Request","User defined encoding_format:",e.encoding_format);const r=this._client.post("/embeddings",{body:{...e,encoding_format:i},...t});return n?r:(ht("response","Decoding base64 embeddings to float32 array"),r._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{const l=o.embedding;o.embedding=ll(l)}),a)))}}class Us extends U{retrieve(e,t,n,i){return this._client.get(`/evals/${e}/runs/${t}/output_items/${n}`,i)}list(e,t,n={},i){return ie(n)?this.list(e,t,{},n):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Hs,{query:n,...i})}}class Hs extends _e{}Us.OutputItemListResponsesPage=Hs;class ln extends U{constructor(){super(...arguments),this.outputItems=new Us(this._client)}create(e,t,n){return this._client.post(`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){return this._client.get(`/evals/${e}/runs/${t}`,n)}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,Ws,{query:t,...n})}del(e,t,n){return this._client.delete(`/evals/${e}/runs/${t}`,n)}cancel(e,t,n){return this._client.post(`/evals/${e}/runs/${t}`,n)}}class Ws extends _e{}ln.RunListResponsesPage=Ws;ln.OutputItems=Us;ln.OutputItemListResponsesPage=Hs;class cn extends U{constructor(){super(...arguments),this.runs=new ln(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,n){return this._client.post(`/evals/${e}`,{body:t,...n})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/evals",Vs,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class Vs extends _e{}cn.EvalListResponsesPage=Vs;cn.Runs=ln;cn.RunListResponsesPage=Ws;let Js=class extends U{create(e,t){return this._client.post("/files",kt({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/files",qs,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=30*60*1e3}={}){const i=new Set(["processed","error","deleted"]),r=Date.now();let a=await this.retrieve(e);for(;!a.status||!i.has(a.status);)if(await nn(t),a=await this.retrieve(e),Date.now()-r>n)throw new Is({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}};class qs extends _e{}Js.FileObjectsPage=qs;class Xa extends U{}let Ka=class extends U{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class Xs extends U{constructor(){super(...arguments),this.graders=new Ka(this._client)}}Xs.Graders=Ka;class Ks extends U{create(e,t,n){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,Gs,{body:t,method:"post",...n})}retrieve(e,t={},n){return ie(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}del(e,t,n){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,n)}}class Gs extends zn{}Ks.PermissionCreateResponsesPage=Gs;let Jn=class extends U{constructor(){super(...arguments),this.permissions=new Ks(this._client)}};Jn.Permissions=Ks;Jn.PermissionCreateResponsesPage=Gs;class Qs extends U{list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Ys,{query:t,...n})}}class Ys extends _e{}Qs.FineTuningJobCheckpointsPage=Ys;class jt extends U{constructor(){super(...arguments),this.checkpoints=new Qs(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Zs,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return ie(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,er,{query:t,...n})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class Zs extends _e{}class er extends _e{}jt.FineTuningJobsPage=Zs;jt.FineTuningJobEventsPage=er;jt.Checkpoints=Qs;jt.FineTuningJobCheckpointsPage=Ys;class ft extends U{constructor(){super(...arguments),this.methods=new Xa(this._client),this.jobs=new jt(this._client),this.checkpoints=new Jn(this._client),this.alpha=new Xs(this._client)}}ft.Methods=Xa;ft.Jobs=jt;ft.FineTuningJobsPage=Zs;ft.FineTuningJobEventsPage=er;ft.Checkpoints=Jn;ft.Alpha=Xs;class Ga extends U{}class tr extends U{constructor(){super(...arguments),this.graderModels=new Ga(this._client)}}tr.GraderModels=Ga;class Qa extends U{createVariation(e,t){return this._client.post("/images/variations",kt({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",kt({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class nr extends U{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",sr,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class sr extends zn{}nr.ModelsPage=sr;class Ya extends U{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function yl(s,e){return!e||!kl(e)?{...s,output_parsed:null,output:s.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(n=>({...n,parsed:null}))}:t)}:Za(s,e)}function Za(s,e){const t=s.output.map(i=>{if(i.type==="function_call")return{...i,parsed_arguments:El(e,i)};if(i.type==="message"){const r=i.content.map(a=>a.type==="output_text"?{...a,parsed:Al(e,a.text)}:a);return{...i,content:r}}return i}),n=Object.assign({},s,{output:t});return Object.getOwnPropertyDescriptor(s,"output_text")||eo(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const i of n.output)if(i.type==="message"){for(const r of i.content)if(r.type==="output_text"&&r.parsed!==null)return r.parsed}return null}}),n}function Al(s,e){var t,n,i,r;return((n=(t=s.text)==null?void 0:t.format)==null?void 0:n.type)!=="json_schema"?null:"$parseRaw"in((i=s.text)==null?void 0:i.format)?((r=s.text)==null?void 0:r.format).$parseRaw(e):JSON.parse(e)}function kl(s){var e;return!!Os((e=s.text)==null?void 0:e.format)}function Sl(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function Cl(s,e){return s.find(t=>t.type==="function"&&t.name===e)}function El(s,e){const t=Cl(s.tools??[],e.name);return{...e,...e,parsed_arguments:Sl(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function eo(s){const e=[];for(const t of s.output)if(t.type==="message")for(const n of t.content)n.type==="output_text"&&e.push(n.text);s.output_text=e.join("")}class to extends U{list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Pl,{query:t,...n})}}var Pt=function(s,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t},ct=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},Dt,vn,ut,yn,Vr,Jr,qr,Xr;class rr extends Rs{constructor(e){super(),Dt.add(this),vn.set(this,void 0),ut.set(this,void 0),yn.set(this,void 0),Pt(this,vn,e,"f")}static createResponse(e,t,n){const i=new rr(t);return i._run(()=>i._createOrRetrieveResponse(e,t,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createOrRetrieveResponse(e,t,n){var o;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),ct(this,Dt,"m",Vr).call(this);let r,a=null;"response_id"in t?(r=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):r=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const l of r)ct(this,Dt,"m",Jr).call(this,l,a);if((o=r.controller.signal)!=null&&o.aborted)throw new je;return ct(this,Dt,"m",qr).call(this)}[(vn=new WeakMap,ut=new WeakMap,yn=new WeakMap,Dt=new WeakSet,Vr=function(){this.ended||Pt(this,ut,void 0,"f")},Jr=function(t,n){if(this.ended)return;const i=(a,o)=>{(n==null||o.sequence_number>n)&&this._emit(a,o)},r=ct(this,Dt,"m",Xr).call(this,t);switch(i("event",t),t.type){case"response.output_text.delta":{const a=r.output[t.output_index];if(!a)throw new z(`missing output at index ${t.output_index}`);if(a.type==="message"){const o=a.content[t.content_index];if(!o)throw new z(`missing content at index ${t.content_index}`);if(o.type!=="output_text")throw new z(`expected content to be 'output_text', got ${o.type}`);i("response.output_text.delta",{...t,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const a=r.output[t.output_index];if(!a)throw new z(`missing output at index ${t.output_index}`);a.type==="function_call"&&i("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:i(t.type,t);break}},qr=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");const t=ct(this,ut,"f");if(!t)throw new z("request ended without sending any events");Pt(this,ut,void 0,"f");const n=Il(t,ct(this,vn,"f"));return Pt(this,yn,n,"f"),n},Xr=function(t){let n=ct(this,ut,"f");if(!n){if(t.type!=="response.created")throw new z(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return n=Pt(this,ut,t.response,"f"),n}switch(t.type){case"response.output_item.added":{n.output.push(t.item);break}case"response.content_part.added":{const i=n.output[t.output_index];if(!i)throw new z(`missing output at index ${t.output_index}`);i.type==="message"&&i.content.push(t.part);break}case"response.output_text.delta":{const i=n.output[t.output_index];if(!i)throw new z(`missing output at index ${t.output_index}`);if(i.type==="message"){const r=i.content[t.content_index];if(!r)throw new z(`missing content at index ${t.content_index}`);if(r.type!=="output_text")throw new z(`expected content to be 'output_text', got ${r.type}`);r.text+=t.delta}break}case"response.function_call_arguments.delta":{const i=n.output[t.output_index];if(!i)throw new z(`missing output at index ${t.output_index}`);i.type==="function_call"&&(i.arguments+=t.delta);break}case"response.completed":{Pt(this,ut,t.response,"f");break}}return n},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",i=>{const r=t.shift();r?r.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const r of t)r.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((r,a)=>t.push({resolve:r,reject:a})).then(r=>r?{value:r,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=ct(this,yn,"f");if(!e)throw new z("stream ended without producing a ChatCompletion");return e}}function Il(s,e){return yl(s,e)}class ir extends U{constructor(){super(...arguments),this.inputItems=new to(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&eo(n),n))}retrieve(e,t={},n){return this._client.get(`/responses/${e}`,{query:t,...n,stream:(t==null?void 0:t.stream)??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(n=>Za(n,e))}stream(e,t){return rr.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}}class Pl extends _e{}ir.InputItems=to;class no extends U{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,kt({body:t,...n}))}}class ar extends U{constructor(){super(...arguments),this.parts=new no(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}ar.Parts=no;const Dl=async s=>{const e=await Promise.allSettled(s),t=e.filter(i=>i.status==="rejected");if(t.length){for(const i of t)console.error(i.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const n=[];for(const i of e)i.status==="fulfilled"&&n.push(i.value);return n};class qn extends U{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,t,n,i){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}list(e,t={},n){return ie(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Xn,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}async createAndPoll(e,t,n){const i=await this.create(e,t,n);return await this.poll(e,i.id,n)}async poll(e,t,n){const i={...n==null?void 0:n.headers,"X-Stainless-Poll-Helper":"true"};for(n!=null&&n.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const r=await this.retrieve(e,t,{...n,headers:i}).withResponse(),a=r.data;switch(a.status){case"in_progress":let o=5e3;if(n!=null&&n.pollIntervalMs)o=n.pollIntervalMs;else{const l=r.response.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await nn(o);break;case"failed":case"completed":return a}}}async upload(e,t,n){const i=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:i.id},n)}async uploadAndPoll(e,t,n){const i=await this.upload(e,t,n);return await this.poll(e,i.id,n)}content(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,or,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class Xn extends _e{}class or extends zn{}qn.VectorStoreFilesPage=Xn;qn.FileContentResponsesPage=or;class so extends U{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}async createAndPoll(e,t,n){const i=await this.create(e,t);return await this.poll(e,i.id,n)}listFiles(e,t,n={},i){return ie(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Xn,{query:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}async poll(e,t,n){const i={...n==null?void 0:n.headers,"X-Stainless-Poll-Helper":"true"};for(n!=null&&n.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:a}=await this.retrieve(e,t,{...n,headers:i}).withResponse();switch(r.status){case"in_progress":let o=5e3;if(n!=null&&n.pollIntervalMs)o=n.pollIntervalMs;else{const l=a.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await nn(o);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},i){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=(i==null?void 0:i.maxConcurrency)??5,a=Math.min(r,t.length),o=this._client,l=t.values(),c=[...n];async function u(f){for(let m of f){const g=await o.files.create({file:m,purpose:"assistants"},i);c.push(g.id)}}const h=Array(a).fill(l).map(u);return await Dl(h),await this.createAndPoll(e,{file_ids:c})}}class dt extends U{constructor(){super(...arguments),this.files=new qn(this._client),this.fileBatches=new so(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}list(e={},t){return ie(e)?this.list({},e):this._client.getAPIList("/vector_stores",lr,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}search(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/search`,cr,{body:t,method:"post",...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class lr extends _e{}class cr extends zn{}dt.VectorStoresPage=lr;dt.VectorStoreSearchResponsesPage=cr;dt.Files=qn;dt.VectorStoreFilesPage=Xn;dt.FileContentResponsesPage=or;dt.FileBatches=so;var ro;class W extends Go{constructor({baseURL:e=gn("OPENAI_BASE_URL"),apiKey:t=gn("OPENAI_API_KEY"),organization:n=gn("OPENAI_ORG_ID")??null,project:i=gn("OPENAI_PROJECT_ID")??null,...r}={}){if(t===void 0)throw new z("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:t,organization:n,project:i,...r,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&al())throw new z(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new Va(this),this.chat=new Hn(this),this.embeddings=new qa(this),this.files=new Js(this),this.images=new Qa(this),this.audio=new sn(this),this.moderations=new Ya(this),this.models=new nr(this),this.fineTuning=new ft(this),this.graders=new tr(this),this.vectorStores=new dt(this),this.beta=new Nt(this),this.batches=new Ps(this),this.uploads=new ar(this),this.responses=new ir(this),this.evals=new cn(this),this.containers=new on(this),this._options=a,this.apiKey=t,this.organization=n,this.project=i}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return Mo(e,{arrayFormat:"brackets"})}}ro=W;W.OpenAI=ro;W.DEFAULT_TIMEOUT=6e5;W.OpenAIError=z;W.APIError=ye;W.APIConnectionError=Ln;W.APIConnectionTimeoutError=Is;W.APIUserAbortError=je;W.NotFoundError=na;W.ConflictError=sa;W.RateLimitError=ia;W.BadRequestError=Zi;W.AuthenticationError=ea;W.InternalServerError=aa;W.PermissionDeniedError=ta;W.UnprocessableEntityError=ra;W.toFile=fa;W.fileFromPath=Gi;W.Completions=Va;W.Chat=Hn;W.ChatCompletionsPage=Un;W.Embeddings=qa;W.Files=Js;W.FileObjectsPage=qs;W.Images=Qa;W.Audio=sn;W.Moderations=Ya;W.Models=nr;W.ModelsPage=sr;W.FineTuning=ft;W.Graders=tr;W.VectorStores=dt;W.VectorStoresPage=lr;W.VectorStoreSearchResponsesPage=cr;W.Beta=Nt;W.Batches=Ps;W.BatchesPage=Ds;W.Uploads=ar;W.Responses=ir;W.Evals=cn;W.EvalListResponsesPage=Vs;W.Containers=on;W.ContainerListResponsesPage=$s;class Rl{constructor(e){q(this,"provider");this.provider=e}getRequestModel(e){return e||this.provider.model}createSystemMessage(e){return{role:"system",content:e}}createUserMessage(e){return{role:"user",content:e}}createAssistantMessage(e){return{role:"assistant",content:e}}}class Tl extends Rl{constructor(t){super(t);q(this,"client");this.client=new W({apiKey:t.apiKey,baseURL:t.baseURL,dangerouslyAllowBrowser:!0,maxRetries:2,timeout:6e4})}getMetadata(){return{id:"openai-compatible",name:this.provider.name,supportStreaming:!0,maxContextToken:4096}}async chatCompletion(t,n){var o,l;const i=await this.client.chat.completions.create({model:this.getRequestModel(n),messages:t,temperature:this.provider.temperature??.7,max_tokens:this.provider.maxTokens??2048}),r=((l=(o=i.choices[0])==null?void 0:o.message)==null?void 0:l.content)||"",a=i.usage;return{content:r,usage:a?{promptTokens:a.prompt_tokens,completionTokens:a.completion_tokens,totalTokens:a.total_tokens}:void 0}}async streamChatCompletion(t,n,i){var r,a;try{const o=await this.client.chat.completions.create({model:this.getRequestModel(i),messages:t,temperature:this.provider.temperature??.7,max_tokens:this.provider.maxTokens??2048,stream:!0});for await(const l of o){const c=(a=(r=l.choices[0])==null?void 0:r.delta)==null?void 0:a.content;c&&n({content:c})}n({done:!0})}catch(o){n({error:o instanceof Error?o:new Error(String(o)),done:!0})}}async testConnection(){try{return await this.client.chat.completions.create({model:this.getRequestModel(),messages:[{role:"user",content:"Hello"}],max_tokens:5}),!0}catch(t){return console.error("[AI Assistant] Connection test failed:",t),!1}}}class Ml{static createAdapter(e){return new Tl(e)}}const Kr=[{name:"Ollama (æœ¬åœ°)",baseURL:"http://localhost:11434/v1",model:"llama3.2",apiKey:"ollama",temperature:.7,maxTokens:2048},{name:"OpenAI",baseURL:"https://api.openai.com/v1",model:"gpt-3.5-turbo",apiKey:"",temperature:.7,maxTokens:2048},{name:"DeepSeek",baseURL:"https://api.deepseek.com/v1",model:"deepseek-chat",apiKey:"",temperature:.7,maxTokens:2048},{name:"Moonshot",baseURL:"https://api.moonshot.cn/v1",model:"moonshot-v1-8k",apiKey:"",temperature:.7,maxTokens:2048},{name:"æ™ºè°±AI (GLM-4-Flash)",baseURL:"https://open.bigmodel.cn/api/paas/v4",model:"glm-4-flash",apiKey:"",temperature:.7,maxTokens:4096},{name:"è‡ªå®šä¹‰ OpenAI æ ¼å¼",baseURL:"",model:"",apiKey:"",temperature:.7,maxTokens:2048}],Qt={chat:"",polish:"ä¼˜åŒ–ä»¥ä¸‹æ–‡æœ¬çš„è¡¨è¾¾ï¼Œä½¿å…¶æ›´æµç•…ã€ä¸“ä¸šã€‚ä¿æŒåŽŸæ„ï¼Œä»…è¾“å‡ºä¿®æ”¹åŽçš„æ–‡æœ¬ï¼š",translate:"å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆç›®æ ‡è¯­è¨€ï¼ˆä¸­æ–‡â†’è‹±æ–‡ï¼Œè‹±æ–‡â†’ä¸­æ–‡ï¼‰ã€‚ä¿æŒåŽŸæ„å’Œè¯­æ°”ï¼Œä»…è¾“å‡ºè¯‘æ–‡ï¼š",summarize:"æç‚¼ä»¥ä¸‹æ–‡æœ¬çš„æ ¸å¿ƒè¦ç‚¹ï¼Œç”¨3-5å¥è¯æ¦‚æ‹¬å…³é”®ä¿¡æ¯ã€‚ä»…è¾“å‡ºæ€»ç»“å†…å®¹ï¼š",expand:"åŸºäºŽä»¥ä¸‹å†…å®¹è¿›è¡Œæ‰©å±•ï¼Œå¢žåŠ ç›¸å…³ç»†èŠ‚å’Œè§£é‡Šï¼Œä½¿å†…å®¹æ›´ä¸°å¯Œå®Œæ•´ã€‚ä¿æŒä¸»é¢˜ä¸€è‡´ï¼š",condense:"åŽ‹ç¼©ä»¥ä¸‹æ–‡æœ¬ï¼ŒåŽ»é™¤å†—ä½™æè¿°å’Œé‡å¤ä¿¡æ¯ï¼Œä¿ç•™æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®æ•°æ®ï¼š",rewrite:"æ”¹å†™ä»¥ä¸‹æ–‡æœ¬ï¼Œè°ƒæ•´ä¸ºæ­£å¼ä¹¦é¢è¯­é£Žæ ¼ï¼Œé€‚ç”¨äºŽå­¦æœ¯æˆ–å•†åŠ¡åœºæ™¯ï¼š",continue:"å»¶ç»­ä»¥ä¸‹æ–‡æœ¬çš„é£Žæ ¼å’Œä¸»é¢˜ï¼Œåˆç†ç»­å†™åŽç»­å†…å®¹ï¼Œä¿æŒé€»è¾‘è¿žè´¯ï¼š",custom1:"",custom2:"",custom3:""},Ol=[{id:"custom1",name:"è‡ªå®šä¹‰1",icon:"âœ¨",prompt:"",enabled:!1},{id:"custom2",name:"è‡ªå®šä¹‰2",icon:"ðŸ”§",prompt:"",enabled:!1},{id:"custom3",name:"è‡ªå®šä¹‰3",icon:"ðŸŽ¯",prompt:"",enabled:!1}],Fl={polish:!0,translate:!0,summarize:!0,expand:!0,condense:!1,rewrite:!1,continue:!1,custom1:!1,custom2:!1,custom3:!1};class io{constructor(){q(this,"adapter",null);q(this,"provider",null)}setProvider(e){this.provider=e,this.adapter=Ml.createAdapter(e)}getCurrentProvider(){return this.provider}isConfigured(){return this.adapter!==null&&this.provider!==null}async*streamChat(e){if(!this.adapter)throw new Error("AI provider not configured");let t="";await this.adapter.streamChatCompletion(e,n=>{if(n.content&&(t+=n.content),n.error)throw n.error});for(const n of t)yield n,await new Promise(i=>setTimeout(i,10))}async processText(e,t){if(!this.adapter)throw new Error("AI provider not configured");if(t==="chat")throw new Error("Use streamChat for chat operation");const n=Qt[t];if(!n)throw new Error(`Unknown operation: ${t}`);const i=[{role:"system",content:"You are a helpful writing assistant."},{role:"user",content:`${n}

${e}`}];return this.adapter.chatCompletion(i)}async testConnection(){return this.adapter?this.adapter.testConnection():!1}buildOperationMessages(e,t,n){const i=n||Qt[t];return[{role:"system",content:"You are a helpful writing assistant. Respond only with the processed text, no explanations."},{role:"user",content:`${i}

${e}`}]}}q(io,"DEFAULT_PROMPTS",Qt);const pe=new io,Gr="ai-assistant-settings";class Bl{constructor(){q(this,"plugin",null);q(this,"settings",this.getDefaultSettings())}init(e){this.plugin=e}async loadSettings(){if(this.plugin)try{const e=await this.plugin.loadData(Gr);e&&(this.settings={...this.getDefaultSettings(),...e})}catch(e){console.error("[AI Assistant] Failed to load settings:",e)}}async saveSettings(){if(this.plugin)try{await this.plugin.saveData(Gr,this.settings)}catch(e){console.error("[AI Assistant] Failed to save settings:",e)}}getSettings(){return{...this.settings}}async updateSettings(e){this.settings={...this.settings,...e},await this.saveSettings()}async addProvider(e){const t=[...this.settings.providers];(e.isDefault||t.length===0)&&(t.forEach(n=>n.isDefault=!1),e.isDefault=!0),t.push(e),this.settings.providers=t,e.isDefault&&(this.settings.currentProviderId=e.id),await this.saveSettings()}async updateProvider(e,t){const n=this.settings.providers.findIndex(r=>r.id===e);if(n===-1)return;const i=this.settings.providers[n];t.isDefault&&t.isDefault!==i.isDefault&&(this.settings.providers.forEach(r=>r.isDefault=!1),this.settings.currentProviderId=e),this.settings.providers[n]={...i,...t},await this.saveSettings()}async deleteProvider(e){const t=this.settings.providers.findIndex(i=>i.id===e);if(t===-1)return;const n=this.settings.providers[t].isDefault;this.settings.providers.splice(t,1),n&&this.settings.providers.length>0?(this.settings.providers[0].isDefault=!0,this.settings.currentProviderId=this.settings.providers[0].id):this.settings.providers.length===0&&(this.settings.currentProviderId=null),await this.saveSettings()}getProvider(e){return this.settings.providers.find(t=>t.id===e)}getCurrentProvider(){return this.settings.currentProviderId&&this.getProvider(this.settings.currentProviderId)||null}async setCurrentProvider(e){const t=this.getProvider(e);t&&(this.settings.providers.forEach(n=>n.isDefault=!1),t.isDefault=!0,this.settings.currentProviderId=e,await this.saveSettings())}getConversations(){return[...this.settings.conversations]}async addConversation(e){const t=this.settings.conversations.findIndex(n=>n.id===e.id);t>=0?this.settings.conversations[t]=e:this.settings.conversations.push(e),await this.saveSettings()}async deleteConversation(e){this.settings.conversations=this.settings.conversations.filter(t=>t.id!==e),await this.saveSettings()}getCustomButtons(){return[...this.settings.customButtons]}async updateCustomButtons(e){this.settings.customButtons=e,await this.saveSettings()}getToolbarButtons(){return{...this.settings.toolbarButtons}}async updateToolbarButtons(e){this.settings.toolbarButtons=e,await this.saveSettings()}getDefaultSettings(){const e={id:"ollama-default",name:"Ollama (æœ¬åœ°)",apiKey:"ollama",baseURL:"http://localhost:11434/v1",model:"llama3.2",temperature:.7,maxTokens:2048,isDefault:!0};return{providers:[e],currentProviderId:e.id,conversations:[],operationPrompts:Qt,uiMode:"both",diffHighlightStyle:"word",showFloatingToolbar:!0,showContextMenu:!0,autoApplyOnAccept:!1,maxConcurrentRequests:3,requestTimeout:6e4,customButtons:Ol,toolbarButtons:Fl,enableLocalMode:!0,redactSensitiveInfo:!1}}}const Q=new Bl;class Ll{getSelectedText(){const e=window.getSelection();return!e||e.rangeCount===0?"":e.toString().trim()}getSelectedBlockIds(){const e=window.getSelection();if(!e||e.rangeCount===0)return[];const t=e.getRangeAt(0),n=new Set,i=t.commonAncestorContainer,r=i.nodeType===Node.ELEMENT_NODE?i:i.parentElement;if(r){const a=document.createTreeWalker(r,NodeFilter.SHOW_ELEMENT,{acceptNode:l=>l.hasAttribute("data-node-id")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});let o;for(;o=a.nextNode();){const l=o.getAttribute("data-node-id");l&&n.add(l)}}if(n.size===0){let a=t.startContainer;for(;a;){if(a.nodeType===Node.ELEMENT_NODE){const l=a.getAttribute("data-node-id");if(l){n.add(l);break}}a=a.parentElement}let o=t.endContainer;for(;o;){if(o.nodeType===Node.ELEMENT_NODE){const l=o.getAttribute("data-node-id");if(l){n.add(l);break}}o=o.parentElement}}if(n.size===0){const a=document.querySelector(".protyle-wysiwyg--select");if(a){const o=a.getAttribute("data-node-id");o&&n.add(o)}}if(n.size===0){const a=window.getSelection();if(a&&a.rangeCount>0){const o=a.getRangeAt(0);let l=o.startContainer.nodeType===Node.ELEMENT_NODE?o.startContainer:o.startContainer.parentElement;for(;l;){if(l.classList&&(l.classList.contains("p")||l.classList.contains("h1")||l.classList.contains("h2")||l.classList.contains("h3")||l.classList.contains("h4")||l.classList.contains("h5")||l.classList.contains("h6")||l.classList.contains("li")||l.classList.contains("blockquote")||l.classList.contains("code-block"))){const c=l.getAttribute("data-node-id");if(c){n.add(c);break}}l=l.parentElement}}}return Array.from(n)}getCurrentBlockId(){const e=this.getSelectedBlockIds();return e.length>0?e[0]:null}async getBlockContent(e){try{const t=await fetch("/api/block/getBlockInfo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})});if(!t.ok)throw new Error(`Failed to get block: ${t.statusText}`);const n=await t.json();if(n.code!==0||!n.data)return null;const i=n.data;return{id:i.id,type:i.type,subtype:i.subtype,content:i.content||"",markdown:i.markdown}}catch(t){return console.error("[AI Assistant] Failed to get block content:",t),null}}async updateBlock(e,t){try{const n=await fetch("/api/block/updateBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,data:t,dataType:"markdown"})});if(!n.ok)throw new Error(`Failed to update block: ${n.statusText}`);return(await n.json()).code===0}catch(n){return console.error("[AI Assistant] Failed to update block:",n),!1}}async insertBlockAfter(e,t){try{const n=await fetch("/api/block/insertBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({previousID:e,data:t,dataType:"markdown"})});if(!n.ok)throw new Error(`Failed to insert block: ${n.statusText}`);const i=await n.json();return i.code===0&&i.data&&i.data[0]?i.data[0].id:null}catch(n){return console.error("[AI Assistant] Failed to insert block:",n),null}}getSelectionRange(){const e=window.getSelection();if(!e||e.rangeCount===0)return{text:"",rect:null};const n=e.getRangeAt(0).getBoundingClientRect();return{text:e.toString().trim(),rect:n}}clearSelection(){const e=window.getSelection();e&&e.removeAllRanges()}async replaceSelectedText(e,t,n){try{const i=await this.getBlockContent(e);if(!i)return{success:!1,error:"æ— æ³•èŽ·å–å—å†…å®¹"};let r=i.content;if(!t)return{success:!0,content:r};console.log("[AI Assistant] ====== replaceSelectedText è°ƒè¯• ======"),console.log("[AI Assistant] blockId:",e),console.log("[AI Assistant] fullContent (åŽŸæ–‡):",JSON.stringify(r)),console.log("[AI Assistant] selectedText (é€‰ä¸­):",JSON.stringify(t)),console.log("[AI Assistant] newText (AIç»“æžœ):",JSON.stringify(n)),console.log("[AI Assistant] fullContenté•¿åº¦:",r.length),console.log("[AI Assistant] selectedTexté•¿åº¦:",t.length),console.log("[AI Assistant] fullContentæ˜¯å¦åŒ…å«selectedText:",r.includes(t));let a=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(a,"");if(o.test(r)){const h=r.replace(o,n);return console.log("[AI Assistant] ç­–ç•¥1-ç²¾ç¡®åŒ¹é…æˆåŠŸ"),{success:!0,content:h}}console.log("[AI Assistant] ç­–ç•¥1-ç²¾ç¡®åŒ¹é…å¤±è´¥");const l=t.trim();if(console.log("[AI Assistant] trimmedSelected:",JSON.stringify(l)),console.log("[AI Assistant] trimmedå…¨æ–‡æ˜¯å¦åŒ…å«trimmedé€‰ä¸­:",r.trim().includes(l)),a=l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(a,""),o.test(r)){const h=r.substring(0,r.indexOf(l)),f=r.substring(r.indexOf(l)+l.length),m=h+n+f;return console.log("[AI Assistant] ç­–ç•¥2-TrimåŒ¹é…æˆåŠŸ"),{success:!0,content:m}}console.log("[AI Assistant] ç­–ç•¥2-TrimåŒ¹é…å¤±è´¥");const c=r.trim(),u=c.indexOf(l);if(console.log("[AI Assistant] trimmedIndex:",u),u!==-1){const h=r.substring(0,r.indexOf(c.substring(0,u>0?u:0))),f=r.indexOf(c)+u+l.length,m=r.substring(f),g=h+n+m;return console.log("[AI Assistant] ç­–ç•¥3-æ¨¡ç³ŠåŒ¹é…æˆåŠŸ"),{success:!0,content:g}}return console.log("[AI Assistant] ç­–ç•¥3-æ¨¡ç³ŠåŒ¹é…å¤±è´¥"),console.log("[AI Assistant] æ‰€æœ‰å­—ç¬¦ä¸²åŒ¹é…ç­–ç•¥å¤±è´¥ï¼Œå°è¯•DOMé€‰åŒºæ›¿æ¢"),await this.smartReplaceByDOMSelection(e,t,n)}catch(i){return console.error("[AI Assistant] æ™ºèƒ½æ›¿æ¢å¤±è´¥:",i),{success:!1,error:String(i)}}}async smartReplaceByDOMSelection(e,t,n){try{const i=await this.getBlockContent(e);if(!i)return{success:!1,error:"æ— æ³•èŽ·å–å—å†…å®¹"};const r=window.getSelection();if(!r||r.rangeCount===0)return console.warn("[AI Assistant] æ— DOMé€‰åŒºï¼Œå›žé€€åˆ°å®Œæ•´æ›¿æ¢"),{success:!0,content:n};const a=r.getRangeAt(0),o=a.startOffset,l=a.endOffset,c=[t,t.trim(),t.replace(/\s+/g," ")];let u="",h=-1;for(const f of c){const m=i.content.indexOf(f);if(m!==-1){u=f,h=m;break}}if(h!==-1){const f=i.content.substring(0,h),m=i.content.substring(h+u.length),g=f+n+m;return console.log("[AI Assistant] DOMé€‰åŒºæ›¿æ¢æˆåŠŸ"),{success:!0,content:g}}return console.warn("[AI Assistant] æ— æ³•æ‰¾åˆ°é€‰ä¸­æ–‡å­—åœ¨åŽŸæ–‡ä¸­çš„ä½ç½®ï¼Œå›žé€€åˆ°å®Œæ•´æ›¿æ¢"),{success:!0,content:n}}catch(i){return console.error("[AI Assistant] DOMé€‰åŒºæ›¿æ¢å¤±è´¥:",i),{success:!1,error:String(i)}}}}const At=new Ll;function Qr(s,e,t){const n=s.slice();return n[26]=e[t],n}function Yr(s,e,t){const n=s.slice();return n[31]=e[t],n}function Zr(s,e,t){const n=s.slice();return n[26]=e[t],n}function ei(s,e,t){const n=s.slice();return n[34]=e[t],n}function ti(s){let e,t,n,i,r,a,o,l,c,u,h=ue(s[5]),f=[];for(let g=0;g<h.length;g+=1)f[g]=ni(ei(s,h,g));let m=s[5].length===0&&si();return{c(){e=b("div"),t=b("div"),n=b("h3"),n.textContent="å¯¹è¯åŽ†å²",i=E(),r=b("button"),r.textContent="âœ•",a=E(),o=b("div");for(let g=0;g<f.length;g+=1)f[g].c();l=E(),m&&m.c(),p(n,"class","svelte-ou36hp"),p(r,"class","btn-close svelte-ou36hp"),p(t,"class","history-header svelte-ou36hp"),p(o,"class","history-list svelte-ou36hp"),p(e,"class","history-sidebar svelte-ou36hp")},m(g,_){$(g,e,_),d(e,t),d(t,n),d(t,i),d(t,r),d(e,a),d(e,o);for(let w=0;w<f.length;w+=1)f[w]&&f[w].m(o,null);d(o,l),m&&m.m(o,null),c||(u=O(r,"click",s[16]),c=!0)},p(g,_){if(_[0]&12336){h=ue(g[5]);let w;for(w=0;w<h.length;w+=1){const y=ei(g,h,w);f[w]?f[w].p(y,_):(f[w]=ni(y),f[w].c(),f[w].m(o,l))}for(;w<f.length;w+=1)f[w].d(1);f.length=h.length}g[5].length===0?m||(m=si(),m.c(),m.m(o,null)):m&&(m.d(1),m=null)},d(g){g&&j(e),Qe(f,g),m&&m.d(),c=!1,u()}}}function ni(s){let e,t,n=s[34].title+"",i,r,a,o=new Date(s[34].updatedAt).toLocaleDateString()+"",l,c,u,h,f;function m(..._){return s[17](s[34],..._)}function g(){return s[18](s[34])}return{c(){e=b("div"),t=b("div"),i=V(n),r=E(),a=b("div"),l=V(o),c=E(),u=b("button"),u.textContent="ðŸ—‘ï¸",p(t,"class","history-title svelte-ou36hp"),p(u,"class","btn-delete svelte-ou36hp"),p(a,"class","history-meta svelte-ou36hp"),p(e,"class","history-item svelte-ou36hp"),ce(e,"active",s[34].id===s[4])},m(_,w){$(_,e,w),d(e,t),d(t,i),d(e,r),d(e,a),d(a,l),d(a,c),d(a,u),h||(f=[O(u,"click",m),O(e,"click",g)],h=!0)},p(_,w){s=_,w[0]&32&&n!==(n=s[34].title+"")&&Y(i,n),w[0]&32&&o!==(o=new Date(s[34].updatedAt).toLocaleDateString()+"")&&Y(l,o),w[0]&48&&ce(e,"active",s[34].id===s[4])},d(_){_&&j(e),h=!1,Ce(f)}}}function si(s){let e;return{c(){e=b("div"),e.textContent="æš‚æ— åŽ†å²å¯¹è¯",p(e,"class","history-empty svelte-ou36hp")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function xl(s){let e,t,n=ue(s[1]),i=[];for(let a=0;a<n.length;a+=1)i[a]=ri(Yr(s,n,a));let r=s[3]&&ii();return{c(){for(let a=0;a<i.length;a+=1)i[a].c();e=E(),r&&r.c(),t=xi()},m(a,o){for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(a,o);$(a,e,o),r&&r.m(a,o),$(a,t,o)},p(a,o){if(o[0]&2){n=ue(a[1]);let l;for(l=0;l<n.length;l+=1){const c=Yr(a,n,l);i[l]?i[l].p(c,o):(i[l]=ri(c),i[l].c(),i[l].m(e.parentNode,e))}for(;l<i.length;l+=1)i[l].d(1);i.length=n.length}a[3]?r||(r=ii(),r.c(),r.m(t.parentNode,t)):r&&(r.d(1),r=null)},d(a){a&&(j(e),j(t)),Qe(i,a),r&&r.d(a)}}}function Nl(s){let e,t,n,i,r,a,o,l,c=ue(s[8]),u=[];for(let h=0;h<c.length;h+=1)u[h]=ai(Zr(s,c,h));return{c(){e=b("div"),t=b("div"),t.textContent="ðŸ¤–",n=E(),i=b("h2"),i.textContent="AIåŠ©æ‰‹",r=E(),a=b("p"),a.textContent="é€‰æ‹©æ–‡æœ¬å¹¶ä½¿ç”¨å¿«æ·æ“ä½œï¼Œæˆ–ç›´æŽ¥å¼€å§‹å¯¹è¯",o=E(),l=b("div");for(let h=0;h<u.length;h+=1)u[h].c();p(t,"class","welcome-icon svelte-ou36hp"),p(i,"class","svelte-ou36hp"),p(a,"class","svelte-ou36hp"),p(l,"class","quick-actions svelte-ou36hp"),p(e,"class","welcome-message svelte-ou36hp")},m(h,f){$(h,e,f),d(e,t),d(e,n),d(e,i),d(e,r),d(e,a),d(e,o),d(e,l);for(let m=0;m<u.length;m+=1)u[m]&&u[m].m(l,null)},p(h,f){if(f[0]&1280){c=ue(h[8]);let m;for(m=0;m<c.length;m+=1){const g=Zr(h,c,m);u[m]?u[m].p(g,f):(u[m]=ai(g),u[m].c(),u[m].m(l,null))}for(;m<u.length;m+=1)u[m].d(1);u.length=c.length}},d(h){h&&j(e),Qe(u,h)}}}function ri(s){let e,t,n=s[31].role==="user"?"ðŸ‘¤":"ðŸ¤–",i,r,a,o,l=s[31].content+"",c,u,h,f=ci(s[31].timestamp)+"",m;return{c(){e=b("div"),t=b("div"),i=V(n),r=E(),a=b("div"),o=b("div"),c=V(l),u=E(),h=b("div"),m=V(f),p(t,"class","message-avatar svelte-ou36hp"),p(o,"class","message-text svelte-ou36hp"),p(h,"class","message-time svelte-ou36hp"),p(a,"class","message-content svelte-ou36hp"),p(e,"class","message svelte-ou36hp"),ce(e,"user",s[31].role==="user"),ce(e,"assistant",s[31].role==="assistant")},m(g,_){$(g,e,_),d(e,t),d(t,i),d(e,r),d(e,a),d(a,o),d(o,c),d(a,u),d(a,h),d(h,m)},p(g,_){_[0]&2&&n!==(n=g[31].role==="user"?"ðŸ‘¤":"ðŸ¤–")&&Y(i,n),_[0]&2&&l!==(l=g[31].content+"")&&Y(c,l),_[0]&2&&f!==(f=ci(g[31].timestamp)+"")&&Y(m,f),_[0]&2&&ce(e,"user",g[31].role==="user"),_[0]&2&&ce(e,"assistant",g[31].role==="assistant")},d(g){g&&j(e)}}}function ii(s){let e;return{c(){e=b("div"),e.innerHTML='<div class="message-avatar svelte-ou36hp">ðŸ¤–</div> <div class="message-content svelte-ou36hp"><div class="typing-indicator svelte-ou36hp"><span class="svelte-ou36hp"></span> <span class="svelte-ou36hp"></span> <span class="svelte-ou36hp"></span></div></div>',p(e,"class","message assistant streaming svelte-ou36hp")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function ai(s){let e,t,n,i,r,a,o;function l(){return s[19](s[26])}return{c(){e=b("button"),t=b("span"),t.textContent=`${s[26].icon}`,n=E(),i=b("span"),i.textContent=`${s[26].label}`,r=E(),p(t,"class","icon"),p(e,"class","quick-action-btn svelte-ou36hp")},m(c,u){$(c,e,u),d(e,t),d(e,n),d(e,i),d(e,r),a||(o=O(e,"click",l),a=!0)},p(c,u){s=c},d(c){c&&j(e),a=!1,o()}}}function oi(s){let e,t=ue(s[8]),n=[];for(let i=0;i<t.length;i+=1)n[i]=li(Qr(s,t,i));return{c(){e=b("div");for(let i=0;i<n.length;i+=1)n[i].c();p(e,"class","quick-actions-bar svelte-ou36hp")},m(i,r){$(i,e,r);for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(e,null)},p(i,r){if(r[0]&1288){t=ue(i[8]);let a;for(a=0;a<t.length;a+=1){const o=Qr(i,t,a);n[a]?n[a].p(o,r):(n[a]=li(o),n[a].c(),n[a].m(e,null))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},d(i){i&&j(e),Qe(n,i)}}}function li(s){let e,t=s[26].icon+"",n,i,r=s[26].label+"",a,o,l,c;function u(){return s[21](s[26])}return{c(){e=b("button"),n=V(t),i=E(),a=V(r),o=E(),p(e,"class","quick-action-chip svelte-ou36hp"),e.disabled=s[3]},m(h,f){$(h,e,f),d(e,n),d(e,i),d(e,a),d(e,o),l||(c=O(e,"click",u),l=!0)},p(h,f){s=h,f[0]&8&&(e.disabled=s[3])},d(h){h&&j(e),l=!1,c()}}}function jl(s){let e,t,n,i,r,a,o,l,c,u,h,f,m,g,_,w,y,v,S,A=s[3]?"â³":"âž¤",I,C,k,M,R=s[6]&&ti(s);function F(B,x){return B[1].length===0?Nl:xl}let D=F(s),T=D(s),P=s[1].length>0&&oi(s);return{c(){e=b("div"),t=b("div"),n=b("div"),n.innerHTML='<span class="icon svelte-ou36hp">ðŸ¤–</span> <span>AIåŠ©æ‰‹</span>',i=E(),r=b("div"),a=b("button"),a.textContent="ðŸ“š",o=E(),l=b("button"),l.textContent="âž•",c=E(),u=b("button"),u.textContent="âš™ï¸",h=E(),R&&R.c(),f=E(),m=b("div"),T.c(),g=E(),P&&P.c(),_=E(),w=b("div"),y=b("textarea"),v=E(),S=b("button"),I=V(A),p(n,"class","header-title svelte-ou36hp"),p(a,"class","btn-icon svelte-ou36hp"),p(a,"title","åŽ†å²è®°å½•"),p(l,"class","btn-icon svelte-ou36hp"),p(l,"title","æ–°å¯¹è¯"),p(u,"class","btn-icon svelte-ou36hp"),p(u,"title","è®¾ç½®"),p(r,"class","header-actions svelte-ou36hp"),p(t,"class","chat-header svelte-ou36hp"),p(m,"class","messages-container svelte-ou36hp"),p(y,"placeholder","è¾“å…¥æ¶ˆæ¯... (Enterå‘é€, Shift+Enteræ¢è¡Œ)"),y.disabled=s[3],p(y,"rows","2"),p(y,"class","svelte-ou36hp"),p(S,"class","send-btn svelte-ou36hp"),S.disabled=C=!s[2].trim()||s[3],p(w,"class","input-area svelte-ou36hp"),p(e,"class","ai-chat-panel svelte-ou36hp")},m(B,x){$(B,e,x),d(e,t),d(t,n),d(t,i),d(t,r),d(r,a),d(r,o),d(r,l),d(r,c),d(r,u),d(e,h),R&&R.m(e,null),d(e,f),d(e,m),T.m(m,null),s[20](m),d(e,g),P&&P.m(e,null),d(e,_),d(e,w),d(w,y),te(y,s[2]),d(w,v),d(w,S),d(S,I),k||(M=[O(a,"click",s[15]),O(l,"click",s[11]),O(u,"click",function(){tn(s[0])&&s[0].apply(this,arguments)}),O(y,"input",s[22]),O(y,"keydown",s[14]),O(S,"click",s[9])],k=!0)},p(B,x){s=B,s[6]?R?R.p(s,x):(R=ti(s),R.c(),R.m(e,f)):R&&(R.d(1),R=null),D===(D=F(s))&&T?T.p(s,x):(T.d(1),T=D(s),T&&(T.c(),T.m(m,null))),s[1].length>0?P?P.p(s,x):(P=oi(s),P.c(),P.m(e,_)):P&&(P.d(1),P=null),x[0]&8&&(y.disabled=s[3]),x[0]&4&&te(y,s[2]),x[0]&8&&A!==(A=s[3]?"â³":"âž¤")&&Y(I,A),x[0]&12&&C!==(C=!s[2].trim()||s[3])&&(S.disabled=C)},i:ze,o:ze,d(B){B&&j(e),R&&R.d(),T.d(),s[20](null),P&&P.d(),k=!1,Ce(M)}}}function wt(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function ci(s){return new Date(s).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}function zl(s,e,t){let{onOpenSettings:n=()=>{}}=e,i=[],r="",a=!1,o=null,l=[],c=!1,u;const h=[{type:"polish",label:"æ¶¦è‰²",icon:"âœ¨"},{type:"translate",label:"ç¿»è¯‘",icon:"ðŸŒ"},{type:"summarize",label:"æ€»ç»“",icon:"ðŸ“"},{type:"expand",label:"æ‰©å†™",icon:"ðŸ“–"}];Ss(()=>{f();const P=Q.getCurrentProvider();P&&pe.setProvider(P)});function f(){t(5,l=Q.getConversations())}async function m(){if(!r.trim()||a)return;const P={id:wt(),role:"user",content:r.trim(),timestamp:Date.now()};t(1,i=[...i,P]),t(2,r=""),t(3,a=!0),A();try{const B=[{role:"system",content:"You are a helpful assistant."},...i.map(ee=>({role:ee.role,content:ee.content}))];let x="";const G={id:wt(),role:"assistant",content:"",timestamp:Date.now()};t(1,i=[...i,G]),await pe.streamChat(B),x=(await pe.processText(P.content,"chat").catch(async()=>{var ae;return await((ae=pe.adapter)==null?void 0:ae.chatCompletion(B))||{content:"Sorry, I could not process your request."}})).content;const H=i.findIndex(ee=>ee.id===G.id);H>=0&&(t(1,i[H]={...G,content:x},i),t(1,i=[...i])),await _()}catch(B){console.error("[AI Assistant] Chat error:",B),t(1,i=[...i,{id:wt(),role:"assistant",content:"æŠ±æ­‰ï¼Œå¤„ç†è¯·æ±‚æ—¶å‡ºé”™ã€‚è¯·æ£€æŸ¥AIæä¾›å•†é…ç½®ã€‚",timestamp:Date.now()}])}finally{t(3,a=!1),A()}}async function g(P){const B=At.getSelectedText();if(!B){t(2,r=Qt[P]);return}const x={id:wt(),role:"user",content:`[${P}] ${B.substring(0,50)}...`,timestamp:Date.now()};t(1,i=[...i,x]),t(3,a=!0),A();try{const G=await pe.processText(B,P);t(1,i=[...i,{id:wt(),role:"assistant",content:G.content,timestamp:Date.now()}]),await _()}catch(G){console.error("[AI Assistant] Action error:",G),t(1,i=[...i,{id:wt(),role:"assistant",content:"å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚",timestamp:Date.now()}])}finally{t(3,a=!1),A()}}async function _(){var x;if(i.length===0)return;const P=i[0].content.substring(0,30)+(i[0].content.length>30?"...":""),B={id:o||wt(),title:P,messages:[...i],createdAt:o&&((x=l.find(G=>G.id===o))==null?void 0:x.createdAt)||Date.now(),updatedAt:Date.now()};t(4,o=B.id),await Q.addConversation(B),f()}function w(){i.length>0&&_(),t(1,i=[]),t(4,o=null)}function y(P){const B=l.find(x=>x.id===P);B&&(t(1,i=[...B.messages]),t(4,o=P),t(6,c=!1),A())}async function v(P,B){B.stopPropagation(),confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ")&&(await Q.deleteConversation(P),o===P&&w(),f())}function S(P){P.key==="Enter"&&!P.shiftKey&&(P.preventDefault(),m())}function A(){mo().then(()=>{u&&t(7,u.scrollTop=u.scrollHeight,u)})}const I=()=>t(6,c=!c),C=()=>t(6,c=!1),k=(P,B)=>v(P.id,B),M=P=>y(P.id),R=P=>g(P.type);function F(P){os[P?"unshift":"push"](()=>{u=P,t(7,u)})}const D=P=>g(P.type);function T(){r=this.value,t(2,r)}return s.$$set=P=>{"onOpenSettings"in P&&t(0,n=P.onOpenSettings)},[n,i,r,a,o,l,c,u,h,m,g,w,y,v,S,I,C,k,M,R,F,D,T]}class $l extends Es{constructor(e){super(),Cs(this,e,zl,jl,ks,{onOpenSettings:0},null,[-1,-1])}}function ui(s,e,t){const n=s.slice();return n[74]=e[t],n[75]=e,n[76]=t,n}function hi(s,e,t){const n=s.slice();return n[71]=e[t],n}function fi(s,e,t){const n=s.slice();return n[68]=e[t],n}function Ul(s){let e,t,n,i,r,a,o=ue(s[3]),l=[];for(let u=0;u<o.length;u+=1)l[u]=di(ui(s,o,u));let c=s[10]&&mi(s);return{c(){e=b("div"),t=b("h3"),t.textContent="è‡ªå®šä¹‰æŒ‰é’®é…ç½®",n=E(),i=b("p"),i.textContent="é…ç½®ä¸‰ä¸ªè‡ªå®šä¹‰æ“ä½œæŒ‰é’®ï¼ˆå¯ç”¨åŽä¼šè‡ªåŠ¨åŒæ­¥åˆ°å·¥å…·æ ï¼‰",r=E();for(let u=0;u<l.length;u+=1)l[u].c();a=E(),c&&c.c(),p(i,"class","section-desc svelte-j5ryrz"),p(e,"class","prompts-section")},m(u,h){$(u,e,h),d(e,t),d(e,n),d(e,i),d(e,r);for(let f=0;f<l.length;f+=1)l[f]&&l[f].m(e,null);d(e,a),c&&c.m(e,null)},p(u,h){if(h[0]&2621448){o=ue(u[3]);let f;for(f=0;f<o.length;f+=1){const m=ui(u,o,f);l[f]?l[f].p(m,h):(l[f]=di(m),l[f].c(),l[f].m(e,a))}for(;f<l.length;f+=1)l[f].d(1);l.length=o.length}u[10]?c?c.p(u,h):(c=mi(u),c.c(),c.m(e,null)):c&&(c.d(1),c=null)},d(u){u&&j(e),Qe(l,u),c&&c.d()}}}function Hl(s){let e;return{c(){e=b("div"),e.innerHTML='<h3>ç•Œé¢è®¾ç½®</h3> <p class="section-desc svelte-j5ryrz">MVPç‰ˆæœ¬æš‚ä¸æ”¯æŒç•Œé¢è‡ªå®šä¹‰</p>',p(e,"class","ui-section")},m(t,n){$(t,e,n)},p:ze,d(t){t&&j(e)}}}function Wl(s){var fr,dr,mr,gr,pr,_r;let e,t,n,i,r,a,o,l,c,u,h,f,m,g,_,w,y,v,S,A,I,C,k,M,R,F,D,T,P,B,x,G,X,H,ee,ae,Te,K,ke,Ee,Ye,rt,Ve,Ze,Ie,Me,Oe,Se,mt,$e,et=(((fr=s[3][0])==null?void 0:fr.name)||"è‡ªå®šä¹‰1")+"",oe,gt,Fe=(((dr=s[3][0])==null?void 0:dr.icon)||"âœ¨")+"",le,pt,Be,he,be,J,ne=(((mr=s[3][1])==null?void 0:mr.name)||"è‡ªå®šä¹‰2")+"",zt,un,St=(((gr=s[3][1])==null?void 0:gr.icon)||"ðŸ”§")+"",$t,hn,it,Je,fn,_t,N=(((pr=s[3][2])==null?void 0:pr.name)||"è‡ªå®šä¹‰3")+"",fe,at,tt=(((_r=s[3][2])==null?void 0:_r.icon)||"ðŸŽ¯")+"",ot,ur,Kn,hr,Pe=s[10]&&gi(s);return{c(){e=b("div"),t=b("h3"),t.textContent="æµ®åŠ¨å·¥å…·æ æŒ‰é’®",n=E(),i=b("p"),i.textContent="é€‰æ‹©åœ¨æµ®åŠ¨å·¥å…·æ ä¸­æ˜¾ç¤ºå“ªäº›æŒ‰é’®",r=E(),a=b("div"),o=b("label"),l=b("input"),c=E(),u=b("span"),u.textContent="âœ¨ æ¶¦è‰²",h=E(),f=b("label"),m=b("input"),g=E(),_=b("span"),_.textContent="ðŸŒ ç¿»è¯‘",w=E(),y=b("label"),v=b("input"),S=E(),A=b("span"),A.textContent="ðŸ“ æ€»ç»“",I=E(),C=b("label"),k=b("input"),M=E(),R=b("span"),R.textContent="ðŸ“– æ‰©å†™",F=E(),D=b("label"),T=b("input"),P=E(),B=b("span"),B.textContent="ðŸ“„ ç²¾ç®€",x=E(),G=b("label"),X=b("input"),H=E(),ee=b("span"),ee.textContent="ðŸ”„ æ”¹å†™",ae=E(),Te=b("label"),K=b("input"),ke=E(),Ee=b("span"),Ee.textContent="âž¡ï¸ ç»­å†™",Ye=E(),rt=b("h4"),rt.textContent="è‡ªå®šä¹‰æŒ‰é’®",Ve=E(),Ze=b("p"),Ze.textContent='åœ¨"è‡ªå®šä¹‰æç¤ºè¯"Tabä¸­é…ç½®åŽä¼šè‡ªåŠ¨åŒæ­¥åˆ°è¿™é‡Œ',Ie=E(),Me=b("div"),Oe=b("label"),Se=b("input"),mt=E(),$e=b("span"),oe=V(et),gt=E(),le=V(Fe),pt=E(),Be=b("label"),he=b("input"),be=E(),J=b("span"),zt=V(ne),un=E(),$t=V(St),hn=E(),it=b("label"),Je=b("input"),fn=E(),_t=b("span"),fe=V(N),at=E(),ot=V(tt),ur=E(),Pe&&Pe.c(),p(i,"class","section-desc svelte-j5ryrz"),p(l,"type","checkbox"),p(l,"class","svelte-j5ryrz"),p(o,"class","checkbox-item svelte-j5ryrz"),p(m,"type","checkbox"),p(m,"class","svelte-j5ryrz"),p(f,"class","checkbox-item svelte-j5ryrz"),p(v,"type","checkbox"),p(v,"class","svelte-j5ryrz"),p(y,"class","checkbox-item svelte-j5ryrz"),p(k,"type","checkbox"),p(k,"class","svelte-j5ryrz"),p(C,"class","checkbox-item svelte-j5ryrz"),p(T,"type","checkbox"),p(T,"class","svelte-j5ryrz"),p(D,"class","checkbox-item svelte-j5ryrz"),p(X,"type","checkbox"),p(X,"class","svelte-j5ryrz"),p(G,"class","checkbox-item svelte-j5ryrz"),p(K,"type","checkbox"),p(K,"class","svelte-j5ryrz"),p(Te,"class","checkbox-item svelte-j5ryrz"),p(a,"class","checkbox-list svelte-j5ryrz"),p(Ze,"class","section-desc svelte-j5ryrz"),p(Se,"type","checkbox"),p(Se,"class","svelte-j5ryrz"),p(Oe,"class","checkbox-item svelte-j5ryrz"),p(he,"type","checkbox"),p(he,"class","svelte-j5ryrz"),p(Be,"class","checkbox-item svelte-j5ryrz"),p(Je,"type","checkbox"),p(Je,"class","svelte-j5ryrz"),p(it,"class","checkbox-item svelte-j5ryrz"),p(Me,"class","checkbox-list svelte-j5ryrz"),p(e,"class","toolbar-section")},m(se,de){$(se,e,de),d(e,t),d(e,n),d(e,i),d(e,r),d(e,a),d(a,o),d(o,l),l.checked=s[4].polish,d(o,c),d(o,u),d(a,h),d(a,f),d(f,m),m.checked=s[4].translate,d(f,g),d(f,_),d(a,w),d(a,y),d(y,v),v.checked=s[4].summarize,d(y,S),d(y,A),d(a,I),d(a,C),d(C,k),k.checked=s[4].expand,d(C,M),d(C,R),d(a,F),d(a,D),d(D,T),T.checked=s[4].condense,d(D,P),d(D,B),d(a,x),d(a,G),d(G,X),X.checked=s[4].rewrite,d(G,H),d(G,ee),d(a,ae),d(a,Te),d(Te,K),K.checked=s[4].continue,d(Te,ke),d(Te,Ee),d(e,Ye),d(e,rt),d(e,Ve),d(e,Ze),d(e,Ie),d(e,Me),d(Me,Oe),d(Oe,Se),Se.checked=s[4].custom1,d(Oe,mt),d(Oe,$e),d($e,oe),d($e,gt),d($e,le),d(Me,pt),d(Me,Be),d(Be,he),he.checked=s[4].custom2,d(Be,be),d(Be,J),d(J,zt),d(J,un),d(J,$t),d(Me,hn),d(Me,it),d(it,Je),Je.checked=s[4].custom3,d(it,fn),d(it,_t),d(_t,fe),d(_t,at),d(_t,ot),d(e,ur),Pe&&Pe.m(e,null),Kn||(hr=[O(l,"change",s[36]),O(l,"change",s[37]),O(m,"change",s[38]),O(m,"change",s[39]),O(v,"change",s[40]),O(v,"change",s[41]),O(k,"change",s[42]),O(k,"change",s[43]),O(T,"change",s[44]),O(T,"change",s[45]),O(X,"change",s[46]),O(X,"change",s[47]),O(K,"change",s[48]),O(K,"change",s[49]),O(Se,"change",s[50]),O(Se,"change",s[51]),O(he,"change",s[52]),O(he,"change",s[53]),O(Je,"change",s[54]),O(Je,"change",s[55])],Kn=!0)},p(se,de){var br,wr,vr,yr,Ar,kr;de[0]&16&&(l.checked=se[4].polish),de[0]&16&&(m.checked=se[4].translate),de[0]&16&&(v.checked=se[4].summarize),de[0]&16&&(k.checked=se[4].expand),de[0]&16&&(T.checked=se[4].condense),de[0]&16&&(X.checked=se[4].rewrite),de[0]&16&&(K.checked=se[4].continue),de[0]&16&&(Se.checked=se[4].custom1),de[0]&8&&et!==(et=(((br=se[3][0])==null?void 0:br.name)||"è‡ªå®šä¹‰1")+"")&&Y(oe,et),de[0]&8&&Fe!==(Fe=(((wr=se[3][0])==null?void 0:wr.icon)||"âœ¨")+"")&&Y(le,Fe),de[0]&16&&(he.checked=se[4].custom2),de[0]&8&&ne!==(ne=(((vr=se[3][1])==null?void 0:vr.name)||"è‡ªå®šä¹‰2")+"")&&Y(zt,ne),de[0]&8&&St!==(St=(((yr=se[3][1])==null?void 0:yr.icon)||"ðŸ”§")+"")&&Y($t,St),de[0]&16&&(Je.checked=se[4].custom3),de[0]&8&&N!==(N=(((Ar=se[3][2])==null?void 0:Ar.name)||"è‡ªå®šä¹‰3")+"")&&Y(fe,N),de[0]&8&&tt!==(tt=(((kr=se[3][2])==null?void 0:kr.icon)||"ðŸŽ¯")+"")&&Y(ot,tt),se[10]?Pe?Pe.p(se,de):(Pe=gi(se),Pe.c(),Pe.m(e,null)):Pe&&(Pe.d(1),Pe=null)},d(se){se&&j(e),Pe&&Pe.d(),Kn=!1,Ce(hr)}}}function Vl(s){let e;function t(r,a){return r[5]?ql:Jl}let n=t(s),i=n(s);return{c(){e=b("div"),i.c(),p(e,"class","providers-section")},m(r,a){$(r,e,a),i.m(e,null)},p(r,a){n===(n=t(r))&&i?i.p(r,a):(i.d(1),i=n(r),i&&(i.c(),i.m(e,null)))},d(r){r&&j(e),i.d()}}}function di(s){let e,t,n,i,r,a,o,l,c,u,h,f,m,g,_,w,y,v,S,A,I,C,k,M;function R(){s[56].call(r,s[75],s[76])}function F(){return s[57](s[76])}function D(){s[58].call(f,s[75],s[76])}function T(){s[60].call(y,s[75],s[76])}function P(){s[62].call(C,s[75],s[76])}return{c(){e=b("div"),t=b("h4"),t.textContent=`è‡ªå®šä¹‰æŒ‰é’® ${s[76]+1}`,n=E(),i=b("label"),r=b("input"),a=E(),o=b("span"),o.textContent="å¯ç”¨æ­¤æŒ‰é’®",l=E(),c=b("div"),u=b("label"),u.textContent="æŒ‰é’®åç§°",h=E(),f=b("input"),m=E(),g=b("div"),_=b("label"),_.textContent="å›¾æ ‡ (emoji)",w=E(),y=b("input"),v=E(),S=b("div"),A=b("label"),A.textContent="AIæç¤ºè¯",I=E(),C=b("textarea"),p(t,"class","svelte-j5ryrz"),p(r,"type","checkbox"),p(r,"class","svelte-j5ryrz"),p(i,"class","checkbox-item svelte-j5ryrz"),p(u,"class","svelte-j5ryrz"),p(f,"type","text"),p(f,"placeholder","æŒ‰é’®æ˜¾ç¤ºåç§°"),p(f,"class","svelte-j5ryrz"),p(c,"class","form-group svelte-j5ryrz"),p(_,"class","svelte-j5ryrz"),p(y,"type","text"),p(y,"placeholder","âœ¨"),p(y,"maxlength","2"),p(y,"class","svelte-j5ryrz"),p(g,"class","form-group svelte-j5ryrz"),p(A,"class","svelte-j5ryrz"),p(C,"placeholder","è¾“å…¥AIæç¤ºè¯ï¼Œä¾‹å¦‚ï¼šè¯·å°†ä»¥ä¸‹å†…å®¹è½¬æ¢æˆè¡¨æ ¼å½¢å¼ï¼š"),p(C,"rows","3"),p(C,"class","svelte-j5ryrz"),p(S,"class","form-group svelte-j5ryrz"),p(e,"class","custom-button-form svelte-j5ryrz")},m(B,x){$(B,e,x),d(e,t),d(e,n),d(e,i),d(i,r),r.checked=s[74].enabled,d(i,a),d(i,o),d(e,l),d(e,c),d(c,u),d(c,h),d(c,f),te(f,s[74].name),d(e,m),d(e,g),d(g,_),d(g,w),d(g,y),te(y,s[74].icon),d(e,v),d(e,S),d(S,A),d(S,I),d(S,C),te(C,s[74].prompt),k||(M=[O(r,"change",R),O(r,"change",F),O(f,"input",D),O(f,"input",s[59]),O(y,"input",T),O(y,"input",s[61]),O(C,"input",P),O(C,"input",s[63])],k=!0)},p(B,x){s=B,x[0]&8&&(r.checked=s[74].enabled),x[0]&8&&f.value!==s[74].name&&te(f,s[74].name),x[0]&8&&y.value!==s[74].icon&&te(y,s[74].icon),x[0]&8&&te(C,s[74].prompt)},d(B){B&&j(e),k=!1,Ce(M)}}}function mi(s){let e,t;return{c(){e=b("div"),t=V(s[10]),p(e,"class","save-message svelte-j5ryrz")},m(n,i){$(n,e,i),d(e,t)},p(n,i){i[0]&1024&&Y(t,n[10])},d(n){n&&j(e)}}}function gi(s){let e,t;return{c(){e=b("div"),t=V(s[10]),p(e,"class","save-message svelte-j5ryrz")},m(n,i){$(n,e,i),d(e,t)},p(n,i){i[0]&1024&&Y(t,n[10])},d(n){n&&j(e)}}}function Jl(s){let e,t,n,i,r,a,o,l;function c(f,m){return f[2].length===0?Kl:Xl}let u=c(s),h=u(s);return{c(){e=b("div"),t=b("div"),n=b("h3"),n.textContent="å·²é…ç½®çš„æä¾›å•†",i=E(),r=b("button"),r.textContent="+ æ·»åŠ æä¾›å•†",a=E(),h.c(),p(n,"class","svelte-j5ryrz"),p(r,"class","btn-primary svelte-j5ryrz"),p(t,"class","section-header svelte-j5ryrz"),p(e,"class","providers-list svelte-j5ryrz")},m(f,m){$(f,e,m),d(e,t),d(t,n),d(t,i),d(t,r),d(e,a),h.m(e,null),o||(l=O(r,"click",s[11]),o=!0)},p(f,m){u===(u=c(f))&&h?h.p(f,m):(h.d(1),h=u(f),h&&(h.c(),h.m(e,null)))},d(f){f&&j(e),h.d(),o=!1,l()}}}function ql(s){let e,t,n=s[6]?"æ·»åŠ æä¾›å•†":"ç¼–è¾‘æä¾›å•†",i,r,a,o,l,c,u,h,f,m,g,_,w,y,v,S,A,I,C,k,M,R,F,D,T,P,B,x,G,X,H,ee,ae,Te,K,ke,Ee,Ye,rt,Ve,Ze,Ie,Me,Oe,Se,mt,$e,et,oe=s[6]&&wi(s);function gt(J,ne){if(J[7]==="success")return Ql;if(J[7]==="error")return Gl}let Fe=gt(s),le=Fe&&Fe(s);function pt(J,ne){return J[7]==="testing"?Zl:Yl}let Be=pt(s),he=Be(s),be=!s[9]&&yi();return{c(){e=b("div"),t=b("h3"),i=V(n),r=E(),oe&&oe.c(),a=E(),o=b("div"),l=b("label"),l.textContent="åç§° *",c=E(),u=b("input"),h=E(),f=b("div"),m=b("label"),m.textContent="APIåœ°å€ *",g=E(),_=b("input"),w=E(),y=b("div"),v=b("label"),v.textContent="APIå¯†é’¥",S=E(),A=b("input"),I=E(),C=b("div"),k=b("label"),k.textContent="æ¨¡åž‹åç§° *",M=E(),R=b("input"),F=E(),D=b("div"),T=b("div"),P=b("label"),P.textContent="æ¸©åº¦ (0-2)",B=E(),x=b("input"),G=E(),X=b("div"),H=b("label"),H.textContent="æœ€å¤§Token",ee=E(),ae=b("input"),Te=E(),le&&le.c(),K=E(),ke=b("div"),Ee=b("button"),he.c(),rt=E(),Ve=b("button"),Ve.textContent="å–æ¶ˆ",Ze=E(),Ie=b("button"),Me=V("ä¿å­˜"),mt=E(),be&&be.c(),p(t,"class","svelte-j5ryrz"),p(l,"class","svelte-j5ryrz"),p(u,"type","text"),p(u,"placeholder","ä¾‹å¦‚ï¼šOllamaæœ¬åœ°"),p(u,"class","svelte-j5ryrz"),p(o,"class","form-group svelte-j5ryrz"),p(m,"class","svelte-j5ryrz"),p(_,"type","text"),p(_,"placeholder","http://localhost:11434/v1"),p(_,"class","svelte-j5ryrz"),p(f,"class","form-group svelte-j5ryrz"),p(v,"class","svelte-j5ryrz"),p(A,"type","password"),p(A,"placeholder","sk-..."),p(A,"class","svelte-j5ryrz"),p(y,"class","form-group svelte-j5ryrz"),p(k,"class","svelte-j5ryrz"),p(R,"type","text"),p(R,"placeholder","llama3.2"),p(R,"class","svelte-j5ryrz"),p(C,"class","form-group svelte-j5ryrz"),p(P,"class","svelte-j5ryrz"),p(x,"type","number"),p(x,"min","0"),p(x,"max","2"),p(x,"step","0.1"),p(x,"class","svelte-j5ryrz"),p(T,"class","form-group svelte-j5ryrz"),p(H,"class","svelte-j5ryrz"),p(ae,"type","number"),p(ae,"min","100"),p(ae,"max","8192"),p(ae,"class","svelte-j5ryrz"),p(X,"class","form-group svelte-j5ryrz"),p(D,"class","form-row svelte-j5ryrz"),p(Ee,"class","btn-test svelte-j5ryrz"),Ee.disabled=Ye=s[7]==="testing",p(Ve,"class","btn-secondary svelte-j5ryrz"),p(Ie,"class","btn-primary svelte-j5ryrz"),Ie.disabled=Oe=!s[9],p(Ie,"title",Se=s[9]?"":"è¯·å…ˆé€šè¿‡è¿žæŽ¥æµ‹è¯•"),p(ke,"class","form-actions svelte-j5ryrz"),p(e,"class","provider-form svelte-j5ryrz")},m(J,ne){$(J,e,ne),d(e,t),d(t,i),d(e,r),oe&&oe.m(e,null),d(e,a),d(e,o),d(o,l),d(o,c),d(o,u),te(u,s[5].name),d(e,h),d(e,f),d(f,m),d(f,g),d(f,_),te(_,s[5].baseURL),d(e,w),d(e,y),d(y,v),d(y,S),d(y,A),te(A,s[5].apiKey),d(e,I),d(e,C),d(C,k),d(C,M),d(C,R),te(R,s[5].model),d(e,F),d(e,D),d(D,T),d(T,P),d(T,B),d(T,x),te(x,s[5].temperature),d(D,G),d(D,X),d(X,H),d(X,ee),d(X,ae),te(ae,s[5].maxTokens),d(e,Te),le&&le.m(e,null),d(e,K),d(e,ke),d(ke,Ee),he.m(Ee,null),d(ke,rt),d(ke,Ve),d(ke,Ze),d(ke,Ie),d(Ie,Me),d(e,mt),be&&be.m(e,null),$e||(et=[O(u,"input",s[27]),O(_,"input",s[28]),O(A,"input",s[29]),O(R,"input",s[30]),O(x,"input",s[31]),O(ae,"input",s[32]),O(Ee,"click",s[16]),O(Ve,"click",s[13]),O(Ie,"click",s[14])],$e=!0)},p(J,ne){ne[0]&64&&n!==(n=J[6]?"æ·»åŠ æä¾›å•†":"ç¼–è¾‘æä¾›å•†")&&Y(i,n),J[6]?oe?oe.p(J,ne):(oe=wi(J),oe.c(),oe.m(e,a)):oe&&(oe.d(1),oe=null),ne[0]&32&&u.value!==J[5].name&&te(u,J[5].name),ne[0]&32&&_.value!==J[5].baseURL&&te(_,J[5].baseURL),ne[0]&32&&A.value!==J[5].apiKey&&te(A,J[5].apiKey),ne[0]&32&&R.value!==J[5].model&&te(R,J[5].model),ne[0]&32&&Rn(x.value)!==J[5].temperature&&te(x,J[5].temperature),ne[0]&32&&Rn(ae.value)!==J[5].maxTokens&&te(ae,J[5].maxTokens),Fe===(Fe=gt(J))&&le?le.p(J,ne):(le&&le.d(1),le=Fe&&Fe(J),le&&(le.c(),le.m(e,K))),Be!==(Be=pt(J))&&(he.d(1),he=Be(J),he&&(he.c(),he.m(Ee,null))),ne[0]&128&&Ye!==(Ye=J[7]==="testing")&&(Ee.disabled=Ye),ne[0]&512&&Oe!==(Oe=!J[9])&&(Ie.disabled=Oe),ne[0]&512&&Se!==(Se=J[9]?"":"è¯·å…ˆé€šè¿‡è¿žæŽ¥æµ‹è¯•")&&p(Ie,"title",Se),J[9]?be&&(be.d(1),be=null):be||(be=yi(),be.c(),be.m(e,null))},d(J){J&&j(e),oe&&oe.d(),le&&le.d(),he.d(),be&&be.d(),$e=!1,Ce(et)}}}function Xl(s){let e,t=ue(s[2]),n=[];for(let i=0;i<t.length;i+=1)n[i]=bi(hi(s,t,i));return{c(){for(let i=0;i<n.length;i+=1)n[i].c();e=xi()},m(i,r){for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(i,r);$(i,e,r)},p(i,r){if(r[0]&167940){t=ue(i[2]);let a;for(a=0;a<t.length;a+=1){const o=hi(i,t,a);n[a]?n[a].p(o,r):(n[a]=bi(o),n[a].c(),n[a].m(e.parentNode,e))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},d(i){i&&j(e),Qe(n,i)}}}function Kl(s){let e,t,n,i,r,a;return{c(){e=b("div"),t=b("p"),t.textContent="æš‚æ— é…ç½®çš„AIæä¾›å•†",n=E(),i=b("button"),i.textContent="æ·»åŠ ç¬¬ä¸€ä¸ªæä¾›å•†",p(t,"class","svelte-j5ryrz"),p(i,"class","btn-primary svelte-j5ryrz"),p(e,"class","empty-state svelte-j5ryrz")},m(o,l){$(o,e,l),d(e,t),d(e,n),d(e,i),r||(a=O(i,"click",s[11]),r=!0)},p:ze,d(o){o&&j(e),r=!1,a()}}}function pi(s){let e;return{c(){e=b("span"),e.textContent="é»˜è®¤",p(e,"class","badge svelte-j5ryrz")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function _i(s){let e,t,n;function i(){return s[33](s[71])}return{c(){e=b("button"),e.textContent="è®¾ä¸ºé»˜è®¤",p(e,"class","btn-text svelte-j5ryrz")},m(r,a){$(r,e,a),t||(n=O(e,"click",i),t=!0)},p(r,a){s=r},d(r){r&&j(e),t=!1,n()}}}function bi(s){let e,t,n,i=s[71].name+"",r,a,o,l,c=s[71].model+"",u,h,f=s[71].baseURL+"",m,g,_,w,y,v,S,A,I,C,k=s[71].isDefault&&pi(),M=!s[71].isDefault&&_i(s);function R(){return s[34](s[71])}function F(){return s[35](s[71])}return{c(){e=b("div"),t=b("div"),n=b("div"),r=V(i),a=E(),k&&k.c(),o=E(),l=b("div"),u=V(c),h=V(" @ "),m=V(f),g=E(),_=b("div"),M&&M.c(),w=E(),y=b("button"),y.textContent="âœï¸",v=E(),S=b("button"),S.textContent="ðŸ—‘ï¸",A=E(),p(n,"class","provider-name svelte-j5ryrz"),p(l,"class","provider-details svelte-j5ryrz"),p(t,"class","provider-info"),p(y,"class","btn-icon svelte-j5ryrz"),p(S,"class","btn-icon svelte-j5ryrz"),p(_,"class","provider-actions svelte-j5ryrz"),p(e,"class","provider-card svelte-j5ryrz"),ce(e,"default",s[71].isDefault)},m(D,T){$(D,e,T),d(e,t),d(t,n),d(n,r),d(n,a),k&&k.m(n,null),d(t,o),d(t,l),d(l,u),d(l,h),d(l,m),d(e,g),d(e,_),M&&M.m(_,null),d(_,w),d(_,y),d(_,v),d(_,S),d(e,A),I||(C=[O(y,"click",R),O(S,"click",F)],I=!0)},p(D,T){s=D,T[0]&4&&i!==(i=s[71].name+"")&&Y(r,i),s[71].isDefault?k||(k=pi(),k.c(),k.m(n,null)):k&&(k.d(1),k=null),T[0]&4&&c!==(c=s[71].model+"")&&Y(u,c),T[0]&4&&f!==(f=s[71].baseURL+"")&&Y(m,f),s[71].isDefault?M&&(M.d(1),M=null):M?M.p(s,T):(M=_i(s),M.c(),M.m(_,w)),T[0]&4&&ce(e,"default",s[71].isDefault)},d(D){D&&j(e),k&&k.d(),M&&M.d(),I=!1,Ce(C)}}}function wi(s){let e,t,n,i=ue(Kr),r=[];for(let a=0;a<i.length;a+=1)r[a]=vi(fi(s,i,a));return{c(){e=b("div"),t=b("label"),t.textContent="å¿«é€Ÿæ¨¡æ¿ï¼š",n=E();for(let a=0;a<r.length;a+=1)r[a].c();p(t,"class","svelte-j5ryrz"),p(e,"class","template-buttons svelte-j5ryrz")},m(a,o){$(a,e,o),d(e,t),d(e,n);for(let l=0;l<r.length;l+=1)r[l]&&r[l].m(e,null)},p(a,o){if(o[0]&262144){i=ue(Kr);let l;for(l=0;l<i.length;l+=1){const c=fi(a,i,l);r[l]?r[l].p(c,o):(r[l]=vi(c),r[l].c(),r[l].m(e,null))}for(;l<r.length;l+=1)r[l].d(1);r.length=i.length}},d(a){a&&j(e),Qe(r,a)}}}function vi(s){let e,t,n;function i(){return s[26](s[68])}return{c(){e=b("button"),e.textContent=`${s[68].name} `,p(e,"class","template-btn svelte-j5ryrz")},m(r,a){$(r,e,a),t||(n=O(e,"click",i),t=!0)},p(r,a){s=r},d(r){r&&j(e),t=!1,n()}}}function Gl(s){let e,t,n,i,r;return{c(){e=b("div"),t=b("div"),t.textContent="âŒ è¿žæŽ¥å¤±è´¥",n=E(),i=b("div"),r=V(s[8]),p(t,"class","test-result-header svelte-j5ryrz"),p(i,"class","test-result-content svelte-j5ryrz"),p(e,"class","test-result error svelte-j5ryrz")},m(a,o){$(a,e,o),d(e,t),d(e,n),d(e,i),d(i,r)},p(a,o){o[0]&256&&Y(r,a[8])},d(a){a&&j(e)}}}function Ql(s){let e,t,n,i,r;return{c(){e=b("div"),t=b("div"),t.textContent="âœ… è¿žæŽ¥æˆåŠŸ",n=E(),i=b("div"),r=V(s[8]),p(t,"class","test-result-header svelte-j5ryrz"),p(i,"class","test-result-content svelte-j5ryrz"),p(e,"class","test-result success svelte-j5ryrz")},m(a,o){$(a,e,o),d(e,t),d(e,n),d(e,i),d(i,r)},p(a,o){o[0]&256&&Y(r,a[8])},d(a){a&&j(e)}}}function Yl(s){let e;return{c(){e=V("æµ‹è¯•è¿žæŽ¥")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function Zl(s){let e;return{c(){e=V("æµ‹è¯•ä¸­...")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function yi(s){let e;return{c(){e=b("div"),e.textContent='âš ï¸ è¯·å…ˆç‚¹å‡»"æµ‹è¯•è¿žæŽ¥"æŒ‰é’®ï¼Œæµ‹è¯•é€šè¿‡åŽæ‰èƒ½ä¿å­˜',p(e,"class","test-warning svelte-j5ryrz")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function ec(s){let e,t,n,i,r,a,o,l,c,u,h,f,m,g,_,w,y,v;function S(C,k){if(C[1]==="providers")return Vl;if(C[1]==="toolbar")return Wl;if(C[1]==="ui")return Hl;if(C[1]==="prompts")return Ul}let A=S(s),I=A&&A(s);return{c(){e=b("div"),t=b("div"),n=b("h2"),n.textContent="âš™ï¸ AIåŠ©æ‰‹è®¾ç½®",i=E(),r=b("button"),r.textContent="âœ•",a=E(),o=b("div"),l=b("button"),l.textContent="AIæä¾›å•†",c=E(),u=b("button"),u.textContent="å·¥å…·æ ",h=E(),f=b("button"),f.textContent="ç•Œé¢è®¾ç½®",m=E(),g=b("button"),g.textContent="è‡ªå®šä¹‰æç¤ºè¯",_=E(),w=b("div"),I&&I.c(),p(n,"class","svelte-j5ryrz"),p(r,"class","btn-close svelte-j5ryrz"),p(t,"class","settings-header svelte-j5ryrz"),p(l,"class","tab-btn svelte-j5ryrz"),ce(l,"active",s[1]==="providers"),p(u,"class","tab-btn svelte-j5ryrz"),ce(u,"active",s[1]==="toolbar"),p(f,"class","tab-btn svelte-j5ryrz"),ce(f,"active",s[1]==="ui"),p(g,"class","tab-btn svelte-j5ryrz"),ce(g,"active",s[1]==="prompts"),p(o,"class","settings-tabs svelte-j5ryrz"),p(w,"class","settings-content svelte-j5ryrz"),p(e,"class","settings-panel svelte-j5ryrz")},m(C,k){$(C,e,k),d(e,t),d(t,n),d(t,i),d(t,r),d(e,a),d(e,o),d(o,l),d(o,c),d(o,u),d(o,h),d(o,f),d(o,m),d(o,g),d(e,_),d(e,w),I&&I.m(w,null),y||(v=[O(r,"click",function(){tn(s[0])&&s[0].apply(this,arguments)}),O(l,"click",s[22]),O(u,"click",s[23]),O(f,"click",s[24]),O(g,"click",s[25])],y=!0)},p(C,k){s=C,k[0]&2&&ce(l,"active",s[1]==="providers"),k[0]&2&&ce(u,"active",s[1]==="toolbar"),k[0]&2&&ce(f,"active",s[1]==="ui"),k[0]&2&&ce(g,"active",s[1]==="prompts"),A===(A=S(s))&&I?I.p(s,k):(I&&I.d(1),I=A&&A(s),I&&(I.c(),I.m(w,null)))},i:ze,o:ze,d(C){C&&j(e),I&&I.d(),y=!1,Ce(v)}}}function tc(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function nc(s,e,t){let{onClose:n=()=>{}}=e,i="providers",r=[],a=[],o={polish:!0,translate:!0,summarize:!0,expand:!0,condense:!1,rewrite:!1,continue:!1,custom1:!1,custom2:!1,custom3:!1},l=null,c=!1,u="idle",h="",f=!1;Ss(()=>{m()});function m(){const N=Q.getSettings();t(2,r=N.providers),t(3,a=N.customButtons),t(4,o=N.toolbarButtons)}function g(){t(6,c=!0),t(5,l={id:tc(),name:"",apiKey:"",baseURL:"",model:"",temperature:.7,maxTokens:2048,isDefault:r.length===0})}function _(N){t(6,c=!1),t(5,l={...N})}function w(){t(5,l=null),t(6,c=!1),t(7,u="idle")}async function y(){if(l){if(!l.name||!l.baseURL||!l.model){alert("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ");return}c?await Q.addProvider(l):await Q.updateProvider(l.id,l),m(),t(5,l=null),t(6,c=!1)}}async function v(N){confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæä¾›å•†å—ï¼Ÿ")&&(await Q.deleteProvider(N),m())}async function S(){var fe;if(!l)return;t(7,u="testing"),t(8,h=""),t(9,f=!1);const N=pe.getCurrentProvider();pe.setProvider(l);try{const tt=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AIåŠ©æ‰‹ã€‚"},{role:"user",content:"ä½ å¥½ï¼Œè¿™æ˜¯æµ‹è¯•"}],ot=await((fe=pe.adapter)==null?void 0:fe.chatCompletion(tt));ot&&ot.content&&ot.content.length>0?(t(7,u="success"),t(8,h=ot.content),t(9,f=!0)):(t(7,u="error"),t(8,h="AIè¿”å›žç©ºå†…å®¹"),t(9,f=!1))}catch(at){t(7,u="error"),t(8,h=at instanceof Error?at.message:"è¿žæŽ¥å¤±è´¥"),t(9,f=!1)}finally{N&&pe.setProvider(N)}}async function A(N){await Q.setCurrentProvider(N),m()}function I(N){l&&t(5,l={...l,name:N.name,baseURL:N.baseURL,model:N.model,apiKey:N.apiKey,temperature:N.temperature,maxTokens:N.maxTokens})}async function C(){await Q.updateCustomButtons(a),await M(),D("è‡ªå®šä¹‰æŒ‰é’®é…ç½®å·²ä¿å­˜")}async function k(){await Q.updateToolbarButtons(o),D("å·¥å…·æ é…ç½®å·²ä¿å­˜")}async function M(){const N=Q.getSettings().toolbarButtons;a.forEach((fe,at)=>{const tt=`custom${at+1}`;tt in N&&t(4,o[tt]=fe.enabled,o)}),await Q.updateToolbarButtons(o)}let R="",F=null;function D(N){t(10,R=N),F&&clearTimeout(F),F=window.setTimeout(()=>{t(10,R="")},2e3)}function T(N){const fe=`custom${N+1}`;fe in o&&t(4,o[fe]=a[N].enabled,o),Promise.all([Q.updateCustomButtons(a),Q.updateToolbarButtons(o)]).then(()=>{D("å·²è‡ªåŠ¨ä¿å­˜")})}const P=()=>t(1,i="providers"),B=()=>t(1,i="toolbar"),x=()=>t(1,i="ui"),G=()=>t(1,i="prompts"),X=N=>I(N);function H(){l.name=this.value,t(5,l)}function ee(){l.baseURL=this.value,t(5,l)}function ae(){l.apiKey=this.value,t(5,l)}function Te(){l.model=this.value,t(5,l)}function K(){l.temperature=Rn(this.value),t(5,l)}function ke(){l.maxTokens=Rn(this.value),t(5,l)}const Ee=N=>A(N.id),Ye=N=>_(N),rt=N=>v(N.id);function Ve(){o.polish=this.checked,t(4,o)}const Ze=()=>k();function Ie(){o.translate=this.checked,t(4,o)}const Me=()=>k();function Oe(){o.summarize=this.checked,t(4,o)}const Se=()=>k();function mt(){o.expand=this.checked,t(4,o)}const $e=()=>k();function et(){o.condense=this.checked,t(4,o)}const oe=()=>k();function gt(){o.rewrite=this.checked,t(4,o)}const Fe=()=>k();function le(){o.continue=this.checked,t(4,o)}const pt=()=>k();function Be(){o.custom1=this.checked,t(4,o)}const he=()=>k();function be(){o.custom2=this.checked,t(4,o)}const J=()=>k();function ne(){o.custom3=this.checked,t(4,o)}const zt=()=>k();function un(N,fe){N[fe].enabled=this.checked,t(3,a)}const St=N=>T(N);function $t(N,fe){N[fe].name=this.value,t(3,a)}const hn=()=>C();function it(N,fe){N[fe].icon=this.value,t(3,a)}const Je=()=>C();function fn(N,fe){N[fe].prompt=this.value,t(3,a)}const _t=()=>C();return s.$$set=N=>{"onClose"in N&&t(0,n=N.onClose)},[n,i,r,a,o,l,c,u,h,f,R,g,_,w,y,v,S,A,I,C,k,T,P,B,x,G,X,H,ee,ae,Te,K,ke,Ee,Ye,rt,Ve,Ze,Ie,Me,Oe,Se,mt,$e,et,oe,gt,Fe,le,pt,Be,he,be,J,ne,zt,un,St,$t,hn,it,Je,fn,_t]}class sc extends Es{constructor(e){super(),Cs(this,e,nc,ec,ks,{onClose:0},null,[-1,-1,-1])}}function rc(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var ao={exports:{}};(function(s){var e=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},t=-1,n=1,i=0;e.Diff=function(r,a){return[r,a]},e.prototype.diff_main=function(r,a,o,l){typeof l>"u"&&(this.Diff_Timeout<=0?l=Number.MAX_VALUE:l=new Date().getTime()+this.Diff_Timeout*1e3);var c=l;if(r==null||a==null)throw new Error("Null input. (diff_main)");if(r==a)return r?[new e.Diff(i,r)]:[];typeof o>"u"&&(o=!0);var u=o,h=this.diff_commonPrefix(r,a),f=r.substring(0,h);r=r.substring(h),a=a.substring(h),h=this.diff_commonSuffix(r,a);var m=r.substring(r.length-h);r=r.substring(0,r.length-h),a=a.substring(0,a.length-h);var g=this.diff_compute_(r,a,u,c);return f&&g.unshift(new e.Diff(i,f)),m&&g.push(new e.Diff(i,m)),this.diff_cleanupMerge(g),g},e.prototype.diff_compute_=function(r,a,o,l){var c;if(!r)return[new e.Diff(n,a)];if(!a)return[new e.Diff(t,r)];var u=r.length>a.length?r:a,h=r.length>a.length?a:r,f=u.indexOf(h);if(f!=-1)return c=[new e.Diff(n,u.substring(0,f)),new e.Diff(i,h),new e.Diff(n,u.substring(f+h.length))],r.length>a.length&&(c[0][0]=c[2][0]=t),c;if(h.length==1)return[new e.Diff(t,r),new e.Diff(n,a)];var m=this.diff_halfMatch_(r,a);if(m){var g=m[0],_=m[1],w=m[2],y=m[3],v=m[4],S=this.diff_main(g,w,o,l),A=this.diff_main(_,y,o,l);return S.concat([new e.Diff(i,v)],A)}return o&&r.length>100&&a.length>100?this.diff_lineMode_(r,a,l):this.diff_bisect_(r,a,l)},e.prototype.diff_lineMode_=function(r,a,o){var l=this.diff_linesToChars_(r,a);r=l.chars1,a=l.chars2;var c=l.lineArray,u=this.diff_main(r,a,!1,o);this.diff_charsToLines_(u,c),this.diff_cleanupSemantic(u),u.push(new e.Diff(i,""));for(var h=0,f=0,m=0,g="",_="";h<u.length;){switch(u[h][0]){case n:m++,_+=u[h][1];break;case t:f++,g+=u[h][1];break;case i:if(f>=1&&m>=1){u.splice(h-f-m,f+m),h=h-f-m;for(var w=this.diff_main(g,_,!1,o),y=w.length-1;y>=0;y--)u.splice(h,0,w[y]);h=h+w.length}m=0,f=0,g="",_="";break}h++}return u.pop(),u},e.prototype.diff_bisect_=function(r,a,o){for(var l=r.length,c=a.length,u=Math.ceil((l+c)/2),h=u,f=2*u,m=new Array(f),g=new Array(f),_=0;_<f;_++)m[_]=-1,g[_]=-1;m[h+1]=0,g[h+1]=0;for(var w=l-c,y=w%2!=0,v=0,S=0,A=0,I=0,C=0;C<u&&!(new Date().getTime()>o);C++){for(var k=-C+v;k<=C-S;k+=2){var M=h+k,R;k==-C||k!=C&&m[M-1]<m[M+1]?R=m[M+1]:R=m[M-1]+1;for(var F=R-k;R<l&&F<c&&r.charAt(R)==a.charAt(F);)R++,F++;if(m[M]=R,R>l)S+=2;else if(F>c)v+=2;else if(y){var D=h+w-k;if(D>=0&&D<f&&g[D]!=-1){var T=l-g[D];if(R>=T)return this.diff_bisectSplit_(r,a,R,F,o)}}}for(var P=-C+A;P<=C-I;P+=2){var D=h+P,T;P==-C||P!=C&&g[D-1]<g[D+1]?T=g[D+1]:T=g[D-1]+1;for(var B=T-P;T<l&&B<c&&r.charAt(l-T-1)==a.charAt(c-B-1);)T++,B++;if(g[D]=T,T>l)I+=2;else if(B>c)A+=2;else if(!y){var M=h+w-P;if(M>=0&&M<f&&m[M]!=-1){var R=m[M],F=h+R-M;if(T=l-T,R>=T)return this.diff_bisectSplit_(r,a,R,F,o)}}}}return[new e.Diff(t,r),new e.Diff(n,a)]},e.prototype.diff_bisectSplit_=function(r,a,o,l,c){var u=r.substring(0,o),h=a.substring(0,l),f=r.substring(o),m=a.substring(l),g=this.diff_main(u,h,!1,c),_=this.diff_main(f,m,!1,c);return g.concat(_)},e.prototype.diff_linesToChars_=function(r,a){var o=[],l={};o[0]="";function c(m){for(var g="",_=0,w=-1,y=o.length;w<m.length-1;){w=m.indexOf(`
`,_),w==-1&&(w=m.length-1);var v=m.substring(_,w+1);(l.hasOwnProperty?l.hasOwnProperty(v):l[v]!==void 0)?g+=String.fromCharCode(l[v]):(y==u&&(v=m.substring(_),w=m.length),g+=String.fromCharCode(y),l[v]=y,o[y++]=v),_=w+1}return g}var u=4e4,h=c(r);u=65535;var f=c(a);return{chars1:h,chars2:f,lineArray:o}},e.prototype.diff_charsToLines_=function(r,a){for(var o=0;o<r.length;o++){for(var l=r[o][1],c=[],u=0;u<l.length;u++)c[u]=a[l.charCodeAt(u)];r[o][1]=c.join("")}},e.prototype.diff_commonPrefix=function(r,a){if(!r||!a||r.charAt(0)!=a.charAt(0))return 0;for(var o=0,l=Math.min(r.length,a.length),c=l,u=0;o<c;)r.substring(u,c)==a.substring(u,c)?(o=c,u=o):l=c,c=Math.floor((l-o)/2+o);return c},e.prototype.diff_commonSuffix=function(r,a){if(!r||!a||r.charAt(r.length-1)!=a.charAt(a.length-1))return 0;for(var o=0,l=Math.min(r.length,a.length),c=l,u=0;o<c;)r.substring(r.length-c,r.length-u)==a.substring(a.length-c,a.length-u)?(o=c,u=o):l=c,c=Math.floor((l-o)/2+o);return c},e.prototype.diff_commonOverlap_=function(r,a){var o=r.length,l=a.length;if(o==0||l==0)return 0;o>l?r=r.substring(o-l):o<l&&(a=a.substring(0,o));var c=Math.min(o,l);if(r==a)return c;for(var u=0,h=1;;){var f=r.substring(c-h),m=a.indexOf(f);if(m==-1)return u;h+=m,(m==0||r.substring(c-h)==a.substring(0,h))&&(u=h,h++)}},e.prototype.diff_halfMatch_=function(r,a){if(this.Diff_Timeout<=0)return null;var o=r.length>a.length?r:a,l=r.length>a.length?a:r;if(o.length<4||l.length*2<o.length)return null;var c=this;function u(S,A,I){for(var C=S.substring(I,I+Math.floor(S.length/4)),k=-1,M="",R,F,D,T;(k=A.indexOf(C,k+1))!=-1;){var P=c.diff_commonPrefix(S.substring(I),A.substring(k)),B=c.diff_commonSuffix(S.substring(0,I),A.substring(0,k));M.length<B+P&&(M=A.substring(k-B,k)+A.substring(k,k+P),R=S.substring(0,I-B),F=S.substring(I+P),D=A.substring(0,k-B),T=A.substring(k+P))}return M.length*2>=S.length?[R,F,D,T,M]:null}var h=u(o,l,Math.ceil(o.length/4)),f=u(o,l,Math.ceil(o.length/2)),m;if(!h&&!f)return null;f?h?m=h[4].length>f[4].length?h:f:m=f:m=h;var g,_,w,y;r.length>a.length?(g=m[0],_=m[1],w=m[2],y=m[3]):(w=m[0],y=m[1],g=m[2],_=m[3]);var v=m[4];return[g,_,w,y,v]},e.prototype.diff_cleanupSemantic=function(r){for(var a=!1,o=[],l=0,c=null,u=0,h=0,f=0,m=0,g=0;u<r.length;)r[u][0]==i?(o[l++]=u,h=m,f=g,m=0,g=0,c=r[u][1]):(r[u][0]==n?m+=r[u][1].length:g+=r[u][1].length,c&&c.length<=Math.max(h,f)&&c.length<=Math.max(m,g)&&(r.splice(o[l-1],0,new e.Diff(t,c)),r[o[l-1]+1][0]=n,l--,l--,u=l>0?o[l-1]:-1,h=0,f=0,m=0,g=0,c=null,a=!0)),u++;for(a&&this.diff_cleanupMerge(r),this.diff_cleanupSemanticLossless(r),u=1;u<r.length;){if(r[u-1][0]==t&&r[u][0]==n){var _=r[u-1][1],w=r[u][1],y=this.diff_commonOverlap_(_,w),v=this.diff_commonOverlap_(w,_);y>=v?(y>=_.length/2||y>=w.length/2)&&(r.splice(u,0,new e.Diff(i,w.substring(0,y))),r[u-1][1]=_.substring(0,_.length-y),r[u+1][1]=w.substring(y),u++):(v>=_.length/2||v>=w.length/2)&&(r.splice(u,0,new e.Diff(i,_.substring(0,v))),r[u-1][0]=n,r[u-1][1]=w.substring(0,w.length-v),r[u+1][0]=t,r[u+1][1]=_.substring(v),u++),u++}u++}},e.prototype.diff_cleanupSemanticLossless=function(r){function a(v,S){if(!v||!S)return 6;var A=v.charAt(v.length-1),I=S.charAt(0),C=A.match(e.nonAlphaNumericRegex_),k=I.match(e.nonAlphaNumericRegex_),M=C&&A.match(e.whitespaceRegex_),R=k&&I.match(e.whitespaceRegex_),F=M&&A.match(e.linebreakRegex_),D=R&&I.match(e.linebreakRegex_),T=F&&v.match(e.blanklineEndRegex_),P=D&&S.match(e.blanklineStartRegex_);return T||P?5:F||D?4:C&&!M&&R?3:M||R?2:C||k?1:0}for(var o=1;o<r.length-1;){if(r[o-1][0]==i&&r[o+1][0]==i){var l=r[o-1][1],c=r[o][1],u=r[o+1][1],h=this.diff_commonSuffix(l,c);if(h){var f=c.substring(c.length-h);l=l.substring(0,l.length-h),c=f+c.substring(0,c.length-h),u=f+u}for(var m=l,g=c,_=u,w=a(l,c)+a(c,u);c.charAt(0)===u.charAt(0);){l+=c.charAt(0),c=c.substring(1)+u.charAt(0),u=u.substring(1);var y=a(l,c)+a(c,u);y>=w&&(w=y,m=l,g=c,_=u)}r[o-1][1]!=m&&(m?r[o-1][1]=m:(r.splice(o-1,1),o--),r[o][1]=g,_?r[o+1][1]=_:(r.splice(o+1,1),o--))}o++}},e.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,e.whitespaceRegex_=/\s/,e.linebreakRegex_=/[\r\n]/,e.blanklineEndRegex_=/\n\r?\n$/,e.blanklineStartRegex_=/^\r?\n\r?\n/,e.prototype.diff_cleanupEfficiency=function(r){for(var a=!1,o=[],l=0,c=null,u=0,h=!1,f=!1,m=!1,g=!1;u<r.length;)r[u][0]==i?(r[u][1].length<this.Diff_EditCost&&(m||g)?(o[l++]=u,h=m,f=g,c=r[u][1]):(l=0,c=null),m=g=!1):(r[u][0]==t?g=!0:m=!0,c&&(h&&f&&m&&g||c.length<this.Diff_EditCost/2&&h+f+m+g==3)&&(r.splice(o[l-1],0,new e.Diff(t,c)),r[o[l-1]+1][0]=n,l--,c=null,h&&f?(m=g=!0,l=0):(l--,u=l>0?o[l-1]:-1,m=g=!1),a=!0)),u++;a&&this.diff_cleanupMerge(r)},e.prototype.diff_cleanupMerge=function(r){r.push(new e.Diff(i,""));for(var a=0,o=0,l=0,c="",u="",h;a<r.length;)switch(r[a][0]){case n:l++,u+=r[a][1],a++;break;case t:o++,c+=r[a][1],a++;break;case i:o+l>1?(o!==0&&l!==0&&(h=this.diff_commonPrefix(u,c),h!==0&&(a-o-l>0&&r[a-o-l-1][0]==i?r[a-o-l-1][1]+=u.substring(0,h):(r.splice(0,0,new e.Diff(i,u.substring(0,h))),a++),u=u.substring(h),c=c.substring(h)),h=this.diff_commonSuffix(u,c),h!==0&&(r[a][1]=u.substring(u.length-h)+r[a][1],u=u.substring(0,u.length-h),c=c.substring(0,c.length-h))),a-=o+l,r.splice(a,o+l),c.length&&(r.splice(a,0,new e.Diff(t,c)),a++),u.length&&(r.splice(a,0,new e.Diff(n,u)),a++),a++):a!==0&&r[a-1][0]==i?(r[a-1][1]+=r[a][1],r.splice(a,1)):a++,l=0,o=0,c="",u="";break}r[r.length-1][1]===""&&r.pop();var f=!1;for(a=1;a<r.length-1;)r[a-1][0]==i&&r[a+1][0]==i&&(r[a][1].substring(r[a][1].length-r[a-1][1].length)==r[a-1][1]?(r[a][1]=r[a-1][1]+r[a][1].substring(0,r[a][1].length-r[a-1][1].length),r[a+1][1]=r[a-1][1]+r[a+1][1],r.splice(a-1,1),f=!0):r[a][1].substring(0,r[a+1][1].length)==r[a+1][1]&&(r[a-1][1]+=r[a+1][1],r[a][1]=r[a][1].substring(r[a+1][1].length)+r[a+1][1],r.splice(a+1,1),f=!0)),a++;f&&this.diff_cleanupMerge(r)},e.prototype.diff_xIndex=function(r,a){var o=0,l=0,c=0,u=0,h;for(h=0;h<r.length&&(r[h][0]!==n&&(o+=r[h][1].length),r[h][0]!==t&&(l+=r[h][1].length),!(o>a));h++)c=o,u=l;return r.length!=h&&r[h][0]===t?u:u+(a-c)},e.prototype.diff_prettyHtml=function(r){for(var a=[],o=/&/g,l=/</g,c=/>/g,u=/\n/g,h=0;h<r.length;h++){var f=r[h][0],m=r[h][1],g=m.replace(o,"&amp;").replace(l,"&lt;").replace(c,"&gt;").replace(u,"&para;<br>");switch(f){case n:a[h]='<ins style="background:#e6ffe6;">'+g+"</ins>";break;case t:a[h]='<del style="background:#ffe6e6;">'+g+"</del>";break;case i:a[h]="<span>"+g+"</span>";break}}return a.join("")},e.prototype.diff_text1=function(r){for(var a=[],o=0;o<r.length;o++)r[o][0]!==n&&(a[o]=r[o][1]);return a.join("")},e.prototype.diff_text2=function(r){for(var a=[],o=0;o<r.length;o++)r[o][0]!==t&&(a[o]=r[o][1]);return a.join("")},e.prototype.diff_levenshtein=function(r){for(var a=0,o=0,l=0,c=0;c<r.length;c++){var u=r[c][0],h=r[c][1];switch(u){case n:o+=h.length;break;case t:l+=h.length;break;case i:a+=Math.max(o,l),o=0,l=0;break}}return a+=Math.max(o,l),a},e.prototype.diff_toDelta=function(r){for(var a=[],o=0;o<r.length;o++)switch(r[o][0]){case n:a[o]="+"+encodeURI(r[o][1]);break;case t:a[o]="-"+r[o][1].length;break;case i:a[o]="="+r[o][1].length;break}return a.join("	").replace(/%20/g," ")},e.prototype.diff_fromDelta=function(r,a){for(var o=[],l=0,c=0,u=a.split(/\t/g),h=0;h<u.length;h++){var f=u[h].substring(1);switch(u[h].charAt(0)){case"+":try{o[l++]=new e.Diff(n,decodeURI(f))}catch{throw new Error("Illegal escape in diff_fromDelta: "+f)}break;case"-":case"=":var m=parseInt(f,10);if(isNaN(m)||m<0)throw new Error("Invalid number in diff_fromDelta: "+f);var g=r.substring(c,c+=m);u[h].charAt(0)=="="?o[l++]=new e.Diff(i,g):o[l++]=new e.Diff(t,g);break;default:if(u[h])throw new Error("Invalid diff operation in diff_fromDelta: "+u[h])}}if(c!=r.length)throw new Error("Delta length ("+c+") does not equal source text length ("+r.length+").");return o},e.prototype.match_main=function(r,a,o){if(r==null||a==null||o==null)throw new Error("Null input. (match_main)");return o=Math.max(0,Math.min(o,r.length)),r==a?0:r.length?r.substring(o,o+a.length)==a?o:this.match_bitap_(r,a,o):-1},e.prototype.match_bitap_=function(r,a,o){if(a.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var l=this.match_alphabet_(a),c=this;function u(R,F){var D=R/a.length,T=Math.abs(o-F);return c.Match_Distance?D+T/c.Match_Distance:T?1:D}var h=this.Match_Threshold,f=r.indexOf(a,o);f!=-1&&(h=Math.min(u(0,f),h),f=r.lastIndexOf(a,o+a.length),f!=-1&&(h=Math.min(u(0,f),h)));var m=1<<a.length-1;f=-1;for(var g,_,w=a.length+r.length,y,v=0;v<a.length;v++){for(g=0,_=w;g<_;)u(v,o+_)<=h?g=_:w=_,_=Math.floor((w-g)/2+g);w=_;var S=Math.max(1,o-_+1),A=Math.min(o+_,r.length)+a.length,I=Array(A+2);I[A+1]=(1<<v)-1;for(var C=A;C>=S;C--){var k=l[r.charAt(C-1)];if(v===0?I[C]=(I[C+1]<<1|1)&k:I[C]=(I[C+1]<<1|1)&k|((y[C+1]|y[C])<<1|1)|y[C+1],I[C]&m){var M=u(v,C-1);if(M<=h)if(h=M,f=C-1,f>o)S=Math.max(1,2*o-f);else break}}if(u(v+1,o)>h)break;y=I}return f},e.prototype.match_alphabet_=function(r){for(var a={},o=0;o<r.length;o++)a[r.charAt(o)]=0;for(var o=0;o<r.length;o++)a[r.charAt(o)]|=1<<r.length-o-1;return a},e.prototype.patch_addContext_=function(r,a){if(a.length!=0){if(r.start2===null)throw Error("patch not initialized");for(var o=a.substring(r.start2,r.start2+r.length1),l=0;a.indexOf(o)!=a.lastIndexOf(o)&&o.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)l+=this.Patch_Margin,o=a.substring(r.start2-l,r.start2+r.length1+l);l+=this.Patch_Margin;var c=a.substring(r.start2-l,r.start2);c&&r.diffs.unshift(new e.Diff(i,c));var u=a.substring(r.start2+r.length1,r.start2+r.length1+l);u&&r.diffs.push(new e.Diff(i,u)),r.start1-=c.length,r.start2-=c.length,r.length1+=c.length+u.length,r.length2+=c.length+u.length}},e.prototype.patch_make=function(r,a,o){var l,c;if(typeof r=="string"&&typeof a=="string"&&typeof o>"u")l=r,c=this.diff_main(l,a,!0),c.length>2&&(this.diff_cleanupSemantic(c),this.diff_cleanupEfficiency(c));else if(r&&typeof r=="object"&&typeof a>"u"&&typeof o>"u")c=r,l=this.diff_text1(c);else if(typeof r=="string"&&a&&typeof a=="object"&&typeof o>"u")l=r,c=a;else if(typeof r=="string"&&typeof a=="string"&&o&&typeof o=="object")l=r,c=o;else throw new Error("Unknown call format to patch_make.");if(c.length===0)return[];for(var u=[],h=new e.patch_obj,f=0,m=0,g=0,_=l,w=l,y=0;y<c.length;y++){var v=c[y][0],S=c[y][1];switch(!f&&v!==i&&(h.start1=m,h.start2=g),v){case n:h.diffs[f++]=c[y],h.length2+=S.length,w=w.substring(0,g)+S+w.substring(g);break;case t:h.length1+=S.length,h.diffs[f++]=c[y],w=w.substring(0,g)+w.substring(g+S.length);break;case i:S.length<=2*this.Patch_Margin&&f&&c.length!=y+1?(h.diffs[f++]=c[y],h.length1+=S.length,h.length2+=S.length):S.length>=2*this.Patch_Margin&&f&&(this.patch_addContext_(h,_),u.push(h),h=new e.patch_obj,f=0,_=w,m=g);break}v!==n&&(m+=S.length),v!==t&&(g+=S.length)}return f&&(this.patch_addContext_(h,_),u.push(h)),u},e.prototype.patch_deepCopy=function(r){for(var a=[],o=0;o<r.length;o++){var l=r[o],c=new e.patch_obj;c.diffs=[];for(var u=0;u<l.diffs.length;u++)c.diffs[u]=new e.Diff(l.diffs[u][0],l.diffs[u][1]);c.start1=l.start1,c.start2=l.start2,c.length1=l.length1,c.length2=l.length2,a[o]=c}return a},e.prototype.patch_apply=function(r,a){if(r.length==0)return[a,[]];r=this.patch_deepCopy(r);var o=this.patch_addPadding(r);a=o+a+o,this.patch_splitMax(r);for(var l=0,c=[],u=0;u<r.length;u++){var h=r[u].start2+l,f=this.diff_text1(r[u].diffs),m,g=-1;if(f.length>this.Match_MaxBits?(m=this.match_main(a,f.substring(0,this.Match_MaxBits),h),m!=-1&&(g=this.match_main(a,f.substring(f.length-this.Match_MaxBits),h+f.length-this.Match_MaxBits),(g==-1||m>=g)&&(m=-1))):m=this.match_main(a,f,h),m==-1)c[u]=!1,l-=r[u].length2-r[u].length1;else{c[u]=!0,l=m-h;var _;if(g==-1?_=a.substring(m,m+f.length):_=a.substring(m,g+this.Match_MaxBits),f==_)a=a.substring(0,m)+this.diff_text2(r[u].diffs)+a.substring(m+f.length);else{var w=this.diff_main(f,_,!1);if(f.length>this.Match_MaxBits&&this.diff_levenshtein(w)/f.length>this.Patch_DeleteThreshold)c[u]=!1;else{this.diff_cleanupSemanticLossless(w);for(var y=0,v,S=0;S<r[u].diffs.length;S++){var A=r[u].diffs[S];A[0]!==i&&(v=this.diff_xIndex(w,y)),A[0]===n?a=a.substring(0,m+v)+A[1]+a.substring(m+v):A[0]===t&&(a=a.substring(0,m+v)+a.substring(m+this.diff_xIndex(w,y+A[1].length))),A[0]!==t&&(y+=A[1].length)}}}}}return a=a.substring(o.length,a.length-o.length),[a,c]},e.prototype.patch_addPadding=function(r){for(var a=this.Patch_Margin,o="",l=1;l<=a;l++)o+=String.fromCharCode(l);for(var l=0;l<r.length;l++)r[l].start1+=a,r[l].start2+=a;var c=r[0],u=c.diffs;if(u.length==0||u[0][0]!=i)u.unshift(new e.Diff(i,o)),c.start1-=a,c.start2-=a,c.length1+=a,c.length2+=a;else if(a>u[0][1].length){var h=a-u[0][1].length;u[0][1]=o.substring(u[0][1].length)+u[0][1],c.start1-=h,c.start2-=h,c.length1+=h,c.length2+=h}if(c=r[r.length-1],u=c.diffs,u.length==0||u[u.length-1][0]!=i)u.push(new e.Diff(i,o)),c.length1+=a,c.length2+=a;else if(a>u[u.length-1][1].length){var h=a-u[u.length-1][1].length;u[u.length-1][1]+=o.substring(0,h),c.length1+=h,c.length2+=h}return o},e.prototype.patch_splitMax=function(r){for(var a=this.Match_MaxBits,o=0;o<r.length;o++)if(!(r[o].length1<=a)){var l=r[o];r.splice(o--,1);for(var c=l.start1,u=l.start2,h="";l.diffs.length!==0;){var f=new e.patch_obj,m=!0;for(f.start1=c-h.length,f.start2=u-h.length,h!==""&&(f.length1=f.length2=h.length,f.diffs.push(new e.Diff(i,h)));l.diffs.length!==0&&f.length1<a-this.Patch_Margin;){var g=l.diffs[0][0],_=l.diffs[0][1];g===n?(f.length2+=_.length,u+=_.length,f.diffs.push(l.diffs.shift()),m=!1):g===t&&f.diffs.length==1&&f.diffs[0][0]==i&&_.length>2*a?(f.length1+=_.length,c+=_.length,m=!1,f.diffs.push(new e.Diff(g,_)),l.diffs.shift()):(_=_.substring(0,a-f.length1-this.Patch_Margin),f.length1+=_.length,c+=_.length,g===i?(f.length2+=_.length,u+=_.length):m=!1,f.diffs.push(new e.Diff(g,_)),_==l.diffs[0][1]?l.diffs.shift():l.diffs[0][1]=l.diffs[0][1].substring(_.length))}h=this.diff_text2(f.diffs),h=h.substring(h.length-this.Patch_Margin);var w=this.diff_text1(l.diffs).substring(0,this.Patch_Margin);w!==""&&(f.length1+=w.length,f.length2+=w.length,f.diffs.length!==0&&f.diffs[f.diffs.length-1][0]===i?f.diffs[f.diffs.length-1][1]+=w:f.diffs.push(new e.Diff(i,w))),m||r.splice(++o,0,f)}}},e.prototype.patch_toText=function(r){for(var a=[],o=0;o<r.length;o++)a[o]=r[o];return a.join("")},e.prototype.patch_fromText=function(r){var a=[];if(!r)return a;for(var o=r.split(`
`),l=0,c=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;l<o.length;){var u=o[l].match(c);if(!u)throw new Error("Invalid patch string: "+o[l]);var h=new e.patch_obj;for(a.push(h),h.start1=parseInt(u[1],10),u[2]===""?(h.start1--,h.length1=1):u[2]=="0"?h.length1=0:(h.start1--,h.length1=parseInt(u[2],10)),h.start2=parseInt(u[3],10),u[4]===""?(h.start2--,h.length2=1):u[4]=="0"?h.length2=0:(h.start2--,h.length2=parseInt(u[4],10)),l++;l<o.length;){var f=o[l].charAt(0);try{var m=decodeURI(o[l].substring(1))}catch{throw new Error("Illegal escape in patch_fromText: "+m)}if(f=="-")h.diffs.push(new e.Diff(t,m));else if(f=="+")h.diffs.push(new e.Diff(n,m));else if(f==" ")h.diffs.push(new e.Diff(i,m));else{if(f=="@")break;if(f!=="")throw new Error('Invalid patch mode "'+f+'" in: '+m)}l++}}return a},e.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},e.patch_obj.prototype.toString=function(){var r,a;this.length1===0?r=this.start1+",0":this.length1==1?r=this.start1+1:r=this.start1+1+","+this.length1,this.length2===0?a=this.start2+",0":this.length2==1?a=this.start2+1:a=this.start2+1+","+this.length2;for(var o=["@@ -"+r+" +"+a+` @@
`],l,c=0;c<this.diffs.length;c++){switch(this.diffs[c][0]){case n:l="+";break;case t:l="-";break;case i:l=" ";break}o[c+1]=l+encodeURI(this.diffs[c][1])+`
`}return o.join("").replace(/%20/g," ")},s.exports=e,s.exports.diff_match_patch=e,s.exports.DIFF_DELETE=t,s.exports.DIFF_INSERT=n,s.exports.DIFF_EQUAL=i})(ao);var ic=ao.exports;const De=rc(ic);class ac{constructor(){q(this,"dmp");this.dmp=new De}computeDiff(e,t){const n=this.dmp.diff_main(e,t);return this.dmp.diff_cleanupSemantic(n),n.map(([i,r])=>{let a;switch(i){case De.DIFF_EQUAL:a="equal";break;case De.DIFF_DELETE:a="delete";break;case De.DIFF_INSERT:a="insert";break;default:a="equal"}return{type:a,original:i===De.DIFF_INSERT?"":r,modified:i===De.DIFF_DELETE?"":r,accepted:!0}})}computeLineDiff(e,t){const n=this.dmp.diff_linesToChars_(e,t),i=this.dmp.diff_main(n.chars1,n.chars2);return this.dmp.diff_charsToLines_(i,n.lineArray),this.dmp.diff_cleanupSemantic(i),i.map(([r,a])=>{let o;switch(r){case De.DIFF_EQUAL:o="equal";break;case De.DIFF_DELETE:o="delete";break;case De.DIFF_INSERT:o="insert";break;default:o="equal"}return{type:o,original:r===De.DIFF_INSERT?"":a,modified:r===De.DIFF_DELETE?"":a,accepted:!0}})}computeInlineDiff(e,t){const n=this.dmp.diff_main(e,t);this.dmp.diff_cleanupSemantic(n);const i=[],r=[];for(const[a,o]of n)switch(a){case De.DIFF_EQUAL:i.push({type:"equal",text:o}),r.push({type:"equal",text:o});break;case De.DIFF_DELETE:i.push({type:"delete",text:o});break;case De.DIFF_INSERT:r.push({type:"insert",text:o});break}return{original:{fullText:e,segments:i},modified:{fullText:t,segments:r}}}getInlineStats(e){const t=e.original.segments.filter(r=>r.type==="delete").length,n=e.modified.segments.filter(r=>r.type==="insert").length,i=e.original.segments.filter(r=>r.type==="equal").length;return{total:e.original.segments.length+e.modified.segments.length,unchanged:i,modified:t+n,accepted:t+n,rejected:0}}getStats(e){const t={total:e.length,unchanged:0,modified:0,accepted:0,rejected:0};for(const n of e)n.type==="equal"?t.unchanged++:t.modified++,n.accepted?t.accepted++:t.rejected++;return t}acceptAll(e){return e.map(t=>({...t,accepted:t.type!=="delete"}))}rejectAll(e){return e.map(t=>({...t,accepted:t.type==="delete"}))}toggleAtIndex(e,t){if(t<0||t>=e.length)return e;const n=[...e];return n[t]={...n[t],accepted:!n[t].accepted},n}mergeAcceptedChanges(e){return e.map(t=>t.accepted?t.modified||"":t.original||"").join("")}createPatch(e,t){const n=this.dmp.diff_main(e,t),i=this.dmp.patch_make(e,n);return this.dmp.patch_toText(i)}applyPatch(e,t){const n=this.dmp.patch_fromText(t),i=this.dmp.patch_apply(n,e);return{result:i[0],applied:i[1].every(Boolean)}}}const An=new ac;function Ai(s,e,t){const n=s.slice();return n[35]=e[t],n}function ki(s,e,t){const n=s.slice();return n[35]=e[t],n}function Si(s,e,t){const n=s.slice();return n[40]=e[t],n}function Ci(s){let e,t=ue(s[9]),n=[];for(let i=0;i<t.length;i+=1)n[i]=Ii(Si(s,t,i));return{c(){e=b("div");for(let i=0;i<n.length;i+=1)n[i].c();p(e,"class","model-dropdown svelte-negwbs")},m(i,r){$(i,e,r);for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(e,null)},p(i,r){if(r[0]&525824){t=ue(i[9]);let a;for(a=0;a<t.length;a+=1){const o=Si(i,t,a);n[a]?n[a].p(o,r):(n[a]=Ii(o),n[a].c(),n[a].m(e,null))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},d(i){i&&j(e),Qe(n,i)}}}function Ei(s){let e;return{c(){e=b("span"),e.textContent="âœ“",p(e,"class","check svelte-negwbs")},m(t,n){$(t,e,n)},d(t){t&&j(e)}}}function Ii(s){var y;let e,t,n=s[40].name+"",i,r,a,o,l=s[40].model+"",c,u,h,f,m,g=s[40].id===((y=s[10])==null?void 0:y.id)&&Ei();function _(){return s[26](s[40])}function w(...v){return s[27](s[40],...v)}return{c(){var v;e=b("div"),t=b("span"),i=V(n),r=E(),a=b("span"),o=V(": "),c=V(l),u=E(),g&&g.c(),h=E(),p(a,"class","model-name svelte-negwbs"),p(e,"class","dropdown-item svelte-negwbs"),p(e,"role","button"),p(e,"tabindex","0"),ce(e,"active",s[40].id===((v=s[10])==null?void 0:v.id))},m(v,S){$(v,e,S),d(e,t),d(t,i),d(e,r),d(e,a),d(a,o),d(a,c),d(e,u),g&&g.m(e,null),d(e,h),f||(m=[O(e,"click",_),O(e,"keydown",w)],f=!0)},p(v,S){var A,I;s=v,S[0]&512&&n!==(n=s[40].name+"")&&Y(i,n),S[0]&512&&l!==(l=s[40].model+"")&&Y(c,l),s[40].id===((A=s[10])==null?void 0:A.id)?g||(g=Ei(),g.c(),g.m(e,h)):g&&(g.d(1),g=null),S[0]&1536&&ce(e,"active",s[40].id===((I=s[10])==null?void 0:I.id))},d(v){v&&j(e),g&&g.d(),f=!1,Ce(m)}}}function Pi(s){let e,t,n=s[6]?"âœ• å–æ¶ˆç¼–è¾‘":"âœï¸ ç›´æŽ¥ç¼–è¾‘",i,r,a,o,l,c,u,h,f;return{c(){e=b("div"),t=b("button"),i=V(n),r=E(),a=b("button"),a.textContent="ðŸ”„ é‡æ–°ç”Ÿæˆ",o=E(),l=b("button"),l.textContent="âœ“ åº”ç”¨ä¿®æ”¹",c=E(),u=b("button"),u.textContent="å–æ¶ˆ",p(t,"class","btn-edit svelte-negwbs"),p(a,"class","btn-regenerate svelte-negwbs"),p(l,"class","btn-apply svelte-negwbs"),p(u,"class","btn-cancel svelte-negwbs"),p(e,"class","diff-actions svelte-negwbs")},m(m,g){$(m,e,g),d(e,t),d(t,i),d(e,r),d(e,a),d(e,o),d(e,l),d(e,c),d(e,u),h||(f=[O(t,"click",function(){tn(s[6]?s[15]:s[13])&&(s[6]?s[15]:s[13]).apply(this,arguments)}),O(a,"click",s[28]),O(l,"click",s[16]),O(u,"click",s[17])],h=!0)},p(m,g){s=m,g[0]&64&&n!==(n=s[6]?"âœ• å–æ¶ˆç¼–è¾‘":"âœï¸ ç›´æŽ¥ç¼–è¾‘")&&Y(i,n)},d(m){m&&j(e),h=!1,Ce(f)}}}function Di(s){let e,t,n,i,r,a,o,l,c,u,h,f,m,g,_,w,y,v,S;return{c(){e=b("div"),t=b("div"),n=b("span"),n.textContent="ðŸ’¬ é‡æ–°ç”Ÿæˆ - æ ¹æ®æ‚¨çš„è¦æ±‚è°ƒæ•´ç»“æžœ",i=E(),r=b("button"),r.textContent="âœ•",a=E(),o=b("div"),l=b("p"),l.innerHTML=`ðŸ’¡ è¾“å…¥æ‚¨çš„è¦æ±‚ï¼ŒAIå°†åŸºäºŽåŽŸæ–‡å’Œå½“å‰ç»“æžœè¿›è¡Œè°ƒæ•´ã€‚<br/>
          ä¾‹å¦‚ï¼š&quot;è¯·æ›´ç®€æ´ä¸€äº›&quot;ã€&quot;å¢žåŠ æ›´å¤šæŠ€æœ¯ç»†èŠ‚&quot;ã€&quot;è¯­æ°”æ›´æ­£å¼&quot;ç­‰ã€‚`,c=E(),u=b("textarea"),h=E(),f=b("div"),m=b("button"),m.textContent="å–æ¶ˆ",g=E(),_=b("button"),w=V("å‘é€è¯·æ±‚"),p(r,"class","btn-close svelte-negwbs"),p(t,"class","regenerate-header svelte-negwbs"),p(l,"class","regenerate-hint svelte-negwbs"),p(u,"placeholder","è¯·è¾“å…¥æ‚¨çš„ä¿®æ”¹è¦æ±‚..."),p(u,"rows","3"),p(u,"class","regenerate-input svelte-negwbs"),p(m,"class","btn-secondary svelte-negwbs"),p(_,"class","btn-primary svelte-negwbs"),_.disabled=y=!s[4].trim(),p(f,"class","regenerate-actions svelte-negwbs"),p(o,"class","regenerate-content svelte-negwbs"),p(e,"class","regenerate-panel svelte-negwbs")},m(A,I){$(A,e,I),d(e,t),d(t,n),d(t,i),d(t,r),d(e,a),d(e,o),d(o,l),d(o,c),d(o,u),te(u,s[4]),d(o,h),d(o,f),d(f,m),d(f,g),d(f,_),d(_,w),v||(S=[O(r,"click",s[29]),O(u,"input",s[30]),O(m,"click",s[31]),O(_,"click",s[18])],v=!0)},p(A,I){I[0]&16&&te(u,A[4]),I[0]&16&&y!==(y=!A[4].trim())&&(_.disabled=y)},d(A){A&&j(e),v=!1,Ce(S)}}}function oc(s){let e,t,n,i,r,a,o,l,c,u,h,f=s[6]?"ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰":"",m,g,_,w=ue(s[2].original.segments),y=[];for(let I=0;I<w.length;I+=1)y[I]=Ri(ki(s,w,I));function v(I,C){return I[6]?uc:cc}let S=v(s),A=S(s);return{c(){e=b("div"),t=b("div"),n=b("div"),n.innerHTML="<span>ðŸ“ åŽŸæ–‡</span>",i=E(),r=b("div"),a=b("div");for(let I=0;I<y.length;I+=1)y[I].c();o=E(),l=b("div"),c=b("div"),u=b("span"),h=V("âœ¨ ä¿®æ”¹åŽ "),m=V(f),g=E(),_=b("div"),A.c(),p(n,"class","panel-header svelte-negwbs"),p(a,"class","text-content svelte-negwbs"),p(r,"class","panel-content svelte-negwbs"),p(t,"class","diff-panel original svelte-negwbs"),p(c,"class","panel-header svelte-negwbs"),p(_,"class","panel-content svelte-negwbs"),p(l,"class","diff-panel modified svelte-negwbs"),ce(l,"editing",s[6]),p(e,"class","diff-content-inline svelte-negwbs")},m(I,C){$(I,e,C),d(e,t),d(t,n),d(t,i),d(t,r),d(r,a);for(let k=0;k<y.length;k+=1)y[k]&&y[k].m(a,null);d(e,o),d(e,l),d(l,c),d(c,u),d(u,h),d(u,m),d(l,g),d(l,_),A.m(_,null)},p(I,C){if(C[0]&4){w=ue(I[2].original.segments);let k;for(k=0;k<w.length;k+=1){const M=ki(I,w,k);y[k]?y[k].p(M,C):(y[k]=Ri(M),y[k].c(),y[k].m(a,null))}for(;k<y.length;k+=1)y[k].d(1);y.length=w.length}C[0]&64&&f!==(f=I[6]?"ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰":"")&&Y(m,f),S===(S=v(I))&&A?A.p(I,C):(A.d(1),A=S(I),A&&(A.c(),A.m(_,null))),C[0]&64&&ce(l,"editing",I[6])},d(I){I&&j(e),Qe(y,I),A.d()}}}function lc(s){let e;return{c(){e=b("div"),e.innerHTML='<div class="loading-spinner svelte-negwbs">â³</div> <p>æ­£åœ¨å¤„ç†ä¸­...</p>',p(e,"class","loading-content svelte-negwbs")},m(t,n){$(t,e,n)},p:ze,d(t){t&&j(e)}}}function Ri(s){let e,t=s[35].text+"",n,i;return{c(){e=b("span"),n=V(t),p(e,"class",i="segment "+Bn(s[35].type)+" svelte-negwbs")},m(r,a){$(r,e,a),d(e,n)},p(r,a){a[0]&4&&t!==(t=r[35].text+"")&&Y(n,t),a[0]&4&&i!==(i="segment "+Bn(r[35].type)+" svelte-negwbs")&&p(e,"class",i)},d(r){r&&j(e)}}}function cc(s){let e,t=ue(s[2].modified.segments),n=[];for(let i=0;i<t.length;i+=1)n[i]=Ti(Ai(s,t,i));return{c(){e=b("div");for(let i=0;i<n.length;i+=1)n[i].c();p(e,"class","text-content svelte-negwbs")},m(i,r){$(i,e,r);for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(e,null)},p(i,r){if(r[0]&4){t=ue(i[2].modified.segments);let a;for(a=0;a<t.length;a+=1){const o=Ai(i,t,a);n[a]?n[a].p(o,r):(n[a]=Ti(o),n[a].c(),n[a].m(e,null))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},d(i){i&&j(e),Qe(n,i)}}}function uc(s){let e,t,n,i,r,a,o,l,c;return{c(){e=b("textarea"),n=E(),i=b("div"),r=b("button"),r.textContent="å–æ¶ˆ",a=E(),o=b("button"),o.textContent="ä¿å­˜",p(e,"class","edit-textarea svelte-negwbs"),p(e,"placeholder","åœ¨æ­¤ç›´æŽ¥ç¼–è¾‘ä¿®æ”¹åŽçš„å†…å®¹..."),p(e,"rows",t=Math.max(10,s[7].split(`
`).length)),p(r,"class","btn-secondary svelte-negwbs"),p(o,"class","btn-primary svelte-negwbs"),p(i,"class","edit-actions svelte-negwbs")},m(u,h){$(u,e,h),te(e,s[7]),$(u,n,h),$(u,i,h),d(i,r),d(i,a),d(i,o),l||(c=[O(e,"input",s[32]),O(r,"click",s[15]),O(o,"click",s[14])],l=!0)},p(u,h){h[0]&128&&t!==(t=Math.max(10,u[7].split(`
`).length))&&p(e,"rows",t),h[0]&128&&te(e,u[7])},d(u){u&&(j(e),j(n),j(i)),l=!1,Ce(c)}}}function Ti(s){let e,t=s[35].text+"",n,i;return{c(){e=b("span"),n=V(t),p(e,"class",i="segment "+Bn(s[35].type)+" svelte-negwbs")},m(r,a){$(r,e,a),d(e,n)},p(r,a){a[0]&4&&t!==(t=r[35].text+"")&&Y(n,t),a[0]&4&&i!==(i="segment "+Bn(r[35].type)+" svelte-negwbs")&&p(e,"class",i)},d(r){r&&j(e)}}}function Mi(s){let e,t,n=s[3].modified+"",i,r;return{c(){e=b("span"),t=V("å…± "),i=V(n),r=V(" å¤„ä¿®æ”¹"),p(e,"class","stats-total")},m(a,o){$(a,e,o),d(e,t),d(e,i),d(e,r)},p(a,o){o[0]&8&&n!==(n=a[3].modified+"")&&Y(i,n)},d(a){a&&j(e)}}}function hc(s){let e,t,n,i,r,a=(s[12][s[1]]||"AIå¤„ç†")+"",o,l,c,u,h=s[10]?s[10].name+" : "+s[10].model:"æœªé…ç½®",f,m,g,_,w,y,v,S,A,I,C,k,M,R,F,D=s[8]&&Ci(s),T=s[0]&&!s[11]&&Pi(s),P=s[5]&&!s[11]&&!s[6]&&Di(s);function B(H,ee){return H[11]?lc:oc}let x=B(s),G=x(s),X=s[3]&&Mi(s);return{c(){e=b("div"),t=b("div"),n=b("div"),i=b("span"),r=V("ðŸ“Š "),o=V(a),l=E(),c=b("div"),u=b("button"),f=V(h),m=E(),D&&D.c(),g=E(),T&&T.c(),_=E(),P&&P.c(),w=E(),G.c(),y=E(),v=b("div"),S=b("span"),S.innerHTML='<span class="legend-color equal svelte-negwbs"></span>æœªæ”¹å˜',A=E(),I=b("span"),I.innerHTML='<span class="legend-color delete svelte-negwbs"></span>åˆ é™¤',C=E(),k=b("span"),k.innerHTML='<span class="legend-color insert svelte-negwbs"></span>æ–°å¢ž',M=E(),X&&X.c(),p(u,"class","model-btn svelte-negwbs"),p(c,"class","model-selector svelte-negwbs"),p(n,"class","diff-title svelte-negwbs"),p(t,"class","diff-header svelte-negwbs"),p(S,"class","legend-item svelte-negwbs"),p(I,"class","legend-item svelte-negwbs"),p(k,"class","legend-item svelte-negwbs"),p(v,"class","diff-legend svelte-negwbs"),p(e,"class","diff-viewer svelte-negwbs")},m(H,ee){$(H,e,ee),d(e,t),d(t,n),d(n,i),d(i,r),d(i,o),d(n,l),d(n,c),d(c,u),d(u,f),d(c,m),D&&D.m(c,null),d(t,g),T&&T.m(t,null),d(e,_),P&&P.m(e,null),d(e,w),G.m(e,null),d(e,y),d(e,v),d(v,S),d(v,A),d(v,I),d(v,C),d(v,k),d(v,M),X&&X.m(v,null),R||(F=O(u,"click",s[20]),R=!0)},p(H,ee){ee[0]&2&&a!==(a=(H[12][H[1]]||"AIå¤„ç†")+"")&&Y(o,a),ee[0]&1024&&h!==(h=H[10]?H[10].name+" : "+H[10].model:"æœªé…ç½®")&&Y(f,h),H[8]?D?D.p(H,ee):(D=Ci(H),D.c(),D.m(c,null)):D&&(D.d(1),D=null),H[0]&&!H[11]?T?T.p(H,ee):(T=Pi(H),T.c(),T.m(t,null)):T&&(T.d(1),T=null),H[5]&&!H[11]&&!H[6]?P?P.p(H,ee):(P=Di(H),P.c(),P.m(e,w)):P&&(P.d(1),P=null),x===(x=B(H))&&G?G.p(H,ee):(G.d(1),G=x(H),G&&(G.c(),G.m(e,y))),H[3]?X?X.p(H,ee):(X=Mi(H),X.c(),X.m(v,null)):X&&(X.d(1),X=null)},i:ze,o:ze,d(H){H&&j(e),D&&D.d(),T&&T.d(),P&&P.d(),G.d(),X&&X.d(),R=!1,F()}}}function Bn(s){switch(s){case"equal":return"equal";case"delete":return"delete";case"insert":return"insert";default:return"equal"}}function fc(s,e,t){let n,i,{original:r}=e,{modified:a}=e,{selectedText:o=""}=e,{showActions:l=!0}=e,{operationType:c="polish"}=e,{blockId:u=""}=e;const h=fo();let f,m,g="",_=!1,w=!1,y="",v=!1,S=[],A=null;const I={chat:"å¯¹è¯",polish:"æ¶¦è‰²",translate:"ç¿»è¯‘",summarize:"æ€»ç»“",expand:"æ‰©å†™",condense:"ç²¾ç®€",rewrite:"æ”¹å†™",continue:"ç»­å†™",custom1:"è‡ªå®šä¹‰1",custom2:"è‡ªå®šä¹‰2",custom3:"è‡ªå®šä¹‰3"};Ss(()=>{C()});function C(){const K=Q.getSettings();t(9,S=K.providers),t(10,A=Q.getCurrentProvider())}function k(){t(7,y=a),t(6,w=!0),C()}function M(){t(21,a=y),t(6,w=!1),t(2,f=An.computeInlineDiff(r,a)),t(3,m=An.getInlineStats(f))}function R(){t(6,w=!1),t(7,y="")}function F(){h("apply",a)}function D(){h("cancel")}function T(){if(!g.trim()){alert("è¯·è¾“å…¥ä¿®æ”¹è¦æ±‚");return}h("regenerate",{instruction:g,original:n,currentModified:a}),t(4,g=""),t(5,_=!1)}function P(K){h("switchModel",K),t(8,v=!1),C()}function B(){t(8,v=!v),C()}const x=K=>P(K.id),G=(K,ke)=>ke.key==="Enter"&&P(K.id),X=()=>t(5,_=!_),H=()=>t(5,_=!1);function ee(){g=this.value,t(4,g)}const ae=()=>t(5,_=!1);function Te(){y=this.value,t(7,y)}return s.$$set=K=>{"original"in K&&t(22,r=K.original),"modified"in K&&t(21,a=K.modified),"selectedText"in K&&t(23,o=K.selectedText),"showActions"in K&&t(0,l=K.showActions),"operationType"in K&&t(1,c=K.operationType),"blockId"in K&&t(24,u=K.blockId)},s.$$.update=()=>{s.$$.dirty[0]&12582912&&t(25,n=o||r),s.$$.dirty[0]&2097152&&t(11,i=a.startsWith("â³")||a===""||a===null||a===void 0),s.$$.dirty[0]&35651588&&(t(2,f=An.computeInlineDiff(n,a)),t(3,m=An.getInlineStats(f)))},[l,c,f,m,g,_,w,y,v,S,A,i,I,k,M,R,F,D,T,P,B,a,r,o,u,n,x,G,X,H,ee,ae,Te]}class dc extends Es{constructor(e){super(),Cs(this,e,fc,hc,ks,{original:22,modified:21,selectedText:23,showActions:0,operationType:1,blockId:24},null,[-1,-1])}}class mc{constructor(e){q(this,"toolbarElement",null);q(this,"options");q(this,"isVisible",!1);q(this,"hideTimeout",null);q(this,"currentSelection","");q(this,"currentBlockId",null);q(this,"currentSelectionStart",-1);q(this,"currentSelectionEnd",-1);q(this,"modelDropdownElement",null);q(this,"isDragging",!1);q(this,"dragOffsetX",0);q(this,"dragOffsetY",0);q(this,"isPinned",!1);this.options=e,this.bindEvents()}bindEvents(){let e;document.addEventListener("mouseup",t=>{clearTimeout(e),e=window.setTimeout(()=>{this.handleSelectionChange(t)},200)}),document.addEventListener("mousedown",t=>{const n=t.target;this.modelDropdownElement&&!this.modelDropdownElement.contains(n)&&this.hideModelDropdown(),this.toolbarElement&&!this.toolbarElement.contains(n)&&this.hide()}),document.addEventListener("scroll",()=>{this.hide(),this.hideModelDropdown()},!0),document.addEventListener("keydown",t=>{t.key==="Escape"&&(this.hideModelDropdown(),this.hide())})}handleSelectionChange(e){if(!Q.getSettings().showFloatingToolbar||!e.target.closest(".protyle-wysiwyg"))return;const i=window.getSelection();if(!i||i.rangeCount===0){this.hide();return}const r=i.toString().trim();if(r.length<1){this.hide();return}this.currentBlockId=At.getCurrentBlockId(),console.log("[AI Assistant] Selected block ID:",this.currentBlockId,"Text length:",r.length),this.calculateSelectionIndices(i,r),this.currentSelection=r,this.show(e,r)}calculateSelectionIndices(e,t){var g;this.currentSelectionStart=-1,this.currentSelectionEnd=-1;const n=e.getRangeAt(0),i=n.commonAncestorContainer;let r=i.nodeType===Node.ELEMENT_NODE?i:i.parentElement,a=null;for(;r;){if(r.classList&&r.classList.contains("p")){a=r;break}r=r.parentElement}if(!a){console.warn("[AI Assistant] æ— æ³•æ‰¾åˆ°åŒ…å«é€‰ä¸­æ–‡å­—çš„å—å…ƒç´ ");return}const o=a.textContent||"",l=e.toString();let c=0,u=0;const h=document.createRange();h.selectNodeContents(a),h.setEnd(n.startContainer,n.startOffset);const f=document.createElement("div");f.appendChild(h.cloneContents()),c=((g=f.textContent)==null?void 0:g.length)||0,u=c+l.length,this.currentSelectionStart=c,this.currentSelectionEnd=u,console.log("[AI Assistant] é€‰ä¸­ä½ç½®è®¡ç®—:",{blockContent:o.substring(0,50)+"...",selectedText:l.substring(0,30)+"...",startOffset:c,endOffset:u,totalLength:o.length});const m=o.substring(c,u);if(m!==l){console.warn("[AI Assistant] ç´¢å¼•è®¡ç®—å¯èƒ½æœ‰è¯¯:",{expected:l,extracted:m});const _=o.indexOf(l);_!==-1&&(this.currentSelectionStart=_,this.currentSelectionEnd=_+l.length,console.log("[AI Assistant] ä½¿ç”¨å›žé€€ç´¢å¼•:",this.currentSelectionStart,this.currentSelectionEnd))}}show(e,t){if(this.toolbarElement||this.createToolbar(),!this.toolbarElement)return;if(this.isPinned){this.toolbarElement.style.display="block",this.toolbarElement.classList.add("show"),this.isVisible=!0;return}this.refreshToolbar();const n=window.getSelection();if(!n||n.rangeCount===0)return;const r=n.getRangeAt(0).getBoundingClientRect(),a=this.toolbarElement.offsetHeight||50,o=this.toolbarElement.offsetWidth||300;let l=r.top-a-10,c=r.left+r.width/2-o/2;l<10&&(l=r.bottom+15),c<10&&(c=10),c+o>window.innerWidth-10&&(c=window.innerWidth-o-10),l+a>window.innerHeight-10&&l>r.bottom+10&&(l=r.top,c=r.right+10,c+o>window.innerWidth-10&&(c=r.left-o-10)),this.toolbarElement.style.top=`${l+window.scrollY}px`,this.toolbarElement.style.left=`${c+window.scrollX}px`,this.toolbarElement.style.display="block",this.toolbarElement.classList.add("show"),this.isVisible=!0,this.resetHideTimeout()}hide(){!this.toolbarElement||!this.isVisible||this.isPinned||(this.toolbarElement.classList.remove("show"),this.toolbarElement.style.display="none",this.isVisible=!1,this.currentSelection="",this.currentBlockId=null,this.currentSelectionStart=-1,this.currentSelectionEnd=-1,this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null))}forceHide(){!this.toolbarElement||!this.isVisible||(this.toolbarElement.classList.remove("show"),this.toolbarElement.style.display="none",this.isVisible=!1,this.isPinned=!1,this.currentSelection="",this.currentBlockId=null,this.currentSelectionStart=-1,this.currentSelectionEnd=-1,this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null))}resetHideTimeout(){this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=window.setTimeout(()=>{this.hide(),this.hideModelDropdown()},1e4)}refreshToolbar(){if(!this.toolbarElement)return;const e=Q.getSettings(),t=Q.getCurrentProvider(),n=e.toolbarButtons,i=this.toolbarElement.querySelector(".provider-name");i&&(i.textContent=t?`${t.name} : ${t.model}`:"âš ï¸ æœªé…ç½®");const r=this.toolbarElement.querySelector(".toolbar-buttons");if(r){r.innerHTML="";const a=[{type:"polish",label:"æ¶¦è‰²",icon:"âœ¨",enabled:n.polish},{type:"translate",label:"ç¿»è¯‘",icon:"ðŸŒ",enabled:n.translate},{type:"summarize",label:"æ€»ç»“",icon:"ðŸ“",enabled:n.summarize},{type:"expand",label:"æ‰©å†™",icon:"ðŸ“–",enabled:n.expand},{type:"condense",label:"ç²¾ç®€",icon:"ðŸ“„",enabled:n.condense},{type:"rewrite",label:"æ”¹å†™",icon:"ðŸ”„",enabled:n.rewrite},{type:"continue",label:"ç»­å†™",icon:"âž¡ï¸",enabled:n.continue}];e.customButtons.forEach((o,l)=>{if(o.enabled){const c=`custom${l+1}`;a.push({type:`custom${l+1}`,label:o.name,icon:o.icon,enabled:n[c]||!1})}}),a.filter(o=>o.enabled).forEach(o=>{const l=document.createElement("button");l.className="toolbar-btn",l.innerHTML=`<span class="icon">${o.icon}</span><span>${o.label}</span>`,l.addEventListener("click",()=>this.handleOperation(o.type)),r.appendChild(l)})}}createModelDropdown(){this.modelDropdownElement&&(this.modelDropdownElement.remove(),this.modelDropdownElement=null);const e=Q.getSettings(),t=e.providers,n=e.currentProviderId;if(t.length===0)return;const i=document.createElement("div");i.className="ai-model-dropdown",i.style.cssText=`
            position: fixed;
            z-index: 10000;
            background: var(--b3-theme-background, #fff);
            border: 1px solid var(--b3-border-color, #e0e0e0);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-height: 200px;
            overflow-y: auto;
            min-width: 200px;
            padding: 4px 0;
        `,t.forEach(r=>{const a=document.createElement("div");a.className="dropdown-item";const o=r.id===n;a.style.cssText=`
                padding: 10px 12px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 13px;
                color: var(--b3-theme-on-background, #333);
            `,o&&(a.style.background="var(--b3-theme-primary-light, rgba(66, 133, 244, 0.1))"),a.innerHTML=`
                <span>${r.name}</span>
                <span style="color: var(--b3-theme-on-surface, #666); font-size: 12px;">: ${r.model}</span>
                ${o?'<span style="margin-left: auto; color: var(--b3-theme-success, #22c55e);">âœ“</span>':""}
            `,a.addEventListener("click",async l=>{l.stopPropagation(),console.log("[AI Assistant] Switching to provider:",r.name,r.model),await Q.setCurrentProvider(r.id),pe.setProvider(r),this.refreshToolbar(),this.hideModelDropdown(),console.log("[AI Assistant] Provider switched successfully to:",r.name)}),a.addEventListener("mouseenter",()=>{a.style.background="var(--b3-theme-hover, rgba(0, 0, 0, 0.05))"}),a.addEventListener("mouseleave",()=>{o||(a.style.background="")}),i.appendChild(a)}),document.body.appendChild(i),this.modelDropdownElement=i}showModelDropdown(){if(!this.toolbarElement||(this.hideModelDropdown(),this.createModelDropdown(),!this.modelDropdownElement))return;const e=this.toolbarElement.querySelector(".provider-name");if(!e)return;const t=e.getBoundingClientRect();this.modelDropdownElement.style.top=`${t.bottom+5}px`,this.modelDropdownElement.style.left=`${t.left}px`}hideModelDropdown(){this.modelDropdownElement&&(this.modelDropdownElement.remove(),this.modelDropdownElement=null)}createToolbar(){var u,h;const e=document.createElement("div");e.className="ai-floating-toolbar",e.style.cssText=`
            position: fixed;
            display: none;
            z-index: 9999;
            background: var(--b3-theme-background, #fff);
            border: 1px solid var(--b3-border-color, #e0e0e0);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px;
            font-family: var(--b3-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            user-select: none;
        `;const t=Q.getCurrentProvider(),n=t?`${t.name} : ${t.model}`:"âš ï¸ æœªé…ç½®",i=document.createElement("div");i.className="toolbar-header",i.style.cssText="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--b3-border-color, #e0e0e0); cursor: move;",i.innerHTML=`
            <span class="drag-handle" style="cursor: move; padding: 2px 4px; margin-right: 4px; color: var(--b3-theme-on-surface, #999);">â‹®â‹®</span>
            <span class="provider-name" style="cursor: pointer; font-weight: 500; font-size: 12px; color: var(--b3-theme-on-surface, #666); flex: 1;" title="ç‚¹å‡»åˆ‡æ¢æ¨¡åž‹">${n}</span>
            <button class="btn-pin" style="background: none; border: none; cursor: pointer; font-size: 12px; padding: 2px 6px; margin-right: 4px; opacity: 0.6;" title="å›ºå®šä½ç½®">ðŸ“Œ</button>
            <button class="btn-settings" style="background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px 6px;" title="è®¾ç½®">âš™ï¸</button>
            <button class="btn-close" style="background: none; border: none; cursor: pointer; font-size: 12px; padding: 2px 6px; margin-left: 4px; color: var(--b3-theme-on-surface, #999);" title="å…³é—­">âœ•</button>
        `;const r=i.querySelector(".drag-handle"),a=f=>{f.addEventListener("mousedown",m=>{(m.target===f||m.target===i||m.target.classList.contains("provider-name"))&&(m.preventDefault(),this.isDragging=!0,this.dragOffsetX=m.clientX-e.offsetLeft,this.dragOffsetY=m.clientY-e.offsetTop,e.style.cursor="grabbing")})};a(i),r&&a(r);const o=i.querySelector(".btn-pin");o&&o.addEventListener("click",f=>{f.stopPropagation(),this.isPinned=!this.isPinned,o.style.opacity=this.isPinned?"1":"0.6",o.textContent=this.isPinned?"ðŸ“":"ðŸ“Œ",o.title=this.isPinned?"å·²å›ºå®šï¼Œç‚¹å‡»å–æ¶ˆå›ºå®š":"å›ºå®šä½ç½®",console.log("[AI Assistant] å·¥å…·æ å·²",this.isPinned?"å›ºå®š":"å–æ¶ˆå›ºå®š")});const l=i.querySelector(".btn-close");l&&l.addEventListener("click",f=>{f.stopPropagation(),this.forceHide()}),(u=i.querySelector(".provider-name"))==null||u.addEventListener("click",f=>{f.stopPropagation(),this.showModelDropdown()}),(h=i.querySelector(".btn-settings"))==null||h.addEventListener("click",()=>{this.hideModelDropdown(),this.options.onOpenSettings(),this.forceHide()}),e.appendChild(i);const c=document.createElement("div");c.className="toolbar-buttons",c.style.cssText="display: flex; gap: 4px; flex-wrap: wrap;",e.appendChild(c),this.refreshToolbar(),document.body.appendChild(e),this.toolbarElement=e,document.addEventListener("mousemove",f=>{if(this.isDragging&&this.toolbarElement){f.preventDefault();const m=f.clientX-this.dragOffsetX,g=f.clientY-this.dragOffsetY,_=window.innerWidth-this.toolbarElement.offsetWidth-10,w=window.innerHeight-this.toolbarElement.offsetHeight-10;this.toolbarElement.style.left=`${Math.max(10,Math.min(m,_))}px`,this.toolbarElement.style.top=`${Math.max(10,Math.min(g,w))}px`}}),document.addEventListener("mouseup",()=>{this.isDragging&&(this.isDragging=!1,this.toolbarElement&&(this.toolbarElement.style.cursor="default"))}),e.addEventListener("mouseenter",()=>{this.hideTimeout&&clearTimeout(this.hideTimeout)}),e.addEventListener("mouseleave",()=>{this.resetHideTimeout()})}async handleOperation(e){var l;if(!this.currentSelection)return;const n=Q.getSettings().customButtons.find(c=>c.id===e),i=n==null?void 0:n.prompt;let r="";if(this.currentBlockId){const c=await At.getBlockContent(this.currentBlockId);r=(c==null?void 0:c.content)||"",console.log("[AI Assistant] èŽ·å–å®Œæ•´å—å†…å®¹:",r==null?void 0:r.substring(0,50),"blockId:",this.currentBlockId)}r||(r=this.getFullBlockContentFromDOM(),console.log("[AI Assistant] ä»ŽDOMèŽ·å–å®Œæ•´å—å†…å®¹:",r==null?void 0:r.substring(0,50))),r||(r=this.currentSelection,console.warn("[AI Assistant] æ— æ³•èŽ·å–å®Œæ•´å—å†…å®¹ï¼Œä½¿ç”¨é€‰ä¸­æ–‡å­—ä»£æ›¿"));let a="";const o=r!==this.currentSelection;o?a={polish:`è¯·æ¶¦è‰²ä»¥ä¸‹æ–‡æœ¬çš„é€‰ä¸­éƒ¨åˆ†ï¼Œåªè¿”å›žæ¶¦è‰²åŽçš„é€‰ä¸­éƒ¨åˆ†æ–‡æœ¬ï¼Œä¸è¦è§£é‡Šï¼š

é€‰ä¸­éƒ¨åˆ†ï¼š${this.currentSelection}`,translate:`è¯·ç¿»è¯‘ä»¥ä¸‹æ–‡æœ¬çš„é€‰ä¸­éƒ¨åˆ†ï¼Œåªè¿”å›žç¿»è¯‘åŽçš„é€‰ä¸­éƒ¨åˆ†æ–‡æœ¬ï¼Œä¸è¦è§£é‡Šï¼š

é€‰ä¸­éƒ¨åˆ†ï¼š${this.currentSelection}`,summarize:`è¯·æ€»ç»“ä»¥ä¸‹æ–‡æœ¬ï¼Œåªè¿”å›žæ€»ç»“å†…å®¹ï¼š

${r}`,expand:`è¯·æ‰©å†™ä»¥ä¸‹æ–‡æœ¬ï¼š

${r}`,condense:`è¯·ç²¾ç®€ä»¥ä¸‹æ–‡æœ¬ï¼š

${r}`,rewrite:`è¯·æ”¹å†™ä»¥ä¸‹æ–‡æœ¬ï¼š

${r}`,continue:`è¯·ç»­å†™ä»¥ä¸‹æ–‡æœ¬ï¼š

${r}`}[e]||i||`${e}: ${this.currentSelection}`:a=i||"",console.log("[AI Assistant] Starting operation:",e,"isPartialSelection:",o),this.options.onOperationStart(e,r,this.currentBlockId||void 0,this.currentSelection,this.currentSelectionStart,this.currentSelectionEnd);try{this.setLoading(!0);const c=pe.buildOperationMessages(this.currentSelection,e,a),u=await((l=pe.adapter)==null?void 0:l.chatCompletion(c));u&&(console.log("[AI Assistant] Operation completed"),this.options.onOperation(e,r,u.content,this.currentBlockId||void 0,this.currentSelection,this.currentSelectionStart,this.currentSelectionEnd))}catch(c){console.error("[AI Assistant] Operation failed:",c),alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥AIæä¾›å•†é…ç½®")}finally{this.setLoading(!1),this.hide()}}getFullBlockContentFromDOM(){const e=window.getSelection();if(!e||e.rangeCount===0)return"";const n=e.getRangeAt(0).commonAncestorContainer;let i=n.nodeType===Node.ELEMENT_NODE?n:n.parentElement;for(;i;){if(i.classList&&i.classList.contains("p")){const r=i.textContent||"";return console.log("[AI Assistant] ä»ŽDOMæ‰¾åˆ°å—å†…å®¹:",r==null?void 0:r.substring(0,50)),r}i=i.parentElement}return this.currentSelection}setLoading(e){if(!this.toolbarElement)return;this.toolbarElement.querySelectorAll(".toolbar-btn").forEach(n=>{n.disabled=e,e?n.classList.add("loading"):n.classList.remove("loading")})}getCurrentSelection(){return this.currentSelection}getCurrentBlockId(){return this.currentBlockId}destroy(){this.hide(),this.hideModelDropdown(),this.toolbarElement&&(this.toolbarElement.remove(),this.toolbarElement=null)}}class gc{constructor(e){q(this,"options");q(this,"menuElement",null);this.options=e}injectIntoBlockMenu(e){var o,l,c,u;const t=(c=(l=(o=window.siyuan)==null?void 0:o.config)==null?void 0:l.pluginSettings)==null?void 0:c["siyuan-ai-assistant"];if(t&&!t.showContextMenu)return;const n=e.detail;if(!((u=n==null?void 0:n.menu)!=null&&u.element))return;const i=n.menu,r=n.blockId;if(!r)return;i.addItem({type:"separator"});const a=[{label:"âœ¨ æ¶¦è‰²æ–‡æœ¬",click:()=>this.options.onOperation("polish",r)},{label:"ðŸŒ ç¿»è¯‘æ–‡æœ¬",click:()=>this.options.onOperation("translate",r)},{label:"ðŸ“ æ€»ç»“å†…å®¹",click:()=>this.options.onOperation("summarize",r)},{label:"ðŸ“– æ‰©å†™å†…å®¹",click:()=>this.options.onOperation("expand",r)},{type:"separator"},{label:"âš™ï¸ AIåŠ©æ‰‹è®¾ç½®",click:()=>this.options.onOpenSettings()}];i.addItem({label:"ðŸ¤– AIåŠ©æ‰‹",submenu:a})}showForSelection(e,t,n){this.hide();const i=document.createElement("div");i.className="ai-context-menu",i.style.cssText=`
            position: fixed;
            z-index: 9999;
            background: var(--b3-theme-background);
            border: 1px solid var(--b3-border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 4px 0;
            min-width: 160px;
            font-family: var(--b3-font-family);
            font-size: 14px;
        `,[{label:"âœ¨ æ¶¦è‰²",action:n.onPolish},{label:"ðŸŒ ç¿»è¯‘",action:n.onTranslate},{label:"ðŸ“ æ€»ç»“",action:n.onSummarize},{label:"ðŸ“– æ‰©å†™",action:n.onExpand}].forEach(l=>{const c=document.createElement("div");c.className="ai-context-menu-item",c.textContent=l.label,c.style.cssText=`
                padding: 8px 16px;
                cursor: pointer;
                transition: background 0.15s;
            `,c.addEventListener("mouseenter",()=>{c.style.background="var(--b3-theme-hover)"}),c.addEventListener("mouseleave",()=>{c.style.background="transparent"}),c.addEventListener("click",()=>{l.action(),this.hide()}),i.appendChild(c)}),i.style.left=`${e.clientX}px`,i.style.top=`${e.clientY}px`;const a=i.getBoundingClientRect();a.right>window.innerWidth&&(i.style.left=`${e.clientX-a.width}px`),a.bottom>window.innerHeight&&(i.style.top=`${e.clientY-a.height}px`),document.body.appendChild(i),this.menuElement=i;const o=l=>{i.contains(l.target)||(this.hide(),document.removeEventListener("mousedown",o))};setTimeout(()=>{document.addEventListener("mousedown",o)},0)}hide(){this.menuElement&&(this.menuElement.remove(),this.menuElement=null)}}function Oi(s){const{title:e,content:t,width:n="600px",height:i="auto",destroyCallback:r}=s;let a;typeof t=="string"?a=t:a='<div class="ai-dialog-content-placeholder"></div>';const o=new Bi.Dialog({title:e,content:a,width:n,height:i,destroyCallback:r});if(typeof t!="string"){const l=[".b3-dialog__body",".b3-dialog__content",".b3-dialog .b3-dialog__body",".b3-dialog .b3-dialog__content"];let c=null;for(const h of l)if(c=o.element.querySelector(h),c)break;c||(c=o.element);const u=c.querySelector(".ai-dialog-content-placeholder");u?u.replaceWith(t):c.appendChild(t)}return o}const kn="siyuan-ai-assistant",Fi="ai_assistant_dock";class pc extends Bi.Plugin{constructor(){super(...arguments);q(this,"floatingToolbar",null);q(this,"contextMenuManager",null);q(this,"settingsDialog",null);q(this,"diffDialog",null);q(this,"chatPanelComponent",null);q(this,"currentDiffViewer",null);q(this,"currentOriginalText","");q(this,"currentSelectedText","");q(this,"currentSelectionStart",-1);q(this,"currentSelectionEnd",-1)}async onload(){console.log(`[${kn}] Plugin loading...`),Q.init(this),await Q.loadSettings();const t=Q.getCurrentProvider();t&&pe.setProvider(t),this.addIcons(`
            <symbol id="iconAIAssistant" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                <circle cx="12" cy="12" r="3" fill="currentColor"/>
            </symbol>
            <symbol id="iconSparkles" viewBox="0 0 24 24">
                <path d="M7 2v11h3v9l7-12h-4l4-8z"/>
            </symbol>
        `),this.addTopBar({icon:"iconAIAssistant",title:this.i18n.title||"AIåŠ©æ‰‹",position:"right",callback:()=>this.toggleDock()}),this.addDock({config:{position:"RightBottom",size:{width:320,height:500},icon:"iconAIAssistant",title:this.i18n.title||"AIåŠ©æ‰‹"},data:{text:this.i18n.title||"AIåŠ©æ‰‹"},type:Fi,init:n=>{this.initChatPanel(n.element)}}),this.initFloatingToolbar(),this.initContextMenu(),this.addCommand({langKey:"toggleAIAssistant",hotkey:"Alt+Cmd+A",callback:()=>this.toggleDock()}),console.log(`[${kn}] Plugin loaded successfully`)}onLayoutReady(){const t=Q.getCurrentProvider();t&&pe.setProvider(t)}onunload(){var t,n,i;console.log(`[${kn}] Plugin unloading...`),(t=this.floatingToolbar)==null||t.destroy(),this.floatingToolbar=null,(n=this.settingsDialog)==null||n.destroy(),this.settingsDialog=null,(i=this.diffDialog)==null||i.destroy(),this.diffDialog=null,console.log(`[${kn}] Plugin unloaded`)}openSetting(){this.openSettings()}initChatPanel(t){t.style.height="100%",t.style.overflow="hidden";const n=new $l({target:t,props:{onOpenSettings:()=>this.openSettings()}});this.chatPanelComponent=n}initFloatingToolbar(){this.floatingToolbar=new mc({onOperation:(t,n,i,r,a,o,l)=>{this.updateDiffViewer(i,n,a,o,l)},onOperationStart:(t,n,i,r,a,o)=>{this.showDiffViewer(n,"â³ æ­£åœ¨è¯·æ±‚AIå¤„ç†...",t,i,r,a,o)},onOpenSettings:()=>this.openSettings()})}initContextMenu(){this.contextMenuManager=new gc({onOperation:async(t,n)=>{const i=await At.getBlockContent(n);if(i)try{const r=await pe.processText(i.content,t);this.showDiffViewer(i.content,r.content,t,n)}catch(r){console.error("[AI Assistant] Context menu operation failed:",r),alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥AIæä¾›å•†é…ç½®")}},onOpenSettings:()=>this.openSettings()}),this.eventBus.on("click-blockicon",t=>{var n;(n=this.contextMenuManager)==null||n.injectIntoBlockMenu(t)})}toggleDock(){const t=document.querySelector(`[data-type="${Fi}"]`);t&&(t.classList.contains("fn__none")?t.classList.remove("fn__none"):t.classList.add("fn__none"))}openSettings(){this.settingsDialog&&this.settingsDialog.destroy();const t=document.createElement("div");t.style.height="500px",new sc({target:t,props:{onClose:()=>{var n;(n=this.settingsDialog)==null||n.destroy(),this.settingsDialog=null}}}),this.settingsDialog=Oi({title:"AIåŠ©æ‰‹è®¾ç½®",content:t,width:"600px",height:"500px",destroyCallback:()=>{this.settingsDialog=null}})}showDiffViewer(t,n,i,r,a,o,l){var f;this.diffDialog&&this.diffDialog.destroy();const c=r;this.currentOriginalText=t,this.currentSelectedText=a||"",this.currentSelectionStart=o??-1,this.currentSelectionEnd=l??-1,console.log("[AI Assistant] showDiffViewer called:"),console.log("  - original (å®Œæ•´å†…å®¹):",t==null?void 0:t.substring(0,50)),console.log("  - modified (AIç»“æžœ):",n==null?void 0:n.substring(0,50)),console.log("  - selectedText (é€‰ä¸­æ–‡å­—):",a),console.log("  - selectionStart (èµ·å§‹ç´¢å¼•):",this.currentSelectionStart),console.log("  - selectionEnd (ç»“æŸç´¢å¼•):",this.currentSelectionEnd),console.log("  - this.currentOriginalText å·²ä¿å­˜:",(f=this.currentOriginalText)==null?void 0:f.substring(0,50));const u=document.createElement("div");this.currentDiffViewer=new dc({target:u,props:{original:t,modified:n,selectedText:a||"",operationType:i,blockId:r||""}}),this.currentDiffViewer.$on("apply",async m=>{var _,w,y;const g=m.detail;if(console.log("[AI Assistant] Applying changes"),console.log("  - result (DiffViewerè¿”å›ž):",g==null?void 0:g.substring(0,50)),console.log("  - this.currentOriginalText:",(_=this.currentOriginalText)==null?void 0:_.substring(0,50)),console.log("  - this.currentSelectionStart:",this.currentSelectionStart),console.log("  - this.currentSelectionEnd:",this.currentSelectionEnd),this.currentOriginalText){let v;if(this.currentSelectionStart>=0&&this.currentSelectionEnd>this.currentSelectionStart){const S=this.currentOriginalText.substring(0,this.currentSelectionStart),A=this.currentOriginalText.substring(this.currentSelectionEnd);v=S+g+A,console.log("[AI Assistant] ä½¿ç”¨ç´¢å¼•ç²¾ç¡®æ›¿æ¢æˆåŠŸ:"),console.log("  - å‰ç¼€:",(S==null?void 0:S.substring(0,30))+"..."),console.log("  - æ›¿æ¢åŽ:",(g==null?void 0:g.substring(0,30))+"..."),console.log("  - åŽç¼€:",(A==null?void 0:A.substring(0,30))+"...")}else{console.warn("[AI Assistant] ç´¢å¼•ä¿¡æ¯ä¸å¯ç”¨ï¼Œä½¿ç”¨å›žé€€æ–¹æ¡ˆ");const S=At.getSelectedText();console.log("  - DOMé€‰ä¸­æ–‡å­—:",S);const A=S||this.currentSelectedText||this.currentOriginalText;console.log("  - æœ€ç»ˆç”¨äºŽæ›¿æ¢çš„æ–‡å­—:",A),v=this.currentOriginalText;const I=A.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),C=new RegExp(I,"");if(C.test(v))v=v.replace(C,g),console.log("[AI Assistant] æ­£åˆ™æ›¿æ¢æˆåŠŸ:",v);else{const k=A.trim(),M=new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"");if(M.test(v))v=v.replace(M,g),console.log("[AI Assistant] Trimæ›¿æ¢æˆåŠŸ:",v);else if(console.warn("[AI Assistant] æ— æ³•æ‰¾åˆ°é€‰ä¸­æ–‡å­—åœ¨åŽŸæ–‡ä¸­çš„ä½ç½®"),console.warn("[AI Assistant] åŽŸæ–‡:",v),console.warn("[AI Assistant] è¦æ›¿æ¢çš„æ–‡å­—:",A),S&&v.includes(S.substring(0,10))){const R=S.substring(0,Math.min(10,S.length)),F=v.indexOf(R);if(F!==-1){const D=v.substring(0,F);let T=F+R.length;for(;T<v.length&&T<F+S.length;)T++;const P=v.substring(T);v=D+g+P,console.log("[AI Assistant] æ¨¡ç³Šæ›¿æ¢æˆåŠŸ:",v)}}else{console.error("[AI Assistant] ä¸¥é‡é”™è¯¯ï¼šé€‰ä¸­æ–‡å­—ä¸åœ¨åŽŸæ–‡ä¸­ï¼"),alert("åº”ç”¨å¤±è´¥ï¼šæ— æ³•åœ¨åŽŸæ–‡ä¸­æ‰¾åˆ°é€‰ä¸­çš„æ–‡å­—"),(w=this.diffDialog)==null||w.destroy(),this.diffDialog=null;return}}}c?(console.log("[AI Assistant] Updating block:",c),console.log("[AI Assistant] æœ€ç»ˆå†…å®¹:",v),await At.updateBlock(c,v)?console.log("[AI Assistant] Block updated successfully"):(console.error("[AI Assistant] Failed to update block"),alert("åº”ç”¨ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•"))):(console.error("[AI Assistant] No block ID found"),alert("æ— æ³•ç¡®å®šè¦æ›´æ–°çš„æ–‡æœ¬å—"))}else console.warn("[AI Assistant] æ²¡æœ‰ä¿å­˜çš„å†…å®¹ï¼Œä½¿ç”¨AIç»“æžœ"),c&&(await At.updateBlock(c,g)||alert("åº”ç”¨ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•"));(y=this.diffDialog)==null||y.destroy(),this.diffDialog=null}),this.currentDiffViewer.$on("cancel",()=>{var m;(m=this.diffDialog)==null||m.destroy(),this.diffDialog=null,this.currentDiffViewer=null}),this.currentDiffViewer.$on("regenerate",async m=>{var y;const{instruction:g,original:_,currentModified:w}=m.detail;console.log("[AI Assistant] Regenerating:",g),this.updateDiffViewer("â³ æ­£åœ¨é‡æ–°ç”Ÿæˆ...");try{const v=[{role:"system",content:"ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å†™ä½œåŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„è¦æ±‚ï¼Œç»“åˆåŽŸæ–‡ï¼Œç”Ÿæˆæ›´å¥½çš„å†…å®¹ã€‚åªè¾“å‡ºç”ŸæˆåŽçš„æ–‡æœ¬ï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šã€‚"},{role:"user",content:`ã€åŽŸæ–‡ã€‘
${_}

ã€ç”¨æˆ·è¦æ±‚ã€‘
${g}

è¯·æ ¹æ®è¦æ±‚é‡æ–°ç”Ÿæˆå†…å®¹ï¼Œç›´æŽ¥è¾“å‡ºæ–‡æœ¬ï¼Œæ— éœ€è§£é‡Šã€‚`}],S=await((y=pe.adapter)==null?void 0:y.chatCompletion(v));S&&S.content?(console.log("[AI Assistant] Regenerated successfully"),this.updateDiffViewer(S.content)):(console.error("[AI Assistant] Regeneration failed: empty response"),alert("é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"),this.updateDiffViewer(w))}catch(v){console.error("[AI Assistant] Regeneration error:",v),alert("é‡æ–°ç”Ÿæˆæ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥AIæä¾›å•†é…ç½®"),this.updateDiffViewer(w)}}),this.currentDiffViewer.$on("switchModel",async m=>{var _;const g=m.detail;console.log("[AI Assistant] Switching model to:",g);try{await Q.setCurrentProvider(g),pe.setProvider(Q.getCurrentProvider()),this.updateDiffViewer("â³ æ­£åœ¨ä½¿ç”¨æ–°æ¨¡åž‹é‡æ–°å¤„ç†...");const w=pe.buildOperationMessages(t,i),y=await((_=pe.adapter)==null?void 0:_.chatCompletion(w));y&&y.content?(console.log("[AI Assistant] Model switch and reprocess completed"),this.updateDiffViewer(y.content)):(console.error("[AI Assistant] Reprocess failed"),alert("ä½¿ç”¨æ–°æ¨¡åž‹å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•"))}catch(w){console.error("[AI Assistant] Model switch error:",w),alert("åˆ‡æ¢æ¨¡åž‹å¤±è´¥")}});const h={chat:"å¯¹è¯",polish:"æ¶¦è‰²",translate:"ç¿»è¯‘",summarize:"æ€»ç»“",expand:"æ‰©å†™",condense:"ç²¾ç®€",rewrite:"æ”¹å†™",continue:"ç»­å†™",custom1:"è‡ªå®šä¹‰1",custom2:"è‡ªå®šä¹‰2",custom3:"è‡ªå®šä¹‰3"};this.diffDialog=Oi({title:`${h[i]||"AI"}ç»“æžœ - å·®å¼‚å¯¹æ¯”`,content:u,width:"800px",height:"600px",destroyCallback:()=>{this.diffDialog=null,this.currentDiffViewer=null}})}updateDiffViewer(t,n,i,r,a){if(this.currentDiffViewer){console.log("[AI Assistant] Updating diff viewer with new content");const o={modified:t};i!==void 0&&(o.selectedText=i),n!==void 0&&(o.original=n),this.currentDiffViewer.$set(o),i&&(this.currentSelectedText=i),n&&(this.currentOriginalText=n),r!==void 0&&r>=0&&(this.currentSelectionStart=r),a!==void 0&&a>=0&&(this.currentSelectionEnd=a)}}}exports.default=pc;
